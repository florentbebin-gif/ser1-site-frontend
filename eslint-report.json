[{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\App.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\auth\\AdminGate.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\auth\\AuthProvider.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'reason' is defined but never used. Allowed unused args must match /^_/u.","line":26,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":26,"endColumn":34,"suggestions":[{"messageId":"removeVar","data":{"varName":"reason"},"fix":{"range":[919,934],"text":""},"desc":"Remove unused variable 'reason'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * AuthProvider - Version simplifi├®e\r\n * \r\n * Principe : faire confiance ├á Supabase pour g├®rer les sessions.\r\n * - autoRefreshToken: true dans supabaseClient.js g├¿re le refresh automatique\r\n * - onAuthStateChange ├®coute les changements d'├®tat\r\n * - Pas de listeners focus/visibility qui causent des d├®connexions\r\n * - Pas de refresh manuel agressif\r\n */\r\n\r\nimport React, { createContext, useCallback, useContext, useEffect, useMemo, useState } from 'react';\r\nimport type { Session, User } from '@supabase/supabase-js';\r\nimport { supabase, DEBUG_AUTH } from '../supabaseClient';\r\n\r\nexport type AuthRole = 'admin' | 'user' | null;\r\n\r\nexport interface AuthState {\r\n  authReady: boolean;\r\n  session: Session | null;\r\n  user: User | null;\r\n  role: AuthRole;\r\n  isAdmin: boolean;\r\n  authRevision: number;\r\n  // Gard├® pour compatibilit├® mais ne change plus automatiquement\r\n  appAwakeRevision: number;\r\n  ensureSession: (reason?: string) => Promise<Session | null>;\r\n}\r\n\r\nconst AuthContext = createContext<AuthState | null>(null);\r\n\r\nfunction computeRole(user: User | null): AuthRole {\r\n  if (!user) return null;\r\n  const role = (user.user_metadata?.role || user.app_metadata?.role || 'user') as string;\r\n  return role === 'admin' ? 'admin' : 'user';\r\n}\r\n\r\nexport function AuthProvider({ children }: { children: React.ReactNode }): React.ReactElement {\r\n  const [authReady, setAuthReady] = useState(false);\r\n  const [session, setSession] = useState<Session | null>(null);\r\n  const [user, setUser] = useState<User | null>(null);\r\n  const [authRevision, setAuthRevision] = useState(0);\r\n  // Gard├® pour compatibilit├® mais fix├® ├á 0 - ne d├®clenche plus de rechargements\r\n  const [appAwakeRevision] = useState(0);\r\n\r\n  // Mise ├á jour de l'├®tat depuis une session\r\n  const updateFromSession = useCallback((newSession: Session | null, source: string) => {\r\n    if (DEBUG_AUTH) {\r\n      console.log('[Auth] updateFromSession', {\r\n        source,\r\n        hasSession: !!newSession,\r\n        userId: newSession?.user?.id,\r\n      });\r\n    }\r\n\r\n    setSession(newSession);\r\n    setUser(newSession?.user ?? null);\r\n    setAuthRevision((r) => r + 1);\r\n    setAuthReady(true);\r\n  }, []);\r\n\r\n  // ensureSession simplifi├® - juste r├®cup├®rer la session actuelle\r\n  const ensureSession = useCallback(async (reason: string = 'unknown'): Promise<Session | null> => {\r\n    if (DEBUG_AUTH) {\r\n      console.log('[Auth] ensureSession', { reason });\r\n    }\r\n\r\n    try {\r\n      const { data: { session: currentSession } } = await supabase.auth.getSession();\r\n      \r\n      if (DEBUG_AUTH) {\r\n        console.log('[Auth] ensureSession:result', {\r\n          reason,\r\n          hasSession: !!currentSession,\r\n          expiresAt: currentSession?.expires_at,\r\n        });\r\n      }\r\n\r\n      return currentSession;\r\n    } catch (e) {\r\n      if (DEBUG_AUTH) {\r\n        console.warn('[Auth] ensureSession:error', { reason, message: (e as Error)?.message });\r\n      }\r\n      return null;\r\n    }\r\n  }, []);\r\n\r\n  // Initialisation et ├®coute des changements d'├®tat\r\n  useEffect(() => {\r\n    let mounted = true;\r\n\r\n    // R├®cup├®rer la session initiale\r\n    const initSession = async () => {\r\n      try {\r\n        const { data: { session: initialSession } } = await supabase.auth.getSession();\r\n        if (mounted) {\r\n          updateFromSession(initialSession, 'init');\r\n        }\r\n      } catch (e) {\r\n        if (DEBUG_AUTH) {\r\n          console.warn('[Auth] init:error', { message: (e as Error)?.message });\r\n        }\r\n        if (mounted) {\r\n          setAuthReady(true);\r\n        }\r\n      }\r\n    };\r\n\r\n    initSession();\r\n\r\n    // ├ëcouter les changements d'authentification\r\n    // Supabase appelle ce callback automatiquement lors de :\r\n    // - Connexion/d├®connexion\r\n    // - Refresh du token (automatique gr├óce ├á autoRefreshToken: true)\r\n    // - Changement de session\r\n    const { data: { subscription } } = supabase.auth.onAuthStateChange((event, newSession) => {\r\n      if (!mounted) return;\r\n\r\n      if (DEBUG_AUTH) {\r\n        console.log('[Auth] onAuthStateChange', {\r\n          event,\r\n          hasSession: !!newSession,\r\n          userId: newSession?.user?.id,\r\n        });\r\n      }\r\n\r\n      updateFromSession(newSession, `onAuthStateChange:${event}`);\r\n    });\r\n\r\n    return () => {\r\n      mounted = false;\r\n      subscription.unsubscribe();\r\n    };\r\n  }, [updateFromSession]);\r\n\r\n  const role = useMemo(() => computeRole(user), [user]);\r\n  const isAdmin = role === 'admin';\r\n\r\n  const value = useMemo<AuthState>(() => ({\r\n    authReady,\r\n    session,\r\n    user,\r\n    role,\r\n    isAdmin,\r\n    authRevision,\r\n    appAwakeRevision,\r\n    ensureSession,\r\n  }), [authReady, session, user, role, isAdmin, authRevision, appAwakeRevision, ensureSession]);\r\n\r\n  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;\r\n}\r\n\r\nexport function useAuth(): AuthState {\r\n  const ctx = useContext(AuthContext);\r\n  if (!ctx) {\r\n    throw new Error('useAuth must be used within an AuthProvider');\r\n  }\r\n  return ctx;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\auth\\PrivateRoute.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\auth\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\auth\\useUserRole.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\components\\ExportMenu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\components\\IssueReportButton.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\components\\ModeToggle.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\components\\ThemeCustomizer.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'theme' is assigned a value but never used.","line":17,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":17,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"theme"},"fix":{"range":[721,727],"text":""},"desc":"Remove unused variable 'theme'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Composant de personnalisation du th├¿me\r\n * Permet aux utilisateurs de modifier les couleurs de l'interface\r\n */\r\n\r\nimport React, { useState } from 'react';\r\nimport { useTheme } from '../hooks/useTheme';\r\n\r\nconst DEFAULT_COLOR_PRESETS = [\r\n  { name: 'Vert For├¬t', colors: { primary: '#2d5a3d', primaryHover: '#1f3d2a', secondary: '#e8c547' } },\r\n  { name: 'Bleu Oc├®an', colors: { primary: '#2563eb', primaryHover: '#1d4ed8', secondary: '#f59e0b' } },\r\n  { name: 'Gris Moderne', colors: { primary: '#374151', primaryHover: '#1f2937', secondary: '#10b981' } },\r\n  { name: 'Rouge Passion', colors: { primary: '#dc2626', primaryHover: '#b91c1c', secondary: '#fbbf24' } }\r\n];\r\n\r\nfunction ThemeCustomizer() {\r\n  const { theme, colors, saveTheme, resetToDefault, isCustom, loading } = useTheme();\r\n  const [isEditing, setIsEditing] = useState(false);\r\n  const [tempColors, setTempColors] = useState(colors);\r\n  const [saving, setSaving] = useState(false);\r\n\r\n  const handleColorChange = (colorKey, value) => {\r\n    setTempColors(prev => ({ ...prev, [colorKey]: value }));\r\n  };\r\n\r\n  const handleSave = async () => {\r\n    setSaving(true);\r\n    const result = await saveTheme(tempColors);\r\n    setSaving(false);\r\n    \r\n    if (result.success) {\r\n      setIsEditing(false);\r\n    } else {\r\n      alert('Erreur lors de la sauvegarde: ' + result.error);\r\n    }\r\n  };\r\n\r\n  const handleReset = async () => {\r\n    if (confirm('R├®initialiser au th├¿me par d├®faut ?')) {\r\n      const result = await resetToDefault();\r\n      if (!result.success) {\r\n        alert('Erreur lors de la r├®initialisation: ' + result.error);\r\n      }\r\n    }\r\n  };\r\n\r\n  const applyPreset = (preset) => {\r\n    setTempColors(prev => ({ ...prev, ...preset.colors }));\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"theme-customizer-loading\">\r\n        <div>Chargement du th├¿me...</div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"theme-customizer\">\r\n      <div className=\"theme-customizer-header\">\r\n        <h3>Personnalisation du th├¿me</h3>\r\n        <div className=\"theme-status\">\r\n          {isCustom ? (\r\n            <span className=\"theme-badge theme-custom\">Ô£¿ Personnalis├®</span>\r\n          ) : (\r\n            <span className=\"theme-badge theme-default\">­ƒÄ¿ Par d├®faut</span>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {!isEditing ? (\r\n        <div className=\"theme-preview\">\r\n          <div className=\"color-grid\">\r\n            {Object.entries(colors).map(([key, value]) => (\r\n              <div key={key} className=\"color-item\">\r\n                <div \r\n                  className=\"color-swatch\" \r\n                  style={{ backgroundColor: value }}\r\n                />\r\n                <div className=\"color-info\">\r\n                  <div className=\"color-name\">{key}</div>\r\n                  <div className=\"color-value\">{value}</div>\r\n                </div>\r\n              </div>\r\n            ))}\r\n          </div>\r\n          \r\n          <div className=\"theme-actions\">\r\n            <button \r\n              className=\"btn btn-primary\"\r\n              onClick={() => setIsEditing(true)}\r\n            >\r\n              Ô£Å´©Å Modifier\r\n            </button>\r\n            {isCustom && (\r\n              <button \r\n                className=\"btn btn-secondary\"\r\n                onClick={handleReset}\r\n              >\r\n                ­ƒöä R├®initialiser\r\n              </button>\r\n            )}\r\n          </div>\r\n        </div>\r\n      ) : (\r\n        <div className=\"theme-editor\">\r\n          <div className=\"presets-section\">\r\n            <h4>Pr├®r├®glages rapides</h4>\r\n            <div className=\"presets-grid\">\r\n              {DEFAULT_COLOR_PRESETS.map((preset) => (\r\n                <button\r\n                  key={preset.name}\r\n                  className=\"preset-btn\"\r\n                  onClick={() => applyPreset(preset)}\r\n                >\r\n                  <div className=\"preset-preview\">\r\n                    <div style={{ backgroundColor: preset.colors.primary }} />\r\n                    <div style={{ backgroundColor: preset.colors.secondary }} />\r\n                  </div>\r\n                  {preset.name}\r\n                </button>\r\n              ))}\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"colors-section\">\r\n            <h4>Couleurs personnalis├®es</h4>\r\n            <div className=\"color-inputs-grid\">\r\n              {Object.entries(tempColors).map(([key, value]) => (\r\n                <div key={key} className=\"color-input\">\r\n                  <label>{key}</label>\r\n                  <div className=\"color-input-wrapper\">\r\n                    <input\r\n                      type=\"color\"\r\n                      value={value}\r\n                      onChange={(e) => handleColorChange(key, e.target.value)}\r\n                    />\r\n                    <input\r\n                      type=\"text\"\r\n                      value={value}\r\n                      onChange={(e) => handleColorChange(key, e.target.value)}\r\n                      placeholder=\"#000000\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"editor-actions\">\r\n            <button \r\n              className=\"btn btn-secondary\"\r\n              onClick={() => {\r\n                setIsEditing(false);\r\n                setTempColors(colors);\r\n              }}\r\n            >\r\n              Annuler\r\n            </button>\r\n            <button \r\n              className=\"btn btn-primary\"\r\n              onClick={handleSave}\r\n              disabled={saving}\r\n            >\r\n              {saving ? 'Sauvegarde...' : '­ƒÆ¥ Sauvegarder'}\r\n            </button>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default ThemeCustomizer;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\components\\TimelineBar.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\components\\TopBar.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'onExport' is defined but never used. Allowed unused args must match /^_/u.","line":34,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":34,"endColumn":11,"suggestions":[{"messageId":"removeVar","data":{"varName":"onExport"},"fix":{"range":[814,828],"text":""},"desc":"Remove unused variable 'onExport'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * TopBar harmonis├®e - Inspir├®e de la page IR\r\n * Boutons : Retour accueil, Sauvegarder, Charger, R├®initialiser, Exporter, Param├¿tres, D├®connexion\r\n */\r\n\r\nimport React, { useState, useRef } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { supabase } from '../supabaseClient';\r\nimport { useAuth } from '../auth';\r\n\r\ninterface TopBarProps {\r\n  title?: string;\r\n  onSave?: () => void;\r\n  onLoad?: () => void;\r\n  onReset?: () => void;\r\n  onExport?: () => void;\r\n  exportOptions?: Array<{\r\n    label: string;\r\n    onClick: () => void | Promise<void>;\r\n  }>;\r\n  showSave?: boolean;\r\n  showLoad?: boolean;\r\n  showReset?: boolean;\r\n  showExport?: boolean;\r\n  showSettings?: boolean;\r\n  showLogout?: boolean;\r\n}\r\n\r\nexport default function TopBar({ \r\n  title, \r\n  onSave, \r\n  onLoad, \r\n  onReset, \r\n  onExport, \r\n  exportOptions = [],\r\n  showSave = true,\r\n  showLoad = true,\r\n  showReset = true,\r\n  showExport = true,\r\n  showSettings = true,\r\n  showLogout = true\r\n}: TopBarProps) {\r\n  const navigate = useNavigate();\r\n  const { user, isAdmin } = useAuth();\r\n  const [exportOpen, setExportOpen] = useState(false);\r\n  const exportRef = useRef<HTMLDivElement>(null);\r\n\r\n  // Fermeture menu export au clic ext├®rieur\r\n  React.useEffect(() => {\r\n    const handler = (e: MouseEvent) => {\r\n      if (!exportRef.current) return;\r\n      if (!exportRef.current.contains(e.target as Node)) setExportOpen(false);\r\n    };\r\n    document.addEventListener('click', handler);\r\n    return () => document.removeEventListener('click', handler);\r\n  }, []);\r\n\r\n  const handleLogout = async () => {\r\n    try {\r\n      // D├®connexion Supabase\r\n      await supabase.auth.signOut();\r\n    } catch (error) {\r\n      console.error('Erreur lors de la d├®connexion:', error);\r\n    } finally {\r\n      // Forcer la redirection dans tous les cas\r\n      navigate('/login');\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"topbar\">\r\n      <div className=\"topbar-left\">\r\n        <button \r\n          className=\"chip\" \r\n          onClick={() => navigate('/')}\r\n          title=\"Retour ├á l'accueil\"\r\n        >\r\n          ­ƒÅá Accueil\r\n        </button>\r\n        \r\n        <div className=\"topbar-title\">{title}</div>\r\n      </div>\r\n\r\n      <div className=\"topbar-right\">\r\n        {showSave && onSave && (\r\n          <button \r\n            className=\"chip\" \r\n            onClick={onSave}\r\n            title=\"Sauvegarder le dossier\"\r\n          >\r\n            ­ƒÆ¥ Sauvegarder\r\n          </button>\r\n        )}\r\n\r\n        {showLoad && onLoad && (\r\n          <button \r\n            className=\"chip\" \r\n            onClick={onLoad}\r\n            title=\"Charger un dossier\"\r\n          >\r\n            ­ƒôé Charger\r\n          </button>\r\n        )}\r\n\r\n        {showReset && onReset && (\r\n          <button \r\n            className=\"chip\" \r\n            onClick={onReset}\r\n            title=\"R├®initialiser la simulation\"\r\n          >\r\n            ­ƒöä R├®initialiser\r\n          </button>\r\n        )}\r\n\r\n        {showExport && exportOptions.length > 0 && (\r\n          <div ref={exportRef} style={{ position: 'relative' }}>\r\n            <button\r\n              type=\"button\"\r\n              className=\"chip\"\r\n              aria-haspopup=\"menu\"\r\n              aria-expanded={exportOpen ? 'true' : 'false'}\r\n              onClick={() => setExportOpen((v) => !v)}\r\n              title=\"Exporter\"\r\n            >\r\n              ­ƒôè Exporter Ôû¥\r\n            </button>\r\n\r\n            {exportOpen && (\r\n              <div role=\"menu\" className=\"topbar-export-menu\">\r\n                {exportOptions.map((option, idx) => (\r\n                  <button\r\n                    key={idx}\r\n                    type=\"button\"\r\n                    role=\"menuitem\"\r\n                    className=\"chip\"\r\n                    onClick={() => {\r\n                      setExportOpen(false);\r\n                      option.onClick();\r\n                    }}\r\n                  >\r\n                    {option.label}\r\n                  </button>\r\n                ))}\r\n              </div>\r\n            )}\r\n          </div>\r\n        )}\r\n\r\n        {showSettings && isAdmin && (\r\n          <button \r\n            className=\"chip\" \r\n            onClick={() => navigate('/settings')}\r\n            title=\"Param├¿tres\"\r\n          >\r\n            ÔÜÖ´©Å Param├¿tres\r\n          </button>\r\n        )}\r\n\r\n        {showLogout && user && (\r\n          <button \r\n            className=\"chip\" \r\n            onClick={handleLogout}\r\n            title=\"Se d├®connecter\"\r\n          >\r\n            ­ƒÜ¬ D├®connexion\r\n          </button>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\components\\UserInfoBanner.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\components\\__tests__\\themes-and-auth.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\components\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\components\\ui\\BusinessIcon.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\engine\\__tests__\\assurance.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\engine\\__tests__\\smoke.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\engine\\__tests__\\succession.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\engine\\__tests__\\tax.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\engine\\__tests__\\transmission.spec.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\engine\\civil.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\engine\\credit\\__tests__\\capitalDeces.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\engine\\credit\\capitalDeces.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\engine\\helpers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\engine\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\engine\\placementEngine.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'calculDMTG' is defined but never used.","line":87,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":87,"endColumn":20,"suggestions":[{"messageId":"removeVar","data":{"varName":"calculDMTG"},"fix":{"range":[2525,3296],"text":""},"desc":"Remove unused variable 'calculDMTG'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'anneeDepuisDernierInvestissement' is assigned a value but never used.","line":342,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":342,"endColumn":37},{"ruleId":"no-unused-vars","severity":1,"message":"'perBancaire' is assigned a value but never used.","line":779,"column":65,"nodeType":"Identifier","messageId":"unusedVar","endLine":779,"endColumn":76,"suggestions":[{"messageId":"removeVar","data":{"varName":"perBancaire"},"fix":{"range":[27616,27629],"text":""},"desc":"Remove unused variable 'perBancaire'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'fraisGestion' is assigned a value but never used.","line":780,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":780,"endColumn":17,"suggestions":[{"messageId":"removeVar","data":{"varName":"fraisGestion"},"fix":{"range":[27643,27667],"text":""},"desc":"Remove unused variable 'fraisGestion'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * placementEngine.js - Moteur de calcul pour le simulateur de placement\r\n * \r\n * Architecture settings-driven : tous les param├¿tres fiscaux proviennent\r\n * des settings Supabase (/settings/fiscalites, /settings/prelevements, /settings/impots)\r\n * \r\n * Phases : ├ëpargne ÔåÆ Liquidation ÔåÆ D├®c├¿s/Transmission\r\n */\r\n\r\n// ============================================================================\r\n// TYPES & CONSTANTES\r\n// ============================================================================\r\n\r\nimport { DEFAULT_VERSEMENT_CONFIG, normalizeVersementConfig } from '../utils/versementConfig.js';\r\n\r\nexport const ENVELOPES = {\r\n  AV: 'AV',\r\n  PER: 'PER',\r\n  PEA: 'PEA',\r\n  CTO: 'CTO',\r\n  SCPI: 'SCPI',\r\n};\r\n\r\nexport const ENVELOPE_LABELS = {\r\n  AV: 'Assurance-vie',\r\n  PER: 'PER individuel d├®ductible',\r\n  PEA: 'PEA',\r\n  CTO: 'Compte-titres',\r\n  SCPI: 'SCPI',\r\n};\r\n\r\n// Valeurs par d├®faut si les settings ne sont pas charg├®s\r\nconst DEFAULT_FISCAL_PARAMS = {\r\n  pfuIR: 0.128,\r\n  pfuPS: 0.172,\r\n  pfuTotal: 0.30,\r\n  psPatrimoine: 0.172,\r\n  avAbattement8ansSingle: 4600,\r\n  avAbattement8ansCouple: 9200,\r\n  avSeuilPrimes150k: 150000,\r\n  avTauxSousSeuil8ans: 0.075,\r\n  avTauxSurSeuil8ans: 0.128,\r\n  av990IAbattement: 152500,\r\n  av990ITranche1Taux: 0.20,\r\n  av990ITranche1Plafond: 700000,\r\n  av990ITranche2Taux: 0.3125,\r\n  av757BAbattement: 30500,\r\n  peaAncienneteMin: 5,\r\n  dividendesAbattementPercent: 0.40,\r\n};\r\n\r\nconst REQUIRED_NUMERIC_FISCAL_KEYS = [\r\n  'pfuIR',\r\n  'pfuPS',\r\n  'pfuTotal',\r\n  'psPatrimoine',\r\n  'avAbattement8ansSingle',\r\n  'avAbattement8ansCouple',\r\n  'avSeuilPrimes150k',\r\n  'avTauxSousSeuil8ans',\r\n  'avTauxSurSeuil8ans',\r\n  'av990IAbattement',\r\n  'av990ITranche1Taux',\r\n  'av990ITranche1Plafond',\r\n  'av990ITranche2Taux',\r\n  'av757BAbattement',\r\n  'peaAncienneteMin',\r\n  'dividendesAbattementPercent',\r\n];\r\n\r\nlet hasWarnedMissingFiscalParams = false;\r\n\r\n// ============================================================================\r\n// HELPERS\r\n// ============================================================================\r\n\r\nconst clamp = (n, min, max) => Math.min(max, Math.max(min, n));\r\nconst round2 = (n) => Math.round(n * 100) / 100;\r\n\r\n/**\r\n * Calcule les DMTG (droits de mutation ├á titre gratuit) avec bar├¿me progressif\r\n * @param {number} assiette - Assiette taxable apr├¿s abattement (par b├®n├®ficiaire)\r\n * @param {number} nbBeneficiaires - Nombre de b├®n├®ficiaires\r\n * @param {Array} dmtgScale - Bar├¿me progressif depuis les settings\r\n * @returns {number} Montant total des DMTG\r\n */\r\nfunction calculDMTG(assiette, nbBeneficiaires, dmtgScale) {\r\n  // Si pas de bar├¿me, utiliser un taux moyen de 20%\r\n  if (!dmtgScale || !Array.isArray(dmtgScale) || dmtgScale.length === 0) {\r\n    return assiette * 0.20;\r\n  }\r\n\r\n  // Assiette par b├®n├®ficiaire\r\n  const assietteParBenef = assiette / nbBeneficiaires;\r\n  let taxeParBenef = 0;\r\n\r\n  // Calcul progressif par tranche\r\n  for (const tranche of dmtgScale) {\r\n    const from = tranche.from || 0;\r\n    const to = tranche.to || Infinity;\r\n    const rate = (tranche.rate || 0) / 100;\r\n\r\n    if (assietteParBenef > from) {\r\n      const taxable = Math.min(assietteParBenef, to) - from;\r\n      if (taxable > 0) {\r\n        taxeParBenef += taxable * rate;\r\n      }\r\n    }\r\n  }\r\n\r\n  return taxeParBenef * nbBeneficiaires;\r\n}\r\n\r\n/**\r\n * Extrait les param├¿tres fiscaux depuis les settings Supabase\r\n * @param {Object} fiscalitySettings - Settings de /settings/fiscalites\r\n * @param {Object} psSettings - Settings de /settings/prelevements\r\n * @returns {Object} Param├¿tres normalis├®s\r\n */\r\nexport function extractFiscalParams(fiscalitySettings, psSettings) {\r\n  const params = { ...DEFAULT_FISCAL_PARAMS };\r\n\r\n  // PS patrimoine\r\n  if (psSettings?.patrimony?.current?.totalRate) {\r\n    params.psPatrimoine = psSettings.patrimony.current.totalRate / 100;\r\n    params.pfuPS = params.psPatrimoine;\r\n    params.pfuTotal = params.pfuIR + params.pfuPS;\r\n  }\r\n\r\n  // Assurance-vie\r\n  const av = fiscalitySettings?.assuranceVie;\r\n  if (av) {\r\n    // Retraits capital\r\n    const rc = av.retraitsCapital;\r\n    if (rc) {\r\n      if (rc.psRatePercent) params.psPatrimoine = rc.psRatePercent / 100;\r\n      \r\n      const d2017 = rc.depuis2017;\r\n      if (d2017) {\r\n        if (d2017.moins8Ans?.irRatePercent) {\r\n          params.pfuIR = d2017.moins8Ans.irRatePercent / 100;\r\n        }\r\n        if (d2017.plus8Ans) {\r\n          const p8 = d2017.plus8Ans;\r\n          if (p8.abattementAnnuel?.single) params.avAbattement8ansSingle = p8.abattementAnnuel.single;\r\n          if (p8.abattementAnnuel?.couple) params.avAbattement8ansCouple = p8.abattementAnnuel.couple;\r\n          if (p8.primesNettesSeuil) params.avSeuilPrimes150k = p8.primesNettesSeuil;\r\n          if (p8.irRateUnderThresholdPercent) params.avTauxSousSeuil8ans = p8.irRateUnderThresholdPercent / 100;\r\n          if (p8.irRateOverThresholdPercent) params.avTauxSurSeuil8ans = p8.irRateOverThresholdPercent / 100;\r\n        }\r\n      }\r\n    }\r\n\r\n    // D├®c├¿s\r\n    const deces = av.deces;\r\n    if (deces?.primesApres1998) {\r\n      if (deces.primesApres1998.allowancePerBeneficiary) {\r\n        params.av990IAbattement = deces.primesApres1998.allowancePerBeneficiary;\r\n      }\r\n      if (deces.primesApres1998.brackets?.[0]) {\r\n        params.av990ITranche1Taux = deces.primesApres1998.brackets[0].ratePercent / 100;\r\n        if (deces.primesApres1998.brackets[0].upTo) {\r\n          params.av990ITranche1Plafond = deces.primesApres1998.brackets[0].upTo - params.av990IAbattement;\r\n        }\r\n      }\r\n      if (deces.primesApres1998.brackets?.[1]) {\r\n        params.av990ITranche2Taux = deces.primesApres1998.brackets[1].ratePercent / 100;\r\n      }\r\n    }\r\n    if (deces?.apres70ans?.globalAllowance) {\r\n      params.av757BAbattement = deces.apres70ans.globalAllowance;\r\n    }\r\n  }\r\n\r\n  // PER individuel\r\n  const per = fiscalitySettings?.perIndividuel;\r\n  if (per?.sortieCapital?.pfu) {\r\n    if (per.sortieCapital.pfu.irRatePercent) {\r\n      params.pfuIR = per.sortieCapital.pfu.irRatePercent / 100;\r\n    }\r\n    if (per.sortieCapital.pfu.psRatePercent) {\r\n      params.pfuPS = per.sortieCapital.pfu.psRatePercent / 100;\r\n    }\r\n    params.pfuTotal = params.pfuIR + params.pfuPS;\r\n  }\r\n\r\n  // Dividendes (CTO au bar├¿me)\r\n  const dividendes = fiscalitySettings?.dividendes;\r\n  if (dividendes?.abattementBaremePercent != null) {\r\n    params.dividendesAbattementPercent = clamp(dividendes.abattementBaremePercent / 100, 0, 1);\r\n  }\r\n\r\n  // V├®rifications finales et warnings centralis├®s\r\n  const missingKeys = [];\r\n  for (const key of REQUIRED_NUMERIC_FISCAL_KEYS) {\r\n    const value = params[key];\r\n    if (typeof value !== 'number' || Number.isNaN(value)) {\r\n      params[key] = DEFAULT_FISCAL_PARAMS[key];\r\n      missingKeys.push(key);\r\n    }\r\n  }\r\n\r\n  if (typeof params.pfuPS !== 'number' || Number.isNaN(params.pfuPS)) {\r\n    params.pfuPS = params.psPatrimoine;\r\n  }\r\n  if (typeof params.pfuTotal !== 'number' || Number.isNaN(params.pfuTotal)) {\r\n    params.pfuTotal = (params.pfuIR ?? 0) + (params.pfuPS ?? params.psPatrimoine ?? 0);\r\n  }\r\n\r\n  if (missingKeys.length && !hasWarnedMissingFiscalParams) {\r\n    console.warn(\r\n      '[Placement] Param├¿tres fiscaux incomplets, fallback appliqu├® pour :',\r\n      missingKeys.join(', ')\r\n    );\r\n    hasWarnedMissingFiscalParams = true;\r\n  }\r\n\r\n  return params;\r\n}\r\n\r\n// ============================================================================\r\n// PHASE 1 : ├ëPARGNE\r\n// ============================================================================\r\n\r\n/**\r\n * Simule la phase d'├®pargne pour un produit\r\n * @param {Object} product - Configuration du produit\r\n * @param {Object} client - Donn├®es client (TMI, ├óges, etc.)\r\n * @param {Object} fiscalParams - Param├¿tres fiscaux extraits\r\n * @param {Object} options - Options de simulation\r\n * @returns {Object} R├®sultats de la phase ├®pargne\r\n */\r\nexport function simulateEpargne(product, client, fiscalParams, options = {}) {\r\n  const {\r\n    envelope,\r\n    dureeEpargne = 20,\r\n    perBancaire = false,\r\n    fraisGestion = 0,\r\n    optionBaremeIR = false,\r\n  } = product;\r\n\r\n  const versementConfig = normalizeVersementConfig(product.versementConfig || DEFAULT_VERSEMENT_CONFIG);\r\n  const { initial, annuel, ponctuels = [], capitalisation, distribution } = versementConfig;\r\n\r\n  const { tmiEpargne = 0.30, ageActuel = 45 } = client;\r\n  const fp = fiscalParams;\r\n\r\n  const isSCPI = envelope === ENVELOPES.SCPI;\r\n\r\n  const pct = (value) => Math.max(0, Math.min(100, value ?? 0)) / 100;\r\n\r\n  const sanitizeSplit = (pctCapi, pctDistrib) => {\r\n    let capi = pctCapi;\r\n    let distrib = pctDistrib;\r\n    if (isSCPI) {\r\n      capi = 0;\r\n      distrib = 1;\r\n    } else {\r\n      const total = capi + distrib;\r\n      if (total === 0) {\r\n        capi = 1;\r\n        distrib = 0;\r\n      } else {\r\n        capi = capi / total;\r\n        distrib = distrib / total;\r\n      }\r\n    }\r\n    return { capi, distrib };\r\n  };\r\n\r\n  const initialSplitRatio = sanitizeSplit(pct(initial.pctCapitalisation), pct(initial.pctDistribution));\r\n  const annualSplitRatio = sanitizeSplit(pct(annuel.pctCapitalisation), pct(annuel.pctDistribution));\r\n\r\n  const splitAmount = (amount, splitRatio) => ({\r\n    capi: amount * splitRatio.capi,\r\n    distrib: amount * splitRatio.distrib,\r\n  });\r\n\r\n  const ponctuelsByYear = ponctuels.reduce((acc, p) => {\r\n    const key = Math.max(1, Math.min(dureeEpargne, p.annee || 1));\r\n    if (!acc[key]) acc[key] = [];\r\n    acc[key].push(p);\r\n    return acc;\r\n  }, {});\r\n\r\n  const capitalisationRate = capitalisation.rendementAnnuel ?? product.rendement ?? 0.03;\r\n  const distributionYield = distribution.tauxDistribution ?? 0;\r\n  const distributionRevalo = distribution.rendementAnnuel ?? product.tauxRevalorisation ?? 0.02;\r\n  const distributionStrategyRaw = distribution.strategie || 'stocker';\r\n  const distributionStrategy = isSCPI && distributionStrategyRaw === 'stocker'\r\n    ? 'apprehender'\r\n    : distributionStrategyRaw;\r\n  const delaiJouissance = distribution.delaiJouissance ?? product.delaiJouissance ?? 0;\r\n  const coeffDelaiJouissance = delaiJouissance > 0 ? (12 - delaiJouissance) / 12 : 1;\r\n\r\n  const dureeProduit = distribution.dureeProduit ?? product.dureeProduit ?? null;\r\n\r\n  const rows = [];\r\n  let capitalCapi = 0;\r\n  let capitalDistrib = 0;\r\n  let compteEspece = 0;\r\n  let pendingReinvestCapi = 0; // coupon net de N, r├®investi en N+1\r\n  let pendingReinvestDistrib = 0; // loyer/dividende net de N, r├®investi en N+1 dans la poche distribution (SCPI)\r\n  let cumulVersements = 0;\r\n  let cumulVersementsNets = 0;\r\n  let cumulInterets = 0;\r\n  let cumulGains = 0;\r\n  let cumulEffort = 0;\r\n  let cumulEconomieIR = 0;\r\n  let cumulPSFondsEuro = 0;\r\n  let cumulRevenusDistribues = 0;\r\n  let cumulFiscaliteRevenus = 0;\r\n  let cumulRevenusNetsPercus = 0;\r\n  let cumulCompteEspece = 0;\r\n  let plusValueLatenteCTO = 0;\r\n  let anneeDepuisDernierInvestissement = 0;\r\n  let anneeDepuisDernierCycleDistrib = 0;\r\n\r\n  const initialAmount = initial.montant ?? product.versementInitial ?? 0;\r\n  const initialFrais = initial.fraisEntree ?? product.fraisEntree ?? 0;\r\n  const initialNet = initialAmount * (1 - initialFrais);\r\n  const splitInitial = splitAmount(initialNet, initialSplitRatio);\r\n  capitalCapi += splitInitial.capi;\r\n  capitalDistrib += splitInitial.distrib;\r\n  if (isSCPI) {\r\n    // Invariant : SCPI = 100% distribution\r\n    capitalCapi = 0;\r\n  }\r\n  cumulVersements += initialAmount;\r\n  cumulVersementsNets += initialNet;\r\n\r\n  if (envelope === ENVELOPES.PER && initialAmount > 0) {\r\n    const eco = initialAmount * tmiEpargne;\r\n    cumulEconomieIR += eco;\r\n    cumulEffort += initialAmount - eco;\r\n  } else {\r\n    cumulEffort += initialAmount;\r\n  }\r\n\r\n  for (let annee = 1; annee <= dureeEpargne; annee++) {\r\n    const age = ageActuel + annee - 1;\r\n    anneeDepuisDernierInvestissement++;\r\n\r\n    // R├®investissement en capitalisation (coupon net de N-1)\r\n    let reinvestCapiN = pendingReinvestCapi;\r\n    let reinvestDistribN = pendingReinvestDistrib;\r\n    if (isSCPI) {\r\n      // SCPI : aucun flux ne doit alimenter la capitalisation\r\n      reinvestCapiN = 0;\r\n      pendingReinvestCapi = 0;\r\n    }\r\n    if (reinvestCapiN > 0) {\r\n      // Le r├®investissement provient d'un cash (compte esp├¿ce) accumul├® en N-1\r\n      const deducted = Math.min(compteEspece, reinvestCapiN);\r\n      compteEspece -= deducted;\r\n      capitalCapi += reinvestCapiN;\r\n      pendingReinvestCapi = 0;\r\n    }\r\n    if (reinvestDistribN > 0) {\r\n      const deducted = Math.min(compteEspece, reinvestDistribN);\r\n      compteEspece -= deducted;\r\n      capitalDistrib += reinvestDistribN;\r\n      pendingReinvestDistrib = 0;\r\n    }\r\n\r\n    const reinvestissementN = isSCPI ? reinvestDistribN : reinvestCapiN;\r\n\r\n    const capitalCapiDebut = capitalCapi;\r\n    const capitalDistribDebut = capitalDistrib;\r\n    const compteEspeceDebut = compteEspece;\r\n\r\n    let versementBrut = annuel.montant ?? product.versementAnnuel ?? 0;\r\n    const fraisAnnuel = annuel.fraisEntree ?? initialFrais;\r\n    let versementNet = 0;\r\n    let addedCapi = 0;\r\n    let addedDistrib = 0;\r\n\r\n    // Calculs li├®s ├á la garantie de bonne fin (PER)\r\n    let capitalDecesTheorique = 0;\r\n    let capitalDecesDegressif = 0;\r\n    if (envelope === ENVELOPES.PER && annuel.garantieBonneFin?.active) {\r\n      const versementAnnuelPlan = annuel.montant ?? product.versementAnnuel ?? 0;\r\n      const remainingYears = Math.max(0, dureeEpargne - annee);\r\n      if (versementAnnuelPlan > 0) {\r\n        capitalDecesDegressif = versementAnnuelPlan * remainingYears;\r\n      }\r\n      if (versementBrut > 0) {\r\n        const remainingYearsTheorique = dureeEpargne - annee + 1;\r\n        capitalDecesTheorique = versementBrut * Math.max(0, remainingYearsTheorique);\r\n      }\r\n    }\r\n\r\n    if (versementBrut > 0) {\r\n      const net = versementBrut * (1 - fraisAnnuel);\r\n      versementNet += net;\r\n      const split = splitAmount(net, annualSplitRatio);\r\n      capitalCapi += split.capi;\r\n      capitalDistrib += split.distrib;\r\n      addedCapi += split.capi;\r\n      addedDistrib += split.distrib;\r\n    }\r\n\r\n    const ponctuelsList = ponctuelsByYear[annee] || [];\r\n    for (const p of ponctuelsList) {\r\n      const montant = p.montant ?? 0;\r\n      const frais = p.fraisEntree ?? fraisAnnuel ?? 0;\r\n      const net = montant * (1 - frais);\r\n      versementBrut += montant;\r\n      versementNet += net;\r\n      const splitRatio = sanitizeSplit(pct(p.pctCapitalisation), pct(p.pctDistribution));\r\n      const split = splitAmount(net, splitRatio);\r\n      capitalCapi += split.capi;\r\n      capitalDistrib += split.distrib;\r\n      addedCapi += split.capi;\r\n      addedDistrib += split.distrib;\r\n    }\r\n\r\n    cumulVersements += versementBrut;\r\n    cumulVersementsNets += versementNet;\r\n\r\n    let economieIRAnnee = 0;\r\n    if (envelope === ENVELOPES.PER && versementBrut > 0) {\r\n      economieIRAnnee = versementBrut * tmiEpargne;\r\n      cumulEconomieIR += economieIRAnnee;\r\n      cumulEffort += versementBrut - economieIRAnnee;\r\n    } else {\r\n      cumulEffort += versementBrut;\r\n    }\r\n\r\n    // Capitalisation : revalorisation annuelle (pas de d├®lai de jouissance)\r\n    const capiBase = capitalCapiDebut + addedCapi;\r\n    const gainsCapi = capiBase * capitalisationRate;\r\n    capitalCapi += gainsCapi;\r\n    cumulInterets += gainsCapi;\r\n\r\n    // ------------------------------\r\n    // Distribution :\r\n    // A) Revalorisation du capital investi (taux distributionRevalo)\r\n    // B) Coupon annuel (distributionYield) sur base investie\r\n    // ------------------------------\r\n    const distribInvested = capitalDistribDebut + addedDistrib;\r\n    const revaloDistrib = distribInvested * distributionRevalo;\r\n    capitalDistrib += revaloDistrib;\r\n\r\n    // Base coupon : d├®lai de jouissance appliqu├® uniquement au coupon\r\n    const couponBase = (annee === 1 ? capitalDistribDebut * coeffDelaiJouissance : capitalDistribDebut) + (addedDistrib * coeffDelaiJouissance);\r\n    const couponBrut = couponBase * distributionYield;\r\n\r\n    // Fiscalit├® du coupon (enveloppe d├®pendante)\r\n    let fiscaliteCoupon = 0;\r\n    if (couponBrut > 0) {\r\n      if (envelope === ENVELOPES.SCPI) {\r\n        const ir = couponBrut * tmiEpargne;\r\n        const ps = couponBrut * fp.psPatrimoine;\r\n        fiscaliteCoupon = ir + ps;\r\n      } else if (envelope === ENVELOPES.CTO) {\r\n        if (optionBaremeIR) {\r\n          const base = couponBrut * (1 - fp.dividendesAbattementPercent);\r\n          const ir = base * tmiEpargne;\r\n          const ps = couponBrut * fp.psPatrimoine;\r\n          fiscaliteCoupon = ir + ps;\r\n        } else {\r\n          fiscaliteCoupon = couponBrut * fp.pfuTotal;\r\n        }\r\n      } else {\r\n        // PEA / AV / PER : pas de fiscalit├® sur le coupon en phase ├®pargne dans l'enveloppe\r\n        fiscaliteCoupon = 0;\r\n      }\r\n    }\r\n    const couponNet = couponBrut - fiscaliteCoupon;\r\n\r\n    // Tracking global (debug/synth├¿se)\r\n    cumulRevenusDistribues += couponBrut;\r\n    cumulFiscaliteRevenus += fiscaliteCoupon;\r\n\r\n    let revenusNetsPercusAnnee = 0;\r\n    let reinvestissementDistribNetAnnee = 0;\r\n\r\n    // Strat├®gie sur coupon NET\r\n    if (couponNet > 0) {\r\n      if (distributionStrategy === 'apprehender') {\r\n        revenusNetsPercusAnnee = couponNet;\r\n        cumulRevenusNetsPercus += couponNet;\r\n      } else if (distributionStrategy === 'reinvestir_capi') {\r\n        reinvestissementDistribNetAnnee = couponNet;\r\n        // Les revenus restent dans le patrimoine (cash) puis sont r├®investis en N+1\r\n        compteEspece += couponNet;\r\n        cumulCompteEspece += couponNet;\r\n        // r├®investi en N+1\r\n        if (isSCPI) {\r\n          pendingReinvestDistrib += couponNet;\r\n        } else {\r\n          pendingReinvestCapi += couponNet;\r\n        }\r\n      } else {\r\n        // stocker : compte esp├¿ces ├á 0%\r\n        compteEspece += couponNet;\r\n        cumulCompteEspece += couponNet;\r\n      }\r\n    }\r\n\r\n    let psFondsEuro = 0;\r\n    if (envelope === ENVELOPES.AV && options.fondsEuro) {\r\n      psFondsEuro = gainsCapi * fp.psPatrimoine;\r\n      capitalCapi -= psFondsEuro;\r\n      cumulPSFondsEuro += psFondsEuro;\r\n    }\r\n\r\n    // PV latente CTO (uniquement sur la revalorisation du capital investi)\r\n    if (envelope === ENVELOPES.CTO) {\r\n      plusValueLatenteCTO += revaloDistrib;\r\n    }\r\n\r\n    // Gains ann├®e (r├¿gle simple):\r\n    // - gainsCapi + revaloDistrib\r\n    // - + revenus nets (couponNet) d├¿s lors qu'ils ne sont pas appr├®hend├®s (ils restent dans le patrimoine)\r\n    const couponResteDansPatrimoine = distributionStrategy !== 'apprehender';\r\n    const gainsAnnee = gainsCapi + revaloDistrib + (couponResteDansPatrimoine ? couponNet : 0);\r\n    cumulGains += gainsAnnee;\r\n\r\n    if (isSCPI) {\r\n      // Invariant : SCPI = 100% distribution\r\n      capitalCapi = 0;\r\n    }\r\n\r\n    // Terme du produit en distribution (cycle)\r\n    let cessionProduit = false;\r\n    let fiscalitePV = 0;\r\n    if (dureeProduit && distribInvested > 0) {\r\n      anneeDepuisDernierCycleDistrib += 1;\r\n      if (anneeDepuisDernierCycleDistrib >= dureeProduit) {\r\n        cessionProduit = true;\r\n        const reinvestirVersAuTerme = distribution.reinvestirVersAuTerme || 'capitalisation';\r\n        if (reinvestirVersAuTerme === 'capitalisation') {\r\n          // Basculer vers capitalisation : d├®duire la fiscalit├® sur PV si CTO\r\n          if (envelope === ENVELOPES.CTO && plusValueLatenteCTO > 0) {\r\n            if (optionBaremeIR) {\r\n              fiscalitePV = plusValueLatenteCTO * tmiEpargne + plusValueLatenteCTO * fp.psPatrimoine;\r\n            } else {\r\n              fiscalitePV = plusValueLatenteCTO * fp.pfuTotal;\r\n            }\r\n            cumulFiscaliteRevenus += fiscalitePV;\r\n          }\r\n\r\n          const montantBrut = capitalDistrib + compteEspece;\r\n          const montantNet = Math.max(0, montantBrut - fiscalitePV);\r\n          capitalCapi += montantNet;\r\n          capitalDistrib = 0;\r\n          compteEspece = 0;\r\n          plusValueLatenteCTO = 0;\r\n        } else {\r\n          // Renouveler en distribution : red├®marrer un cycle (sans liquidation)\r\n          // Option : r├®injecter le stock dans la poche distribution ├á l'├®ch├®ance\r\n          if (compteEspece > 0) {\r\n            capitalDistrib += compteEspece;\r\n            compteEspece = 0;\r\n          }\r\n        }\r\n\r\n        anneeDepuisDernierCycleDistrib = 0;\r\n      }\r\n    } else {\r\n      anneeDepuisDernierCycleDistrib = 0;\r\n    }\r\n\r\n    rows.push({\r\n      annee,\r\n      age,\r\n      capitalDebut: round2(capitalCapiDebut + capitalDistribDebut + compteEspeceDebut),\r\n      versementBrut: round2(versementBrut),\r\n      versementNet: round2(versementNet),\r\n      cumulVersementsNets: round2(cumulVersementsNets),\r\n      gains: round2(gainsCapi),\r\n      gainsAnnee: round2(gainsAnnee),\r\n      cumulInterets: round2(cumulInterets),\r\n      cumulGains: round2(cumulGains),\r\n      psFondsEuro: round2(psFondsEuro),\r\n      revenuDistribue: round2(couponBrut),\r\n      cumulRevenusDistribues: round2(cumulRevenusDistribues),\r\n      fiscaliteRevenu: round2(fiscaliteCoupon),\r\n      revenuNetPercu: round2(couponNet),\r\n      cumulRevenusNetsPercus: round2(cumulRevenusNetsPercus),\r\n      revalorisation: round2(revaloDistrib),\r\n      economieIR: round2(economieIRAnnee),\r\n      effortReel: round2(versementBrut - economieIRAnnee),\r\n      compteEspece: round2(compteEspece),\r\n      cumulCompteEspece: round2(cumulCompteEspece),\r\n      capitalInvesti: round2(capitalCapi + capitalDistrib),\r\n      capitalFin: round2(capitalCapi + capitalDistrib + compteEspece),\r\n      cessionProduit,\r\n      fiscalitePV: round2(fiscalitePV),\r\n      reinvestissement: round2(reinvestissementN),\r\n      capitalDecesTheorique: round2(capitalDecesTheorique),\r\n      capitalDecesDegressif: round2(capitalDecesDegressif),\r\n\r\n      revenusNetsPercusAnnee: round2(revenusNetsPercusAnnee),\r\n      reinvestissementDistribNetAnnee: round2(reinvestissementDistribNetAnnee),\r\n\r\n      // Debug distribution\r\n      couponBrut: round2(couponBrut),\r\n      fiscaliteCoupon: round2(fiscaliteCoupon),\r\n      couponNet: round2(couponNet),\r\n      revaloDistrib: round2(revaloDistrib),\r\n      capitalCapi: round2(capitalCapi),\r\n      capitalDistrib: round2(capitalDistrib),\r\n      compteEspece0pct: round2(compteEspece),\r\n    });\r\n  }\r\n\r\n  const capitalInvestiFinal = capitalCapi + capitalDistrib;\r\n  const capitalFinal = capitalInvestiFinal + compteEspece;\r\n  const plusValueLatente = Math.max(0, capitalInvestiFinal - cumulVersementsNets);\r\n\r\n  return {\r\n    envelope,\r\n    dureeEpargne,\r\n    perBancaire,\r\n    rendement: isSCPI ? distributionYield : capitalisationRate,\r\n    fraisGestion,\r\n    tauxRevalorisation: distributionRevalo,\r\n    optionBaremeIR,\r\n    rows,\r\n    capitalAcquis: round2(capitalFinal),\r\n    cumulVersements: round2(cumulVersements),\r\n    cumulEffort: round2(cumulEffort),\r\n    cumulEconomieIR: round2(cumulEconomieIR),\r\n    plusValueLatente: round2(plusValueLatente),\r\n    cumulPSFondsEuro: round2(cumulPSFondsEuro),\r\n    cumulRevenusDistribues: round2(cumulRevenusDistribues),\r\n    cumulFiscaliteRevenus: round2(cumulFiscaliteRevenus),\r\n  };\r\n}\r\n\r\n// ============================================================================\r\n// PHASE 2 : LIQUIDATION\r\n// ============================================================================\r\n\r\n/**\r\n * Calcule la fiscalit├® sur un retrait selon l'enveloppe\r\n * @param {Object} params - Param├¿tres du retrait\r\n * @param {Object} fiscalParams - Param├¿tres fiscaux\r\n * @returns {Object} D├®tail de la fiscalit├®\r\n */\r\nexport function calculFiscaliteRetrait(params, fiscalParams) {\r\n  const {\r\n    envelope,\r\n    montantRetrait,\r\n    partGains,\r\n    partCapital,\r\n    anneeOuverture = 0,\r\n    tmiRetraite = 0.11,\r\n    situation = 'single',\r\n    primesCumulees = 0,\r\n    abattementUtilise = 0,\r\n    optionBaremeIR = false,\r\n  } = params;\r\n\r\n  const fp = fiscalParams;\r\n  let irSurGains = 0;\r\n  let irSurCapital = 0;\r\n  let ps = 0;\r\n  let abattementApplique = 0;\r\n\r\n  switch (envelope) {\r\n    case ENVELOPES.AV: {\r\n      if (anneeOuverture >= 8) {\r\n        // Contrat >= 8 ans : abattement 4 600 Ôé¼ (c├®libataire) ou 9 200 Ôé¼ (couple)\r\n        const abattementMax = situation === 'couple' \r\n          ? fp.avAbattement8ansCouple \r\n          : fp.avAbattement8ansSingle;\r\n        const abattementDispo = Math.max(0, abattementMax - abattementUtilise);\r\n        abattementApplique = Math.min(partGains, abattementDispo);\r\n        const assiette = Math.max(0, partGains - abattementApplique);\r\n\r\n        if (optionBaremeIR) {\r\n          // Option bar├¿me IR progressif\r\n          irSurGains = assiette * tmiRetraite;\r\n        } else {\r\n          // PFU : taux selon seuil 150k de primes\r\n          const taux = primesCumulees <= fp.avSeuilPrimes150k \r\n            ? fp.avTauxSousSeuil8ans  // 7.5%\r\n            : fp.avTauxSurSeuil8ans;  // 12.8%\r\n          irSurGains = assiette * taux;\r\n        }\r\n      } else {\r\n        // Contrat < 8 ans : 12.8% ou option bar├¿me\r\n        if (optionBaremeIR) {\r\n          irSurGains = partGains * tmiRetraite;\r\n        } else {\r\n          irSurGains = partGains * fp.pfuIR; // 12.8%\r\n        }\r\n      }\r\n      ps = partGains * fp.psPatrimoine; // 17.2% toujours\r\n      break;\r\n    }\r\n\r\n    case ENVELOPES.PER: {\r\n      // PER toujours d├®ductible : capital ÔåÆ bar├¿me IR (TMI retraite), gains ÔåÆ PFU\r\n      irSurCapital = partCapital * tmiRetraite;\r\n      irSurGains = partGains * fp.pfuIR;\r\n      ps = partGains * fp.psPatrimoine;\r\n      break;\r\n    }\r\n\r\n    case ENVELOPES.PEA: {\r\n      if (anneeOuverture >= fp.peaAncienneteMin) {\r\n        // >= 5 ans : PS uniquement\r\n        irSurGains = 0;\r\n      } else {\r\n        // < 5 ans : PFU complet\r\n        irSurGains = partGains * fp.pfuIR;\r\n      }\r\n      ps = partGains * fp.psPatrimoine;\r\n      break;\r\n    }\r\n\r\n    case ENVELOPES.CTO:\r\n    case ENVELOPES.SCPI:\r\n    default: {\r\n      // PFU par d├®faut\r\n      irSurGains = partGains * fp.pfuIR;\r\n      ps = partGains * fp.psPatrimoine;\r\n      break;\r\n    }\r\n  }\r\n\r\n  const fiscaliteTotal = irSurGains + irSurCapital + ps;\r\n\r\n  return {\r\n    irSurGains: round2(irSurGains),\r\n    irSurCapital: round2(irSurCapital),\r\n    ps: round2(ps),\r\n    fiscaliteTotal: round2(fiscaliteTotal),\r\n    abattementApplique: round2(abattementApplique),\r\n    retraitNet: round2(montantRetrait - fiscaliteTotal),\r\n  };\r\n}\r\n\r\n/**\r\n * Simule la phase de liquidation\r\n * @param {Object} epargneResult - R├®sultat de la phase ├®pargne\r\n * @param {Object} liquidationParams - Param├¿tres de liquidation\r\n * @param {Object} client - Donn├®es client\r\n * @param {Object} fiscalParams - Param├¿tres fiscaux\r\n * @returns {Object} R├®sultats de la phase liquidation\r\n */\r\n/**\r\n * Calcule le retrait annuel avec la formule VPM (├®puisement progressif)\r\n * VPM = Capital * r / (1 - (1+r)^-n)\r\n * @param {number} capital - Capital ├á ├®puiser\r\n * @param {number} rendement - Taux de rendement annuel\r\n * @param {number} duree - Nombre d'ann├®es\r\n * @returns {number} Retrait annuel brut\r\n */\r\nfunction calculVPM(capital, rendement, duree) {\r\n  if (duree <= 0) return capital;\r\n  if (rendement === 0) return capital / duree;\r\n  const r = rendement;\r\n  const n = duree;\r\n  return capital * r / (1 - Math.pow(1 + r, -n));\r\n}\r\n\r\nexport function simulateLiquidation(epargneResult, liquidationParams, client, fiscalParams, transmissionParams = {}) {\r\n  const {\r\n    mode = 'epuiser', // 'epuiser' | 'mensualite' | 'unique'\r\n    duree = 25,\r\n    mensualiteCible = 0,\r\n    montantUnique = 0,\r\n    optionBaremeIR: optionBaremeIRLiquidation = false,\r\n  } = liquidationParams;\r\n\r\n  const {\r\n    tmiRetraite = 0.11,\r\n    situation = 'single',\r\n    ageActuel = 45,\r\n  } = client;\r\n\r\n  const { \r\n    envelope, capitalAcquis, plusValueLatente, cumulVersements, perBancaire, dureeEpargne, \r\n    fraisGestion = 0, tauxRevalorisation = 0.02, optionBaremeIR = false \r\n  } = epargneResult;\r\n  const fp = fiscalParams;\r\n\r\n  // ├ége au d├®c├¿s pour calculer la dur├®e de liquidation\r\n  const ageAuDeces = transmissionParams.ageAuDeces || 85;\r\n  const ageFinEpargne = ageActuel + dureeEpargne;\r\n  const dureeJusquAuDeces = Math.max(1, ageAuDeces - ageFinEpargne);\r\n\r\n  // Rendement annuel en phase liquidation\r\n  // - si l'utilisateur override via l'UI, liquidationParams.rendement prime\r\n  // - sinon, reprendre le rendement de la phase ├®pargne (d├®j├á normalis├®)\r\n  const rendement = liquidationParams.rendement ?? epargneResult.rendement ?? 0.03;\r\n\r\n  // Ratio gains/capital (├®volue avec les rendements)\r\n  let totalGains = plusValueLatente;\r\n  let totalCapital = capitalAcquis - plusValueLatente;\r\n\r\n  const rows = [];\r\n  let capitalRestant = capitalAcquis;\r\n  let cumulRetraitsBruts = 0;\r\n  let cumulRetraitsNets = 0;\r\n  let cumulFiscalite = 0;\r\n  let abattementCumulUtilise = 0;\r\n  let anneeOuverture = dureeEpargne;\r\n\r\n  // SCPI : pas de strat├®gie de retraits, juste revalorisation + loyers jusqu'au d├®c├¿s\r\n  const isSCPI = envelope === ENVELOPES.SCPI;\r\n  const isCTOorPEA = envelope === ENVELOPES.CTO || envelope === ENVELOPES.PEA;\r\n\r\n  // Calcul du nombre d'ann├®es de liquidation selon le mode\r\n  let anneesLiquidation;\r\n  if (isSCPI) {\r\n    // SCPI : pas de retraits, juste projection jusqu'au d├®c├¿s\r\n    anneesLiquidation = dureeJusquAuDeces;\r\n  } else if (mode === 'unique') {\r\n    // Retrait unique puis fructification jusqu'au d├®c├¿s\r\n    anneesLiquidation = dureeJusquAuDeces;\r\n  } else if (mode === 'mensualite') {\r\n    // Mensualit├® cible : dur├®e jusqu'au d├®c├¿s\r\n    anneesLiquidation = dureeJusquAuDeces;\r\n  } else {\r\n    // ├ëpuiser sur N ann├®es (dur├®e choisie par l'utilisateur)\r\n    anneesLiquidation = duree;\r\n  }\r\n\r\n  // Calcul du retrait VPM pour le mode \"├®puiser\" (constant sur toute la dur├®e)\r\n  // Simplification : en liquidation, tout est ramen├® en capitalisation (sauf SCPI)\r\n  let retraitVPM = 0;\r\n  if (mode === 'epuiser' && !isSCPI) {\r\n    retraitVPM = calculVPM(capitalAcquis, rendement, duree);\r\n  }\r\n\r\n  for (let annee = 1; annee <= anneesLiquidation; annee++) {\r\n    if (capitalRestant <= 0) break;\r\n\r\n    anneeOuverture++;\r\n    const age = ageFinEpargne + annee;\r\n    const capitalDebut = capitalRestant;\r\n    const pvLatenteDebut = totalGains;\r\n\r\n    // 1. Appliquer le rendement annuel sur le capital restant\r\n    let gainsAnnee = 0;\r\n    let loyersOuDividendes = 0;\r\n    let fiscaliteRevenus = 0;\r\n\r\n    if (isSCPI) {\r\n      // SCPI : loyers distribu├®s + revalorisation\r\n      loyersOuDividendes = capitalRestant * rendement;\r\n      const revalorisation = capitalRestant * tauxRevalorisation;\r\n      capitalRestant += revalorisation;\r\n      gainsAnnee = revalorisation;\r\n      // Fiscalit├® loyers : bar├¿me IR + PS\r\n      const irLoyers = loyersOuDividendes * tmiRetraite;\r\n      const psLoyers = loyersOuDividendes * fp.psPatrimoine;\r\n      fiscaliteRevenus = irLoyers + psLoyers;\r\n    } else {\r\n      // AV / PER / CTO / PEA : rendement capitalisation (simplification liquidation)\r\n      gainsAnnee = capitalRestant * rendement;\r\n      capitalRestant += gainsAnnee;\r\n      totalGains += gainsAnnee;\r\n    }\r\n\r\n    const pvLatenteAvantRetrait = totalGains;\r\n\r\n    // 2. Recalculer la quotit├® gains/capital\r\n    const quotiteGains = capitalRestant > 0 ? totalGains / capitalRestant : 0;\r\n\r\n    // 3. D├®terminer le retrait brut selon le mode\r\n    let retraitBrut = 0;\r\n    if (isSCPI) {\r\n      // SCPI : pas de retrait, les loyers sont distribu├®s directement\r\n      retraitBrut = loyersOuDividendes;\r\n    } else if (mode === 'unique') {\r\n      // Retrait unique la premi├¿re ann├®e seulement\r\n      if (annee === 1) {\r\n        retraitBrut = Math.min(montantUnique, capitalRestant);\r\n      }\r\n      // Les ann├®es suivantes : pas de retrait, le capital fructifie\r\n    } else if (mode === 'mensualite') {\r\n      // Mensualit├® cible annuelle\r\n      retraitBrut = Math.min(mensualiteCible * 12, capitalRestant);\r\n    } else {\r\n      // ├ëpuiser sur N ann├®es avec formule VPM (retrait constant)\r\n      retraitBrut = Math.min(retraitVPM, capitalRestant);\r\n    }\r\n\r\n    if (!isSCPI) {\r\n      retraitBrut = Math.min(retraitBrut, capitalRestant);\r\n    }\r\n\r\n    // 4. Quote-part gains dans le retrait\r\n    const partGains = isSCPI ? 0 : retraitBrut * quotiteGains;\r\n    const partCapital = isSCPI ? 0 : retraitBrut - partGains;\r\n\r\n    // Fiscalit├® sur le retrait (pas pour SCPI, d├®j├á fiscalis├® sur les loyers)\r\n    let fiscalite;\r\n    if (isSCPI) {\r\n      // SCPI : fiscalit├® d├®j├á calcul├®e sur les loyers\r\n      fiscalite = {\r\n        irSurGains: 0,\r\n        irSurCapital: 0,\r\n        ps: 0,\r\n        fiscaliteTotal: fiscaliteRevenus,\r\n        retraitNet: loyersOuDividendes - fiscaliteRevenus,\r\n        abattementApplique: 0,\r\n      };\r\n    } else if (isCTOorPEA) {\r\n      // CTO/PEA : fiscalit├® sur les plus-values de cession\r\n      let irPV = 0;\r\n      let psPV = 0;\r\n      if (envelope === ENVELOPES.CTO) {\r\n        // CTO : PV de cession = partGains, fiscalis├®e au PFU ou bar├¿me\r\n        if (optionBaremeIR) {\r\n          irPV = partGains * tmiRetraite;\r\n        } else {\r\n          irPV = partGains * fp.pfuIR;\r\n        }\r\n        psPV = partGains * fp.psPatrimoine;\r\n      } else {\r\n        // PEA : < 5 ans = PFU (IR + PS), >= 5 ans = PS uniquement (r├¿gle existante)\r\n        irPV = anneeOuverture >= fp.peaAncienneteMin ? 0 : partGains * fp.pfuIR;\r\n        psPV = partGains * fp.psPatrimoine;\r\n      }\r\n      fiscalite = {\r\n        irSurGains: irPV,\r\n        irSurCapital: 0,\r\n        ps: psPV,\r\n        fiscaliteTotal: irPV + psPV + fiscaliteRevenus,\r\n        retraitNet: retraitBrut - irPV - psPV,\r\n        abattementApplique: 0,\r\n      };\r\n    } else {\r\n      // AV, PER : fiscalit├® classique\r\n      fiscalite = calculFiscaliteRetrait({\r\n        envelope,\r\n        montantRetrait: retraitBrut,\r\n        partGains,\r\n        partCapital,\r\n        anneeOuverture,\r\n        tmiRetraite,\r\n        situation,\r\n        primesCumulees: cumulVersements,\r\n        abattementUtilise: abattementCumulUtilise,\r\n        optionBaremeIR: optionBaremeIRLiquidation,\r\n      }, fp);\r\n    }\r\n\r\n    abattementCumulUtilise += fiscalite.abattementApplique || 0;\r\n    \r\n    // 5. Mettre ├á jour les totaux apr├¿s retrait\r\n    if (!isSCPI) {\r\n      // Pour SCPI, le capital ne diminue pas (loyers distribu├®s, pas de retrait)\r\n      capitalRestant -= retraitBrut;\r\n      totalGains -= partGains;\r\n      totalCapital -= partCapital;\r\n    }\r\n\r\n    const pvLatenteFin = totalGains;\r\n    \r\n    cumulRetraitsBruts += retraitBrut;\r\n    cumulRetraitsNets += fiscalite.retraitNet;\r\n    cumulFiscalite += fiscalite.fiscaliteTotal;\r\n\r\n    rows.push({\r\n      annee,\r\n      age,\r\n      isAgeAuDeces: age === ageAuDeces,\r\n      capitalDebut: round2(capitalDebut),\r\n      gainsAnnee: round2(gainsAnnee),\r\n      retraitBrut: round2(retraitBrut),\r\n      partGains: round2(partGains),\r\n      partCapital: round2(partCapital),\r\n      totalCapitalRestant: round2(totalCapital),\r\n      totalInteretsRestants: round2(totalGains),\r\n      pvLatenteDebut: round2(pvLatenteDebut),\r\n      pvLatenteAvantRetrait: round2(pvLatenteAvantRetrait),\r\n      pvLatenteFin: round2(pvLatenteFin),\r\n      irSurGains: fiscalite.irSurGains,\r\n      irSurCapital: fiscalite.irSurCapital,\r\n      ps: fiscalite.ps,\r\n      fiscaliteTotal: fiscalite.fiscaliteTotal,\r\n      retraitNet: fiscalite.retraitNet,\r\n      capitalFin: round2(capitalRestant),\r\n    });\r\n  }\r\n\r\n  // Calculer le revenu moyen net sur les ann├®es avec retrait effectif\r\n  const anneesAvecRetrait = rows.filter(r => r.retraitBrut > 0).length;\r\n  const revenuAnnuelMoyenNet = anneesAvecRetrait > 0 ? cumulRetraitsNets / anneesAvecRetrait : 0;\r\n\r\n  // Calculer les cumuls jusqu'au d├®c├¿s (pour la synth├¿se)\r\n  const rowsJusquAuDeces = rows.filter(r => r.age <= ageAuDeces);\r\n  const ligneAuDeces = rows.find(r => r.age === ageAuDeces) || rows[rows.length - 1];\r\n  const cumulRetraitsNetsAuDeces = rowsJusquAuDeces.reduce((sum, r) => sum + r.retraitNet, 0);\r\n  const cumulFiscaliteAuDeces = rowsJusquAuDeces.reduce((sum, r) => sum + r.fiscaliteTotal, 0);\r\n  const capitalRestantAuDeces = ligneAuDeces ? ligneAuDeces.capitalFin : capitalRestant;\r\n\r\n  return {\r\n    envelope,\r\n    mode,\r\n    duree: anneesLiquidation,\r\n    ageFinEpargne,\r\n    ageAuDeces,\r\n    rows,\r\n    capitalRestant: round2(capitalRestant),\r\n    capitalRestantAuDeces: round2(capitalRestantAuDeces),\r\n    cumulRetraitsBruts: round2(cumulRetraitsBruts),\r\n    cumulRetraitsNets: round2(cumulRetraitsNets),\r\n    cumulRetraitsNetsAuDeces: round2(cumulRetraitsNetsAuDeces),\r\n    cumulFiscalite: round2(cumulFiscalite),\r\n    cumulFiscaliteAuDeces: round2(cumulFiscaliteAuDeces),\r\n    revenuAnnuelMoyenNet: round2(revenuAnnuelMoyenNet),\r\n  };\r\n}\r\n\r\n// ============================================================================\r\n// PHASE 3 : D├ëC├êS / TRANSMISSION\r\n// ============================================================================\r\n\r\n/**\r\n * Calcule la fiscalit├® de transmission selon l'enveloppe\r\n * @param {Object} params - Param├¿tres de transmission\r\n * @param {Object} fiscalParams - Param├¿tres fiscaux\r\n * @returns {Object} D├®tail de la transmission\r\n */\r\nexport function calculTransmission(params, fiscalParams) {\r\n  const {\r\n    envelope,\r\n    capitalTransmis,\r\n    cumulVersements = 0,\r\n    ageAuDeces = 85,\r\n    agePremierVersement = 45,\r\n    nbBeneficiaires = 1,\r\n    beneficiaryType = 'enfants',\r\n    perBancaire = false,\r\n  } = params;\r\n\r\n  const fp = fiscalParams;\r\n  // Taux DMTG choisi par l'utilisateur sur la page Transmission\r\n  const dmtgTauxChoisi = fp.dmtgTauxChoisi || 0.20;\r\n\r\n  const effectiveNbBeneficiaires = beneficiaryType === 'conjoint' ? 1 : Math.max(1, nbBeneficiaires || 1);\r\n  \r\n  let taxeDmtg = 0; // droits de succession (bar├¿me DMTG choisi)\r\n  let taxeForfaitaire = 0; // pr├®l├¿vement forfaitaire (990 I)\r\n  let abattement = 0;\r\n  let regime = '';\r\n  const psTaux = typeof fp.psPatrimoine === 'number' ? fp.psPatrimoine : 0.172;\r\n  const resultatPs = {\r\n    applicable: false,\r\n    assiette: 0,\r\n    taux: psTaux,\r\n    montant: 0,\r\n    note: '',\r\n  };\r\n\r\n  const computePsDeces = (assietteGains, noteIfZero = '') => {\r\n    const assiette = Math.max(0, assietteGains || 0);\r\n    if (assiette <= 0) {\r\n      resultatPs.applicable = false;\r\n      resultatPs.note = noteIfZero || 'Aucun gain latent soumis aux PS';\r\n      return 0;\r\n    }\r\n    resultatPs.applicable = true;\r\n    resultatPs.assiette = round2(assiette);\r\n    resultatPs.montant = round2(assiette * psTaux);\r\n    resultatPs.note = '';\r\n    return resultatPs.montant;\r\n  };\r\n\r\n  // Hypoth├¿se : AV/PER/PEA 100% UC ÔåÆ PS sur gains latents\r\n  const isAssuranceVieLike = envelope === ENVELOPES.AV;\r\n  const isPea = envelope === ENVELOPES.PEA;\r\n  const gainsLatents = Math.max(0, capitalTransmis - (cumulVersements || 0));\r\n  const psMontant = (() => {\r\n    if (isAssuranceVieLike || isPea) {\r\n      return computePsDeces(gainsLatents);\r\n    }\r\n    if (perBancaire || envelope === ENVELOPES.CTO || envelope === ENVELOPES.PER) {\r\n      resultatPs.note = 'PS d├®j├á acquitt├®s pendant la vie du contrat';\r\n    } else if (envelope === ENVELOPES.SCPI) {\r\n      resultatPs.note = 'PS pr├®lev├®s sur les loyers annuels';\r\n    }\r\n    return 0;\r\n  })();\r\n\r\n  const capitalApresPs = Math.max(0, capitalTransmis - psMontant);\r\n\r\n  if (beneficiaryType === 'conjoint') {\r\n    const assiette = 0;\r\n    return {\r\n      envelope,\r\n      capitalTransmis: round2(capitalTransmis),\r\n      regime: 'Exon├®ration conjoint/PACS',\r\n      abattement: round2(capitalApresPs),\r\n      assiette,\r\n      taxeForfaitaire: 0,\r\n      taxeDmtg: 0,\r\n      taxe: 0,\r\n      capitalTransmisNet: round2(capitalTransmis - psMontant),\r\n      psDeces: {\r\n        applicable: resultatPs.applicable,\r\n        assiette: resultatPs.assiette,\r\n        taux: resultatPs.taux,\r\n        montant: round2(resultatPs.montant),\r\n        note: resultatPs.note,\r\n      },\r\n    };\r\n  }\r\n\r\n  switch (envelope) {\r\n    case ENVELOPES.AV: {\r\n      if (agePremierVersement < 70) {\r\n        // Article 990 I (primes vers├®es avant 70 ans)\r\n        regime = '990 I';\r\n        abattement = fp.av990IAbattement * effectiveNbBeneficiaires;\r\n        const assiette = Math.max(0, capitalApresPs - abattement);\r\n        // Tranche 1 : 20% jusqu'├á 700k par b├®n├®ficiaire\r\n        const plafondTranche1 = fp.av990ITranche1Plafond * effectiveNbBeneficiaires;\r\n        if (assiette <= plafondTranche1) {\r\n          taxeForfaitaire = assiette * fp.av990ITranche1Taux;\r\n        } else {\r\n          taxeForfaitaire = plafondTranche1 * fp.av990ITranche1Taux;\r\n          taxeForfaitaire += (assiette - plafondTranche1) * fp.av990ITranche2Taux;\r\n        }\r\n      } else {\r\n        // Article 757 B (primes vers├®es apr├¿s 70 ans)\r\n        // Abattement global de 30 500 Ôé¼ puis taux DMTG choisi\r\n        regime = '757 B';\r\n        abattement = fp.av757BAbattement; // 30 500 Ôé¼ global\r\n        const assiette = Math.max(0, capitalApresPs - abattement);\r\n        // Appliquer le taux DMTG choisi par l'utilisateur\r\n        taxeDmtg = assiette * dmtgTauxChoisi;\r\n      }\r\n      break;\r\n    }\r\n\r\n    case ENVELOPES.PER: {\r\n      // PER assurance : fiscalit├® d├®c├¿s d├®pend de l'├éGE AU D├ëC├êS (pas de l'├óge au versement)\r\n      // Si d├®c├¿s < 70 ans ÔåÆ 990 I, si d├®c├¿s >= 70 ans ÔåÆ 757 B\r\n      // PER bancaire : int├®gration ├á l'actif successoral (DMTG)\r\n      if (params.perBancaire) {\r\n        // PER bancaire ÔåÆ DMTG avec taux choisi\r\n        // On part du principe que l'abattement de 100 000 Ôé¼ est d├®j├á consomm├®\r\n        regime = 'DMTG (PER bancaire)';\r\n        abattement = 0; // Abattement d├®j├á consomm├®\r\n        const assiette = capitalApresPs;\r\n        taxeDmtg = assiette * dmtgTauxChoisi;\r\n      } else if (ageAuDeces < 70) {\r\n        // PER assurance + d├®c├¿s avant 70 ans ÔåÆ 990 I\r\n        regime = '990 I (PER assurance)';\r\n        abattement = fp.av990IAbattement * effectiveNbBeneficiaires;\r\n        const assiette = Math.max(0, capitalApresPs - abattement);\r\n        const plafondTranche1 = fp.av990ITranche1Plafond * effectiveNbBeneficiaires;\r\n        if (assiette <= plafondTranche1) {\r\n          taxeForfaitaire = assiette * fp.av990ITranche1Taux;\r\n        } else {\r\n          taxeForfaitaire = plafondTranche1 * fp.av990ITranche1Taux;\r\n          taxeForfaitaire += (assiette - plafondTranche1) * fp.av990ITranche2Taux;\r\n        }\r\n      } else {\r\n        // PER assurance + d├®c├¿s >= 70 ans ÔåÆ 757 B\r\n        // Abattement global de 30 500 Ôé¼ puis taux DMTG choisi\r\n        regime = '757 B (PER assurance)';\r\n        abattement = fp.av757BAbattement; // 30 500 Ôé¼ global\r\n        const assiette = Math.max(0, capitalApresPs - abattement);\r\n        taxeDmtg = assiette * dmtgTauxChoisi;\r\n      }\r\n      break;\r\n    }\r\n\r\n    case ENVELOPES.PEA:\r\n    case ENVELOPES.CTO:\r\n    case ENVELOPES.SCPI:\r\n    default: {\r\n      // Int├®gration ├á l'actif successoral (DMTG) avec taux choisi\r\n      // On part du principe que l'abattement de 100 000 Ôé¼ est d├®j├á consomm├®\r\n      regime = 'DMTG';\r\n      abattement = 0; // Abattement d├®j├á consomm├®\r\n      const assiette = capitalApresPs;\r\n      taxeDmtg = assiette * dmtgTauxChoisi;\r\n      break;\r\n    }\r\n  }\r\n\r\n  const assiette = Math.max(0, capitalApresPs - abattement);\r\n  const taxeTotal = taxeForfaitaire + taxeDmtg;\r\n\r\n  return {\r\n    envelope,\r\n    capitalTransmis: round2(capitalTransmis),\r\n    regime,\r\n    abattement: round2(abattement),\r\n    assiette: round2(assiette),\r\n    taxeForfaitaire: round2(taxeForfaitaire),\r\n    taxeDmtg: round2(taxeDmtg),\r\n    taxe: round2(taxeTotal),\r\n    capitalTransmisNet: round2(capitalTransmis - psMontant - taxeTotal),\r\n    psDeces: {\r\n      applicable: resultatPs.applicable,\r\n      assiette: resultatPs.assiette,\r\n      taux: resultatPs.taux,\r\n      montant: round2(resultatPs.montant),\r\n      note: resultatPs.note,\r\n    },\r\n  };\r\n}\r\n\r\n// ============================================================================\r\n// SIMULATION COMPL├êTE\r\n// ============================================================================\r\n\r\n/**\r\n * Ex├®cute une simulation compl├¿te (├ëpargne + Liquidation + D├®c├¿s)\r\n * @param {Object} product - Configuration du produit\r\n * @param {Object} client - Donn├®es client\r\n * @param {Object} liquidationParams - Param├¿tres de liquidation\r\n * @param {Object} transmissionParams - Param├¿tres de transmission\r\n * @param {Object} fiscalParams - Param├¿tres fiscaux extraits des settings\r\n * @returns {Object} R├®sultats complets\r\n */\r\nexport function simulateComplete(product, client, liquidationParams, transmissionParams, fiscalParams) {\r\n  // Phase 1 : ├ëpargne\r\n  const epargne = simulateEpargne(product, client, fiscalParams);\r\n\r\n  // D├®terminer si le d├®c├¿s intervient pendant la phase ├®pargne ou liquidation\r\n  const ageAuDeces = transmissionParams.ageAuDeces || 85;\r\n  const ageActuel = client.ageActuel || 45;\r\n  const ageFinEpargne = ageActuel + epargne.dureeEpargne;\r\n  const decesEnPhaseEpargne = ageAuDeces < ageFinEpargne;\r\n\r\n  // Calculer le capital au moment du d├®c├¿s (m├¬me si en phase ├®pargne)\r\n  let capitalAuDeces = epargne.capitalAcquis;\r\n  let capitalDecesTheoriqueAuDeces = 0;\r\n  let capitalDecesDegressifAuDeces = 0;\r\n  \r\n  if (decesEnPhaseEpargne) {\r\n    // D├®c├¿s pendant la phase ├®pargne : trouver le capital ├á l'├óge du d├®c├¿s\r\n    const ligneAuDeces = epargne.rows.find(r => r.age === ageAuDeces);\r\n    if (ligneAuDeces) {\r\n      capitalAuDeces = ligneAuDeces.capitalFin;\r\n      capitalDecesTheoriqueAuDeces = ligneAuDeces.capitalDecesTheorique || 0;\r\n      capitalDecesDegressifAuDeces = ligneAuDeces.capitalDecesDegressif || 0;\r\n\r\n      // Ajouter le capital d├®c├¿s th├®orique si garantie de bonne fin active\r\n      if (product.envelope === ENVELOPES.PER && product.versementConfig?.annuel?.garantieBonneFin?.active) {\r\n        capitalAuDeces += capitalDecesTheoriqueAuDeces + capitalDecesDegressifAuDeces;\r\n      }\r\n    } else {\r\n      // Si l'├óge du d├®c├¿s est avant le d├®but de l'├®pargne\r\n      capitalAuDeces = 0;\r\n    }\r\n  }\r\n\r\n  // Phase 2 : Liquidation (seulement si d├®c├¿s apr├¿s phase ├®pargne)\r\n  let liquidation;\r\n  if (decesEnPhaseEpargne) {\r\n    // Pas de phase liquidation si d├®c├¿s en phase ├®pargne\r\n    liquidation = {\r\n      duree: 0,\r\n      ageFinEpargne,\r\n      ageAuDeces,\r\n      rows: [],\r\n      capitalRestant: capitalAuDeces,\r\n      capitalRestantAuDeces: capitalAuDeces,\r\n      cumulRetraitsBruts: 0,\r\n      cumulRetraitsNets: 0,\r\n      cumulRetraitsNetsAuDeces: 0,\r\n      cumulFiscalite: 0,\r\n      cumulFiscaliteAuDeces: 0,\r\n      revenuAnnuelMoyenNet: 0,\r\n    };\r\n  } else {\r\n    liquidation = simulateLiquidation(epargne, liquidationParams, client, fiscalParams, transmissionParams);\r\n  }\r\n\r\n  // Capital ├á transmettre = capital restant au d├®c├¿s\r\n  const capitalTransmis = decesEnPhaseEpargne ? capitalAuDeces : liquidation.capitalRestantAuDeces;\r\n\r\n  // Phase 3 : Transmission\r\n  const transmission = calculTransmission({\r\n    envelope: product.envelope,\r\n    capitalTransmis: capitalTransmis,\r\n    cumulVersements: epargne.cumulVersements,\r\n    ageAuDeces: transmissionParams.ageAuDeces,\r\n    agePremierVersement: transmissionParams.agePremierVersement || (client.ageActuel || 45),\r\n    nbBeneficiaires: transmissionParams.nbBeneficiaires || 1,\r\n    perBancaire: product.perBancaire || false,\r\n  }, fiscalParams);\r\n\r\n  // Synth├¿se\r\n  return {\r\n    envelope: product.envelope,\r\n    envelopeLabel: ENVELOPE_LABELS[product.envelope] || product.envelope,\r\n\r\n    // ├ëpargne\r\n    epargne: {\r\n      duree: epargne.dureeEpargne,\r\n      capitalAcquis: epargne.capitalAcquis,\r\n      cumulVersements: epargne.cumulVersements,\r\n      cumulEffort: epargne.cumulEffort,\r\n      cumulEconomieIR: epargne.cumulEconomieIR,\r\n      plusValueLatente: epargne.plusValueLatente,\r\n      cumulPSFondsEuro: epargne.cumulPSFondsEuro,\r\n      cumulRevenusDistribues: epargne.cumulRevenusDistribues,\r\n      cumulFiscaliteRevenus: epargne.cumulFiscaliteRevenus,\r\n      rows: epargne.rows,\r\n    },\r\n\r\n    // Liquidation\r\n    liquidation: {\r\n      duree: liquidation.duree,\r\n      ageAuDeces: liquidation.ageAuDeces,\r\n      cumulRetraitsBruts: liquidation.cumulRetraitsBruts,\r\n      cumulRetraitsNets: liquidation.cumulRetraitsNets,\r\n      cumulRetraitsNetsAuDeces: liquidation.cumulRetraitsNetsAuDeces,\r\n      cumulFiscalite: liquidation.cumulFiscalite,\r\n      cumulFiscaliteAuDeces: liquidation.cumulFiscaliteAuDeces,\r\n      revenuAnnuelMoyenNet: liquidation.revenuAnnuelMoyenNet,\r\n      capitalRestant: liquidation.capitalRestant,\r\n      capitalRestantAuDeces: liquidation.capitalRestantAuDeces,\r\n      rows: liquidation.rows,\r\n    },\r\n\r\n    // Transmission\r\n    transmission: {\r\n      regime: transmission.regime,\r\n      capitalTransmis: transmission.capitalTransmis,\r\n      abattement: transmission.abattement,\r\n      assiette: transmission.assiette,\r\n      taxeForfaitaire: transmission.taxeForfaitaire,\r\n      taxeDmtg: transmission.taxeDmtg,\r\n      taxe: transmission.taxe,\r\n      capitalTransmisNet: transmission.capitalTransmisNet,\r\n      psDeces: transmission.psDeces,\r\n    },\r\n\r\n    // Totaux\r\n    totaux: {\r\n      effortTotal: epargne.cumulEffort,\r\n      // Revenus nets phase ├®pargne (SCPI/CTO) = revenus distribu├®s - fiscalit├® revenus\r\n      revenusNetsEpargne: (epargne.cumulRevenusDistribues || 0) - (epargne.cumulFiscaliteRevenus || 0),\r\n      // Effort r├®el pour SCPI/CTO = effort - revenus nets ├®pargne\r\n      effortReel: epargne.cumulEffort - ((epargne.cumulRevenusDistribues || 0) - (epargne.cumulFiscaliteRevenus || 0)),\r\n      economieIRTotal: epargne.cumulEconomieIR,\r\n      revenusNetsLiquidation: liquidation.cumulRetraitsNetsAuDeces,\r\n      revenusNetsTotal: liquidation.cumulRetraitsNets,\r\n      fiscaliteTotale: liquidation.cumulFiscalite + transmission.taxe,\r\n      capitalTransmisNet: transmission.capitalTransmisNet,\r\n    },\r\n  };\r\n}\r\n\r\n/**\r\n * Compare deux produits\r\n * @param {Object} result1 - R├®sultat simulation produit 1\r\n * @param {Object} result2 - R├®sultat simulation produit 2\r\n * @returns {Object} Comparaison avec deltas\r\n */\r\nexport function compareProducts(result1, result2) {\r\n  const delta = (a, b) => round2(a - b);\r\n\r\n  return {\r\n    produit1: result1,\r\n    produit2: result2,\r\n    \r\n    deltas: {\r\n      // Effort r├®el = effort brut - revenus nets ├®pargne (SCPI/CTO)\r\n      effortTotal: delta(result1.totaux.effortReel, result2.totaux.effortReel),\r\n      economieIR: delta(result1.totaux.economieIRTotal, result2.totaux.economieIRTotal),\r\n      capitalAcquis: delta(result1.epargne.capitalAcquis, result2.epargne.capitalAcquis),\r\n      // Revenus nets = revenus nets phase liquidation uniquement\r\n      revenusNetsLiquidation: delta(result1.totaux.revenusNetsLiquidation, result2.totaux.revenusNetsLiquidation),\r\n      fiscaliteTotale: delta(result1.totaux.fiscaliteTotale, result2.totaux.fiscaliteTotale),\r\n      capitalTransmisNet: delta(result1.totaux.capitalTransmisNet, result2.totaux.capitalTransmisNet),\r\n    },\r\n\r\n    // Meilleur effort = effort r├®el le plus bas (prend en compte revenus nets SCPI/CTO)\r\n    meilleurEffort: result1.totaux.effortReel <= result2.totaux.effortReel ? result1.envelope : result2.envelope,\r\n    // Meilleurs revenus = revenus nets liquidation les plus ├®lev├®s\r\n    meilleurRevenus: result1.totaux.revenusNetsLiquidation >= result2.totaux.revenusNetsLiquidation ? result1.envelope : result2.envelope,\r\n    meilleurTransmission: result1.totaux.capitalTransmisNet >= result2.totaux.capitalTransmisNet ? result1.envelope : result2.envelope,\r\n  };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\engine\\succession.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\engine\\tax.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\engine\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\features\\audit\\AuditWizard.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'handleExport'. Either include it or remove the dependency array.","line":86,"column":6,"nodeType":"ArrayExpression","endLine":86,"endColumn":15,"suggestions":[{"desc":"Update the dependencies array to be: [dossier, handleExport]","fix":{"range":[2900,2909],"text":"[dossier, handleExport]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'updates' is defined but never used. Allowed unused args must match /^_/u.","line":282,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":282,"endColumn":49,"suggestions":[{"messageId":"removeVar","data":{"varName":"updates"},"fix":{"range":[8982,9012],"text":""},"desc":"Remove unused variable 'updates'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * AuditWizard - Wizard multi-├®tapes pour l'audit patrimonial\r\n */\r\n\r\nimport React, { useState, useEffect, useCallback, useRef } from 'react';\r\nimport type { DossierAudit, ObjectifClient } from './types';\r\nimport { createEmptyDossier, OBJECTIFS_CLIENT_LABELS } from './types';\r\nimport {\r\n  exportDossierToFile,\r\n  importDossierFromFile,\r\n  saveDraftToSession,\r\n  loadDraftFromSession,\r\n  clearDraftFromSession,\r\n  setupBeforeUnloadWarning,\r\n} from './storage';\r\nimport { generateAuditPptx } from '../../pptx/auditPptx';\r\nimport { useTheme } from '../../settings/ThemeProvider';\r\nimport { onResetEvent } from '../../utils/reset';\r\nimport './AuditWizard.css';\r\n\r\n// ├ëv├®nements globaux pour Save/Load depuis la Topbar\r\nconst SAVE_EVENT = 'ser1:save';\r\nconst LOAD_EVENT = 'ser1:load';\r\n\r\n// ├ëtapes du wizard (ic├┤nes sobres num├®rot├®es)\r\nconst STEPS = [\r\n  { id: 'famille', label: 'Situation familiale', num: 1 },\r\n  { id: 'civil', label: 'Situation civile', num: 2 },\r\n  { id: 'actifs', label: 'Actifs', num: 3 },\r\n  { id: 'passif', label: 'Passif', num: 4 },\r\n  { id: 'fiscalite', label: 'Fiscalit├®', num: 5 },\r\n  { id: 'objectifs', label: 'Objectifs', num: 6 },\r\n] as const;\r\n\r\ntype StepId = typeof STEPS[number]['id'];\r\n\r\nexport default function AuditWizard(): React.ReactElement {\r\n  const { colors } = useTheme();\r\n  const [dossier, setDossier] = useState<DossierAudit>(() => {\r\n    const draft = loadDraftFromSession();\r\n    return draft || createEmptyDossier();\r\n  });\r\n  const [currentStep, setCurrentStep] = useState<StepId>('famille');\r\n  const [hasChanges, setHasChanges] = useState(false);\r\n  const [isExportingPptx, setIsExportingPptx] = useState(false);\r\n  const [exportMenuOpen, setExportMenuOpen] = useState(false);\r\n  const fileInputRef = useRef<HTMLInputElement>(null);\r\n  const exportRef = useRef<HTMLDivElement>(null);\r\n\r\n  // Sauvegarde automatique en session\r\n  useEffect(() => {\r\n    if (hasChanges) {\r\n      saveDraftToSession(dossier);\r\n    }\r\n  }, [dossier, hasChanges]);\r\n\r\n  // Alerte avant de quitter\r\n  useEffect(() => {\r\n    const cleanup = setupBeforeUnloadWarning(() => hasChanges);\r\n    return cleanup;\r\n  }, [hasChanges]);\r\n\r\n  // ├ëcoute de l'├®v├®nement reset depuis la topbar\r\n  useEffect(() => {\r\n    const off = onResetEvent?.(({ simId }: { simId: string }) => {\r\n      if (simId === 'audit') {\r\n        // Reset complet : state + storage\r\n        clearDraftFromSession();\r\n        setDossier(createEmptyDossier());\r\n        setHasChanges(false);\r\n        setCurrentStep('famille');\r\n      }\r\n    });\r\n    return off || (() => {});\r\n  }, []);\r\n\r\n  // ├ëcoute de l'├®v├®nement Save depuis la Topbar\r\n  useEffect(() => {\r\n    const handler = () => {\r\n      if (window.location.pathname === '/audit') {\r\n        handleExport();\r\n      }\r\n    };\r\n    window.addEventListener(SAVE_EVENT, handler);\r\n    return () => window.removeEventListener(SAVE_EVENT, handler);\r\n  }, [dossier]);\r\n\r\n  // ├ëcoute de l'├®v├®nement Load depuis la Topbar\r\n  useEffect(() => {\r\n    const handler = () => {\r\n      if (window.location.pathname === '/audit') {\r\n        fileInputRef.current?.click();\r\n      }\r\n    };\r\n    window.addEventListener(LOAD_EVENT, handler);\r\n    return () => window.removeEventListener(LOAD_EVENT, handler);\r\n  }, []);\r\n\r\n  // Fermeture menu export au clic ext├®rieur\r\n  useEffect(() => {\r\n    const handler = (e: MouseEvent) => {\r\n      if (!exportRef.current) return;\r\n      if (!exportRef.current.contains(e.target as Node)) setExportMenuOpen(false);\r\n    };\r\n    document.addEventListener('click', handler);\r\n    return () => document.removeEventListener('click', handler);\r\n  }, []);\r\n\r\n  const updateDossier = useCallback((updates: Partial<DossierAudit>) => {\r\n    setDossier(prev => ({\r\n      ...prev,\r\n      ...updates,\r\n      dateModification: new Date().toISOString(),\r\n    }));\r\n    setHasChanges(true);\r\n  }, []);\r\n\r\n  const handleExport = () => {\r\n    exportDossierToFile(dossier);\r\n    setHasChanges(false);\r\n  };\r\n\r\n  const handleExportPptx = async () => {\r\n    try {\r\n      setIsExportingPptx(true);\r\n      await generateAuditPptx({ dossier, colors });\r\n    } catch (error) {\r\n      console.error('Erreur export PPTX:', error);\r\n      alert('Erreur lors de l\\'export PPTX');\r\n    } finally {\r\n      setIsExportingPptx(false);\r\n    }\r\n  };\r\n\r\n  const handleImport = async (event: React.ChangeEvent<HTMLInputElement>) => {\r\n    const file = event.target.files?.[0];\r\n    if (!file) return;\r\n\r\n    try {\r\n      const imported = await importDossierFromFile(file);\r\n      setDossier(imported);\r\n      setHasChanges(false);\r\n      alert('Dossier import├® avec succ├¿s');\r\n    } catch (error) {\r\n      alert((error as Error).message);\r\n    }\r\n    \r\n    // Reset input\r\n    if (fileInputRef.current) {\r\n      fileInputRef.current.value = '';\r\n    }\r\n  };\r\n\r\n  \r\n  const currentStepIndex = STEPS.findIndex(s => s.id === currentStep);\r\n  const canGoNext = currentStepIndex < STEPS.length - 1;\r\n  const canGoPrev = currentStepIndex > 0;\r\n\r\n  return (\r\n    <div className=\"audit-wizard\">\r\n      {/* Header sobre */}\r\n      <div className=\"audit-header\">\r\n        <h1>Audit Patrimonial</h1>\r\n        \r\n        {/* Menu export harmonis├® (style /sim/ir) */}\r\n        <div ref={exportRef} className=\"export-menu-container\">\r\n          <button\r\n            type=\"button\"\r\n            className=\"chip\"\r\n            aria-haspopup=\"menu\"\r\n            aria-expanded={exportMenuOpen}\r\n            onClick={() => setExportMenuOpen(v => !v)}\r\n          >\r\n            Exporter Ôû¥\r\n          </button>\r\n          {exportMenuOpen && (\r\n            <div role=\"menu\" className=\"export-dropdown\">\r\n              <button\r\n                type=\"button\"\r\n                role=\"menuitem\"\r\n                className=\"export-dropdown-item\"\r\n                onClick={() => {\r\n                  setExportMenuOpen(false);\r\n                  handleExportPptx();\r\n                }}\r\n                disabled={isExportingPptx}\r\n              >\r\n                {isExportingPptx ? 'Export en cours...' : 'PowerPoint (.pptx)'}\r\n              </button>\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Input file cach├® pour l'import via Topbar */}\r\n      <input\r\n        ref={fileInputRef}\r\n        type=\"file\"\r\n        accept=\".json\"\r\n        onChange={handleImport}\r\n        style={{ display: 'none' }}\r\n      />\r\n\r\n      {/* Indicateur de changements non sauvegard├®s */}\r\n      {hasChanges && (\r\n        <div className=\"unsaved-warning\">\r\n          ÔÜá´©Å Modifications non export├®es\r\n        </div>\r\n      )}\r\n\r\n      {/* Barre de progression sobre */}\r\n      <div className=\"progress-bar-container\">\r\n        <div className=\"progress-bar\">\r\n          <div \r\n            className=\"progress-bar-fill\" \r\n            style={{ width: `${((currentStepIndex + 1) / STEPS.length) * 100}%` }}\r\n          />\r\n        </div>\r\n        <span className=\"progress-text\">├ëtape {currentStepIndex + 1} sur {STEPS.length}</span>\r\n      </div>\r\n\r\n      {/* Navigation ├®tapes sobre */}\r\n      <div className=\"steps-nav\">\r\n        {STEPS.map((step, index) => (\r\n          <button\r\n            key={step.id}\r\n            className={`step-pill ${currentStep === step.id ? 'active' : ''} ${index < currentStepIndex ? 'completed' : ''}`}\r\n            onClick={() => setCurrentStep(step.id)}\r\n          >\r\n            <span className=\"step-num\">{step.num}</span>\r\n            <span className=\"step-label\">{step.label}</span>\r\n          </button>\r\n        ))}\r\n      </div>\r\n\r\n      {/* Contenu ├®tape */}\r\n      <div className=\"step-content\">\r\n        {currentStep === 'famille' && (\r\n          <StepFamille dossier={dossier} updateDossier={updateDossier} />\r\n        )}\r\n        {currentStep === 'civil' && (\r\n          <StepCivil dossier={dossier} updateDossier={updateDossier} />\r\n        )}\r\n        {currentStep === 'actifs' && (\r\n          <StepActifs dossier={dossier} updateDossier={updateDossier} />\r\n        )}\r\n        {currentStep === 'passif' && (\r\n          <StepPassif dossier={dossier} updateDossier={updateDossier} />\r\n        )}\r\n        {currentStep === 'fiscalite' && (\r\n          <StepFiscalite dossier={dossier} updateDossier={updateDossier} />\r\n        )}\r\n        {currentStep === 'objectifs' && (\r\n          <StepObjectifs dossier={dossier} updateDossier={updateDossier} />\r\n        )}\r\n      </div>\r\n\r\n      {/* Navigation bas */}\r\n      <div className=\"step-navigation\">\r\n        <button \r\n          className=\"chip chip-secondary\" \r\n          onClick={() => setCurrentStep(STEPS[currentStepIndex - 1].id)}\r\n          disabled={!canGoPrev}\r\n        >\r\n          Pr├®c├®dent\r\n        </button>\r\n        <button \r\n          className=\"chip chip-primary\" \r\n          onClick={() => setCurrentStep(STEPS[currentStepIndex + 1].id)}\r\n          disabled={!canGoNext}\r\n        >\r\n          Suivant\r\n        </button>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n// Composants ├®tapes simplifi├®s (MVP)\r\ninterface StepProps {\r\n  dossier: DossierAudit;\r\n  updateDossier: (updates: Partial<DossierAudit>) => void;\r\n}\r\n\r\nfunction StepFamille({ dossier, updateDossier }: StepProps) {\r\n  const { situationFamiliale } = dossier;\r\n\r\n  return (\r\n    <div className=\"step-form\">\r\n      <h2>Situation familiale</h2>\r\n      \r\n      <div className=\"form-section\">\r\n        <h3>Monsieur</h3>\r\n        <div className=\"form-row\">\r\n          <label>Pr├®nom</label>\r\n          <input\r\n            type=\"text\"\r\n            value={situationFamiliale.mr.prenom}\r\n            onChange={(e) => updateDossier({\r\n              situationFamiliale: {\r\n                ...situationFamiliale,\r\n                mr: { ...situationFamiliale.mr, prenom: e.target.value }\r\n              }\r\n            })}\r\n            placeholder=\"Pr├®nom\"\r\n          />\r\n        </div>\r\n        <div className=\"form-row\">\r\n          <label>Nom</label>\r\n          <input\r\n            type=\"text\"\r\n            value={situationFamiliale.mr.nom}\r\n            onChange={(e) => updateDossier({\r\n              situationFamiliale: {\r\n                ...situationFamiliale,\r\n                mr: { ...situationFamiliale.mr, nom: e.target.value }\r\n              }\r\n            })}\r\n            placeholder=\"Nom\"\r\n          />\r\n        </div>\r\n        <div className=\"form-row\">\r\n          <label>Date de naissance</label>\r\n          <input\r\n            type=\"date\"\r\n            value={situationFamiliale.mr.dateNaissance}\r\n            onChange={(e) => updateDossier({\r\n              situationFamiliale: {\r\n                ...situationFamiliale,\r\n                mr: { ...situationFamiliale.mr, dateNaissance: e.target.value }\r\n              }\r\n            })}\r\n          />\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"form-section\">\r\n        <h3>Situation</h3>\r\n        <div className=\"form-row\">\r\n          <label>Situation matrimoniale</label>\r\n          <select\r\n            value={situationFamiliale.situationMatrimoniale}\r\n            onChange={(e) => updateDossier({\r\n              situationFamiliale: {\r\n                ...situationFamiliale,\r\n                situationMatrimoniale: e.target.value as typeof situationFamiliale.situationMatrimoniale\r\n              }\r\n            })}\r\n          >\r\n            <option value=\"celibataire\">C├®libataire</option>\r\n            <option value=\"marie\">Mari├®(e)</option>\r\n            <option value=\"pacse\">Pacs├®(e)</option>\r\n            <option value=\"concubinage\">Concubinage</option>\r\n            <option value=\"divorce\">Divorc├®(e)</option>\r\n            <option value=\"veuf\">Veuf/Veuve</option>\r\n          </select>\r\n        </div>\r\n\r\n        {['marie', 'pacse', 'concubinage'].includes(situationFamiliale.situationMatrimoniale) && (\r\n          <div className=\"form-section\">\r\n            <h3>Madame / Partenaire</h3>\r\n            <div className=\"form-row\">\r\n              <label>Pr├®nom</label>\r\n              <input\r\n                type=\"text\"\r\n                value={situationFamiliale.mme?.prenom || ''}\r\n                onChange={(e) => updateDossier({\r\n                  situationFamiliale: {\r\n                    ...situationFamiliale,\r\n                    mme: { \r\n                      ...situationFamiliale.mme || { nom: '', dateNaissance: '' },\r\n                      prenom: e.target.value \r\n                    }\r\n                  }\r\n                })}\r\n                placeholder=\"Pr├®nom\"\r\n              />\r\n            </div>\r\n            <div className=\"form-row\">\r\n              <label>Nom</label>\r\n              <input\r\n                type=\"text\"\r\n                value={situationFamiliale.mme?.nom || ''}\r\n                onChange={(e) => updateDossier({\r\n                  situationFamiliale: {\r\n                    ...situationFamiliale,\r\n                    mme: { \r\n                      ...situationFamiliale.mme || { prenom: '', dateNaissance: '' },\r\n                      nom: e.target.value \r\n                    }\r\n                  }\r\n                })}\r\n                placeholder=\"Nom\"\r\n              />\r\n            </div>\r\n            <div className=\"form-row\">\r\n              <label>Date de naissance</label>\r\n              <input\r\n                type=\"date\"\r\n                value={situationFamiliale.mme?.dateNaissance || ''}\r\n                onChange={(e) => updateDossier({\r\n                  situationFamiliale: {\r\n                    ...situationFamiliale,\r\n                    mme: { \r\n                      ...situationFamiliale.mme || { prenom: '', nom: '' },\r\n                      dateNaissance: e.target.value \r\n                    }\r\n                  }\r\n                })}\r\n              />\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        <div className=\"form-row\">\r\n          <label>Nombre d'enfants</label>\r\n          <input\r\n            type=\"number\"\r\n            min=\"0\"\r\n            value={situationFamiliale.enfants.length}\r\n            onChange={(e) => {\r\n              const count = parseInt(e.target.value) || 0;\r\n              const current = situationFamiliale.enfants;\r\n              let newEnfants = [...current];\r\n              \r\n              if (count > current.length) {\r\n                for (let i = current.length; i < count; i++) {\r\n                  newEnfants.push({ prenom: '', dateNaissance: '', estCommun: true });\r\n                }\r\n              } else {\r\n                newEnfants = newEnfants.slice(0, count);\r\n              }\r\n              \r\n              updateDossier({\r\n                situationFamiliale: { ...situationFamiliale, enfants: newEnfants }\r\n              });\r\n            }}\r\n          />\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction StepCivil({ dossier, updateDossier }: StepProps) {\r\n  const { situationCivile, situationFamiliale } = dossier;\r\n  const isMarie = situationFamiliale.situationMatrimoniale === 'marie';\r\n\r\n  return (\r\n    <div className=\"step-form\">\r\n      <h2>Situation civile</h2>\r\n      \r\n      {isMarie && (\r\n        <div className=\"form-section\">\r\n          <h3>R├®gime matrimonial</h3>\r\n          <div className=\"form-row\">\r\n            <label>R├®gime</label>\r\n            <select\r\n              value={situationCivile.regimeMatrimonial || ''}\r\n              onChange={(e) => updateDossier({\r\n                situationCivile: {\r\n                  ...situationCivile,\r\n                  regimeMatrimonial: e.target.value as typeof situationCivile.regimeMatrimonial\r\n                }\r\n              })}\r\n            >\r\n              <option value=\"\">S├®lectionner...</option>\r\n              <option value=\"communaute_legale\">Communaut├® r├®duite aux acqu├¬ts</option>\r\n              <option value=\"communaute_universelle\">Communaut├® universelle</option>\r\n              <option value=\"separation_biens\">S├®paration de biens</option>\r\n              <option value=\"participation_acquets\">Participation aux acqu├¬ts</option>\r\n            </select>\r\n          </div>\r\n          <div className=\"form-row\">\r\n            <label>\r\n              <input\r\n                type=\"checkbox\"\r\n                checked={situationCivile.contratMariage}\r\n                onChange={(e) => updateDossier({\r\n                  situationCivile: { ...situationCivile, contratMariage: e.target.checked }\r\n                })}\r\n              />\r\n              Contrat de mariage\r\n            </label>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      <div className=\"form-section\">\r\n        <h3>Donations ant├®rieures</h3>\r\n        <p className=\"form-hint\">Les donations r├®alis├®es au cours des 15 derni├¿res ann├®es.</p>\r\n        <button \r\n          className=\"chip\"\r\n          onClick={() => updateDossier({\r\n            situationCivile: {\r\n              ...situationCivile,\r\n              donations: [...situationCivile.donations, {\r\n                id: crypto.randomUUID(),\r\n                type: 'donation_simple',\r\n                date: '',\r\n                montant: 0,\r\n                beneficiaire: ''\r\n              }]\r\n            }\r\n          })}\r\n        >\r\n          + Ajouter une donation\r\n        </button>\r\n        {situationCivile.donations.map((don, idx) => (\r\n          <div key={don.id} className=\"form-card\">\r\n            <div className=\"form-row\">\r\n              <label>Montant</label>\r\n              <input\r\n                type=\"number\"\r\n                value={don.montant}\r\n                onChange={(e) => {\r\n                  const newDonations = [...situationCivile.donations];\r\n                  newDonations[idx] = { ...don, montant: parseFloat(e.target.value) || 0 };\r\n                  updateDossier({ situationCivile: { ...situationCivile, donations: newDonations } });\r\n                }}\r\n              />\r\n            </div>\r\n            <div className=\"form-row\">\r\n              <label>B├®n├®ficiaire</label>\r\n              <input\r\n                type=\"text\"\r\n                value={don.beneficiaire}\r\n                onChange={(e) => {\r\n                  const newDonations = [...situationCivile.donations];\r\n                  newDonations[idx] = { ...don, beneficiaire: e.target.value };\r\n                  updateDossier({ situationCivile: { ...situationCivile, donations: newDonations } });\r\n                }}\r\n              />\r\n            </div>\r\n          </div>\r\n        ))}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction StepActifs({ dossier, updateDossier }: StepProps) {\r\n  const { actifs } = dossier;\r\n  const totalActifs = actifs.reduce((sum, a) => sum + a.valeur, 0);\r\n\r\n  return (\r\n    <div className=\"step-form\">\r\n      <h2>Actifs</h2>\r\n      <div className=\"summary-bar\">\r\n        Total actifs : <strong>{totalActifs.toLocaleString('fr-FR')} Ôé¼</strong>\r\n      </div>\r\n\r\n      <button \r\n        className=\"chip\"\r\n        onClick={() => updateDossier({\r\n          actifs: [...actifs, {\r\n            id: crypto.randomUUID(),\r\n            libelle: '',\r\n            valeur: 0,\r\n            proprietaire: 'commun',\r\n            type: 'autre_financier'\r\n          }]\r\n        })}\r\n      >\r\n        + Ajouter un actif\r\n      </button>\r\n\r\n      {actifs.map((actif, idx) => (\r\n        <div key={actif.id} className=\"form-card\">\r\n          <div className=\"form-row\">\r\n            <label>Libell├®</label>\r\n            <input\r\n              type=\"text\"\r\n              value={actif.libelle}\r\n              onChange={(e) => {\r\n                const newActifs = [...actifs];\r\n                newActifs[idx] = { ...actif, libelle: e.target.value };\r\n                updateDossier({ actifs: newActifs });\r\n              }}\r\n              placeholder=\"Ex: R├®sidence principale\"\r\n            />\r\n          </div>\r\n          <div className=\"form-row\">\r\n            <label>Valeur (Ôé¼)</label>\r\n            <input\r\n              type=\"number\"\r\n              value={actif.valeur}\r\n              onChange={(e) => {\r\n                const newActifs = [...actifs];\r\n                newActifs[idx] = { ...actif, valeur: parseFloat(e.target.value) || 0 };\r\n                updateDossier({ actifs: newActifs });\r\n              }}\r\n            />\r\n          </div>\r\n          <div className=\"form-row\">\r\n            <label>Propri├®taire</label>\r\n            <select\r\n              value={actif.proprietaire}\r\n              onChange={(e) => {\r\n                const newActifs = [...actifs];\r\n                newActifs[idx] = { ...actif, proprietaire: e.target.value as typeof actif.proprietaire };\r\n                updateDossier({ actifs: newActifs });\r\n              }}\r\n            >\r\n              <option value=\"mr\">Monsieur</option>\r\n              <option value=\"mme\">Madame</option>\r\n              <option value=\"commun\">Communaut├®</option>\r\n              <option value=\"indivision\">Indivision</option>\r\n            </select>\r\n          </div>\r\n          <button \r\n            className=\"chip chip-small chip-danger\"\r\n            onClick={() => {\r\n              updateDossier({ actifs: actifs.filter((_, i) => i !== idx) });\r\n            }}\r\n          >\r\n            Supprimer\r\n          </button>\r\n        </div>\r\n      ))}\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction StepPassif({ dossier, updateDossier }: StepProps) {\r\n  const { passif } = dossier;\r\n  const totalPassif = passif.emprunts.reduce((sum, e) => sum + e.capitalRestantDu, 0);\r\n\r\n  return (\r\n    <div className=\"step-form\">\r\n      <h2>Passif</h2>\r\n      <div className=\"summary-bar\">\r\n        Total emprunts CRD : <strong>{totalPassif.toLocaleString('fr-FR')} Ôé¼</strong>\r\n      </div>\r\n\r\n      <button \r\n        className=\"chip\"\r\n        onClick={() => updateDossier({\r\n          passif: {\r\n            ...passif,\r\n            emprunts: [...passif.emprunts, {\r\n              id: crypto.randomUUID(),\r\n              libelle: '',\r\n              type: 'immobilier',\r\n              capitalInitial: 0,\r\n              capitalRestantDu: 0,\r\n              mensualite: 0,\r\n              tauxInteret: 0,\r\n              dateDebut: '',\r\n              dateFin: ''\r\n            }]\r\n          }\r\n        })}\r\n      >\r\n        + Ajouter un emprunt\r\n      </button>\r\n\r\n      {passif.emprunts.map((emprunt, idx) => (\r\n        <div key={emprunt.id} className=\"form-card\">\r\n          <div className=\"form-row\">\r\n            <label>Libell├®</label>\r\n            <input\r\n              type=\"text\"\r\n              value={emprunt.libelle}\r\n              onChange={(e) => {\r\n                const newEmprunts = [...passif.emprunts];\r\n                newEmprunts[idx] = { ...emprunt, libelle: e.target.value };\r\n                updateDossier({ passif: { ...passif, emprunts: newEmprunts } });\r\n              }}\r\n              placeholder=\"Ex: Cr├®dit r├®sidence principale\"\r\n            />\r\n          </div>\r\n          <div className=\"form-row\">\r\n            <label>Capital restant d├╗ (Ôé¼)</label>\r\n            <input\r\n              type=\"number\"\r\n              value={emprunt.capitalRestantDu}\r\n              onChange={(e) => {\r\n                const newEmprunts = [...passif.emprunts];\r\n                newEmprunts[idx] = { ...emprunt, capitalRestantDu: parseFloat(e.target.value) || 0 };\r\n                updateDossier({ passif: { ...passif, emprunts: newEmprunts } });\r\n              }}\r\n            />\r\n          </div>\r\n          <div className=\"form-row\">\r\n            <label>Mensualit├® (Ôé¼)</label>\r\n            <input\r\n              type=\"number\"\r\n              value={emprunt.mensualite}\r\n              onChange={(e) => {\r\n                const newEmprunts = [...passif.emprunts];\r\n                newEmprunts[idx] = { ...emprunt, mensualite: parseFloat(e.target.value) || 0 };\r\n                updateDossier({ passif: { ...passif, emprunts: newEmprunts } });\r\n              }}\r\n            />\r\n          </div>\r\n          <div className=\"form-row\">\r\n            <label>Date de fin</label>\r\n            <input\r\n              type=\"date\"\r\n              value={emprunt.dateFin}\r\n              onChange={(e) => {\r\n                const newEmprunts = [...passif.emprunts];\r\n                newEmprunts[idx] = { ...emprunt, dateFin: e.target.value };\r\n                updateDossier({ passif: { ...passif, emprunts: newEmprunts } });\r\n              }}\r\n            />\r\n          </div>\r\n          <button \r\n            className=\"chip chip-small chip-danger\"\r\n            onClick={() => {\r\n              updateDossier({ \r\n                passif: { \r\n                  ...passif, \r\n                  emprunts: passif.emprunts.filter((_, i) => i !== idx) \r\n                } \r\n              });\r\n            }}\r\n          >\r\n            Supprimer\r\n          </button>\r\n        </div>\r\n      ))}\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction StepFiscalite({ dossier, updateDossier }: StepProps) {\r\n  const { situationFiscale } = dossier;\r\n\r\n  return (\r\n    <div className=\"step-form\">\r\n      <h2>Fiscalit├®</h2>\r\n      \r\n      <div className=\"form-section\">\r\n        <h3>Imp├┤t sur le revenu</h3>\r\n        <div className=\"form-row\">\r\n          <label>Ann├®e de r├®f├®rence</label>\r\n          <input\r\n            type=\"number\"\r\n            value={situationFiscale.anneeReference}\r\n            onChange={(e) => updateDossier({\r\n              situationFiscale: { \r\n                ...situationFiscale, \r\n                anneeReference: parseInt(e.target.value) || new Date().getFullYear() - 1 \r\n              }\r\n            })}\r\n          />\r\n        </div>\r\n        <div className=\"form-row\">\r\n          <label>Revenu fiscal de r├®f├®rence (Ôé¼)</label>\r\n          <input\r\n            type=\"number\"\r\n            value={situationFiscale.revenuFiscalReference}\r\n            onChange={(e) => updateDossier({\r\n              situationFiscale: { \r\n                ...situationFiscale, \r\n                revenuFiscalReference: parseFloat(e.target.value) || 0 \r\n              }\r\n            })}\r\n          />\r\n        </div>\r\n        <div className=\"form-row\">\r\n          <label>Nombre de parts</label>\r\n          <input\r\n            type=\"number\"\r\n            step=\"0.5\"\r\n            min=\"1\"\r\n            value={situationFiscale.nombreParts}\r\n            onChange={(e) => updateDossier({\r\n              situationFiscale: { \r\n                ...situationFiscale, \r\n                nombreParts: parseFloat(e.target.value) || 1 \r\n              }\r\n            })}\r\n          />\r\n        </div>\r\n        <div className=\"form-row\">\r\n          <label>Imp├┤t sur le revenu (Ôé¼)</label>\r\n          <input\r\n            type=\"number\"\r\n            value={situationFiscale.impotRevenu}\r\n            onChange={(e) => updateDossier({\r\n              situationFiscale: { \r\n                ...situationFiscale, \r\n                impotRevenu: parseFloat(e.target.value) || 0 \r\n              }\r\n            })}\r\n          />\r\n        </div>\r\n        <div className=\"form-row\">\r\n          <label>TMI (%)</label>\r\n          <select\r\n            value={situationFiscale.tmi}\r\n            onChange={(e) => updateDossier({\r\n              situationFiscale: { \r\n                ...situationFiscale, \r\n                tmi: parseInt(e.target.value) || 0 \r\n              }\r\n            })}\r\n          >\r\n            <option value=\"0\">0%</option>\r\n            <option value=\"11\">11%</option>\r\n            <option value=\"30\">30%</option>\r\n            <option value=\"41\">41%</option>\r\n            <option value=\"45\">45%</option>\r\n          </select>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"form-section\">\r\n        <h3>Autres imp├┤ts</h3>\r\n        <div className=\"form-row\">\r\n          <label>IFI (Ôé¼)</label>\r\n          <input\r\n            type=\"number\"\r\n            value={situationFiscale.ifi || 0}\r\n            onChange={(e) => updateDossier({\r\n              situationFiscale: { \r\n                ...situationFiscale, \r\n                ifi: parseFloat(e.target.value) || 0 \r\n              }\r\n            })}\r\n          />\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction StepObjectifs({ dossier, updateDossier }: StepProps) {\r\n  const { objectifs, actifs } = dossier;\r\n  \r\n  // D├®tecte si le client a une entreprise\r\n  const hasEntreprise = actifs.some(a => 'type' in a && a.type === 'entreprise');\r\n  \r\n  const allObjectifs: ObjectifClient[] = [\r\n    'proteger_conjoint',\r\n    'proteger_proches',\r\n    'proteger_revenus_sante',\r\n    ...(hasEntreprise ? ['proteger_entreprise', 'proteger_associes'] as ObjectifClient[] : []),\r\n    'preparer_transmission',\r\n    'developper_patrimoine',\r\n    'revenus_differes',\r\n    'revenus_immediats',\r\n    'reduire_fiscalite',\r\n    'reduire_droits_succession',\r\n  ];\r\n\r\n  const toggleObjectif = (obj: ObjectifClient) => {\r\n    const newObjectifs = objectifs.includes(obj)\r\n      ? objectifs.filter(o => o !== obj)\r\n      : [...objectifs, obj];\r\n    updateDossier({ objectifs: newObjectifs });\r\n  };\r\n\r\n  return (\r\n    <div className=\"step-form\">\r\n      <h2>Objectifs client</h2>\r\n      <p className=\"form-hint\">S├®lectionnez les objectifs prioritaires du client.</p>\r\n      \r\n      <div className=\"objectifs-grid\">\r\n        {allObjectifs.map(obj => (\r\n          <label key={obj} className={`objectif-card ${objectifs.includes(obj) ? 'selected' : ''}`}>\r\n            <input\r\n              type=\"checkbox\"\r\n              checked={objectifs.includes(obj)}\r\n              onChange={() => toggleObjectif(obj)}\r\n            />\r\n            <span>{OBJECTIFS_CLIENT_LABELS[obj]}</span>\r\n          </label>\r\n        ))}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\features\\audit\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\features\\audit\\storage.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":49,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":49,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Storage - Export/Import JSON pour sauvegarde locale RGPD\r\n * \r\n * RGPD : pas de stockage serveur des noms clients.\r\n * Les dossiers sont sauvegard├®s localement (fichier JSON).\r\n */\r\n\r\nimport type { DossierAudit } from './types';\r\n\r\nconst SESSION_STORAGE_KEY = 'ser1_audit_draft';\r\n\r\n/**\r\n * Exporte un dossier audit en fichier JSON\r\n */\r\nexport function exportDossierToFile(dossier: DossierAudit, filename?: string): void {\r\n  const data = JSON.stringify(dossier, null, 2);\r\n  const blob = new Blob([data], { type: 'application/json' });\r\n  const url = URL.createObjectURL(blob);\r\n  \r\n  const link = document.createElement('a');\r\n  link.href = url;\r\n  link.download = filename || `audit_${dossier.id.slice(0, 8)}_${new Date().toISOString().split('T')[0]}.json`;\r\n  document.body.appendChild(link);\r\n  link.click();\r\n  document.body.removeChild(link);\r\n  URL.revokeObjectURL(url);\r\n}\r\n\r\n/**\r\n * Importe un dossier audit depuis un fichier JSON\r\n */\r\nexport function importDossierFromFile(file: File): Promise<DossierAudit> {\r\n  return new Promise((resolve, reject) => {\r\n    const reader = new FileReader();\r\n    \r\n    reader.onload = (event) => {\r\n      try {\r\n        const data = JSON.parse(event.target?.result as string);\r\n        \r\n        // Validation basique\r\n        if (!data.id || !data.version || !data.situationFamiliale) {\r\n          throw new Error('Format de fichier invalide');\r\n        }\r\n        \r\n        // Mise ├á jour de la date de modification\r\n        data.dateModification = new Date().toISOString();\r\n        \r\n        resolve(data as DossierAudit);\r\n      } catch (error) {\r\n        reject(new Error('Impossible de lire le fichier. V├®rifiez qu\\'il s\\'agit d\\'un export audit valide.'));\r\n      }\r\n    };\r\n    \r\n    reader.onerror = () => {\r\n      reject(new Error('Erreur de lecture du fichier'));\r\n    };\r\n    \r\n    reader.readAsText(file);\r\n  });\r\n}\r\n\r\n/**\r\n * Sauvegarde le brouillon en session storage (m├®moire temporaire)\r\n */\r\nexport function saveDraftToSession(dossier: DossierAudit): void {\r\n  try {\r\n    sessionStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify(dossier));\r\n  } catch (error) {\r\n    console.warn('Impossible de sauvegarder le brouillon:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Charge le brouillon depuis la session storage\r\n */\r\nexport function loadDraftFromSession(): DossierAudit | null {\r\n  try {\r\n    const data = sessionStorage.getItem(SESSION_STORAGE_KEY);\r\n    if (data) {\r\n      return JSON.parse(data) as DossierAudit;\r\n    }\r\n  } catch (error) {\r\n    console.warn('Impossible de charger le brouillon:', error);\r\n  }\r\n  return null;\r\n}\r\n\r\n/**\r\n * Efface le brouillon de la session storage\r\n */\r\nexport function clearDraftFromSession(): void {\r\n  try {\r\n    sessionStorage.removeItem(SESSION_STORAGE_KEY);\r\n  } catch (error) {\r\n    console.warn('Impossible de supprimer le brouillon:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * V├®rifie si des donn├®es non sauvegard├®es existent\r\n */\r\nexport function hasUnsavedData(): boolean {\r\n  return sessionStorage.getItem(SESSION_STORAGE_KEY) !== null;\r\n}\r\n\r\n/**\r\n * Hook pour l'alerte avant de quitter\r\n */\r\nexport function setupBeforeUnloadWarning(hasChanges: () => boolean): () => void {\r\n  const handler = (event: BeforeUnloadEvent) => {\r\n    if (hasChanges()) {\r\n      event.preventDefault();\r\n      event.returnValue = 'Vous avez des modifications non sauvegard├®es. ├ètes-vous s├╗r de vouloir quitter ?';\r\n      return event.returnValue;\r\n    }\r\n  };\r\n\r\n  window.addEventListener('beforeunload', handler);\r\n  \r\n  return () => {\r\n    window.removeEventListener('beforeunload', handler);\r\n  };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\features\\audit\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\features\\strategy\\StrategyBuilder.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\features\\strategy\\__tests__\\calculations.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\features\\strategy\\__tests__\\recommendations.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\features\\strategy\\calculations.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'patrimoineInitial' is assigned a value but never used.","line":23,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":23,"endColumn":26,"suggestions":[{"messageId":"removeVar","data":{"varName":"patrimoineInitial"},"fix":{"range":[820,873],"text":""},"desc":"Remove unused variable 'patrimoineInitial'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Calculs de projections financi├¿res\r\n * \r\n * Projections simplifi├®es MVP :\r\n * - Baseline : situation actuelle sans intervention\r\n * - Strat├®gie : avec les produits s├®lectionn├®s\r\n */\r\n\r\nimport type { DossierAudit } from '../audit/types';\r\nimport type { ProduitConfig, Projection, Scenario, ComparaisonScenarios } from './types';\r\nimport { calculateIR } from '../../engine/tax';\r\n\r\nconst HORIZON_ANNEES = 10; // Projection sur 10 ans par d├®faut\r\n\r\n/**\r\n * Calcule la projection baseline (sans intervention)\r\n */\r\nexport function calculateBaselineProjection(dossier: DossierAudit): Scenario {\r\n  const projections: Projection[] = [];\r\n  \r\n  const totalActifs = dossier.actifs.reduce((sum, a) => sum + a.valeur, 0);\r\n  const totalPassifs = dossier.passif.emprunts.reduce((sum, e) => sum + e.capitalRestantDu, 0);\r\n  const patrimoineInitial = totalActifs - totalPassifs;\r\n\r\n  // Hypoth├¿ses baseline\r\n  const tauxCroissancePatrimoine = 0.02; // 2% par an (inflation)\r\n  const revenuAnnuel = dossier.situationFiscale.revenuFiscalReference;\r\n\r\n  for (let annee = 0; annee <= HORIZON_ANNEES; annee++) {\r\n    const actifs = totalActifs * Math.pow(1 + tauxCroissancePatrimoine, annee);\r\n    const passifs = totalPassifs * Math.pow(0.95, annee); // Remboursement progressif\r\n    const patrimoineTotal = actifs - passifs;\r\n\r\n    // Calcul IR (simplifi├®, revenu constant)\r\n    const irResult = calculateIR({\r\n      revenuNetImposable: revenuAnnuel,\r\n      nbParts: dossier.situationFiscale.nombreParts,\r\n    });\r\n\r\n    projections.push({\r\n      annee,\r\n      patrimoineTotal,\r\n      actifs,\r\n      passifs,\r\n      revenusAnnuels: revenuAnnuel,\r\n      impotRevenu: irResult.result.impotBrut,\r\n      ifi: dossier.situationFiscale.ifi,\r\n    });\r\n  }\r\n\r\n  return {\r\n    id: 'baseline',\r\n    nom: 'Situation actuelle',\r\n    description: 'Projection sans intervention du CGP',\r\n    projections,\r\n    hypotheses: [\r\n      'Croissance du patrimoine : 2% par an (inflation)',\r\n      'Revenus constants',\r\n      'Remboursement progressif des emprunts',\r\n    ],\r\n  };\r\n}\r\n\r\n/**\r\n * Calcule la projection avec strat├®gie\r\n */\r\nexport function calculateStrategyProjection(\r\n  dossier: DossierAudit,\r\n  produits: ProduitConfig[]\r\n): Scenario {\r\n  const projections: Projection[] = [];\r\n  \r\n  const totalActifs = dossier.actifs.reduce((sum, a) => sum + a.valeur, 0);\r\n  const totalPassifs = dossier.passif.emprunts.reduce((sum, e) => sum + e.capitalRestantDu, 0);\r\n  const revenuAnnuel = dossier.situationFiscale.revenuFiscalReference;\r\n\r\n  // Calcul des versements PER pour d├®duction IR\r\n  const versementsPER = produits\r\n    .filter(p => p.type === 'per')\r\n    .reduce((sum, p) => sum + (p.versementsProgrammes || 0) * 12, 0);\r\n\r\n  const tauxCroissancePatrimoine = 0.03; // 3% avec strat├®gie optimis├®e\r\n\r\n  for (let annee = 0; annee <= HORIZON_ANNEES; annee++) {\r\n    let actifs = totalActifs * Math.pow(1 + tauxCroissancePatrimoine, annee);\r\n    const passifs = totalPassifs * Math.pow(0.95, annee);\r\n\r\n    // Ajout des versements programm├®s capitalis├®s\r\n    produits.forEach(produit => {\r\n      if (produit.versementsProgrammes && annee > 0) {\r\n        const versementsAnnuels = produit.versementsProgrammes * 12;\r\n        const taux = (produit.tauxRendementEstime || 3) / 100;\r\n        const capitalise = versementsAnnuels * ((Math.pow(1 + taux, annee) - 1) / taux);\r\n        actifs += capitalise;\r\n      }\r\n      if (produit.montantInitial && annee > 0) {\r\n        const taux = (produit.tauxRendementEstime || 3) / 100;\r\n        actifs += produit.montantInitial * (Math.pow(1 + taux, annee) - 1);\r\n      }\r\n    });\r\n\r\n    const patrimoineTotal = actifs - passifs;\r\n\r\n    // Calcul IR avec d├®duction PER\r\n    const revenuImposable = Math.max(0, revenuAnnuel - versementsPER);\r\n    const irResult = calculateIR({\r\n      revenuNetImposable: revenuImposable,\r\n      nbParts: dossier.situationFiscale.nombreParts,\r\n    });\r\n\r\n    projections.push({\r\n      annee,\r\n      patrimoineTotal,\r\n      actifs,\r\n      passifs,\r\n      revenusAnnuels: revenuAnnuel,\r\n      impotRevenu: irResult.result.impotBrut,\r\n      ifi: dossier.situationFiscale.ifi,\r\n    });\r\n  }\r\n\r\n  return {\r\n    id: 'strategie',\r\n    nom: 'Strat├®gie CGP',\r\n    description: 'Projection avec mise en place de la strat├®gie',\r\n    projections,\r\n    hypotheses: [\r\n      'Croissance du patrimoine : 3% par an (optimisation)',\r\n      `Versements PER : ${versementsPER.toLocaleString('fr-FR')} Ôé¼ / an`,\r\n      'D├®duction fiscale des versements PER',\r\n      'Rendement moyen des placements : 3%',\r\n    ],\r\n  };\r\n}\r\n\r\n/**\r\n * Compare les deux sc├®narios\r\n */\r\nexport function compareScenarios(\r\n  baseline: Scenario,\r\n  strategie: Scenario\r\n): ComparaisonScenarios {\r\n  const dernierAnneeBaseline = baseline.projections[baseline.projections.length - 1];\r\n  const dernierAnneeStrategie = strategie.projections[strategie.projections.length - 1];\r\n\r\n  const ecartPatrimoine = dernierAnneeStrategie.patrimoineTotal - dernierAnneeBaseline.patrimoineTotal;\r\n\r\n  // Somme des ├®conomies d'imp├┤ts sur la p├®riode\r\n  const economieImpots = baseline.projections.reduce((sum, proj, idx) => {\r\n    return sum + (proj.impotRevenu - strategie.projections[idx].impotRevenu);\r\n  }, 0);\r\n\r\n  // Estimation succession (simplifi├®)\r\n  const economieSuccession = 0; // ├Ç affiner selon les produits\r\n\r\n  return {\r\n    baseline,\r\n    strategie,\r\n    ecarts: {\r\n      patrimoineTotal: ecartPatrimoine,\r\n      economieImpots,\r\n      economieSuccession,\r\n    },\r\n  };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\features\\strategy\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\features\\strategy\\recommendations.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\features\\strategy\\types.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'DossierAudit' is defined but never used.","line":5,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":27,"suggestions":[{"messageId":"removeVar","data":{"varName":"DossierAudit"},"fix":{"range":[67,80],"text":""},"desc":"Remove unused variable 'DossierAudit'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Types pour la Strat├®gie Patrimoniale\r\n */\r\n\r\nimport type { DossierAudit, ObjectifClient } from '../audit/types';\r\n\r\n// Types de produits disponibles (MVP)\r\nexport type ProduitType = \r\n  | 'per'\r\n  | 'assurance_vie'\r\n  | 'cto'\r\n  | 'pea'\r\n  | 'scpi'\r\n  | 'immobilier_locatif'\r\n  | 'donation';\r\n\r\nexport interface ProduitConfig {\r\n  id: string;\r\n  type: ProduitType;\r\n  libelle: string;\r\n  montantInitial?: number;\r\n  versementsProgrammes?: number; // Mensuel\r\n  dureeAnnees?: number;\r\n  tauxRendementEstime?: number;\r\n  fiscaliteEntree?: 'ir' | 'ifi' | 'aucune';\r\n  fiscaliteSortie?: 'ir' | 'ps' | 'pfu' | 'bareme';\r\n  notes?: string;\r\n}\r\n\r\n// Recommandation g├®n├®r├®e par le moteur\r\nexport interface Recommandation {\r\n  id: string;\r\n  titre: string;\r\n  description: string;\r\n  objectifsCibles: ObjectifClient[];\r\n  priorite: 'haute' | 'moyenne' | 'basse';\r\n  produitsAssocies: ProduitType[];\r\n  metriquesImpactees: string[];\r\n  warnings?: string[];\r\n}\r\n\r\n// Strat├®gie compl├¿te\r\nexport interface Strategie {\r\n  id: string;\r\n  dossierAuditId: string;\r\n  dateCreation: string;\r\n  dateModification: string;\r\n  recommandations: Recommandation[];\r\n  produitsSelectionnes: ProduitConfig[];\r\n  notes?: string;\r\n}\r\n\r\n// Projection financi├¿re\r\nexport interface Projection {\r\n  annee: number;\r\n  patrimoineTotal: number;\r\n  actifs: number;\r\n  passifs: number;\r\n  revenusAnnuels: number;\r\n  impotRevenu: number;\r\n  ifi?: number;\r\n  droitsSuccessionEstimes?: number;\r\n}\r\n\r\nexport interface Scenario {\r\n  id: string;\r\n  nom: string;\r\n  description: string;\r\n  projections: Projection[];\r\n  hypotheses: string[];\r\n}\r\n\r\nexport interface ComparaisonScenarios {\r\n  baseline: Scenario;\r\n  strategie: Scenario;\r\n  ecarts: {\r\n    patrimoineTotal: number;\r\n    economieImpots: number;\r\n    economieSuccession: number;\r\n  };\r\n}\r\n\r\n// ├ëtat initial vide\r\nexport function createEmptyStrategie(dossierAuditId: string): Strategie {\r\n  return {\r\n    id: crypto.randomUUID(),\r\n    dossierAuditId,\r\n    dateCreation: new Date().toISOString(),\r\n    dateModification: new Date().toISOString(),\r\n    recommandations: [],\r\n    produitsSelectionnes: [],\r\n  };\r\n}\r\n\r\n// Labels produits\r\nexport const PRODUIT_LABELS: Record<ProduitType, string> = {\r\n  per: 'Plan ├ëpargne Retraite (PER)',\r\n  assurance_vie: 'Assurance-Vie',\r\n  cto: 'Compte-Titres Ordinaire (CTO)',\r\n  pea: 'Plan ├ëpargne Actions (PEA)',\r\n  scpi: 'SCPI',\r\n  immobilier_locatif: 'Immobilier locatif',\r\n  donation: 'Donation',\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\hooks\\usePlacementSettings.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'supabase' is defined but never used.","line":11,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":18,"suggestions":[{"messageId":"removeVar","data":{"varName":"supabase"},"fix":{"range":[330,375],"text":""},"desc":"Remove unused variable 'supabase'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'SUPABASE_TIMEOUT' is assigned a value but never used.","line":17,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":17,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"SUPABASE_TIMEOUT"},"fix":{"range":[588,618],"text":""},"desc":"Remove unused variable 'SUPABASE_TIMEOUT'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'createTimeoutPromise' is defined but never used.","line":19,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":19,"endColumn":30,"suggestions":[{"messageId":"removeVar","data":{"varName":"createTimeoutPromise"},"fix":{"range":[636,786],"text":""},"desc":"Remove unused variable 'createTimeoutPromise'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * usePlacementSettings.js - Hook pour charger les param├¿tres fiscaux du simulateur Placement\r\n * \r\n * Charge les settings depuis Supabase :\r\n * - fiscality_settings (AV, PER, bar├¿mes)\r\n * - ps_settings (pr├®l├¿vements sociaux)\r\n * - tax_settings (bar├¿me IR, TMI)\r\n */\r\n\r\nimport { useState, useEffect, useMemo } from 'react';\r\nimport { supabase } from '../supabaseClient';\r\nimport { extractFiscalParams } from '../engine/placementEngine';\r\nimport { getFiscalSettings, addInvalidationListener } from '../utils/fiscalSettingsCache.js';\r\n\r\n\r\n// Timeout pour ├®viter les blocages Supabase\r\nconst SUPABASE_TIMEOUT = 8000; // 8 secondes\r\n\r\nfunction createTimeoutPromise(ms) {\r\n  return new Promise((_, reject) => {\r\n    setTimeout(() => reject(new Error('Timeout Supabase')), ms);\r\n  });\r\n}\r\n\r\nconst DEFAULT_TMI_OPTIONS = [\r\n  { value: 0, label: '0 %' },\r\n  { value: 0.11, label: '11 %' },\r\n  { value: 0.30, label: '30 %' },\r\n  { value: 0.41, label: '41 %' },\r\n  { value: 0.45, label: '45 %' },\r\n  { value: 0.50, label: '50 %' },\r\n];\r\n\r\n// Valeurs par d├®faut si Supabase ne r├®pond pas (import├®es depuis fiscalSettingsCache.js pour ├®viter la duplication)\r\nconst DEFAULT_FISCALITY_SETTINGS = {\r\n  assuranceVie: {\r\n    retraitsCapital: {\r\n      psRatePercent: 17.2,\r\n      depuis2017: {\r\n        moins8Ans: { irRatePercent: 12.8 },\r\n        plus8Ans: {\r\n          abattementAnnuel: { single: 4600, couple: 9200 },\r\n          primesNettesSeuil: 150000,\r\n          irRateUnderThresholdPercent: 7.5,\r\n          irRateOverThresholdPercent: 12.8,\r\n        },\r\n      },\r\n    },\r\n    deces: {\r\n      primesApres1998: {\r\n        allowancePerBeneficiary: 152500,\r\n        brackets: [\r\n          { upTo: 852500, ratePercent: 20 },\r\n          { upTo: null, ratePercent: 31.25 },\r\n        ],\r\n      },\r\n      apres70ans: { globalAllowance: 30500 },\r\n    },\r\n  },\r\n  perIndividuel: {\r\n    sortieCapital: {\r\n      pfu: { irRatePercent: 12.8, psRatePercent: 17.2 },\r\n    },\r\n  },\r\n  dividendes: {\r\n    abattementBaremePercent: 40,\r\n  },\r\n};\r\n\r\nconst DEFAULT_PS_SETTINGS = {\r\n  patrimony: {\r\n    current: { totalRate: 17.2, csgDeductibleRate: 6.8 },\r\n  },\r\n};\r\n\r\nconst DEFAULT_TAX_SETTINGS = {\r\n  incomeTax: {\r\n    scaleCurrent: [\r\n      { from: 0, to: 11294, rate: 0 },\r\n      { from: 11295, to: 28797, rate: 11 },\r\n      { from: 28798, to: 82341, rate: 30 },\r\n      { from: 82342, to: 177106, rate: 41 },\r\n      { from: 177107, to: null, rate: 45 },\r\n    ],\r\n  },\r\n  dmtg: {\r\n    abattementLigneDirecte: 100000,\r\n    scale: [\r\n      { from: 0, to: 8072, rate: 5 },\r\n      { from: 8072, to: 12109, rate: 10 },\r\n      { from: 12109, to: 15932, rate: 15 },\r\n      { from: 15932, to: 552324, rate: 20 },\r\n      { from: 552324, to: 902838, rate: 30 },\r\n      { from: 902838, to: 1805677, rate: 40 },\r\n      { from: 1805677, to: null, rate: 45 },\r\n    ],\r\n  },\r\n};\r\n\r\nfunction buildTmiOptionsFromBareme(bareme) {\r\n  const effectiveBareme = Array.isArray(bareme) && bareme.length\r\n    ? bareme\r\n    : DEFAULT_TAX_SETTINGS.incomeTax.scaleCurrent;\r\n\r\n  if (!effectiveBareme || !effectiveBareme.length) {\r\n    return DEFAULT_TMI_OPTIONS;\r\n  }\r\n\r\n  const uniqueRates = Array.from(\r\n    new Set(\r\n      effectiveBareme\r\n        .map((tranche) => (typeof tranche.rate === 'number' ? tranche.rate / 100 : null))\r\n        .filter((rate) => rate !== null && !Number.isNaN(rate))\r\n    )\r\n  ).sort((a, b) => a - b);\r\n\r\n  if (!uniqueRates.length) {\r\n    return DEFAULT_TMI_OPTIONS;\r\n  }\r\n\r\n  return uniqueRates.map((rate) => ({\r\n    value: rate,\r\n    label: `${Math.round(rate * 100)} %`,\r\n  }));\r\n}\r\n\r\n/**\r\n * Hook pour charger et g├®rer les settings du simulateur Placement\r\n * @returns {Object} { fiscalParams, taxSettings, loading, error }\r\n */\r\nexport function usePlacementSettings() {\r\n  const [fiscalitySettings, setFiscalitySettings] = useState(DEFAULT_FISCALITY_SETTINGS);\r\n  const [psSettings, setPsSettings] = useState(DEFAULT_PS_SETTINGS);\r\n  const [taxSettings, setTaxSettings] = useState(DEFAULT_TAX_SETTINGS);\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState(null);\r\n\r\n  useEffect(() => {\r\n    let mounted = true;\r\n\r\n    async function loadSettings() {\r\n      try {\r\n        setLoading(true);\r\n        setError(null);\r\n        const settings = await getFiscalSettings();\r\n        if (!mounted) return;\r\n        setFiscalitySettings(settings.fiscality);\r\n        setPsSettings(settings.ps);\r\n        setTaxSettings(settings.tax);\r\n        setLoading(false);\r\n      } catch (e) {\r\n        if (mounted) {\r\n          console.error('[Placement] Erreur critique chargement settings:', e);\r\n          setError('Erreur lors du chargement des param├¿tres fiscaux.');\r\n          setLoading(false);\r\n        }\r\n      }\r\n    }\r\n\r\n    loadSettings();\r\n    return () => { mounted = false; };\r\n  }, []);\r\n\r\n  // Invalidation cache apr├¿s mise ├á jour admin\r\n  useEffect(() => {\r\n    const remove = addInvalidationListener((kind) => {\r\n      if (['tax', 'ps', 'fiscality'].includes(kind)) {\r\n        getFiscalSettings({ force: true }).then((settings) => {\r\n          setFiscalitySettings(settings.fiscality);\r\n          setPsSettings(settings.ps);\r\n          setTaxSettings(settings.tax);\r\n        });\r\n      }\r\n    });\r\n    return remove;\r\n  }, []);\r\n\r\n  // Extraire les param├¿tres normalis├®s pour le moteur de calcul\r\n  const fiscalParams = useMemo(() => {\r\n    const params = extractFiscalParams(fiscalitySettings, psSettings);\r\n    // Ajouter les param├¿tres DMTG depuis tax_settings\r\n    const dmtg = taxSettings?.dmtg || DEFAULT_TAX_SETTINGS.dmtg;\r\n    params.dmtgAbattementLigneDirecte = dmtg.abattementLigneDirecte || 100000;\r\n    params.dmtgScale = dmtg.scale || DEFAULT_TAX_SETTINGS.dmtg.scale;\r\n    return params;\r\n  }, [fiscalitySettings, psSettings, taxSettings]);\r\n\r\n  // Extraire le bar├¿me IR pour calculer la TMI\r\n  const baremIR = useMemo(() => {\r\n    return taxSettings?.incomeTax?.scaleCurrent || DEFAULT_TAX_SETTINGS.incomeTax.scaleCurrent;\r\n  }, [taxSettings]);\r\n\r\n  const tmiOptions = useMemo(() => buildTmiOptionsFromBareme(baremIR), [baremIR]);\r\n\r\n  return {\r\n    fiscalParams,\r\n    fiscalitySettings,\r\n    psSettings,\r\n    taxSettings,\r\n    baremIR,\r\n    tmiOptions,\r\n    loading,\r\n    error,\r\n  };\r\n}\r\n\r\n/**\r\n * Calcule la TMI ├á partir d'un revenu imposable et du bar├¿me\r\n * @param {number} revenuImposable - Revenu net imposable\r\n * @param {number} parts - Nombre de parts fiscales\r\n * @param {Array} bareme - Bar├¿me IR\r\n * @returns {number} TMI en d├®cimal (ex: 0.30 pour 30%)\r\n */\r\nexport function calculTMI(revenuImposable, parts = 1, bareme) {\r\n  let effectiveBareme = bareme;\r\n  if (!effectiveBareme || !effectiveBareme.length) {\r\n    effectiveBareme = DEFAULT_TAX_SETTINGS.incomeTax.scaleCurrent;\r\n  }\r\n  if (!effectiveBareme || !effectiveBareme.length) {\r\n    return 0.30; // ultime filet\r\n  }\r\n\r\n  const quotient = revenuImposable / parts;\r\n  let tmi = 0;\r\n\r\n  for (const tranche of effectiveBareme) {\r\n    if (tranche.to === null || quotient <= tranche.to) {\r\n      tmi = tranche.rate / 100;\r\n      break;\r\n    }\r\n  }\r\n\r\n  return tmi;\r\n}\r\n\r\nexport default usePlacementSettings;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\hooks\\useTheme.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'useState' is defined but never used.","line":8,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":18,"suggestions":[{"messageId":"removeVar","data":{"varName":"useState"},"fix":{"range":[193,202],"text":""},"desc":"Remove unused variable 'useState'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'useEffect' is defined but never used.","line":8,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":29,"suggestions":[{"messageId":"removeVar","data":{"varName":"useEffect"},"fix":{"range":[201,212],"text":""},"desc":"Remove unused variable 'useEffect'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'useMemo' is defined but never used.","line":8,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":38,"suggestions":[{"messageId":"removeVar","data":{"varName":"useMemo"},"fix":{"range":[212,221],"text":""},"desc":"Remove unused variable 'useMemo'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'supabase' is defined but never used.","line":9,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":18,"suggestions":[{"messageId":"removeVar","data":{"varName":"supabase"},"fix":{"range":[239,284],"text":""},"desc":"Remove unused variable 'supabase'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Hook pour g├®rer les th├¿mes et couleurs personnalis├®es\r\n * \r\n * ÔÜá´©Å D├ëSACTIV├ë - Utiliser ThemeProvider ├á la place\r\n * Ce hook cr├®ait des conflits de chargement multiples\r\n */\r\n\r\nimport { useState, useEffect, useMemo } from 'react';\r\nimport { supabase } from '../supabaseClient';\r\n\r\n// Th├¿me par d├®faut (fallback) - couleurs SER1 d'origine\r\nconst DEFAULT_THEME = {\r\n  name: 'default',\r\n  colors: {\r\n    primary: '#2B3E37',      // Couleur 1\r\n    primaryHover: '#1f2d28',\r\n    secondary: '#709B8B',    // Couleur 2\r\n    accent: '#9FBDB2',       // Couleur 3\r\n    background: '#CFDED8',   // Couleur 4\r\n    surface: '#788781',      // Couleur 5\r\n    text: '#000000',         // Couleur 10\r\n    textMuted: '#7F7F7F',    // Couleur 9\r\n    border: '#D9D9D9',       // Couleur 8\r\n    success: '#2B3E37',      // R├®utiliser Couleur 1\r\n    warning: '#CEC1B6',      // Couleur 6\r\n    error: '#dc2626'         // Rouge standard pour les erreurs\r\n  }\r\n};\r\n\r\nexport function useTheme() {\r\n  // ÔÜá´©Å Hook d├®sactiv├® - utilisez ThemeProvider\r\n  console.warn('[useTheme] Hook d├®sactiv├® - utilisez ThemeProvider ├á la place');\r\n  \r\n  return {\r\n    theme: DEFAULT_THEME,\r\n    colors: DEFAULT_THEME.colors,\r\n    loading: false,\r\n    error: null,\r\n    cssVariables: {},\r\n    saveTheme: async () => ({ success: false, error: 'Hook d├®sactiv├®' }),\r\n    resetToDefault: async () => ({ success: false, error: 'Hook d├®sactiv├®' }),\r\n    isCustom: false\r\n  };\r\n}\r\n\r\nexport { DEFAULT_THEME };\r\nexport default useTheme;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\icons\\business\\businessIconLibrary.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\main.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pages\\Credit.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'STORE_KEY'. Either include it or remove the dependency array.","line":301,"column":6,"nodeType":"ArrayExpression","endLine":301,"endColumn":139,"suggestions":[{"desc":"Update the dependencies array to be: [hydrated, startYM, assurMode, creditType, capital, duree, taux, tauxAssur, mensuBase, pretsPlus, lisserPret1, viewMode, lissageMode, STORE_KEY]","fix":{"range":[10967,11100],"text":"[hydrated, startYM, assurMode, creditType, capital, duree, taux, tauxAssur, mensuBase, pretsPlus, lisserPret1, viewMode, lissageMode, STORE_KEY]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has a missing dependency: 'tauxAssur'. Either include it or remove the dependency array.","line":463,"column":6,"nodeType":"ArrayExpression","endLine":466,"endColumn":4,"suggestions":[{"desc":"Update the dependencies array to be: [effectiveCapitalPret1, r, rA, N, assurMode, creditType, lisserPret1, anyInfine, autresRows, lissageMode, tauxAssur, mensuBaseEffectivePret1]","fix":{"range":[17624,17769],"text":"[effectiveCapitalPret1, r, rA, N, assurMode, creditType, lisserPret1, anyInfine, autresRows, lissageMode, tauxAssur, mensuBaseEffectivePret1]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has an unnecessary dependency: 'N'. Either exclude it or remove the dependency array.","line":494,"column":6,"nodeType":"ArrayExpression","endLine":494,"endColumn":88,"suggestions":[{"desc":"Update the dependencies array to be: [pret1Rows, autresRows, pretsPlus, assurMode, effectiveCapitalPret1, tauxAssur]","fix":{"range":[18697,18779],"text":"[pret1Rows, autresRows, pretsPlus, assurMode, effectiveCapitalPret1, tauxAssur]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has a missing dependency: 'aggregateToYears'. Either include it or remove the dependency array.","line":540,"column":68,"nodeType":"ArrayExpression","endLine":540,"endColumn":86,"suggestions":[{"desc":"Update the dependencies array to be: [aggregateToYears, agrRows]","fix":{"range":[20695,20713],"text":"[aggregateToYears, agrRows]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has a missing dependency: 'attachMonthLabels'. Either include it or remove the dependency array.","line":544,"column":6,"nodeType":"ArrayExpression","endLine":544,"endColumn":51,"suggestions":[{"desc":"Update the dependencies array to be: [aggregatedYears, agrRows, attachMonthLabels, isAnnual]","fix":{"range":[20840,20885],"text":"[aggregatedYears, agrRows, attachMonthLabels, isAnnual]"}}]}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'STORE_KEY'. Either include it or remove the dependency array.","line":293,"column":6,"nodeType":"ArrayExpression","endLine":293,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [STORE_KEY]","fix":{"range":[10688,10690],"text":"[STORE_KEY]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useMemo, useState } from \"react\"\r\nimport { onResetEvent, storageKeyFor } from '../utils/reset.js'\r\nimport { toNumber } from '../utils/number.js'\r\nimport { useTheme } from '../settings/ThemeProvider'\r\nimport { supabase } from '../supabaseClient'\r\nimport { ExportMenu } from '../components/ExportMenu'\r\n\r\n// V4: PPTX/Excel imports moved to dynamic import() in export functions\r\nimport { computeCapitalDecesSchedule, computeGlobalCapitalDecesSchedule } from '../engine/credit/capitalDeces';\r\nimport './Credit.css'\r\n\r\n/* ---------- Helpers format ---------- */\r\nconst fmt0  = (n)=> (Math.round(Number(n)||0)).toLocaleString('fr-FR')\r\nconst euro0 = (n)=> fmt0(n) + ' Ôé¼'\r\nconst toNum = (v)=> toNumber(v, 0)\r\nconst rid = () => Math.random().toString(36).slice(2,9)\r\n\r\n/* Date utils (YYYY-MM) */\r\nfunction nowYearMonth(){\r\n  const d = new Date()\r\n  const m = String(d.getMonth()+1).padStart(2,'0')\r\n  return `${d.getFullYear()}-${m}`\r\n}\r\nfunction addMonths(ym, k){\r\n  const [y,m] = ym.split('-').map(Number)\r\n  const d = new Date(y, m-1 + k, 1)\r\n  const mm = String(d.getMonth()+1).padStart(2,'0')\r\n  return `${d.getFullYear()}-${mm}`\r\n}\r\nfunction labelMonthFR(ym){\r\n  const [y,m] = ym.split('-').map(Number)\r\n  return `${String(m).padStart(2,'0')}/${y}`\r\n}\r\nfunction labelYear(ym){ return ym.split('-')[0] }\r\nfunction monthsDiff(a, b){\r\n  const [ya,ma] = a.split('-').map(Number)\r\n  const [yb,mb] = b.split('-').map(Number)\r\n  return (yb-ya)*12 + (mb-ma)\r\n}\r\n\r\n/* ===============================\r\n   Formules & ├®ch├®anciers\r\n================================ */\r\nfunction mensualiteAmortissable(C, r, N) {\r\n  if (N <= 0) return 0\r\n  if (r === 0) return C / N\r\n  return (C * r) / (1 - Math.pow(1 + r, -N))\r\n}\r\n\r\nfunction scheduleAmortissable({ capital, r, rAss, N, assurMode, mensuOverride }) {\r\n  const rows = []\r\n  let crd = Math.max(0, capital)\r\n  const mensuFixe = (typeof mensuOverride === 'number' && mensuOverride > 0)\r\n    ? mensuOverride\r\n    : mensualiteAmortissable(capital, r, N)\r\n\r\n  const assurFixe = (assurMode === 'CI') ? (capital * rAss) : null\r\n  const EPS = 1e-8\r\n\r\n  for (let m = 1; m <= N; m++) {\r\n    if (crd <= EPS) break\r\n\r\n    const crdStart = crd\r\n    const interet  = crdStart * r\r\n    let mensu      = mensuFixe\r\n\r\n    // borne derni├¿re ├®ch├®ance\r\n    const maxMensu = interet + crdStart\r\n    if (mensu > maxMensu) mensu = maxMensu\r\n    if (mensu < interet && r > 0) mensu = interet\r\n\r\n    let amort = Math.max(0, mensu - interet)\r\n    if (amort > crdStart) amort = crdStart\r\n\r\n    const crdEnd = Math.max(0, crdStart - amort)\r\n    const assur  = (assurMode === 'CI') ? assurFixe : (crdStart * rAss) // assurance CRD d├®but\r\n\r\n    const mensuTotal = mensu + (assur || 0)\r\n    rows.push({ mois:m, interet, assurance:(assur||0), amort, mensu, mensuTotal, crd: crdEnd })\r\n    crd = crdEnd\r\n  }\r\n  return rows\r\n}\r\n\r\nfunction scheduleInFine({ capital, r, rAss, N, assurMode, mensuOverride }) {\r\n  const rows = []\r\n  let crd = Math.max(0, capital)\r\n  const assurFixe = (assurMode === 'CI') ? (capital * rAss) : null\r\n  const EPS = 1e-8\r\n\r\n  for (let m = 1; m <= N; m++) {\r\n    if (crd <= EPS) break\r\n\r\n    const crdStart = crd\r\n    const interet  = crdStart * r\r\n    let mensu = (typeof mensuOverride === 'number' && mensuOverride > 0) ? mensuOverride : interet\r\n\r\n    const maxMensu = interet + (m === N ? crdStart : 0) // borne si derni├¿re\r\n    if (mensu > maxMensu) mensu = maxMensu\r\n    if (mensu < interet && r > 0) mensu = interet\r\n\r\n    let amort = 0\r\n    if (m === N) {\r\n      amort = crdStart\r\n      mensu = interet + amort\r\n    } else if (mensu > interet) {\r\n      amort = Math.min(crdStart, mensu - interet)\r\n    }\r\n\r\n    const crdEnd = Math.max(0, crdStart - amort)\r\n    const assur  = (assurMode === 'CI') ? assurFixe : (crdStart * rAss) // assurance CRD d├®but\r\n\r\n    const mensuTotal = mensu + (assur || 0)\r\n    rows.push({ mois:m, interet, assurance:(assur||0), amort, mensu, mensuTotal, crd: crdEnd })\r\n    crd = crdEnd\r\n  }\r\n  return rows\r\n}\r\n\r\n// === LISSAGE : MENSUALIT├ë TOTALE CONSTANTE (avec assurance tous pr├¬ts) ===\r\nfunction scheduleLisseePret1({ pret1, autresPretsRows, cibleMensuTotale }) {\r\n  const { capital, r, rAss, N, assurMode, type } = pret1\r\n  const rows = []\r\n\r\n  let crd = Math.max(0, capital)\r\n  const assurFixe = (assurMode === 'CI') ? (capital * rAss) : null\r\n  const EPS = 1e-8\r\n\r\n  // Utilise mensuTotal (avec assurance) pour le lissage global\r\n  const mensuAutresAt = (m) =>\r\n    autresPretsRows.reduce((s, arr) => s + ((arr[m-1]?.mensuTotal) || 0), 0)\r\n\r\n  for (let m = 1; m <= N; m++) {\r\n    if (crd <= EPS) break\r\n\r\n    const crdStart = crd\r\n    const interet  = crdStart * r\r\n    const autres   = mensuAutresAt(m)\r\n\r\n    // part pr├¬t 1 = cible - autres (hors assurance)\r\n    let mensu1 = Math.max(0, cibleMensuTotale - autres)\r\n\r\n    // bornes ┬½ s├╗ret├® ┬╗\r\n    const capMensu = interet + crdStart\r\n    if (mensu1 > capMensu) mensu1 = capMensu\r\n    if (type !== 'infine' && m < N && mensu1 < interet) mensu1 = interet\r\n    if (type === 'infine' && mensu1 < interet) mensu1 = interet\r\n    if (m === N) mensu1 = Math.min(mensu1, capMensu)\r\n\r\n    const amort  = Math.max(0, mensu1 - interet)\r\n    const crdEnd = Math.max(0, crdStart - amort)\r\n\r\n    // assurance sur le pr├¬t 1 uniquement\r\n    const assur = (assurMode === 'CI') ? assurFixe : (crdStart * rAss)\r\n    const mensuTotal = mensu1 + (assur || 0)\r\n\r\n    rows.push({ mois:m, interet, assurance:(assur||0), amort, mensu:mensu1, mensuTotal, crd:crdEnd })\r\n    crd = crdEnd\r\n  }\r\n  return rows\r\n}\r\n\r\n// ---- ├ëch├®ancier liss├® avec \"T\" constant (dur├®e conserv├®e, avec assurance tous pr├¬ts) ----\r\nfunction scheduleLisseePret1Duration({ basePret1, autresPretsRows, totalConst }) {\r\n  const { capital, r, rAss, N, assurMode } = basePret1\r\n  const rows = []\r\n\r\n  let crd = Math.max(0, capital)\r\n  const assurFixe = (assurMode === 'CI') ? (capital * rAss) : null\r\n\r\n  const EPS = 1e-8\r\n  // Utilise mensuTotal (avec assurance) pour le lissage global\r\n  const sumAutres = (m) => autresPretsRows.reduce((s, arr) => s + ((arr[m - 1]?.mensuTotal) || 0), 0)\r\n\r\n  for (let m = 1; m <= N; m++) {\r\n    if (crd <= EPS) break\r\n\r\n    const crdStart = crd\r\n    const interet  = crdStart * r\r\n    const autres   = sumAutres(m)\r\n\r\n    let mensu1 = totalConst - autres\r\n\r\n    if (m < N && mensu1 < interet) mensu1 = interet\r\n    const capMensu = interet + crdStart\r\n    if (mensu1 > capMensu) mensu1 = capMensu\r\n    if (m === N) mensu1 = Math.min(mensu1, interet + crdStart)\r\n\r\n    const amort = Math.max(0, mensu1 - interet)\r\n    const crdEnd = Math.max(0, crdStart - amort)\r\n\r\n    const assur = (assurMode === 'CI') ? assurFixe : (crdStart * rAss)\r\n    const mensuTotal = mensu1 + (assur || 0)\r\n\r\n    rows.push({ mois:m, interet, assurance:(assur||0), amort, mensu:mensu1, mensuTotal, crd:crdEnd })\r\n    crd = crdEnd\r\n  }\r\n  return rows\r\n}\r\n\r\n// ---- Annuit├® totale \"T\" (fermeture analytique) qui garantit CRD_N = 0 (avec assurance tous pr├¬ts) ----\r\nfunction totalConstantForDuration({ basePret1, autresPretsRows }) {\r\n  const { capital: B0, r, N } = basePret1\r\n  const pow = Math.pow(1 + r, N)\r\n\r\n  let A = 0 // somme des poids a_t = (1+r)^(N-t)\r\n  let B = 0 // somme des o_t * a_t\r\n\r\n  for (let t = 1; t <= N; t++) {\r\n    const a = Math.pow(1 + r, N - t)\r\n    A += a\r\n    // Utilise mensuTotal (avec assurance) pour le lissage global\r\n    const autres = autresPretsRows.reduce((s, arr) => s + ((arr[t - 1]?.mensuTotal) || 0), 0)\r\n    B += autres * a\r\n  }\r\n  return (B0 * pow + B) / A\r\n}\r\n\r\n/* ===============================\r\n   Page Cr├®dit\r\n================================ */\r\nexport default function Credit(){\r\n\r\n/* ---- THEME ---- */\r\nconst { colors: themeColors, logo, setLogo, cabinetLogo, themeSource, pptxColors } = useTheme()\r\n\r\n/* ---- ├ëTATS ---- */\r\nconst [startYM, setStartYM]         = useState(nowYearMonth()) // Date souscription pr├¬t 1\r\nconst [assurMode, setAssurMode]     = useState('CRD')          // 'CI' | 'CRD'\r\nconst [creditType, setCreditType]   = useState('amortissable') // type pr├¬t 1\r\n\r\nconst [capital, setCapital]         = useState(300000)\r\nconst [duree, setDuree]             = useState(240)\r\nconst [taux, setTaux]               = useState(3.50)\r\nconst [tauxAssur, setTauxAssur]     = useState(0.30)\r\nconst [mensuBase, setMensuBase]     = useState('')             // saisie mensu pr├¬t 1\r\n\r\n// ├ëtat \"touched\" pour tracker si l'utilisateur a interagi avec les champs\r\nconst [touched, setTouched]         = useState({ capital: false, duree: false })\r\n\r\nconst [rawTauxPlus, setRawTauxPlus] = useState({}); // par pr├¬t id -> string\r\nconst [rawTauxAssurPlus, setRawTauxAssurPlus] = useState({}); // par pr├¬t id -> string pour taux assurance\r\n\r\n//  version normalis├®e d├¿s lÔÇÖaffichage\r\nconst [rawTaux, setRawTaux] = useState(Number(taux).toFixed(2).replace('.', ','));\r\nconst [rawTauxAssur, setRawTauxAssur] = useState(Number(tauxAssur).toFixed(2).replace('.', ','));\r\n\r\n// Sync initial / reset\r\nuseEffect(() => {\r\n  setRawTaux((Number(taux).toFixed(2)).toString());\r\n}, [taux, tauxAssur]);\r\n \r\n  // pr├¬ts additionnels : + type & startYM\r\n  const [pretsPlus, setPretsPlus]     = useState([])             // [{id,capital,duree,taux,startYM,type}]\r\n  const [lisserPret1, setLisserPret1] = useState(false)\r\n  const [viewMode, setViewMode]       = useState('mensuel')      // 'mensuel' | 'annuel'\r\n  const [lissageMode, setLissageMode] = useState('mensu')        // 'mensu' | 'duree'\r\n\r\n  // --- Export Loading state\r\n  const [exportLoading, setExportLoading] = useState(false)\r\n\r\n  // --- Si plus de pr├¬t 2/3, ├®teindre le lissage s'il ├®tait ON\r\n  useEffect(() => {\r\n    if (pretsPlus.length === 0 && lisserPret1) setLisserPret1(false)\r\n  }, [pretsPlus.length, lisserPret1])\r\n\r\n  // PERSISTENCE\r\n  const STORE_KEY = storageKeyFor('credit')\r\n  const [hydrated, setHydrated] = useState(false)\r\n  useEffect(()=>{\r\n    try{\r\n      const raw = sessionStorage.getItem(STORE_KEY)\r\n      if(raw){\r\n        const s = JSON.parse(raw)\r\n        if (s && typeof s === 'object'){\r\n          setStartYM(s.startYM ?? nowYearMonth())\r\n          setAssurMode(s.assurMode ?? 'CRD')\r\n          setCreditType(s.creditType ?? 'amortissable')\r\n          setCapital(s.capital ?? 300000)\r\n          setDuree(s.duree ?? 240)\r\n          setTaux(s.taux ?? 3.5)\r\n          setTauxAssur(s.tauxAssur ?? 0.3)\r\n          setMensuBase(s.mensuBase ?? '')\r\n          setPretsPlus(Array.isArray(s.pretsPlus) ? s.pretsPlus : [])\r\n          setLisserPret1(!!s.lisserPret1)\r\n          setViewMode(s.viewMode ?? 'mensuel')\r\n          setLissageMode(s.lissageMode ?? 'mensu')\r\n        }\r\n      }\r\n    }catch{}\r\n    setHydrated(true)\r\n  // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [])\r\n  useEffect(()=>{\r\n    if(!hydrated) return\r\n    try{\r\n      sessionStorage.setItem(STORE_KEY, JSON.stringify({\r\n        startYM, assurMode, creditType, capital, duree, taux, tauxAssur, mensuBase, pretsPlus, lisserPret1, viewMode, lissageMode\r\n      }))\r\n    }catch{}\r\n  }, [hydrated, startYM, assurMode, creditType, capital, duree, taux, tauxAssur, mensuBase, pretsPlus, lisserPret1, viewMode, lissageMode])\r\n\r\n// Reset global (ne r├®initialise que les champs saisissables du simulateur CR├ëDIT)\r\nuseEffect(() => {\r\n  const off = onResetEvent?.(({ simId }) => {\r\n    // Ne r├®agit qu'au reset du simulateur \"credit\"\r\n    if (simId && simId !== 'credit') return;\r\n\r\n    const ym = nowYearMonth();\r\n\r\n    // champs \"saisissables\" du pr├¬t 1\r\n    setStartYM(ym);\r\n    setCapital(0);\r\n    setDuree(0);\r\n    setTaux(0);\r\n    setTauxAssur(0);\r\n    setMensuBase('');\r\n\r\n    // pr├¬ts additionnels : on efface tout\r\n    setPretsPlus([]);\r\n\r\n    // champs \"bruts\" utilis├®s pour la saisie des taux\r\n    setRawTauxPlus({});\r\n    setRawTauxAssurPlus({});\r\n\r\n    // R├®initialiser l'├®tat touched\r\n    setTouched({ capital: false, duree: false });\r\n\r\n    // on nettoie aussi le sessionStorage pour repartir d'une feuille blanche\r\n    try {\r\n      sessionStorage.removeItem(STORE_KEY);\r\n    } catch {}\r\n\r\n    // On ne touche PAS ├á :\r\n    // - assurMode\r\n    // - creditType\r\n    // - lisserPret1 (sera remis ├á false automatiquement si plus de pr├¬ts)\r\n    // - viewMode\r\n    // - lissageMode\r\n  });\r\n\r\n  return off || (() => {});\r\n}, [STORE_KEY]);\r\n\r\n\r\n  /* ---- Handlers born├®s ---- */\r\n  const onChangeCapital = (val) => setCapital(toNum(String(val).replace(/\\D/g,'').slice(0,8)))\r\n  const onChangeDuree   = (val) => setDuree(Math.max(1, toNum(String(val).replace(/\\D/g,'').slice(0,3))))\r\n  /* ---- Taux mensuels & param├¿tres ---- */\r\n  const rAn  = Math.max(0, Number(taux) || 0)/100\r\n  const rAss = Math.max(0, Number(tauxAssur) || 0)/100\r\n  const r    = rAn / 12\r\n  const rA   = rAss / 12\r\n  const N    = Math.max(1, Math.floor(duree || 0))\r\n\r\n  /* ---- Mensualit├® base pr├¬t 1 + capital recalcul├® si mensu saisie ---- */\r\n  const mensuHorsAssurance_base = useMemo(()=>{\r\n    if (creditType === 'infine') return r === 0 ? 0 : capital * r\r\n    return mensualiteAmortissable(capital, r, N)\r\n  }, [creditType, capital, r, N])\r\n\r\n  const effectiveCapitalPret1 = useMemo(()=>{\r\n    const hasOthers = pretsPlus.length > 0\r\n    const mensuUser = toNum(mensuBase)\r\n    if (!mensuUser || hasOthers) return capital\r\n    if (creditType === 'infine') return (r === 0) ? capital : Math.floor(mensuUser / r)\r\n    if (r === 0) return Math.floor(mensuUser * N)\r\n    return Math.floor(mensuUser * (1 - Math.pow(1+r, -N)) / r)\r\n  }, [capital, pretsPlus.length, mensuBase, creditType, r, N])\r\n\r\n  const mensuBaseEffectivePret1 = useMemo(()=>{\r\n    const hasOthers = pretsPlus.length > 0\r\n    const mensuUser = toNum(mensuBase)\r\n    return hasOthers ? mensuHorsAssurance_base : (mensuUser || mensuHorsAssurance_base)\r\n  }, [pretsPlus.length, mensuBase, mensuHorsAssurance_base])\r\n\r\n  function shiftRows(rows, offset){\r\n    if (offset === 0) return rows.slice()\r\n    if (offset > 0) return Array.from({length:offset}, () => null).concat(rows)\r\n    return rows.slice(-offset)\r\n  }\r\n  const autresRows = useMemo(()=>{\r\n    return pretsPlus.map(p=>{\r\n      const rM = (Math.max(0, Number(p.taux)||0)/100)/12\r\n      const Np = Math.max(1, Math.floor(toNum(p.duree)||0))\r\n      const C  = Math.max(0, toNum(p.capital))\r\n      const type = p.type || creditType\r\n      \r\n      // Assurance pr├¬t additionnel : utilise tauxAssur et assurMode du pr├¬t (d├®faut: 0, CRD)\r\n      const pTauxAssur = Math.max(0, Number(p.tauxAssur) || 0)\r\n      const pAssurMode = p.assurMode || 'CRD'\r\n      const rAssP = pTauxAssur / 100 / 12\r\n\r\n      const baseRows = (type === 'infine')\r\n        ? scheduleInFine({ capital:C, r:rM, rAss:rAssP, N:Np, assurMode: pAssurMode })\r\n        : scheduleAmortissable({ capital:C, r:rM, rAss:rAssP, N:Np, assurMode: pAssurMode })\r\n\r\n      // Calcule les capitaux d├®c├¿s avec la source de v├®rit├® unique\r\n      const loanParams = {\r\n        capital: C,\r\n        tauxAssur: pTauxAssur,\r\n        assurMode: pAssurMode\r\n      };\r\n      const rowsWithDeces = computeCapitalDecesSchedule(loanParams, baseRows);\r\n      \r\n      const rows = rowsWithDeces.map(row => ({\r\n        ...row,\r\n        // assuranceDeces est d├®j├á calcul├® par computeCapitalDecesSchedule\r\n      }))\r\n\r\n      const off = monthsDiff(startYM, p.startYM || startYM)\r\n      return shiftRows(rows, off)\r\n    })\r\n  }, [pretsPlus, creditType, startYM])\r\n\r\n  /* ---- Pr├¬t 1 : base (sans lissage) ---- */\r\n  const basePret1Rows = useMemo(() => {\r\n    const base = { capital: effectiveCapitalPret1, r, rAss: rA, N, assurMode, type: creditType }\r\n    return (creditType === 'infine')\r\n      ? scheduleInFine({ ...base, mensuOverride: mensuHorsAssurance_base })\r\n      : scheduleAmortissable({ ...base, mensuOverride: mensuHorsAssurance_base })\r\n  }, [effectiveCapitalPret1, r, rA, N, assurMode, creditType, mensuHorsAssurance_base])\r\n\r\n  // === Statut In fine global (d├®sactive le lissage partout)\r\n  const pret1IsInfine = (creditType === 'infine')\r\n  const anyInfine = pret1IsInfine || pretsPlus.some(p => (p?.type || '') === 'infine')\r\n\r\n  // Si un pr├¬t est In fine ÔåÆ on coupe le lissage si ON\r\n  useEffect(()=>{\r\n    if (anyInfine && lisserPret1) setLisserPret1(false)\r\n  }, [anyInfine, lisserPret1])\r\n\r\n  /* ---- Pr├¬t 1 (standard ou liss├®) ---- */\r\n  const pret1Rows = useMemo(() => {\r\n    const basePret1 = { capital: effectiveCapitalPret1, r, rAss:rA, N, assurMode, type: creditType }\r\n\r\n    // Pas de lissage (ou impossible) ou pas d'autres pr├¬ts => ├®ch├®ancier standard\r\n    let rows\r\n    if (!lisserPret1 || anyInfine || autresRows.length === 0) {\r\n      rows = (creditType === 'infine')\r\n        ? scheduleInFine({ ...basePret1, mensuOverride: mensuBaseEffectivePret1 })\r\n        : scheduleAmortissable({ ...basePret1, mensuOverride: mensuBaseEffectivePret1 })\r\n    } else if (lissageMode === 'mensu') {\r\n      // Utilise mensuTotal (avec assurance) pour la cible de lissage\r\n      const mensuAutresM1 = autresRows.reduce((s, arr) => s + ((arr[0]?.mensuTotal) || 0), 0)\r\n      const cible = mensuBaseEffectivePret1 + mensuAutresM1\r\n      rows = scheduleLisseePret1({ pret1: basePret1, autresPretsRows: autresRows, cibleMensuTotale: cible })\r\n    } else {\r\n      const T = totalConstantForDuration({ basePret1, autresPretsRows: autresRows })\r\n      rows = scheduleLisseePret1Duration({ basePret1, autresPretsRows: autresRows, totalConst: T })\r\n    }\r\n\r\n    // Calcule les capitaux d├®c├¿s avec la source de v├®rit├® unique\r\n      const loanParams = {\r\n        capital: effectiveCapitalPret1,\r\n        tauxAssur: tauxAssur, // D├®j├á en % annuel\r\n        assurMode: assurMode\r\n      };\r\n      const rowsWithDeces = computeCapitalDecesSchedule(loanParams, rows);\r\n      \r\n      return rowsWithDeces\r\n\r\n  }, [\r\n    effectiveCapitalPret1, r, rA, N, assurMode, creditType,\r\n    mensuBaseEffectivePret1, lisserPret1, autresRows, lissageMode, anyInfine\r\n  ])\r\n\r\n  // Dur├®es & diff├®rence\r\n  const dureeBaseMois  = basePret1Rows.length\r\n  const dureeLisseMois = pret1Rows.length\r\n  const diffDureesMois = dureeLisseMois - dureeBaseMois\r\n\r\n  /* ---- Table mensuelle agr├®g├®e ---- */\r\n  const agrRows = useMemo(()=>{\r\n    // Pr├®pare les param├¿tres pour tous les pr├¬ts\r\n    const allLoansParams = [\r\n      {\r\n        capital: effectiveCapitalPret1,\r\n        tauxAssur: tauxAssur,\r\n        assurMode: assurMode\r\n      },\r\n      ...pretsPlus.map(p => ({\r\n        capital: Math.max(0, toNum(p.capital)),\r\n        tauxAssur: Math.max(0, Number(p.tauxAssur) || 0),\r\n        assurMode: p.assurMode || 'CRD'\r\n      }))\r\n    ];\r\n    \r\n    // Pr├®pare les ├®ch├®anciers bruts pour tous les pr├¬ts\r\n    const allSchedules = [pret1Rows, ...autresRows];\r\n    \r\n    // Calcule l'├®ch├®ancier global avec capitaux d├®c├¿s unifi├®s\r\n    return computeGlobalCapitalDecesSchedule(allLoansParams, allSchedules);\r\n  }, [pret1Rows, autresRows, pretsPlus, N, assurMode, effectiveCapitalPret1, tauxAssur])\r\n\r\n  /* ---- Agr├®gation annuelle (si besoin) ---- */\r\n  function aggregateToYears(rows) {\r\n    const map = new Map()\r\n    rows.forEach((r, idx) => {\r\n      const ym = addMonths(startYM, idx)\r\n      const year = labelYear(ym)\r\n      const cur = map.get(year) || { interet:0, assurance:0, amort:0, mensu:0, mensuTotal:0, crd:0, assuranceDeces:null }\r\n      cur.interet    += r.interet\r\n      cur.assurance  += r.assurance\r\n      cur.amort      += r.amort\r\n      cur.assuranceDeces = r.assuranceDeces ?? cur.assuranceDeces ?? null\r\n      cur.mensu      += r.mensu\r\n      cur.mensuTotal += r.mensuTotal\r\n      cur.crd         = r.crd\r\n      map.set(year, cur)\r\n    })\r\n    return Array.from(map.entries()).map(([year, v])=> ({ periode: year, ...v }))\r\n  }\r\n  function attachMonthLabels(rows){\r\n    return rows.map((r, idx)=> ({ periode: labelMonthFR(addMonths(startYM, idx)), ...r }))\r\n}\r\n\r\n // Agr├¿ge des rows (format {interet, assurance, amort, mensu, mensuTotal, crd}) par ann├®e\r\nfunction aggregateToYearsFromRows(rows, startYMBase) {\r\n  const map = new Map();\r\n  rows.forEach((r, idx) => {\r\n    if (!r) return;\r\n    const ym = addMonths(startYMBase, idx);\r\n    const year = labelYear(ym);\r\n    const acc = map.get(year) || { interet:0, assurance:0, amort:0, mensu:0, mensuTotal:0, crd:0, assuranceDeces:null };\r\n    acc.interet    += r.interet || 0;\r\n    acc.assurance  += r.assurance || 0;\r\n    acc.amort      += r.amort || 0;\r\n    acc.mensu      += r.mensu || 0;\r\n    acc.mensuTotal += r.mensuTotal || 0;\r\n    // on prend le dernier CRD / capital d├®c├¿s de l'ann├®e\r\n    acc.crd         = r.crd || acc.crd || 0;\r\n    acc.assuranceDeces = r.assuranceDeces ?? acc.assuranceDeces ?? null;\r\n    map.set(year, acc);\r\n  });\r\n  return Array.from(map.entries()).map(([periode, v]) => ({ periode, ...v }));\r\n}\r\n \r\n  const isAnnual = viewMode === 'annuel'\r\n  const aggregatedYears = useMemo(() => aggregateToYears(agrRows), [agrRows, startYM])\r\n  const tableDisplay = useMemo(()=>{\r\n    if (isAnnual) return aggregatedYears\r\n    return attachMonthLabels(agrRows)\r\n  }, [aggregatedYears, agrRows, isAnnual, startYM])\r\n\r\n  /* ---- Synth├¿se ---- */\r\n  const mensualiteTotaleM1 = (pret1Rows[0]?.mensu || 0) + autresRows.reduce((s,arr)=> s + ((arr[0]?.mensu) || 0), 0)\r\n  const firstYearAggregate = isAnnual ? aggregatedYears[0] : null\r\n  // Valeurs d'affichage selon mode (mensuel/annuel)\r\n  const montantPrincipalAff = isAnnual ? (firstYearAggregate?.mensu || 0) : mensualiteTotaleM1;\r\n  \r\n  // Assurance mensuelle M1 tous pr├¬ts\r\n  const primeAssMensuellePret1 = (pret1Rows[0]?.assurance || 0)\r\n  const primeAssMensuelleAutres = autresRows.reduce((s,arr)=> s + ((arr[0]?.assurance) || 0), 0)\r\n  const primeAssMensuelle = primeAssMensuellePret1 + primeAssMensuelleAutres\r\n  const primeAssAff = isAnnual ? (firstYearAggregate?.assurance || 0) : primeAssMensuelle;\r\n  \r\n  const pret1Interets      = pret1Rows.reduce((s,l)=> s + (l.interet   || 0), 0)\r\n  const pret1Assurance     = pret1Rows.reduce((s,l)=> s + (l.assurance || 0), 0)\r\n  \r\n  // Totaux assurance et int├®r├¬ts tous pr├¬ts (pour synth├¿se globale)\r\n  const autresInterets = autresRows.reduce((total, arr) => \r\n    total + arr.reduce((s, row) => s + ((row?.interet) || 0), 0), 0)\r\n  const autresAssurance = autresRows.reduce((total, arr) => \r\n    total + arr.reduce((s, row) => s + ((row?.assurance) || 0), 0), 0)\r\n  const totalInterets = pret1Interets + autresInterets\r\n  const totalAssurance = pret1Assurance + autresAssurance\r\n  const coutTotalCredit = totalInterets + totalAssurance\r\n\r\n  // Annuit├® max (hors assurance) pour la vue annuelle\r\n  // === Tableau des p├®riodes (affich├® sÔÇÖil y a ÔëÑ1 pr├¬t additionnel)\r\nconst synthesePeriodes = useMemo(() => {\r\n  if (pretsPlus.length === 0) return []\r\n\r\n  // 1) Points de rupture : 0 + d├®but/fin effectifs (relatifs ├á startYM) de chaque pr├¬t 2/3\r\n  const changeSet = new Set([0])\r\n\r\n  pretsPlus.forEach(p => {\r\n    const offRaw = monthsDiff(startYM, p.startYM || startYM) // peut ├¬tre n├®gatif si le pr├¬t a d├®j├á commenc├®\r\n    const Np     = Math.max(1, Math.floor(toNum(p.duree) || 0))\r\n\r\n    // D├®but ÔÇ£vu depuis startYMÔÇØ (si pr├¬t d├®j├á en cours, cÔÇÖest 0)\r\n    const startIdx = Math.max(0, offRaw)\r\n\r\n    // Fin ÔÇ£vu depuis startYMÔÇØ\r\n    // - si offRaw < 0  => endIdx = Np + offRaw (mois restants)\r\n    // - si offRaw >= 0 => endIdx = offRaw + Np\r\n    const endIdx = Math.max(0, offRaw + Np)\r\n\r\n    changeSet.add(startIdx)\r\n    changeSet.add(endIdx)\r\n  })\r\n\r\n  // 2) On garde seulement les points dans lÔÇÖhorizon simul├®\r\n  const maxLen = Math.max(pret1Rows.length, ...autresRows.map(a => a.length), N)\r\n  const points = Array.from(changeSet)\r\n    .sort((a, b) => a - b)\r\n    .filter(x => x < maxLen)\r\n\r\n  // 3) Mat├®rialise les lignes avec leurs mensualit├®s ├á ces points\r\n  const rows = points.map(t => {\r\n    const ym = addMonths(startYM, t)\r\n    const p1 = pret1Rows[t]?.mensu || 0\r\n    const p2 = autresRows[0]?.[t]?.mensu || 0\r\n    const p3 = autresRows[1]?.[t]?.mensu || 0\r\n    return { from: `├Ç partir de ${labelMonthFR(ym)}`, p1, p2, p3 }\r\n  })\r\n\r\n  // 4) D├®dupe les lignes cons├®cutives identiques\r\n  const dedup = []\r\n  for (const r of rows) {\r\n    const last = dedup[dedup.length - 1]\r\n    if (last && last.p1 === r.p1 && last.p2 === r.p2 && last.p3 === r.p3) continue\r\n    dedup.push(r)\r\n  }\r\n  return dedup\r\n}, [pretsPlus, startYM, pret1Rows, autresRows, N])\r\n\r\n  /* ---- V├®rifications ---- */\r\n  const warnings = useMemo(() => {\r\n    const w = []\r\n    // N'afficher l'alerte que si l'utilisateur a interagi avec le champ (onBlur)\r\n    if (touched.capital && (effectiveCapitalPret1 || 0) <= 0) w.push('Le capital du pr├¬t 1 doit ├¬tre > 0.')\r\n    if (touched.duree && (N || 0) <= 0) w.push('La dur├®e (mois) doit ├¬tre > 0.')\r\n    if (creditType === 'amortissable') {\r\n      const m1 = pret1Rows?.[0]?.mensu ?? 0\r\n      const i1 = pret1Rows?.[0]?.interet ?? 0\r\n      if (m1 < i1 - 1e-6) w.push('La mensualit├® du pr├¬t 1 est inf├®rieure aux int├®r├¬ts du premier mois.')\r\n    }\r\n    pretsPlus.forEach((p, idx) => {\r\n      const k = idx + 2\r\n      if ((toNum(p.capital) || 0) <= 0)  w.push(`Le capital du pr├¬t ${k} doit ├¬tre > 0.`)\r\n      if ((toNum(p.duree)   || 0) <= 0)  w.push(`La dur├®e du pr├¬t ${k} doit ├¬tre > 0.`)\r\n    })\r\n    return w\r\n  }, [effectiveCapitalPret1, N, creditType, pret1Rows, pretsPlus, touched])\r\n\r\n  /* ---- Actions pr├¬ts additionnels ---- */\r\n  const addPret = () => {\r\n    if (pretsPlus.length >= 2) return\r\n    setPretsPlus(arr => [...arr, {\r\n      id: rid(), capital: 100000, duree: 120, taux: 2.50,\r\n      startYM, type: creditType,\r\n      tauxAssur: 0, assurMode: 'CRD'  // Assurance d├®sactiv├®e par d├®faut (z├®ro r├®gression)\r\n    }])\r\n  }\r\n  const updatePret = (id, patch) => setPretsPlus(arr => arr.map(p => p.id === id ? ({ ...p, ...patch }) : p))\r\n  const removePret = (id) => setPretsPlus(arr => arr.filter(p => p.id !== id))\r\n  // Transpose un array-of-arrays (pour les ├®ch├®anciers : p├®riodes en colonnes)\r\n  function transpose(aoa) {\r\n    if (!aoa.length) return aoa;\r\n    const rows = aoa.length;\r\n    const cols = Math.max(...aoa.map(r => r.length));\r\n    const out = Array.from({ length: cols }, () => Array(rows).fill(''));\r\n    for (let r = 0; r < rows; r++) {\r\n      for (let c = 0; c < cols; c++) {\r\n        out[c][r] = aoa[r][c] ?? '';\r\n      }\r\n    }\r\n    return out;\r\n  }\r\n\r\n  /* ---- Export Excel (.xlsx) ---- */\r\n\r\n  const cell = (v, style) => ({ v, style });\r\n\r\n  async function exportExcel() {\r\n    setExportLoading(true);\r\n    try {\r\n      // V4: Dynamic import Excel builder\r\n      const { buildXlsxBlob, downloadXlsx, validateXlsxBlob } = await import('../utils/xlsxBuilder');\r\n      const headerResume = [\r\n        cell('P├®riode', 'sHeader'),\r\n        cell('Int├®r├¬ts', 'sHeader'),\r\n        cell('Assurance', 'sHeader'),\r\n        cell('Amort.', 'sHeader'),\r\n        cell(isAnnual ? 'Annuit├®' : 'Mensualit├®', 'sHeader'),\r\n        cell(isAnnual ? 'Annuit├® + Assur.' : 'Mensualit├® + Assur.', 'sHeader'),\r\n        cell('CRD total', 'sHeader'),\r\n        cell('Assurance d├®c├¿s', 'sHeader'),\r\n      ];\r\n      const headerPret = [\r\n        cell('P├®riode', 'sHeader'),\r\n        cell('Int├®r├¬ts', 'sHeader'),\r\n        cell('Assurance', 'sHeader'),\r\n        cell('Amort.', 'sHeader'),\r\n        cell(isAnnual ? 'Annuit├®' : 'Mensualit├®', 'sHeader'),\r\n        cell(isAnnual ? 'Annuit├® + Assur.' : 'Mensualit├® + Assur.', 'sHeader'),\r\n        cell('CRD', 'sHeader'),\r\n        cell('Capitaux d├®c├¿s', 'sHeader'),\r\n      ];\r\n\r\n      // 0) Onglet PARAM├êTRES : tout ce qui est saisi par lÔÇÖutilisateur\r\n      const headerParams = [cell('Champ', 'sHeader'), cell('Valeur', 'sHeader')];\r\n      const rowsParams = [];\r\n\r\n      // Pr├¬t 1\r\n      rowsParams.push([cell('Pr├¬t 1', 'sSection'), cell('', 'sSection')]);\r\n      rowsParams.push([cell('Type de cr├®dit (Pr├¬t 1)', 'sText'), cell(creditType === 'amortissable' ? 'Amortissable' : 'In fine', 'sText')]);\r\n      rowsParams.push([cell('Date de souscription (Pr├¬t 1)', 'sText'), cell(startYM ? labelMonthFR(startYM) : '', 'sText')]);\r\n      rowsParams.push([cell('Dur├®e (mois) ÔÇö Pr├¬t 1', 'sText'), cell(duree, 'sCenter')]);\r\n      rowsParams.push([cell('Montant emprunt├® (Pr├¬t 1)', 'sText'), cell(toNum(capital), 'sMoney')]);\r\n      rowsParams.push([cell('Taux annuel (cr├®dit) ÔÇö Pr├¬t 1', 'sText'), cell((Number(taux) || 0) / 100, 'sPercent')]);\r\n      rowsParams.push([cell('Mensualit├® (hors assurance) ÔÇö Pr├¬t 1', 'sText'), cell(toNum(mensuBase), 'sMoney')]);\r\n      rowsParams.push([cell('Mensualit├® totale estim├®e', 'sText'), cell(Math.round(mensuHorsAssurance_base + primeAssMensuelle), 'sMoney')]);\r\n      rowsParams.push([cell(\"Mode de lÔÇÖassurance (Pr├¬t 1)\", 'sText'), cell(assurMode === 'CI' ? 'Capital initial' : 'Capital restant d├╗', 'sText')]);\r\n      rowsParams.push([cell('Taux annuel (assurance) ÔÇö Pr├¬t 1', 'sText'), cell((Number(tauxAssur) || 0) / 100, 'sPercent')]);\r\n      rowsParams.push([cell('Vue', 'sText'), cell(isAnnual ? 'Vue annuelle' : 'Vue mensuelle', 'sText')]);\r\n      rowsParams.push([cell('Lissage pr├¬t 1', 'sText'), cell(lisserPret1 ? (lissageMode === 'mensu' ? 'Mensualit├® constante' : 'Dur├®e constante') : 'Aucun', 'sText')]);\r\n\r\n      // Pr├¬ts additionnels (Pr├¬t 2 / Pr├¬t 3)\r\n      pretsPlus.forEach((p, idx) => {\r\n        const k = idx + 2;\r\n        const type = p.type || creditType;\r\n        const pAssurMode = p.assurMode || 'CRD';\r\n        rowsParams.push([cell(`Pr├¬t ${k}`, 'sSection'), cell('', 'sSection')]);\r\n        rowsParams.push([cell(`Pr├¬t ${k} - Type de cr├®dit`, 'sText'), cell(type === 'amortissable' ? 'Amortissable' : 'In fine', 'sText')]);\r\n        rowsParams.push([cell(`Pr├¬t ${k} - Montant emprunt├®`, 'sText'), cell(toNum(p.capital), 'sMoney')]);\r\n        rowsParams.push([cell(`Pr├¬t ${k} - Dur├®e (mois)`, 'sText'), cell(toNum(p.duree), 'sCenter')]);\r\n        rowsParams.push([cell(`Pr├¬t ${k} - Taux annuel (cr├®dit)`, 'sText'), cell((Number(p.taux || 0) || 0) / 100, 'sPercent')]);\r\n        rowsParams.push([cell(`Pr├¬t ${k} - Taux annuel (assurance)`, 'sText'), cell((Number(p.tauxAssur || 0) || 0) / 100, 'sPercent')]);\r\n        rowsParams.push([cell(`Pr├¬t ${k} - Mode assurance`, 'sText'), cell(pAssurMode === 'CI' ? 'Capital initial' : 'Capital restant d├╗', 'sText')]);\r\n        rowsParams.push([cell(`Pr├¬t ${k} - Date de souscription`, 'sText'), cell(p.startYM ? labelMonthFR(p.startYM) : '', 'sText')]);\r\n      });\r\n\r\n      // 1) R├®sum├® : ce qui est affich├® dans le tableau principal\r\n      const resumeRows = tableDisplay.map((l) => [\r\n        cell(l.periode, 'sCenter'),\r\n        cell(Math.round(l.interet), 'sMoney'),\r\n        cell(Math.round(l.assurance), 'sMoney'),\r\n        cell(Math.round(l.amort), 'sMoney'),\r\n        cell(Math.round(l.mensu), 'sMoney'),\r\n        cell(Math.round(l.mensuTotal), 'sMoney'),\r\n        cell(Math.round(l.crd), 'sMoney'),\r\n        cell(Math.round(l.assuranceDeces ?? 0), 'sMoney'),\r\n      ]);\r\n\r\n      // 2) D├®tail par pr├¬t selon la vue actuelle\r\n      const pret1Arr = (isAnnual\r\n        ? aggregateToYearsFromRows(pret1Rows, startYM)\r\n        : attachMonthLabels(pret1Rows)\r\n      ).map((l) => [\r\n        cell(l.periode, 'sCenter'),\r\n        cell(Math.round(l.interet), 'sMoney'),\r\n        cell(Math.round(l.assurance), 'sMoney'),\r\n        cell(Math.round(l.amort), 'sMoney'),\r\n        cell(Math.round(l.mensu), 'sMoney'),\r\n        cell(Math.round(l.mensuTotal), 'sMoney'),\r\n        cell(Math.round(l.crd), 'sMoney'),\r\n        cell(Math.round(l.assuranceDeces ?? 0), 'sMoney'),\r\n      ]);\r\n\r\n      const pret2Arr = (autresRows[0]\r\n        ? isAnnual\r\n          ? aggregateToYearsFromRows(autresRows[0], startYM)\r\n          : attachMonthLabels(autresRows[0])\r\n        : []\r\n      ).map((l) => [\r\n        cell(l.periode, 'sCenter'),\r\n        cell(Math.round(l?.interet ?? 0), 'sMoney'),\r\n        cell(Math.round(l?.assurance ?? 0), 'sMoney'),\r\n        cell(Math.round(l?.amort ?? 0), 'sMoney'),\r\n        cell(Math.round(l?.mensu ?? 0), 'sMoney'),\r\n        cell(Math.round(l?.mensuTotal ?? 0), 'sMoney'),\r\n        cell(Math.round(l?.crd ?? 0), 'sMoney'),\r\n        cell(Math.round(l?.assuranceDeces ?? 0), 'sMoney'),\r\n      ]);\r\n\r\n      const pret3Arr = (autresRows[1]\r\n        ? isAnnual\r\n          ? aggregateToYearsFromRows(autresRows[1], startYM)\r\n          : attachMonthLabels(autresRows[1])\r\n        : []\r\n      ).map((l) => [\r\n        cell(l.periode, 'sCenter'),\r\n        cell(Math.round(l?.interet ?? 0), 'sMoney'),\r\n        cell(Math.round(l?.assurance ?? 0), 'sMoney'),\r\n        cell(Math.round(l?.amort ?? 0), 'sMoney'),\r\n        cell(Math.round(l?.mensu ?? 0), 'sMoney'),\r\n        cell(Math.round(l?.mensuTotal ?? 0), 'sMoney'),\r\n        cell(Math.round(l?.crd ?? 0), 'sMoney'),\r\n        cell(Math.round(l?.assuranceDeces ?? 0), 'sMoney'),\r\n      ]);\r\n\r\n      const sheets = [\r\n        {\r\n          name: 'Param├¿tres',\r\n          rows: [headerParams, ...rowsParams],\r\n          columnWidths: [36, 22],\r\n        },\r\n        {\r\n          name: 'R├®sum├®',\r\n          rows: transpose([headerResume, ...resumeRows]),\r\n          columnWidths: [18, 14, 14, 14, 14, 14, 14, 14],\r\n        },\r\n        {\r\n          name: 'Pr├¬t 1',\r\n          rows: transpose([headerPret, ...pret1Arr]),\r\n          columnWidths: [18, 14, 14, 14, 14, 14, 14, 14],\r\n        },\r\n        ...(pretsPlus.length > 0\r\n          ? [\r\n              {\r\n                name: 'Pr├¬t 2',\r\n                rows: transpose([headerPret, ...pret2Arr]),\r\n                columnWidths: [18, 14, 14, 14, 14, 14, 14, 14],\r\n              },\r\n            ]\r\n          : []),\r\n        ...(pretsPlus.length > 1\r\n          ? [\r\n              {\r\n                name: 'Pr├¬t 3',\r\n                rows: transpose([headerPret, ...pret3Arr]),\r\n                columnWidths: [18, 14, 14, 14, 14, 14, 14, 14],\r\n              },\r\n            ]\r\n          : []),\r\n      ];\r\n\r\n      const blob = await buildXlsxBlob({\r\n        sheets,\r\n        headerFill: themeColors?.c1,\r\n        sectionFill: themeColors?.c7,\r\n      });\r\n      const isValid = await validateXlsxBlob(blob);\r\n      if (!isValid) {\r\n        throw new Error('XLSX invalide (signature PK manquante).');\r\n      }\r\n      downloadXlsx(blob, `SER1_${isAnnual ? 'Annuel' : 'Mensuel'}.xlsx`);\r\n    } catch (e) {\r\n      console.error('Export Excel ├®chou├®', e);\r\n      alert('Impossible de g├®n├®rer le fichier Excel.');\r\n    } finally {\r\n      setExportLoading(false);\r\n    }\r\n  }\r\n\r\n  async function exportPowerPoint() {\r\n    setExportLoading(true);\r\n    try {\r\n      // V4: Dynamic import PPTX builders\r\n      const [{ buildCreditStudyDeck }, { exportAndDownloadStudyDeck }] = await Promise.all([\r\n        import('../pptx/presets/creditDeckBuilder'),\r\n        import('../pptx/export/exportStudyDeck')\r\n      ]);\r\n      \r\n      // Build PPTX colors from theme\r\n      // V3.3: Logo resolution based on themeSource\r\n      // Priority: cabinet logo > user logo > undefined\r\n      let exportLogo\r\n      if (themeSource === 'cabinet') {\r\n        // Mode cabinet: priorit├® logo cabinet, fallback logo user\r\n        exportLogo = cabinetLogo || logo\r\n      } else {\r\n        // Mode custom: logo user uniquement\r\n        exportLogo = logo\r\n      }\r\n      \r\n      // TRACE: Log exact logo being used for debugging\r\n      console.info('[Credit Export] exportLogo resolved =', exportLogo \r\n        ? (exportLogo.startsWith('data:') ? `dataURI (${exportLogo.length} chars)` : exportLogo.substring(0, 80) + '...')\r\n        : '(none)')\r\n      console.info('[Credit Export] themeSource:', themeSource, '| cabinetLogo:', !!cabinetLogo, '| userLogo:', !!logo)\r\n      \r\n      // Fallback: reload from user_metadata if still undefined\r\n      if (!exportLogo) {\r\n        console.info('[Credit Export] No logo in context, attempting reload from user_metadata...')\r\n        try {\r\n          const { data: { user } } = await supabase.auth.getUser()\r\n          if (user?.user_metadata?.cover_slide_url) {\r\n            exportLogo = user.user_metadata.cover_slide_url\r\n            setLogo(exportLogo)\r\n            console.info('[Credit Export] Logo reloaded from user_metadata')\r\n          }\r\n        } catch (logoError) {\r\n          console.warn('[Credit Export] Failed to reload logo:', logoError)\r\n        }\r\n      }\r\n\r\n      // Build amortization rows for TOTAL (annual aggregation)\r\n      const amortizationRowsTotal = aggregatedYears.map(row => ({\r\n        periode: row.periode,\r\n        interet: row.interet,\r\n        assurance: row.assurance,\r\n        amort: row.amort,\r\n        annuite: row.mensu,\r\n        annuiteTotale: row.mensuTotal,\r\n        crd: row.crd,\r\n      }))\r\n\r\n      // Build per-loan amortization rows\r\n      const pret1AggregatedYears = aggregateToYearsFromRows(pret1Rows, startYM)\r\n      const amortizationRowsPret1 = pret1AggregatedYears.map(row => ({\r\n        periode: row.periode,\r\n        interet: row.interet,\r\n        assurance: row.assurance,\r\n        amort: row.amort,\r\n        annuite: row.mensu,\r\n        annuiteTotale: row.mensuTotal,\r\n        crd: row.crd,\r\n      }))\r\n\r\n      // Calculate total capital (all loans)\r\n      const totalCapital = effectiveCapitalPret1 + pretsPlus.reduce((s, p) => s + toNum(p.capital), 0)\r\n      \r\n      // Calculate max duration across all loans\r\n      const maxDureeMois = Math.max(N, ...pretsPlus.map(p => toNum(p.duree) || 0))\r\n\r\n      // Build loans array for multi-loan PPTX\r\n      const loans = [\r\n        {\r\n          index: 1,\r\n          capital: effectiveCapitalPret1,\r\n          dureeMois: N,\r\n          tauxNominal: taux,\r\n          tauxAssurance: tauxAssur,\r\n          creditType: creditType,\r\n          assuranceMode: assurMode,\r\n          mensualiteHorsAssurance: mensuHorsAssurance_base,\r\n          mensualiteTotale: mensuHorsAssurance_base + primeAssMensuellePret1,\r\n          coutInterets: pret1Interets,\r\n          coutAssurance: pret1Assurance,\r\n          amortizationRows: amortizationRowsPret1,\r\n        },\r\n        ...pretsPlus.map((p, idx) => {\r\n          const pRows = autresRows[idx] || []\r\n          const pAggregated = aggregateToYearsFromRows(pRows.filter(r => r), startYM)\r\n          const pInterets = pRows.reduce((s, row) => s + ((row?.interet) || 0), 0)\r\n          const pAssurance = pRows.reduce((s, row) => s + ((row?.assurance) || 0), 0)\r\n          return {\r\n            index: idx + 2,\r\n            capital: toNum(p.capital),\r\n            dureeMois: toNum(p.duree),\r\n            tauxNominal: Number(p.taux) || 0,\r\n            tauxAssurance: Number(p.tauxAssur) || 0,\r\n            creditType: p.type || creditType,\r\n            assuranceMode: p.assurMode || 'CRD',\r\n            mensualiteHorsAssurance: pRows[0]?.mensu || 0,\r\n            mensualiteTotale: pRows[0]?.mensuTotal || 0,\r\n            coutInterets: pInterets,\r\n            coutAssurance: pAssurance,\r\n            amortizationRows: pAggregated.map(row => ({\r\n              periode: row.periode,\r\n              interet: row.interet,\r\n              assurance: row.assurance,\r\n              amort: row.amort,\r\n              annuite: row.mensu,\r\n              annuiteTotale: row.mensuTotal,\r\n              crd: row.crd,\r\n            })),\r\n          }\r\n        })\r\n      ]\r\n\r\n      // Build payment periods for timeline visualization\r\n      const paymentPeriods = synthesePeriodes.map(p => ({\r\n        label: p.from,\r\n        mensualitePret1: p.p1,\r\n        mensualitePret2: p.p2,\r\n        mensualitePret3: p.p3,\r\n        total: p.p1 + p.p2 + p.p3,\r\n      }))\r\n\r\n      const assuranceDecesByYear = aggregatedYears.map((row) => row?.assuranceDeces ?? 0);\r\n\r\n      // Build credit data for PPTX with full multi-loan support\r\n      const creditData = {\r\n        // Global totals\r\n        totalCapital,\r\n        maxDureeMois,\r\n        coutTotalInterets: totalInterets,\r\n        coutTotalAssurance: totalAssurance,\r\n        coutTotalCredit: coutTotalCredit,\r\n        assuranceDecesByYear,\r\n        \r\n        // Smoothing info\r\n        smoothingEnabled: lisserPret1 && pretsPlus.length > 0,\r\n        smoothingMode: lissageMode,\r\n        \r\n        // Per-loan data\r\n        loans,\r\n        \r\n        // Payment periods timeline\r\n        paymentPeriods,\r\n        \r\n        // Total amortization (aggregated all loans)\r\n        amortizationRows: amortizationRowsTotal,\r\n        \r\n        // Legacy fields for backward compatibility\r\n        capitalEmprunte: totalCapital,\r\n        dureeMois: maxDureeMois,\r\n        tauxNominal: taux,\r\n        tauxAssurance: tauxAssur,\r\n        mensualiteHorsAssurance: mensuHorsAssurance_base,\r\n        mensualiteTotale: mensuHorsAssurance_base + primeAssMensuelle,\r\n        creditType: creditType,\r\n        assuranceMode: assurMode,\r\n        \r\n        clientName: undefined,\r\n      }\r\n\r\n      // Build deck spec with logo from ThemeProvider\r\n      const deck = buildCreditStudyDeck(creditData, pptxColors, exportLogo)\r\n\r\n      // Generate filename with date\r\n      const dateStr = new Date().toISOString().split('T')[0].replace(/-/g, '')\r\n      const filename = `simulation-credit-${dateStr}.pptx`\r\n\r\n      // Export and download\r\n      await exportAndDownloadStudyDeck(deck, pptxColors, filename)\r\n    } catch (error) {\r\n      console.error('Export PowerPoint Cr├®dit ├®chou├®:', error)\r\n      alert('Erreur lors de la g├®n├®ration du PowerPoint. Veuillez r├®essayer.')\r\n    } finally {\r\n      setExportLoading(false);\r\n    }\r\n  }\r\n\r\n  /* ---- Rendu ---- */\r\n  const colLabelPaiement    = isAnnual ? 'Annuit├®' : 'Mensualit├®'\r\n  const colLabelPaiementAss = isAnnual ? 'Annuit├® + Assur.' : 'Mensualit├® + Assur.'\r\n  const canShowLissageChips = lisserPret1 && !anyInfine && pretsPlus.length > 0\r\n\r\n  return (\r\n    <div className=\"credit-page premium-page sim-credit\">\r\n      {/* HEADER */}\r\n      <div className=\"credit-header premium-header\">\r\n        <span className=\"credit-title premium-title\">Simulateur de cr├®dit</span>\r\n        <div className=\"credit-actions\">\r\n          <div className=\"credit-view-toggle\">\r\n            <button className={`chip premium-btn ${viewMode==='mensuel'?'active':''}`} onClick={()=> setViewMode('mensuel')}>Mensuel</button>\r\n            <button className={`chip premium-btn ${viewMode==='annuel'?'active':''}`} onClick={()=> setViewMode('annuel')}>Annuel</button>\r\n          </div>\r\n          <ExportMenu\r\n            options={[\r\n              { label: 'Excel', onClick: exportExcel },\r\n              { label: 'PowerPoint', onClick: exportPowerPoint },\r\n            ]}\r\n            loading={exportLoading}\r\n          />\r\n        </div>\r\n      </div>\r\n\r\n      {/* WARNINGS */}\r\n      {Array.isArray(warnings) && warnings.length > 0 && (\r\n        <div className=\"credit-warnings\">\r\n          <ul>{warnings.map((w,i)=><li key={i}>{w}</li>)}</ul>\r\n        </div>\r\n      )}\r\n\r\n      {/* GRID : Param├¿tres + Synth├¿se */}\r\n      <div className=\"credit-grid premium-grid\">\r\n        {/* COLONNE GAUCHE : Param├¿tres */}\r\n        <div className=\"credit-left premium-left\">\r\n          <div className=\"credit-section premium-section\">\r\n            <div className=\"credit-section-title premium-title\">Pr├¬t principal</div>\r\n            <div className=\"credit-params-grid premium-grid-2\">\r\n              <div className=\"credit-field premium-field\">\r\n                <label>Type de cr├®dit</label>\r\n                <div className=\"credit-input premium-input\">\r\n                  <select className=\"credit-select premium-select\" value={creditType} onChange={e=> setCreditType(e.target.value)}>\r\n                    <option value=\"amortissable\">Amortissable</option>\r\n                    <option value=\"infine\">In fine</option>\r\n                  </select>\r\n                </div>\r\n              </div>\r\n              <div className=\"credit-field premium-field\">\r\n                <label>Date de souscription</label>\r\n                <div className=\"credit-input premium-input\">\r\n                  <input type=\"month\" className=\"credit-input__field premium-input\" value={startYM} onChange={e=> setStartYM(e.target.value)}/>\r\n                </div>\r\n              </div>\r\n              <div className=\"credit-field premium-field\">\r\n                <label>Montant emprunt├®</label>\r\n                <div className=\"credit-input premium-input\">\r\n                  <input type=\"text\" inputMode=\"numeric\" className=\"credit-input__field premium-input\" value={fmt0(effectiveCapitalPret1)} onChange={e=> onChangeCapital(e.target.value)} onBlur={()=> setTouched(t => ({...t, capital: true}))}/>\r\n                  <span className=\"credit-input__unit premium-unit\">Ôé¼</span>\r\n                </div>\r\n              </div>\r\n              <div className=\"credit-field premium-field\">\r\n                <label>Dur├®e</label>\r\n                <div className=\"credit-input premium-input\">\r\n                  <input type=\"text\" inputMode=\"numeric\" className=\"credit-input__field premium-input\" value={String(duree)} onChange={e=> onChangeDuree(e.target.value)} onBlur={()=> setTouched(t => ({...t, duree: true}))}/>\r\n                  <span className=\"credit-input__unit premium-unit\">mois</span>\r\n                </div>\r\n              </div>\r\n              <div className=\"credit-field premium-field\">\r\n                <label>Taux annuel (cr├®dit)</label>\r\n                <div className=\"credit-input premium-input\">\r\n                  <input type=\"text\" inputMode=\"decimal\" className=\"credit-input__field premium-input\" value={rawTaux}\r\n                    onChange={e => {\r\n                      let raw = e.target.value.replace(',', '.');\r\n                      raw = raw.replace(/[^0-9.]/g, '');\r\n                      const parts = raw.split('.');\r\n                      if (parts.length > 2) raw = parts.shift() + '.' + parts.join('');\r\n                      setRawTaux(raw);\r\n                    }}\r\n                    onBlur={() => {\r\n                      const num = toNumber(rawTaux);\r\n                      setTaux(num);\r\n                      setRawTaux(Number(num).toFixed(2).replace('.', ','));\r\n                    }}\r\n                  />\r\n                  <span className=\"credit-input__unit premium-unit\">%</span>\r\n                </div>\r\n              </div>\r\n              <div className=\"credit-field premium-field\">\r\n                <label>Mensualit├®</label>\r\n                <div className=\"credit-input premium-input\">\r\n                  <input type=\"text\" className=\"credit-input__field premium-input\" value={fmt0(mensuHorsAssurance_base)} disabled/>\r\n                  <span className=\"credit-input__unit premium-unit\">Ôé¼</span>\r\n                </div>\r\n                <span className=\"credit-field-hint\">Hors assurance</span>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"credit-section premium-section\">\r\n            <div className=\"credit-section-title premium-section-title\">Assurance emprunteur</div>\r\n            <div className=\"credit-params-grid premium-grid-2\">\r\n              <div className=\"credit-field premium-field\">\r\n                <label>Mode de calcul</label>\r\n                <div className=\"credit-input premium-input\">\r\n                  <select className=\"credit-select premium-select\" value={assurMode} onChange={e=> setAssurMode(e.target.value)}>\r\n                    <option value=\"CI\">Sur capital initial</option>\r\n                    <option value=\"CRD\">Sur capital restant d├╗</option>\r\n                  </select>\r\n                </div>\r\n              </div>\r\n              <div className=\"credit-field premium-field\">\r\n                <label>Taux annuel (assurance)</label>\r\n                <div className=\"credit-input premium-input\">\r\n                  <input type=\"text\" inputMode=\"decimal\" className=\"credit-input__field premium-input\" value={rawTauxAssur}\r\n                    onChange={e => {\r\n                      let raw = e.target.value.replace(',', '.');\r\n                      raw = raw.replace(/[^0-9.]/g, '');\r\n                      const parts = raw.split('.');\r\n                      if (parts.length > 2) raw = parts.shift() + '.' + parts.join('');\r\n                      setRawTauxAssur(raw);\r\n                    }}\r\n                    onBlur={() => {\r\n                      const num = toNumber(rawTauxAssur);\r\n                      setTauxAssur(num);\r\n                      setRawTauxAssur(Number(num).toFixed(2).replace('.', ','));\r\n                    }}\r\n                  />\r\n                  <span className=\"credit-input__unit premium-unit\">%</span>\r\n                </div>\r\n              </div>\r\n                                        </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* COLONNE DROITE : Synth├¿se */}\r\n        <div className=\"credit-right premium-right\">\r\n          <div className=\"credit-summary-card premium-summary-card\">\r\n            <div className=\"credit-summary-title premium-summary-title\">Synth├¿se du pr├¬t</div>\r\n            <div className=\"credit-kpi-grid premium-kpi-grid\">\r\n              <div className=\"credit-kpi premium-kpi\">\r\n                <div className=\"credit-kpi-value premium-kpi-value\">{euro0(montantPrincipalAff)}</div>\r\n                <div className=\"credit-kpi-label premium-kpi-label\">{isAnnual ? 'Annuit├®' : 'Mensualit├®'} (hors ass.)</div>\r\n              </div>\r\n              <div className=\"credit-kpi premium-kpi\">\r\n                <div className=\"credit-kpi-value premium-kpi-value\">{euro0(primeAssAff)}</div>\r\n                <div className=\"credit-kpi-label premium-kpi-label\">Assurance / {isAnnual ? 'an' : 'mois'}</div>\r\n              </div>\r\n            </div>\r\n            <div className=\"credit-summary-row premium-summary-row\">\r\n              <span className=\"credit-summary-label premium-summary-label\">Co├╗t total des int├®r├¬ts</span>\r\n              <span className=\"credit-summary-value premium-summary-value\">{euro0(totalInterets)}</span>\r\n            </div>\r\n            <div className=\"credit-summary-row\">\r\n              <span className=\"credit-summary-label\">Co├╗t total assurance</span>\r\n              <span className=\"credit-summary-value\">{euro0(totalAssurance)}</span>\r\n            </div>\r\n            <div className=\"credit-summary-row\">\r\n              <span className=\"credit-summary-label\">Co├╗t total du cr├®dit</span>\r\n              <span className=\"credit-summary-value credit-summary-value--highlight\">{euro0(coutTotalCredit)}</span>\r\n            </div>\r\n            {lisserPret1 && (\r\n              <div className=\"credit-summary-row\">\r\n                <span className=\"credit-summary-label\">Diff├®rence de dur├®e</span>\r\n                <span className=\"credit-summary-value\">{diffDureesMois > 0 ? `+${diffDureesMois}` : diffDureesMois} mois</span>\r\n              </div>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* PR├èTS ADDITIONNELS */}\r\n      <div className=\"credit-section\">\r\n        <div className=\"credit-prets-header\">\r\n          <span className=\"credit-prets-title\">Pr├¬ts additionnels (max 2)</span>\r\n          <div className=\"credit-prets-actions\">\r\n            <button className=\"chip\" onClick={addPret} disabled={pretsPlus.length>=2}>+ Ajouter un pr├¬t</button>\r\n            {pretsPlus.length > 0 && (\r\n              <button\r\n                className={`chip ${lisserPret1 ? 'active' : ''}`}\r\n                onClick={()=> setLisserPret1(v => !v)}\r\n                disabled={anyInfine}\r\n                title={anyInfine ? \"Le lissage est indisponible si un pr├¬t est en In fine\" : \"Lisser la mensualit├® totale en ajustant le pr├¬t 1\"}\r\n              >\r\n                {lisserPret1 ? 'Lissage : ON' : 'Lisser le pr├¬t 1'}\r\n              </button>\r\n            )}\r\n            {canShowLissageChips && (\r\n              <>\r\n                <button className={`chip ${lissageMode==='mensu' ? 'active' : ''}`} onClick={()=> setLissageMode('mensu')}>Mensualit├® cste</button>\r\n                <button className={`chip ${lissageMode==='duree' ? 'active' : ''}`} onClick={()=> setLissageMode('duree')}>Dur├®e cste</button>\r\n              </>\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        {pretsPlus.length > 0 && (\r\n          <div className=\"credit-table-wrapper\">\r\n            <table className=\"credit-table credit-table--compact\">\r\n              <thead>\r\n                <tr>\r\n                  <th>#</th>\r\n                  <th>Type</th>\r\n                  <th className=\"text-right\">Capital</th>\r\n                  <th className=\"text-right\">Dur├®e</th>\r\n                  <th className=\"text-right\">Taux</th>\r\n                  <th className=\"text-right\">Taux (ass.)</th>\r\n                  <th>Mode</th>\r\n                  <th className=\"text-right\">Mensualit├®</th>\r\n                  <th>Date</th>\r\n                  <th></th>\r\n                </tr>\r\n              </thead>\r\n              <tbody>\r\n                {pretsPlus.map((p,idx)=>{\r\n                  const rM = (Math.max(0, Number(p.taux)||0)/100)/12\r\n                  const Np = Math.max(1, Math.floor(toNum(p.duree)||0))\r\n                  const C  = Math.max(0, toNum(p.capital))\r\n                  const type = p.type || creditType\r\n                  const mensu = (type === 'infine') ? (rM === 0 ? 0 : C * rM) : mensualiteAmortissable(C, rM, Np)\r\n                  return (\r\n                    <tr key={p.id}>\r\n                      <td>{idx+2}</td>\r\n                      <td>\r\n                        <select className=\"credit-select\" value={type} onChange={e=> updatePret(p.id, { type: e.target.value })} style={{height:28}}>\r\n                          <option value=\"amortissable\">Amort.</option>\r\n                          <option value=\"infine\">In fine</option>\r\n                        </select>\r\n                      </td>\r\n                      <td className=\"text-right\">\r\n                        <input type=\"text\" inputMode=\"numeric\" className=\"credit-input__field\" value={fmt0(C)} onChange={e=> updatePret(p.id, { capital: String(e.target.value).replace(/\\D/g,'').slice(0,8) })} style={{height:28}}/>\r\n                      </td>\r\n                      <td className=\"text-right\">\r\n                        <input type=\"text\" inputMode=\"numeric\" className=\"credit-input__field\" value={String(toNum(p.duree) || 0)} onChange={e => updatePret(p.id, { duree: String(e.target.value).replace(/\\D/g, '').slice(0, 3) })} style={{height:28}}/>\r\n                      </td>\r\n                      <td className=\"text-right\">\r\n                        <input type=\"text\" inputMode=\"decimal\" className=\"credit-input__field\" value={rawTauxPlus[p.id] ?? (Number((Number(p.taux)||0).toFixed(2)).toString())}\r\n                          onChange={e=>{ setRawTauxPlus(m => ({ ...m, [p.id]: e.target.value })); updatePret(p.id, { taux: toNumber(e.target.value) }); }}\r\n                          onBlur={()=>{ setRawTauxPlus(m => ({ ...m, [p.id]: (Number((Number(p.taux)||0).toFixed(2)).toString()) })); }}\r\n                          style={{height:28}}/>\r\n                      </td>\r\n                      <td className=\"text-right\">\r\n                        <input type=\"text\" inputMode=\"decimal\" className=\"credit-input__field\" \r\n                          value={rawTauxAssurPlus[p.id] ?? (Number((Number(p.tauxAssur)||0).toFixed(2)).toString())}\r\n                          onChange={e=>{ setRawTauxAssurPlus(m => ({ ...m, [p.id]: e.target.value })); updatePret(p.id, { tauxAssur: Math.max(0, toNumber(e.target.value)) }); }}\r\n                          onBlur={()=>{ setRawTauxAssurPlus(m => ({ ...m, [p.id]: (Number((Number(p.tauxAssur)||0).toFixed(2)).toString()) })); }}\r\n                          style={{height:28, width:60}}\r\n                          placeholder=\"0.00\"\r\n                        />\r\n                      </td>\r\n                      <td>\r\n                        <select className=\"credit-select\" value={p.assurMode || 'CRD'} onChange={e=> updatePret(p.id, { assurMode: e.target.value })} style={{height:28, minWidth:60}}>\r\n                          <option value=\"CI\">CI</option>\r\n                          <option value=\"CRD\">CRD</option>\r\n                        </select>\r\n                      </td>\r\n                      <td className=\"text-right font-semibold\">{euro0(mensu)}</td>\r\n                      <td className=\"text-center\">\r\n                        <input type=\"month\" className=\"credit-input__field\" value={p.startYM || startYM} onChange={e=> updatePret(p.id, { startYM: e.target.value })} style={{height:28}}/>\r\n                      </td>\r\n                      <td className=\"text-center\">\r\n                        <button className=\"chip\" onClick={()=> removePret(p.id)}>├ù</button>\r\n                      </td>\r\n                    </tr>\r\n                  )\r\n                })}\r\n              </tbody>\r\n            </table>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* TABLEAU DES P├ëRIODES (si pr├¬ts multiples) */}\r\n      {pretsPlus.length > 0 && synthesePeriodes.length > 0 && (\r\n        <div className=\"credit-section\">\r\n          <div className=\"credit-section-title\">R├®partition par p├®riode</div>\r\n          <div className=\"credit-table-wrapper\">\r\n            <table className=\"credit-table premium-table\">\r\n              <thead>\r\n                <tr>\r\n                  <th>P├®riode</th>\r\n                  <th className=\"text-right\">Pr├¬t 1</th>\r\n                  <th className=\"text-right\">Pr├¬t 2</th>\r\n                  {pretsPlus.length > 1 && <th className=\"text-right\">Pr├¬t 3</th>}\r\n                </tr>\r\n              </thead>\r\n              <tbody>\r\n                {synthesePeriodes.map((ln, i)=>(\r\n                  <tr key={i}>\r\n                    <td>{ln.from}</td>\r\n                    <td className=\"text-right\">{ln.p1>0 ? euro0(ln.p1) : 'ÔÇö'}</td>\r\n                    <td className=\"text-right\">{ln.p2>0 ? euro0(ln.p2) : 'ÔÇö'}</td>\r\n                    {pretsPlus.length > 1 && <td className=\"text-right\">{ln.p3>0 ? euro0(ln.p3) : 'ÔÇö'}</td>}\r\n                  </tr>\r\n                ))}\r\n              </tbody>\r\n            </table>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* TABLEAU D'AMORTISSEMENT */}\r\n      <div className=\"credit-section\">\r\n        <div className=\"credit-section-title\">├ëch├®ancier {isAnnual ? 'annuel' : 'mensuel'}</div>\r\n        <div className=\"credit-table-wrapper\">\r\n          <table className=\"credit-table premium-table\">\r\n            <thead>\r\n              <tr>\r\n                <th>P├®riode</th>\r\n                <th className=\"text-right\">Int├®r├¬ts</th>\r\n                <th className=\"text-right\">Assurance</th>\r\n                <th className=\"text-right\">Amort.</th>\r\n                <th className=\"text-right\">{colLabelPaiement}</th>\r\n                <th className=\"text-right\">{colLabelPaiementAss}</th>\r\n                <th className=\"text-right\">CRD</th>\r\n                <th className=\"text-right\">Assurance d├®c├¿s</th>\r\n              </tr>\r\n            </thead>\r\n            <tbody>\r\n              {tableDisplay.map((l, i) => (\r\n                <tr key={i}>\r\n                  <td>{l.periode}</td>\r\n                  <td className=\"text-right\">{euro0(l.interet)}</td>\r\n                  <td className=\"text-right\">{euro0(l.assurance)}</td>\r\n                  <td className=\"text-right\">{euro0(l.amort)}</td>\r\n                  <td className=\"text-right font-semibold\">{euro0(l.mensu)}</td>\r\n                  <td className=\"text-right font-semibold\">{euro0(l.mensuTotal)}</td>\r\n                  <td className=\"text-right\">{euro0(l.crd)}</td>\r\n                  <td className=\"text-right\">{l.assuranceDeces ? euro0(l.assuranceDeces) : 'ÔÇö'}</td>\r\n                </tr>\r\n              ))}\r\n            </tbody>\r\n          </table>\r\n        </div>\r\n      </div>\r\n\r\n      {/* D├ëTAIL PAR PR├èT */}\r\n      {pretsPlus.length > 0 && (\r\n        <div className=\"credit-detail-section\">\r\n          <div className=\"credit-section\">\r\n            <div className=\"credit-section-title\">D├®tail par pr├¬t</div>\r\n            \r\n            <div className=\"credit-detail-subtitle\">Pr├¬t 1</div>\r\n            <div className=\"credit-table-wrapper\">\r\n              <table className=\"credit-table credit-table--compact\">\r\n                <thead>\r\n                  <tr>\r\n                    <th>P├®riode</th>\r\n                    <th className=\"text-right\">Int├®r├¬ts</th>\r\n                    <th className=\"text-right\">Assur.</th>\r\n                    <th className=\"text-right\">Amort.</th>\r\n                    <th className=\"text-right\">{colLabelPaiement}</th>\r\n                    <th className=\"text-right\">CRD</th>\r\n                    <th className=\"text-right\">Capitaux d├®c├¿s</th>\r\n                  </tr>\r\n                </thead>\r\n                <tbody>\r\n                  {(isAnnual ? aggregateToYearsFromRows(pret1Rows, startYM) : attachMonthLabels(pret1Rows)).map((l, idx) => (\r\n                    <tr key={idx}>\r\n                      <td>{l.periode}</td>\r\n                      <td className=\"text-right\">{euro0(l.interet)}</td>\r\n                      <td className=\"text-right\">{euro0(l.assurance)}</td>\r\n                      <td className=\"text-right\">{euro0(l.amort)}</td>\r\n                      <td className=\"text-right font-semibold\">{euro0(l.mensu)}</td>\r\n                      <td className=\"text-right\">{euro0(l.crd)}</td>\r\n                      <td className=\"text-right\">{l.assuranceDeces ? euro0(l.assuranceDeces) : 'ÔÇö'}</td>\r\n                    </tr>\r\n                  ))}\r\n                </tbody>\r\n              </table>\r\n            </div>\r\n\r\n            {autresRows[0] && (\r\n              <>\r\n                <div className=\"credit-detail-subtitle\">Pr├¬t 2</div>\r\n                <div className=\"credit-table-wrapper\">\r\n                  <table className=\"credit-table credit-table--compact\">\r\n                    <thead>\r\n                      <tr>\r\n                        <th>P├®riode</th>\r\n                        <th className=\"text-right\">Int├®r├¬ts</th>\r\n                        <th className=\"text-right\">Assur.</th>\r\n                        <th className=\"text-right\">Amort.</th>\r\n                        <th className=\"text-right\">{colLabelPaiement}</th>\r\n                        <th className=\"text-right\">CRD</th>\r\n                        <th className=\"text-right\">Capitaux d├®c├¿s</th>\r\n                      </tr>\r\n                    </thead>\r\n                    <tbody>\r\n                      {(isAnnual ? aggregateToYearsFromRows(autresRows[0], startYM) : attachMonthLabels(autresRows[0])).map((l, idx) => (\r\n                        <tr key={idx}>\r\n                          <td>{l.periode}</td>\r\n                          <td className=\"text-right\">{euro0(l?.interet ?? 0)}</td>\r\n                          <td className=\"text-right\">{euro0(l?.assurance ?? 0)}</td>\r\n                          <td className=\"text-right\">{euro0(l?.amort ?? 0)}</td>\r\n                          <td className=\"text-right font-semibold\">{euro0(l?.mensu ?? 0)}</td>\r\n                          <td className=\"text-right\">{euro0(l?.crd ?? 0)}</td>\r\n                          <td className=\"text-right\">{l?.assuranceDeces ? euro0(l.assuranceDeces) : 'ÔÇö'}</td>\r\n                        </tr>\r\n                      ))}\r\n                    </tbody>\r\n                  </table>\r\n                </div>\r\n              </>\r\n            )}\r\n\r\n            {autresRows[1] && (\r\n              <>\r\n                <div className=\"credit-detail-subtitle\">Pr├¬t 3</div>\r\n                <div className=\"credit-table-wrapper\">\r\n                  <table className=\"credit-table credit-table--compact\">\r\n                    <thead>\r\n                      <tr>\r\n                        <th>P├®riode</th>\r\n                        <th className=\"text-right\">Int├®r├¬ts</th>\r\n                        <th className=\"text-right\">Assur.</th>\r\n                        <th className=\"text-right\">Amort.</th>\r\n                        <th className=\"text-right\">{colLabelPaiement}</th>\r\n                        <th className=\"text-right\">CRD</th>\r\n                        <th className=\"text-right\">Capitaux d├®c├¿s</th>\r\n                      </tr>\r\n                    </thead>\r\n                    <tbody>\r\n                      {(isAnnual ? aggregateToYearsFromRows(autresRows[1], startYM) : attachMonthLabels(autresRows[1])).map((l, idx) => (\r\n                        <tr key={idx}>\r\n                          <td>{l.periode}</td>\r\n                          <td className=\"text-right\">{euro0(l?.interet ?? 0)}</td>\r\n                          <td className=\"text-right\">{euro0(l?.assurance ?? 0)}</td>\r\n                          <td className=\"text-right\">{euro0(l?.amort ?? 0)}</td>\r\n                          <td className=\"text-right font-semibold\">{euro0(l?.mensu ?? 0)}</td>\r\n                          <td className=\"text-right\">{euro0(l?.crd ?? 0)}</td>\r\n                          <td className=\"text-right\">{l?.assuranceDeces ? euro0(l.assuranceDeces) : 'ÔÇö'}</td>\r\n                        </tr>\r\n                      ))}\r\n                    </tbody>\r\n                  </table>\r\n                </div>\r\n              </>\r\n            )}\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* ENCART HYPOTH├êSES */}\r\n      <div className=\"credit-hypotheses\">\r\n        <div className=\"credit-hypotheses-title\">Hypoth├¿ses et limites</div>\r\n        <ul>\r\n          <li>Les r├®sultats sont indicatifs et ne constituent pas une offre de pr├¬t.</li>\r\n          <li>Le calcul suppose un taux fixe sur toute la dur├®e du pr├¬t.</li>\r\n          <li>L'assurance emprunteur est calcul├®e selon le mode s├®lectionn├® (capital initial ou restant d├╗) pour chaque pr├¬t.</li>\r\n          <li>Les frais de dossier, de garantie et de notaire ne sont pas inclus dans ce simulateur.</li>\r\n        </ul>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pages\\ForgotPassword.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pages\\Home.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pages\\Ir.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'DEFAULT_INCOMES'. Either include it or remove the dependency array.","line":235,"column":6,"nodeType":"ArrayExpression","endLine":235,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [DEFAULT_INCOMES, STORE_KEY]","fix":{"range":[7228,7239],"text":"[DEFAULT_INCOMES, STORE_KEY]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has a missing dependency: 'children'. Either include it or remove the dependency array.","line":312,"column":3,"nodeType":"ArrayExpression","endLine":327,"endColumn":4,"suggestions":[{"desc":"Update the dependencies array to be: [yearKey, status, isIsolated, effectiveParts, location, incomes, deductions, extraDeductions, credits, taxSettings, psSettings, capitalMode, children]","fix":{"range":[9456,9696],"text":"[yearKey, status, isIsolated, effectiveParts, location, incomes, deductions, extraDeductions, credits, taxSettings, psSettings, capitalMode, children]"}}]}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'DEFAULT_INCOMES' and 'STORE_KEY'. Either include them or remove the dependency array.","line":163,"column":6,"nodeType":"ArrayExpression","endLine":163,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [DEFAULT_INCOMES, STORE_KEY]","fix":{"range":[5874,5876],"text":"[DEFAULT_INCOMES, STORE_KEY]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/pages/Ir.jsx\r\nimport React, { useEffect, useMemo, useState } from 'react';\r\nimport './Ir.css';\r\nimport { onResetEvent, storageKeyFor } from '../utils/reset';\r\nimport { toNumber } from '../utils/number';\r\nimport { computeIrResult as computeIrResultEngine, computeAutoPartsWithChildren } from '../utils/irEngine.js';\r\nimport { getFiscalSettings, addInvalidationListener } from '../utils/fiscalSettingsCache.js';\r\nimport { useTheme } from '../settings/ThemeProvider';\r\nimport { supabase } from '../supabaseClient';\r\nimport { ExportMenu } from '../components/ExportMenu';\r\n\r\n// V4: PPTX/Excel imports moved to dynamic import() in export functions\r\n// ---- Helpers formats ----\r\nconst fmt0 = (n) => (Math.round(Number(n) || 0)).toLocaleString('fr-FR');\r\nconst euro0 = (n) => `${fmt0(n)} Ôé¼`;\r\nconst fmtPct = (n) =>\r\n  (Number(n) || 0).toLocaleString('fr-FR', {\r\n    minimumFractionDigits: 0,\r\n    maximumFractionDigits: 1,\r\n  });\r\nconst toNum = (v, def = 0) => toNumber(v, def);\r\n// pour afficher joliment les entr├®es mon├®taires\r\nconst formatMoneyInput = (n) => {\r\n  const v = Math.round(Number(n) || 0);\r\n  if (!v) return '';\r\n  return v.toLocaleString('fr-FR');\r\n};\r\n// abattement 10 % avec plafond / plancher\r\nfunction computeAbattement10(base, cfg) {\r\n  if (!cfg || base <= 0) return 0;\r\n  const plafond = Number(cfg.plafond) || 0;\r\n  const plancher = Number(cfg.plancher) || 0;\r\n\r\n  let val = base * 0.1;\r\n  if (plafond > 0) val = Math.min(val, plafond);\r\n  if (plancher > 0) val = Math.max(val, plancher);\r\n  return val;\r\n}\r\n\r\n/* ===============================\r\n   Page IR\r\n================================ */\r\nexport default function Ir() {\r\n  // Theme colors and logo from ThemeProvider\r\n  // pptxColors respects the theme scope setting (SER1 classic if ui-only)\r\n  const { colors, logo, setLogo, cabinetLogo, themeSource, pptxColors } = useTheme();\r\n\r\n  const [taxSettings, setTaxSettings] = useState(null);\r\n  const [psSettings, setPsSettings] = useState(null);\r\n\r\n  // Choix utilisateur\r\n  const [yearKey, setYearKey] = useState('current'); // current = 2025, previous = 2024\r\n  const [status, setStatus] = useState('couple'); // 'single' | 'couple'\r\n  const [isIsolated, setIsIsolated] = useState(false); // option parent isol├®\r\n  const [parts, setParts] = useState(0); // ajustement manuel en nombre de parts\r\n  const [location, setLocation] = useState('metropole'); // metropole | gmr | guyane\r\n  const [children, setChildren] = useState([]);\r\n// ex : [{ id: 1, mode: 'charge' | 'shared' }]\r\n\r\n\r\n  const DEFAULT_INCOMES = {\r\n  d1: { salaries: 0, associes62: 0, pensions: 0, bic: 0, fonciers: 0, autres: 0 },\r\n  d2: { salaries: 0, associes62: 0, pensions: 0, bic: 0, fonciers: 0, autres: 0 },\r\n  capital: {\r\n    withPs: 0,\r\n    withoutPs: 0,\r\n  },\r\n    fonciersFoyer: 0,\r\n};\r\n\r\nconst [incomes, setIncomes] = useState(DEFAULT_INCOMES);\r\nconst [capitalMode, setCapitalMode] = useState('pfu'); // 'pfu' ou 'bareme'\r\n\r\n\r\n  // Mode de d├®duction des frais pour salaires / art.62\r\n  const [realMode, setRealMode] = useState({ d1: 'abat10', d2: 'abat10' }); // 'abat10' | 'reels'\r\n  const [realExpenses, setRealExpenses] = useState({ d1: 0, d2: 0 });\r\n\r\n  const [deductions, setDeductions] = useState(0);\r\n  const [credits, setCredits] = useState(0);\r\n\r\n  const [showDetails, setShowDetails] = useState(false);\r\n\r\n  // Export state\r\n  const [exportLoading, setExportLoading] = useState(false);\r\n\r\n  // Persist dans sessionStorage\r\n  const STORE_KEY = storageKeyFor('ir');\r\n  const [hydrated, setHydrated] = useState(false);\r\n\r\n  // Valeurs par d├®faut (fallback si Supabase ne r├®pond pas)\r\n  \r\n  // Chargement des param├¿tres fiscaux via le cache (jamais de blocage infini)\r\n  useEffect(() => {\r\n    let mounted = true;\r\n    async function load() {\r\n      try {\r\n        const settings = await getFiscalSettings();\r\n        if (!mounted) return;\r\n        setTaxSettings(settings.tax);\r\n        setPsSettings(settings.ps);\r\n      } catch (e) {\r\n        console.error('[IR] Erreur chargement settings:', e);\r\n      }\r\n    }\r\n    load();\r\n    return () => { mounted = false; };\r\n  }, []);\r\n\r\n  // Invalidation cache apr├¿s mise ├á jour admin (optionnel, pour coh├®rence)\r\n  useEffect(() => {\r\n    const remove = addInvalidationListener((kind) => {\r\n      if (kind === 'tax' || kind === 'ps') {\r\n        // Recharger imm├®diatement pour refl├®ter les changements\r\n        getFiscalSettings({ force: true }).then((settings) => {\r\n          setTaxSettings(settings.tax);\r\n          setPsSettings(settings.ps);\r\n        });\r\n      }\r\n    });\r\n    return remove;\r\n  }, []);\r\n\r\n  // Restauration depuis sessionStorage\r\n  useEffect(() => {\r\n    try {\r\n      const raw = sessionStorage.getItem(STORE_KEY);\r\n      if (raw) {\r\n        const s = JSON.parse(raw);\r\n        if (s && typeof s === 'object') {\r\n          setYearKey(s.yearKey ?? 'current');\r\n          setStatus(s.status ?? 'couple');\r\n          setIsIsolated(s.isIsolated ?? false);\r\n          setParts(s.parts ?? 0);\r\n          setLocation(s.location ?? 'metropole');\r\nsetIncomes(\r\n  s.incomes\r\n    ? {\r\n        d1: { ...DEFAULT_INCOMES.d1, ...(s.incomes.d1 || {}) },\r\n        d2: { ...DEFAULT_INCOMES.d2, ...(s.incomes.d2 || {}) },\r\n        capital: {\r\n          ...DEFAULT_INCOMES.capital,\r\n          ...(s.incomes.capital || {}),\r\n        },\r\n        fonciersFoyer: s.incomes.fonciersFoyer ?? 0,\r\n      }\r\n    : DEFAULT_INCOMES\r\n);\r\n\r\n          setRealMode(s.realMode ?? { d1: 'abat10', d2: 'abat10' });\r\n          setRealExpenses(s.realExpenses ?? { d1: 0, d2: 0 });\r\n          setDeductions(s.deductions ?? 0);\r\n          setCredits(s.credits ?? 0);\r\n          setCapitalMode(s.capitalMode ?? 'pfu');\r\n          setChildren(Array.isArray(s.children) ? s.children : []);\r\n        }\r\n      }\r\n    } catch {\r\n      // ignore\r\n    }\r\n    setHydrated(true)\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, []);\r\n\r\n  // Sauvegarde dans sessionStorage\r\n  useEffect(() => {\r\n    if (!hydrated) return;\r\n    try {\r\n      sessionStorage.setItem(\r\n        STORE_KEY,\r\nJSON.stringify({\r\n  yearKey,\r\n  status,\r\n  isIsolated,\r\n  parts,\r\n  location,\r\n  incomes,\r\n  realMode,\r\n  realExpenses,\r\n  deductions,\r\n  credits,\r\n  capitalMode,\r\n  children,\r\n})\r\n\r\n      );\r\n    } catch {\r\n      // ignore\r\n    }\r\n    }, [\r\n    STORE_KEY,\r\n    hydrated,\r\n    yearKey,\r\n    status,\r\n    isIsolated,\r\n    parts,\r\n    location,\r\n    incomes,\r\n    realMode,\r\n    realExpenses,\r\n    deductions,\r\n    credits,\r\n    capitalMode,\r\n    children,\r\n  ]);\r\n\r\n\r\n  // Reset global depuis la topbar\r\n  useEffect(() => {\r\n    const off = onResetEvent?.(({ simId }) => {\r\n      // ne r├®agit qu'au reset du simulateur IR\r\n      if (simId && simId !== 'ir') return;\r\n\r\nsetYearKey('current');\r\nsetStatus('couple');\r\nsetIsIsolated(false);\r\nsetParts(0);            // ajustement remis ├á z├®ro\r\nsetLocation('metropole');\r\nsetIncomes(DEFAULT_INCOMES);\r\nsetChildren([]);        // on supprime tous les enfants\r\nsetDeductions(0);\r\nsetCredits(0);\r\nsetRealMode({ d1: 'abat10', d2: 'abat10' });\r\nsetRealExpenses({ d1: 0, d2: 0 });\r\nsetCapitalMode('pfu');\r\n\r\n      try {\r\n        sessionStorage.removeItem(STORE_KEY);\r\n      } catch {\r\n        // ignore\r\n      }\r\n    });\r\n\r\n    return off || (() => {});\r\n  }, [STORE_KEY]);\r\n\r\n\r\n  // Handlers de saisie\r\n  const updateIncome = (who, field, value) => {\r\n    setIncomes((prev) => ({\r\n      ...prev,\r\n      [who]: {\r\n        ...prev[who],\r\n        [field]: toNum(value, 0),\r\n      },\r\n    }));\r\n  };\r\n  \r\n// ===== Calcul automatique du nombre de parts =====\r\n\r\n// Parts de base selon la situation familiale (sert de minimum apr├¿s ajustement manuel)\r\nconst baseParts = status === 'couple' ? 2 : 1;\r\n\r\n// Source de v├®rit├® : calcule parts enfants + bonus parent isol├® uniquement si ÔëÑ1 enfant en charge exclusive\r\nconst computedParts = computeAutoPartsWithChildren({ status, isIsolated, children });\r\n\r\n// Ajustement manuel (par quart de part)\r\nconst effectiveParts = Math.max(\r\n  baseParts,\r\n  Math.round((computedParts + (Number(parts) || 0)) * 4) / 4\r\n);\r\n\r\n\r\n  // Abattement 10 % salaires / art. 62 (par d├®clarant)\r\n  const abat10CfgRoot = taxSettings?.incomeTax?.abat10 || {};\r\n  const abat10SalCfg =\r\n    yearKey === 'current'\r\n      ? abat10CfgRoot.current\r\n      : abat10CfgRoot.previous;\r\n\r\n  const baseSalD1 = (incomes.d1.salaries || 0) + (incomes.d1.associes62 || 0);\r\n  const baseSalD2 = (incomes.d2.salaries || 0) + (incomes.d2.associes62 || 0);\r\n\r\n  const abat10SalD1 = computeAbattement10(baseSalD1, abat10SalCfg);\r\n  const abat10SalD2 = computeAbattement10(baseSalD2, abat10SalCfg);\r\n\r\n  // Frais r├®els / 10 % d├®clar├®s par le foyer (s'ajoutent aux \"D├®ductions\")\r\n  const extraDeductions =\r\n    (realMode.d1 === 'reels'\r\n      ? realExpenses.d1 || 0\r\n      : realMode.d1 === 'abat10'\r\n      ? abat10SalD1\r\n      : 0) +\r\n    (status === 'couple'\r\n      ? realMode.d2 === 'reels'\r\n        ? realExpenses.d2 || 0\r\n        : realMode.d2 === 'abat10'\r\n        ? abat10SalD2\r\n        : 0\r\n      : 0);\r\n\r\n\r\n  // Calcul principal\r\nconst result = useMemo(\r\n  () =>\r\n    computeIrResultEngine({\r\n      yearKey,\r\n      status,\r\n      isIsolated,\r\n      parts: effectiveParts,\r\n      location,\r\n      incomes,\r\n      deductions: deductions + extraDeductions,\r\n      credits,\r\n      taxSettings,\r\n      psSettings,\r\n      capitalMode,\r\n      personsAChargeCount: Array.isArray(children)\r\n  ? children.filter((c) => c && (c.mode === 'charge' || c.mode === 'shared')).length\r\n  : 0,\r\n    }),\r\n  [\r\n    yearKey,\r\n    status,\r\n    isIsolated,\r\n    effectiveParts,\r\n    location,\r\n    incomes,\r\n    deductions,\r\n    extraDeductions,\r\n    credits,\r\n    taxSettings,\r\n    psSettings,\r\n    realMode,\r\n    realExpenses,\r\n    capitalMode,\r\n  ]\r\n);\r\n\r\n\r\nconst yearLabel =\r\n  yearKey === 'current'\r\n    ? (taxSettings?.incomeTax?.currentYearLabel || '')\r\n    : (taxSettings?.incomeTax?.previousYearLabel || '');\r\n\r\n\r\n  const tmiScale =\r\n  yearKey === 'current'\r\n    ? taxSettings?.incomeTax?.scaleCurrent || []\r\n    : taxSettings?.incomeTax?.scalePrevious || [];\r\n\r\n  const pfuRateIR = toNum(taxSettings?.pfu?.[yearKey]?.rateIR, 12.8);\r\n  const psPatrimonyRate = toNum(psSettings?.patrimony?.[yearKey]?.totalRate, 17.2);\r\n\r\n  const cell = (v, style) => ({ v, style });\r\n\r\n  async function exportExcel() {\r\n    setExportLoading(true);\r\n    try {\r\n      if (!result) {\r\n        alert('Les r├®sultats ne sont pas disponibles.');\r\n        setExportLoading(false);\r\n        return;\r\n      }\r\n      \r\n      // V4: Dynamic import Excel builder\r\n      const { buildXlsxBlob, downloadXlsx, validateXlsxBlob } = await import('../utils/xlsxBuilder');\r\n\r\n      const headerParams = [cell('Champ', 'sHeader'), cell('Valeur', 'sHeader')];\r\n      const rowsParams = [];\r\n\r\n      rowsParams.push([cell('Param├¿tres fiscaux', 'sSection'), cell('', 'sSection')]);\r\n      rowsParams.push([cell('Bar├¿me', 'sText'), cell(yearLabel, 'sText')]);\r\n      rowsParams.push([\r\n        cell('Situation familiale', 'sText'),\r\n        cell(status === 'couple' ? 'Mari├® / Pacs├®' : 'C├®libataire / Veuf / Divorc├®', 'sText'),\r\n      ]);\r\n      rowsParams.push([cell('Parent isol├®', 'sText'), cell(isIsolated ? 'Oui' : 'Non', 'sText')]);\r\n      rowsParams.push([cell('Nombre de parts (calcul├®)', 'sText'), cell(result.partsNb || effectiveParts, 'sCenter')]);\r\n      rowsParams.push([cell('Zone g├®ographique', 'sText'), cell(location === 'metropole'\r\n        ? 'M├®tropole'\r\n        : location === 'gmr'\r\n        ? 'Guadeloupe / Martinique / R├®union'\r\n        : 'Guyane / Mayotte', 'sText')]);\r\n\r\n      rowsParams.push([cell('Revenus', 'sSection'), cell('', 'sSection')]);\r\n      rowsParams.push([cell('Salaires D1', 'sText'), cell(incomes.d1.salaries || 0, 'sMoney')]);\r\n      rowsParams.push([cell('Salaires D2', 'sText'), cell(incomes.d2.salaries || 0, 'sMoney')]);\r\n      rowsParams.push([cell('Associ├®s/g├®rants D1', 'sText'), cell(incomes.d1.associes62 || 0, 'sMoney')]);\r\n      rowsParams.push([cell('Associ├®s/g├®rants D2', 'sText'), cell(incomes.d2.associes62 || 0, 'sMoney')]);\r\n      rowsParams.push([cell('BIC/BNC/BA D1', 'sText'), cell(incomes.d1.bic || 0, 'sMoney')]);\r\n      rowsParams.push([cell('BIC/BNC/BA D2', 'sText'), cell(incomes.d2.bic || 0, 'sMoney')]);\r\n      rowsParams.push([cell('Pensions D1', 'sText'), cell(incomes.d1.pensions || 0, 'sMoney')]);\r\n      rowsParams.push([cell('Pensions D2', 'sText'), cell(incomes.d2.pensions || 0, 'sMoney')]);\r\n      rowsParams.push([cell('Revenus fonciers nets', 'sText'), cell(incomes.fonciersFoyer || 0, 'sMoney')]);\r\n      rowsParams.push([cell('RCM soumis aux PS', 'sText'), cell(incomes.capital.withPs || 0, 'sMoney')]);\r\n      rowsParams.push([cell('RCM hors PS', 'sText'), cell(incomes.capital.withoutPs || 0, 'sMoney')]);\r\n      rowsParams.push([cell('Option RCM', 'sText'), cell(capitalMode === 'pfu' ? 'PFU (flat tax)' : 'Bar├¿me', 'sText')]);\r\n\r\n      rowsParams.push([cell('D├®ductions / cr├®dits', 'sSection'), cell('', 'sSection')]);\r\n      rowsParams.push([cell('Frais r├®els D1', 'sText'), cell(realMode.d1 === 'reels' ? realExpenses.d1 || 0 : 0, 'sMoney')]);\r\n      rowsParams.push([cell('Frais r├®els D2', 'sText'), cell(realMode.d2 === 'reels' ? realExpenses.d2 || 0 : 0, 'sMoney')]);\r\n      rowsParams.push([cell('D├®ductions foyer', 'sText'), cell(deductions || 0, 'sMoney')]);\r\n      rowsParams.push([cell('Cr├®dits dÔÇÖimp├┤t', 'sText'), cell(credits || 0, 'sMoney')]);\r\n\r\n      const headerSynth = [cell('Indicateur', 'sHeader'), cell('Valeur', 'sHeader')];\r\n      const rowsSynth = [];\r\n      rowsSynth.push([cell('Revenu imposable du foyer', 'sText'), cell(result.taxableIncome || 0, 'sMoney')]);\r\n      rowsSynth.push([cell('Revenu imposable par part', 'sText'), cell(result.taxablePerPart || 0, 'sMoney')]);\r\n      rowsSynth.push([cell('TMI', 'sText'), cell((result.tmiRate || 0) / 100, 'sPercent')]);\r\n      rowsSynth.push([cell('Imp├┤t sur le revenu', 'sText'), cell(result.irNet || 0, 'sMoney')]);\r\n      rowsSynth.push([cell('PFU IR', 'sText'), cell(result.pfuIr || 0, 'sMoney')]);\r\n      rowsSynth.push([cell('CEHR', 'sText'), cell(result.cehr || 0, 'sMoney')]);\r\n      rowsSynth.push([cell('CDHR', 'sText'), cell(result.cdhr || 0, 'sMoney')]);\r\n      rowsSynth.push([cell('PS fonciers', 'sText'), cell(result.psFoncier || 0, 'sMoney')]);\r\n      rowsSynth.push([cell('PS dividendes', 'sText'), cell(result.psDividends || 0, 'sMoney')]);\r\n      rowsSynth.push([cell('PS total', 'sText'), cell(result.psTotal || 0, 'sMoney')]);\r\n      rowsSynth.push([cell('Imposition totale', 'sText'), cell(result.totalTax || 0, 'sMoney')]);\r\n\r\n      const headerDetails = [\r\n        cell('Poste', 'sHeader'),\r\n        cell('Base', 'sHeader'),\r\n        cell('Taux', 'sHeader'),\r\n        cell('Imp├┤t', 'sHeader'),\r\n      ];\r\n\r\n      const rowsDetails = [];\r\n      rowsDetails.push([cell('Bar├¿me (tranches)', 'sSection'), cell('', 'sSection'), cell('', 'sSection'), cell('', 'sSection')]);\r\n      (result.bracketsDetails || []).forEach((b) => {\r\n        rowsDetails.push([\r\n          cell(b.label || '', 'sText'),\r\n          cell(b.base || 0, 'sMoney'),\r\n          cell((b.rate || 0) / 100, 'sPercent'),\r\n          cell(b.tax || 0, 'sMoney'),\r\n        ]);\r\n      });\r\n\r\n      rowsDetails.push([cell('D├®cote', 'sText'), cell(result.decote || 0, 'sMoney'), cell('', 'sText'), cell('', 'sText')]);\r\n      rowsDetails.push([cell('Avantage QF', 'sText'), cell(result.qfAdvantage || 0, 'sMoney'), cell('', 'sText'), cell('', 'sText')]);\r\n      rowsDetails.push([cell('Cr├®dits / R├®ductions', 'sText'), cell(result.creditsTotal || 0, 'sMoney'), cell('', 'sText'), cell('', 'sText')]);\r\n      rowsDetails.push([cell('PFU IR', 'sText'), cell(result.pfuIr || 0, 'sMoney'), cell('', 'sText'), cell('', 'sText')]);\r\n      rowsDetails.push([cell('CEHR', 'sText'), cell(result.cehr || 0, 'sMoney'), cell('', 'sText'), cell('', 'sText')]);\r\n      rowsDetails.push([cell('CDHR', 'sText'), cell(result.cdhr || 0, 'sMoney'), cell('', 'sText'), cell('', 'sText')]);\r\n      rowsDetails.push([cell('PS fonciers', 'sText'), cell(result.psFoncier || 0, 'sMoney'), cell('', 'sText'), cell('', 'sText')]);\r\n      rowsDetails.push([cell('PS dividendes', 'sText'), cell(result.psDividends || 0, 'sMoney'), cell('', 'sText'), cell('', 'sText')]);\r\n      rowsDetails.push([cell('PS total', 'sText'), cell(result.psTotal || 0, 'sMoney'), cell('', 'sText'), cell('', 'sText')]);\r\n\r\n      const blob = await buildXlsxBlob({\r\n        sheets: [\r\n          {\r\n            name: 'Param├¿tres',\r\n            rows: [headerParams, ...rowsParams],\r\n            columnWidths: [36, 22],\r\n          },\r\n          {\r\n            name: 'Synth├¿se imp├┤ts',\r\n            rows: [headerSynth, ...rowsSynth],\r\n            columnWidths: [36, 22],\r\n          },\r\n          {\r\n            name: 'D├®tails calculs',\r\n            rows: [headerDetails, ...rowsDetails],\r\n            columnWidths: [36, 18, 14, 18],\r\n          },\r\n        ],\r\n        headerFill: colors?.c1,\r\n        sectionFill: colors?.c7,\r\n      });\r\n      \r\n      const isValid = await validateXlsxBlob(blob);\r\n      if (!isValid) {\r\n        throw new Error('XLSX invalide (signature PK manquante).');\r\n      }\r\n      \r\n      const dateStr = new Date().toISOString().split('T')[0].replace(/-/g, '');\r\n      downloadXlsx(blob, `simulation-ir-${dateStr}.xlsx`);\r\n    } catch (error) {\r\n      console.error('Export Excel IR ├®chou├®:', error);\r\n      alert('Erreur lors de la g├®n├®ration du fichier Excel.');\r\n    } finally {\r\n      setExportLoading(false);\r\n    }\r\n  }\r\n\r\n  async function exportPowerPoint() {\r\n    if (!result) {\r\n      alert('Les r├®sultats ne sont pas disponibles.');\r\n      return;\r\n    }\r\n\r\n    setExportLoading(true);\r\n    try {\r\n      // V4: Dynamic import PPTX builders\r\n      const [{ buildIrStudyDeck }, { exportAndDownloadStudyDeck }] = await Promise.all([\r\n        import('../pptx/presets/irDeckBuilder'),\r\n        import('../pptx/export/exportStudyDeck')\r\n      ]);\r\n\r\n      // V3.3: Logo resolution based on themeSource\r\n      // Priority: cabinet logo > user logo > undefined\r\n      let exportLogo;\r\n      if (themeSource === 'cabinet') {\r\n        // Mode cabinet: priorit├® logo cabinet, fallback logo user\r\n        exportLogo = cabinetLogo || logo;\r\n      } else {\r\n        // Mode custom: logo user uniquement\r\n        exportLogo = logo;\r\n      }\r\n      \r\n      // TRACE: Log exact logo being used for debugging\r\n      console.info('[IR Export] exportLogo resolved =', exportLogo \r\n        ? (exportLogo.startsWith('data:') ? `dataURI (${exportLogo.length} chars)` : exportLogo.substring(0, 80) + '...')\r\n        : '(none)');\r\n      console.info('[IR Export] themeSource:', themeSource, '| cabinetLogo:', !!cabinetLogo, '| userLogo:', !!logo);\r\n      \r\n      // Fallback: reload from user_metadata if still undefined\r\n      if (!exportLogo) {\r\n        console.info('[IR Export] No logo in context, attempting reload from user_metadata...');\r\n        try {\r\n          const { data: { user } } = await supabase.auth.getUser();\r\n          if (user?.user_metadata?.cover_slide_url) {\r\n            exportLogo = user.user_metadata.cover_slide_url;\r\n            setLogo(exportLogo);\r\n            console.info('[IR Export] Logo reloaded from user_metadata');\r\n          }\r\n        } catch (logoError) {\r\n          console.warn('[IR Export] Failed to reload logo:', logoError);\r\n        }\r\n      }\r\n\r\n      // Build IR data from current result\r\n      const irData = {\r\n        taxableIncome: result.taxableIncome || 0,\r\n        partsNb: result.partsNb || effectiveParts,\r\n        tmiRate: result.tmiRate || 0,\r\n        irNet: result.irNet || 0,\r\n        pfuIr: result.pfuIr || 0,\r\n        cehr: result.cehr || 0,\r\n        cdhr: result.cdhr || 0,\r\n        psFoncier: result.psFoncier || 0,\r\n        psDividends: result.psDividends || 0,\r\n        psTotal: result.psTotal || 0,\r\n        totalTax: result.totalTax || 0,\r\n        bracketsDetails: result.bracketsDetails || [],\r\n        yearLabel,\r\n        status,\r\n        location,\r\n      };\r\n\r\n      const deck = buildIrStudyDeck(irData, pptxColors, exportLogo);\r\n      const dateStr = new Date().toISOString().split('T')[0].replace(/-/g, '');\r\n      const filename = `simulation-ir-${dateStr}.pptx`;\r\n\r\n      // Export and download using pptxColors (respects theme scope setting)\r\n      await exportAndDownloadStudyDeck(deck, pptxColors, filename);\r\n    } catch (error) {\r\n      console.error('Export PowerPoint IR ├®chou├®:', error);\r\n      alert('Erreur lors de la g├®n├®ration du PowerPoint. Veuillez r├®essayer.');\r\n    } finally {\r\n      setExportLoading(false);\r\n    }\r\n  }\r\n\r\n  // ...\r\n\r\n  return (\r\n    <div className=\"ir-panel premium-page\">\r\n      <div className=\"ir-header premium-header\">\r\n        <div className=\"ir-title premium-title\">Simulateur d'imp├┤t sur le revenu</div>\r\n\r\n        <ExportMenu\r\n          options={[\r\n            { label: 'Excel', onClick: exportExcel },\r\n            { label: 'PowerPoint', onClick: exportPowerPoint },\r\n          ]}\r\n          loading={exportLoading}\r\n        />\r\n      </div>\r\n\r\n      <div className=\"ir-grid premium-grid\">\r\n        {/* Bloc de gauche : saisie */}\r\n        {/* ... */}\r\n        <div className=\"ir-left premium-section\">\r\n          <div className=\"ir-table-wrapper premium-card premium-section\">\r\n            <div className=\"ir-top-row\">\r\n              <div className=\"ir-field premium-field\">\r\n                <label>Bar├¿me</label>\r\n                <select\r\n                  className=\"premium-select\"\r\n                  value={yearKey}\r\n                  onChange={(e) => setYearKey(e.target.value)}\r\n                >\r\n                  <option value=\"current\">\r\n                    {taxSettings?.incomeTax?.currentYearLabel || 'Ann├®e N'}\r\n                  </option>\r\n                  <option value=\"previous\">\r\n                    {taxSettings?.incomeTax?.previousYearLabel || 'Ann├®e N-1'}\r\n                  </option>\r\n                </select>\r\n              </div>\r\n\r\n              <div className=\"ir-field premium-field\">\r\n                <label>Situation familiale</label>\r\n                <select\r\n                  className=\"premium-select\"\r\n                  value={status}\r\n                  onChange={(e) => {\r\n                    const newStatus = e.target.value;\r\n                    setStatus(newStatus);\r\n\r\n                    if (newStatus === 'couple') {\r\n                      setIsIsolated(false);\r\n                    } else {\r\n                      // C├®libataire / Veuf / Divorc├® :\r\n                      // On efface les revenus du d├®clarant 2\r\n                      setIncomes((prev) => ({\r\n                        ...prev,\r\n                        d2: {\r\n                          salaries: 0,\r\n                          associes62: 0,\r\n                          pensions: 0,\r\n                          bic: 0,\r\n                          fonciers: 0,\r\n                          autres: 0,\r\n                        },\r\n                      }));\r\n                      setRealMode((prev) => ({ ...prev, d2: 'abat10' }));\r\n                      setRealExpenses((prev) => ({ ...prev, d2: 0 }));\r\n                    }\r\n                    // quel que soit le cas, on remet lÔÇÖajustement manuel ├á 0\r\n                    setParts(0);\r\n                  }}\r\n                >\r\n                  <option value=\"single\">C├®libataire / Veuf / Divorc├®</option>\r\n                  <option value=\"couple\">Mari├® / Pacs├®</option>\r\n                </select>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"ir-table-wrapper\">\r\n            <table\r\n              className={`ir-table ${status === 'single' ? 'ir-table-single' : ''}`}\r\n              aria-label=\"Revenus imposables\"\r\n            >\r\n              <colgroup>\r\n                <col style={{ width: '40%' }} />\r\n                <col style={{ width: '30%' }} />\r\n                <col style={{ width: '30%' }} />\r\n              </colgroup>\r\n              <thead>\r\n                <tr>\r\n                  <th>Revenus imposables</th>\r\n                  <th>D├®clarant 1</th>\r\n                  <th>D├®clarant 2</th>\r\n                </tr>\r\n              </thead>\r\n              <tbody>\r\n                <tr>\r\n                  <td>Traitements et salaires</td>\r\n                  <td>\r\n                    <input\r\n                      type=\"text\"\r\n                      inputMode=\"numeric\"\r\n                      placeholder=\"0 Ôé¼\"\r\n                      value={formatMoneyInput(incomes.d1.salaries)}\r\n                      onChange={(e) => {\r\n                        const raw = e.target.value.replace(/[^\\d]/g, '');\r\n                        updateIncome('d1', 'salaries', raw === '' ? 0 : Number(raw));\r\n                      }}\r\n                    />\r\n                  </td>\r\n                  <td>\r\n                    <input\r\n                      type=\"text\"\r\n                      inputMode=\"numeric\"\r\n                      placeholder=\"0 Ôé¼\"\r\n                      value={formatMoneyInput(incomes.d2.salaries)}\r\n                      onChange={(e) => {\r\n                        const raw = e.target.value.replace(/[^\\d]/g, '');\r\n                        updateIncome('d2', 'salaries', raw === '' ? 0 : Number(raw));\r\n                      }}\r\n                    />\r\n                  </td>\r\n                </tr>\r\n                <tr>\r\n                  <td>Revenus des associ├®s / g├®rants</td>\r\n                  <td>\r\n                    <input\r\n                      type=\"text\"\r\n                      inputMode=\"numeric\"\r\n                      placeholder=\"0 Ôé¼\"\r\n                      value={formatMoneyInput(incomes.d1.associes62)}\r\n                      onChange={(e) => {\r\n                        const raw = e.target.value.replace(/[^\\d]/g, '');\r\n                        updateIncome('d1', 'associes62', raw === '' ? 0 : Number(raw));\r\n                      }}\r\n                    />\r\n                  </td>\r\n                  <td>\r\n                    <input\r\n                      type=\"text\"\r\n                      inputMode=\"numeric\"\r\n                      placeholder=\"0 Ôé¼\"\r\n                      value={formatMoneyInput(incomes.d2.associes62)}\r\n                      onChange={(e) => {\r\n                        const raw = e.target.value.replace(/[^\\d]/g, '');\r\n                        updateIncome('d2', 'associes62', raw === '' ? 0 : Number(raw));\r\n                      }}\r\n                    />\r\n                  </td>\r\n                </tr>\r\n                <tr className=\"ir-row-title\">\r\n                  <td>Frais r├®els ou abattement 10&nbsp;%</td>\r\n                  <td>\r\n                    <div style={{ display: 'flex', gap: 4 }}>\r\n                      <select\r\n                        style={{ flex: 1 }}\r\n                        value={realMode.d1}\r\n                        onChange={(e) =>\r\n                          setRealMode((m) => ({ ...m, d1: e.target.value }))\r\n                        }\r\n                      >\r\n                        <option value=\"reels\">FR</option>\r\n                        <option value=\"abat10\">10%</option>\r\n                      </select>\r\n                      {realMode.d1 === 'reels' ? (\r\n                        <input\r\n                          type=\"text\"\r\n                          inputMode=\"numeric\"\r\n                          placeholder=\"0 Ôé¼\"\r\n                          style={{ flex: 1 }}\r\n                          value={formatMoneyInput(realExpenses.d1)}\r\n                          onChange={(e) => {\r\n                            const raw = e.target.value.replace(/[^\\d]/g, '');\r\n                            setRealExpenses((r) => ({\r\n                              ...r,\r\n                              d1: raw === '' ? 0 : Number(raw),\r\n                            }));\r\n                          }}\r\n                        />\r\n                      ) : (\r\n                        <input\r\n                          type=\"text\"\r\n                          style={{ flex: 1, background: '#f3f3f3' }}\r\n                          readOnly\r\n                          value={formatMoneyInput(abat10SalD1)}\r\n                        />\r\n                      )}\r\n                    </div>\r\n                  </td>\r\n                  <td>\r\n                    <div style={{ display: 'flex', gap: 4 }}>\r\n                      <select\r\n                        style={{ flex: 1 }}\r\n                        value={realMode.d2}\r\n                        onChange={(e) =>\r\n                          setRealMode((m) => ({ ...m, d2: e.target.value }))\r\n                        }\r\n                      >\r\n                        <option value=\"reels\">FR</option>\r\n                        <option value=\"abat10\">10%</option>\r\n                      </select>\r\n                      {realMode.d2 === 'reels' ? (\r\n                        <input\r\n                          type=\"text\"\r\n                          inputMode=\"numeric\"\r\n                          placeholder=\"0 Ôé¼\"\r\n                          style={{ flex: 1 }}\r\n                          value={formatMoneyInput(realExpenses.d2)}\r\n                          onChange={(e) => {\r\n                            const raw = e.target.value.replace(/[^\\d]/g, '');\r\n                            setRealExpenses((r) => ({\r\n                              ...r,\r\n                              d2: raw === '' ? 0 : Number(raw),\r\n                            }));\r\n                          }}\r\n                        />\r\n                      ) : (\r\n                        <input\r\n                          type=\"text\"\r\n                          style={{ flex: 1, background: '#f3f3f3' }}\r\n                          readOnly\r\n                          value={formatMoneyInput(abat10SalD2)}\r\n                        />\r\n                      )}\r\n                    </div>\r\n                  </td>\r\n                </tr>\r\n                <tr>\r\n                  <td>BIC-BNC-BA imposables</td>\r\n                  <td>\r\n                    <input\r\n                      type=\"text\"\r\n                      inputMode=\"numeric\"\r\n                      placeholder=\"0 Ôé¼\"\r\n                      value={formatMoneyInput(incomes.d1.bic)}\r\n                      onChange={(e) => {\r\n                        const raw = e.target.value.replace(/[^\\d]/g, '');\r\n                        updateIncome('d1', 'bic', raw === '' ? 0 : Number(raw));\r\n                      }}\r\n                    />\r\n                  </td>\r\n                  <td>\r\n                    <input\r\n                      type=\"text\"\r\n                      inputMode=\"numeric\"\r\n                      placeholder=\"0 Ôé¼\"\r\n                      value={formatMoneyInput(incomes.d2.bic)}\r\n                      onChange={(e) => {\r\n                        const raw = e.target.value.replace(/[^\\d]/g, '');\r\n                        updateIncome('d2', 'bic', raw === '' ? 0 : Number(raw));\r\n                      }}\r\n                    />\r\n                  </td>\r\n                </tr>\r\n\r\n                <tr>\r\n                  <td>Autres revenus imposables</td>\r\n                  <td>\r\n                    <input\r\n                      type=\"text\"\r\n                      inputMode=\"numeric\"\r\n                      placeholder=\"0 Ôé¼\"\r\n                      value={formatMoneyInput(incomes.d1.autres)}\r\n                      onChange={(e) => {\r\n                        const raw = e.target.value.replace(/[^\\d]/g, '');\r\n                        updateIncome('d1', 'autres', raw === '' ? 0 : Number(raw));\r\n                      }}\r\n                    />\r\n                  </td>\r\n                  <td>\r\n                    <input\r\n                      type=\"text\"\r\n                      inputMode=\"numeric\"\r\n                      placeholder=\"0 Ôé¼\"\r\n                      value={formatMoneyInput(incomes.d2.autres)}\r\n                      onChange={(e) => {\r\n                        const raw = e.target.value.replace(/[^\\d]/g, '');\r\n                        updateIncome('d2', 'autres', raw === '' ? 0 : Number(raw));\r\n                      }}\r\n                    />\r\n                  </td>\r\n                </tr>\r\n                <tr>\r\n                  <td>Pensions, retraites et rentes</td>\r\n                  <td>\r\n                    <input\r\n                      type=\"text\"\r\n                      inputMode=\"numeric\"\r\n                      placeholder=\"0 Ôé¼\"\r\n                      value={formatMoneyInput(incomes.d1.pensions)}\r\n                      onChange={(e) => {\r\n                        const raw = e.target.value.replace(/[^\\d]/g, '');\r\n                        updateIncome('d1', 'pensions', raw === '' ? 0 : Number(raw));\r\n                      }}\r\n                    />\r\n                  </td>\r\n                  <td>\r\n                    <input\r\n                      type=\"text\"\r\n                      inputMode=\"numeric\"\r\n                      placeholder=\"0 Ôé¼\"\r\n                      value={formatMoneyInput(incomes.d2.pensions)}\r\n                      onChange={(e) => {\r\n                        const raw = e.target.value.replace(/[^\\d]/g, '');\r\n                        updateIncome('d2', 'pensions', raw === '' ? 0 : Number(raw));\r\n                      }}\r\n                    />\r\n                  </td>\r\n                </tr>\r\n                <tr className=\"ir-row-title\">\r\n                  <td>Abattement 10&nbsp;% pensions (foyer)</td>\r\n                  <td colSpan={2} style={{ textAlign: 'center' }}>\r\n                    {(() => {\r\n                      const abat10CfgRoot = taxSettings?.incomeTax?.abat10 || {};\r\n                      const cfgRet =\r\n                        yearKey === 'current'\r\n                          ? abat10CfgRoot.retireesCurrent\r\n                          : abat10CfgRoot.retireesPrevious;\r\n                      const baseRet =\r\n                        (incomes.d1.pensions || 0) +\r\n                        (status === 'couple' ? incomes.d2.pensions || 0 : 0);\r\n                      const val = computeAbattement10(baseRet, cfgRet);\r\n                      return euro0(val);\r\n                    })()}\r\n                  </td>\r\n                </tr>\r\n\r\n\r\n<tr>\r\n  <td>Revenus fonciers nets</td>\r\n  <td colSpan={2}>\r\n    <input\r\n      type=\"text\"\r\n      inputMode=\"numeric\"\r\n      placeholder=\"0 Ôé¼\"\r\n      value={formatMoneyInput(incomes.fonciersFoyer || 0)}\r\n      onChange={(e) => {\r\n        const raw = e.target.value.replace(/[^\\d]/g, '');\r\n        const val = raw === '' ? 0 : Number(raw);\r\n        setIncomes((prev) => ({\r\n          ...prev,\r\n          fonciersFoyer: val,\r\n        }));\r\n      }}\r\n    />\r\n  </td>\r\n</tr>\r\n\r\n<tr>\r\n  <td>RCM soumis aux PS ├á {fmtPct(psPatrimonyRate)} %</td>\r\n  <td colSpan={2}>\r\n    <input\r\n      type=\"text\"\r\n      inputMode=\"numeric\"\r\n      placeholder=\"0 Ôé¼\"\r\n      value={formatMoneyInput(incomes.capital.withPs)}\r\n      onChange={(e) => {\r\n        const raw = e.target.value.replace(/[^\\d]/g, '');\r\n        updateIncome('capital', 'withPs', raw === '' ? 0 : Number(raw));\r\n      }}\r\n    />\r\n  </td>\r\n</tr>\r\n\r\n<tr>\r\n  <td>RCM non soumis aux PS ├á {fmtPct(psPatrimonyRate)} %</td>\r\n  <td colSpan={2}>\r\n    <input\r\n      type=\"text\"\r\n      inputMode=\"numeric\"\r\n      placeholder=\"0 Ôé¼\"\r\n      value={formatMoneyInput(incomes.capital.withoutPs)}\r\n      onChange={(e) => {\r\n        const raw = e.target.value.replace(/[^\\d]/g, '');\r\n        updateIncome('capital', 'withoutPs', raw === '' ? 0 : Number(raw));\r\n      }}\r\n    />\r\n  </td>\r\n</tr>\r\n<tr>\r\n  <td>Option d&apos;imposition des RCM</td>\r\n  <td colSpan={2}>\r\n    <select\r\n      value={capitalMode}\r\n      onChange={(e) => setCapitalMode(e.target.value)}\r\n      style={{ width: '100%' }}\r\n    >\r\n      <option value=\"pfu\">PFU {fmtPct(pfuRateIR)} %</option>\r\n      <option value=\"bareme\">Bar├¿me de l&apos;IR (abattement 40 %)</option>\r\n    </select>\r\n  </td>\r\n</tr>\r\n\r\n                <tr className=\"ir-row-title\">\r\n                  <td colSpan={3}>Ajustements</td>\r\n                </tr>\r\n                <tr>\r\n                  <td>D├®ductions (pensions alimentaires, etc.)</td>\r\n                  <td colSpan={2}>\r\n                    <input\r\n                      type=\"text\"\r\n                      inputMode=\"numeric\"\r\n                      placeholder=\"0 Ôé¼\"\r\n                      value={formatMoneyInput(deductions)}\r\n                      onChange={(e) => {\r\n                        const raw = e.target.value.replace(/[^\\d]/g, '');\r\n                        setDeductions(raw === '' ? 0 : Number(raw));\r\n                      }}\r\n                    />\r\n                  </td>\r\n                </tr>\r\n                <tr>\r\n                  <td>R├®ductions / cr├®dits d&apos;imp├┤t</td>\r\n                  <td colSpan={2}>\r\n                    <input\r\n                      type=\"text\"\r\n                      inputMode=\"numeric\"\r\n                      placeholder=\"0 Ôé¼\"\r\n                      value={formatMoneyInput(credits)}\r\n                      onChange={(e) => {\r\n                        const raw = e.target.value.replace(/[^\\d]/g, '');\r\n                        setCredits(raw === '' ? 0 : Number(raw));\r\n                      }}\r\n                    />\r\n                  </td>\r\n                </tr>\r\n\r\n              </tbody>\r\n            </table>\r\n          </div>\r\n\r\n\r\n          \r\n          </div>\r\n\r\n        {/* Bloc de droite */}\r\n        <div className=\"ir-right\">\r\n          <div className=\"ir-field\">\r\n            <label>R├®sidence</label>\r\n            <select\r\n              value={location}\r\n              onChange={(e) => setLocation(e.target.value)}\r\n            >\r\n              <option value=\"metropole\">M├®tropole</option>\r\n              <option value=\"gmr\">\r\n                Guadeloupe / Martinique / R├®union\r\n              </option>\r\n              <option value=\"guyane\">Guyane / Mayotte</option>\r\n            </select>\r\n          </div>\r\n\r\n          {status === 'single' && (\r\n            <div className=\"ir-field\">\r\n              <label>Situation familiale particuli├¿re</label>\r\n\r\n              <label style={{ fontSize: 12 }}>\r\n                <input\r\n                  type=\"checkbox\"\r\n                  checked={isIsolated}\r\n                  onChange={(e) => setIsIsolated(e.target.checked)}\r\n                  style={{ marginRight: 6 }}\r\n                />\r\n                Parent isol├®\r\n              </label>\r\n            </div>\r\n          )}\r\n\r\n          <button\r\n            type=\"button\"\r\n            className=\"chip\"\r\n            onClick={() =>\r\n              setChildren((c) => [\r\n                ...c,\r\n                { id: Date.now(), mode: 'charge' },\r\n              ])\r\n            }\r\n          >\r\n            + Ajouter un enfant\r\n          </button>\r\n\r\n          {children.map((child, idx) => (\r\n            <div\r\n              key={child.id}\r\n              style={{\r\n                display: 'flex',\r\n                alignItems: 'center',\r\n                gap: 8,\r\n                fontSize: 13,\r\n                marginTop: 4,\r\n              }}\r\n            >\r\n              <strong>Enfant {idx + 1}</strong>\r\n\r\n<select\r\n  className=\"ir-child-select\"\r\n  value={child.mode}\r\n  onChange={(e) =>\r\n    setChildren((list) =>\r\n      list.map((c) =>\r\n        c.id === child.id ? { ...c, mode: e.target.value } : c\r\n      )\r\n    )\r\n  }\r\n>\r\n  <option value=\"charge\">├Ç charge</option>\r\n  <option value=\"shared\">Garde altern├®e</option>\r\n</select>\r\n\r\n\r\n              <button\r\n                type=\"button\"\r\n                className=\"chip\"\r\n                style={{ padding: '2px 6px', fontSize: 12 }}\r\n                onClick={() =>\r\n                  setChildren((list) =>\r\n                    list.filter((c) => c.id !== child.id)\r\n                  )\r\n                }\r\n              >\r\n                ÔêÆ\r\n              </button>\r\n            </div>\r\n          ))}\r\n\r\n<div className=\"ir-parts-row\">\r\n  <div className=\"ir-field\">\r\n    <label>Nombre de parts (calcul├®)</label>\r\n    <input\r\n      type=\"text\"\r\n      readOnly\r\n      value={effectiveParts.toFixed(2)}\r\n      style={{ background: '#f3f3f3' }}\r\n    />\r\n  </div>\r\n\r\n  <div className=\"ir-field\">\r\n    <label>Ajustement de parts</label>\r\n    <input\r\n      type=\"number\"\r\n      step=\"0.25\"\r\n      value={parts}\r\n      onChange={(e) =>\r\n        setParts(\r\n          Math.round(Number(e.target.value || 0) * 4) / 4\r\n        )\r\n      }\r\n      title=\"Ajustement manuel\"\r\n    />\r\n  </div>\r\n</div>\r\n\r\n\r\n          <div className=\"ir-tmi-card\">\r\n            <div className=\"ir-tmi-header\">Estimation IR</div>\r\n\r\n            <div className=\"ir-tmi-bar\">\r\n              {tmiScale.map((br, idx) => {\r\n                const rate = Number(br.rate) || 0;\r\n                const isActive = rate === (result?.tmiRate || 0);\r\n                return (\r\n                  <div\r\n                    key={idx}\r\n                    className={`ir-tmi-segment${\r\n                      isActive ? ' is-active' : ''\r\n                    }`}\r\n                  >\r\n                    <span>{rate}%</span>\r\n                  </div>\r\n                );\r\n              })}\r\n            </div>\r\n\r\n            <div className=\"ir-tmi-rows\">\r\n              <div className=\"ir-tmi-row\">\r\n                <span>TMI</span>\r\n                <span>\r\n                  {result ? `${result.tmiRate || 0} %` : '-'}\r\n                </span>\r\n              </div>\r\n              <div className=\"ir-tmi-row\">\r\n                <span>Imp├┤t sur le revenu</span>\r\n                <span>\r\n                  {result ? euro0(result.irNet || 0) : '-'}\r\n                </span>\r\n              </div>\r\n\r\n            </div>\r\n\r\n            <div className=\"ir-tmi-sub\">\r\n              <div>\r\n                Montant des revenus dans cette TMI :{' '}\r\n                {result ? euro0(result.tmiBaseGlobal) : '0 Ôé¼'}\r\n              </div>\r\n              <div>\r\n                Marge avant changement de TMI :{' '}\r\n                {result && result.tmiMarginGlobal != null\r\n                  ? euro0(result.tmiMarginGlobal)\r\n                  : 'ÔÇö'}\r\n              </div>\r\n            </div>\r\n\r\n\r\n            \r\n          </div>\r\n\r\n          {result && (\r\n            <div className=\"ir-summary-card\">\r\n              <div className=\"ir-summary-row\">\r\n                <span>Revenu imposable du foyer</span>\r\n                <span>{euro0(result.taxableIncome)}</span>\r\n              </div>\r\n              <div className=\"ir-summary-row\">\r\n                <span>Nombre de parts</span>\r\n                <span>{result.partsNb}</span>\r\n              </div>\r\n              <div className=\"ir-summary-row\">\r\n                <span>Revenu par part</span>\r\n                <span>{euro0(result.taxablePerPart)}</span>\r\n              </div>\r\n\r\n              <div className=\"ir-summary-row\">\r\n                <span>Imp├┤t sur le revenu</span>\r\n                <span>{euro0(result.irNet || 0)}</span>\r\n              </div>\r\n              <div className=\"ir-summary-row\">\r\n                <span>PFU {fmtPct(pfuRateIR)} %</span>\r\n                <span>{euro0(result.pfuIr || 0)}</span>\r\n              </div>\r\n              <div className=\"ir-summary-row\">\r\n                <span>CEHR</span>\r\n                <span>{euro0(result.cehr || 0)}</span>\r\n              </div>\r\n              <div className=\"ir-summary-row\">\r\n                <span>CDHR</span>\r\n                <span>{euro0(result.cdhr || 0)}</span>\r\n              </div>\r\n              <div className=\"ir-summary-row\">\r\n                <span>PS sur les revenus fonciers</span>\r\n                <span>{euro0(result.psFoncier || 0)}</span>\r\n              </div>\r\n              <div className=\"ir-summary-row\">\r\n                <span>PS sur dividendes</span>\r\n                <span>{euro0(result.psDividends || 0)}</span>\r\n              </div>\r\n              <div className=\"ir-summary-row\">\r\n                <span>Imposition totale</span>\r\n                <span>{euro0(result.totalTax || 0)}</span>\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          <button\r\n            type=\"button\"\r\n            className=\"chip\"\r\n            onClick={() => setShowDetails((v) => !v)}\r\n            style={{ marginTop: 12 }}\r\n          >\r\n            {showDetails\r\n              ? 'Masquer le d├®tail du calcul'\r\n              : 'Afficher le d├®tail du calcul'}\r\n          </button>\r\n        </div> {/* fin .ir-right */}\r\n\r\n      </div>\r\n\r\n      {showDetails && result && (\r\n        <div className=\"ir-details\">\r\n\r\n          <h3>D├®tail du calcul</h3>\r\n\r\n          <h4>Bar├¿me de l&apos;imp├┤t sur le revenu</h4>\r\n          <table className=\"ir-table premium-table\">\r\n            <thead>\r\n              <tr>\r\n                <th>Tranche</th>\r\n                <th>Base (par part)</th>\r\n                <th>Taux</th>\r\n                <th>Imp├┤t (par part)</th>\r\n              </tr>\r\n            </thead>\r\n            <tbody>\r\n              {(Array.isArray(result.bracketsDetails) ? result.bracketsDetails : []).map((row, idx) => (\r\n                <tr key={idx}>\r\n                  <td>{row.label}</td>\r\n                  <td>{euro0(row.base)}</td>\r\n                  <td>{row.rate} %</td>\r\n                  <td>{euro0(row.tax)}</td>\r\n                </tr>\r\n              ))}\r\n            </tbody>\r\n          </table>\r\n    <table className=\"ir-table premium-table\">\r\n      <tbody>\r\n        <tr>\r\n          <td>Base imposable du foyer</td>\r\n          <td style={{ textAlign: 'right' }}>\r\n            {euro0(result.taxableIncome)}\r\n          </td>\r\n        </tr>\r\n        <tr>\r\n          <td>Imp├┤t avant quotient familial</td>\r\n          <td style={{ textAlign: 'right' }}>\r\n            {euro0(result.irBeforeQfBase || 0)}\r\n          </td>\r\n        </tr>\r\n        \r\n        <tr>\r\n          <td>Quotient familial</td>\r\n          <td style={{ textAlign: 'right' }}>\r\n            {euro0(result.qfAdvantage || 0)}\r\n          </td>\r\n        </tr>\r\n        <tr>\r\n          <td>Imp├┤t apr├¿s quotient familial</td>\r\n          <td style={{ textAlign: 'right' }}>\r\n            {euro0(result.irAfterQf || 0)}\r\n          </td>\r\n        </tr>\r\n        {(result.domAbatementAmount || 0) > 0 && (\r\n  <tr>\r\n    <td>Abattement DOM</td>\r\n    <td style={{ textAlign: 'right' }}>\r\n      - {euro0(result.domAbatementAmount)}\r\n    </td>\r\n  </tr>\r\n)}\r\n        <tr>\r\n  <td>Imp├┤t apr├¿s abattement DOM</td>\r\n  <td style={{ textAlign: 'right' }}>\r\n    {euro0(Math.max(0, (result.irAfterQf || 0) - (result.domAbatementAmount || 0)))}\r\n  </td>\r\n</tr>\r\n\r\n        <tr>\r\n          <td>R├®ductions et cr├®dits d&apos;imp├┤t</td>\r\n          <td style={{ textAlign: 'right' }}>\r\n            {euro0(result.creditsTotal || 0)}\r\n          </td>\r\n        </tr>\r\n        <tr>\r\n          <td>D├®cote</td>\r\n          <td style={{ textAlign: 'right' }}>\r\n            {euro0(result.decote || 0)}\r\n          </td>\r\n        </tr>\r\n        <tr>\r\n          <td>Imp├┤t apr├¿s r├®ductions, cr├®dits d&apos;imp├┤t et d├®cote</td>\r\n          <td style={{ textAlign: 'right' }}>\r\n            {euro0(result.irNet || 0)}\r\n          </td>\r\n        </tr>\r\n      </tbody>\r\n    </table>\r\n\r\n          <h4>CEHR</h4>\r\n          {result.cehrDetails && result.cehrDetails.length > 0 ? (\r\n            <table className=\"ir-table premium-table\">\r\n              <thead>\r\n                <tr>\r\n                  <th>Tranche RFR</th>\r\n                  <th>Base</th>\r\n                  <th>Taux</th>\r\n                  <th>CEHR</th>\r\n                </tr>\r\n              </thead>\r\n              <tbody>\r\n                {result.cehrDetails.map((row, idx) => (\r\n                  <tr key={idx}>\r\n                    <td>{row.label}</td>\r\n                    <td>{euro0(row.base)}</td>\r\n                    <td>{row.rate} %</td>\r\n                    <td>{euro0(row.tax)}</td>\r\n                  </tr>\r\n                ))}\r\n              </tbody>\r\n            </table>\r\n          ) : (\r\n            <p>Aucune CEHR due.</p>\r\n          )}\r\n\r\n<h4>CDHR</h4>\r\n{result.cdhrDetails ? (\r\n  <table className=\"ir-table premium-table\">\r\n    <tbody>\r\n      <tr>\r\n        <td>Assiette (RFR)</td>\r\n        <td style={{ textAlign: 'right' }}>{euro0(result.cdhrDetails.assiette)}</td>\r\n      </tr>\r\n\r\n      <tr>\r\n        <td>Terme A (avant d├®cote) : {result.cdhrDetails.minRatePercent}% ├ù assiette</td>\r\n        <td style={{ textAlign: 'right' }}>{euro0(result.cdhrDetails.termA_beforeDecote)}</td>\r\n      </tr>\r\n\r\n      <tr>\r\n        <td>D├®cote CDHR appliqu├®e</td>\r\n        <td style={{ textAlign: 'right' }}>{euro0(result.cdhrDetails.decoteApplied)}</td>\r\n      </tr>\r\n\r\n      <tr>\r\n        <td><strong>Terme A (apr├¿s d├®cote)</strong></td>\r\n        <td style={{ textAlign: 'right' }}><strong>{euro0(result.cdhrDetails.termA_afterDecote)}</strong></td>\r\n      </tr>\r\n\r\n      <tr>\r\n        <td>Terme B : IR retenu</td>\r\n        <td style={{ textAlign: 'right' }}>{euro0(result.cdhrDetails.irRetenu)}</td>\r\n      </tr>\r\n\r\n      <tr>\r\n        <td>+ PFU {fmtPct(pfuRateIR)}% (part IR)</td>\r\n        <td style={{ textAlign: 'right' }}>{euro0(result.cdhrDetails.pfuIr)}</td>\r\n      </tr>\r\n\r\n      <tr>\r\n        <td>+ CEHR</td>\r\n        <td style={{ textAlign: 'right' }}>{euro0(result.cdhrDetails.cehr)}</td>\r\n      </tr>\r\n\r\n      <tr>\r\n        <td>\r\n          + Majorations (couple + charges) ÔÇö charges : {result.cdhrDetails.personsAChargeCount}\r\n        </td>\r\n        <td style={{ textAlign: 'right' }}>{euro0(result.cdhrDetails.majorations)}</td>\r\n      </tr>\r\n\r\n      <tr>\r\n        <td style={{ paddingLeft: 18, opacity: 0.85 }}>ÔÇó Majoration couple</td>\r\n        <td style={{ textAlign: 'right', opacity: 0.85 }}>{euro0(result.cdhrDetails.majCouple)}</td>\r\n      </tr>\r\n\r\n      <tr>\r\n        <td style={{ paddingLeft: 18, opacity: 0.85 }}>ÔÇó Majoration personnes ├á charge</td>\r\n        <td style={{ textAlign: 'right', opacity: 0.85 }}>{euro0(result.cdhrDetails.majCharges)}</td>\r\n      </tr>\r\n\r\n      <tr>\r\n        <td><strong>CDHR = max(0, Terme A (apr├¿s d├®cote) ÔêÆ Terme B)</strong></td>\r\n        <td style={{ textAlign: 'right' }}><strong>{euro0(result.cdhr || 0)}</strong></td>\r\n      </tr>\r\n    </tbody>\r\n  </table>\r\n) : (\r\n  <p>Aucune CDHR due.</p>\r\n)}\r\n\r\n\r\n          \r\n        </div>\r\n      )}\r\n<div className=\"ir-disclaimer\">\r\n  <strong>Hypoth├¿ses / simplifications</strong>\r\n  <p>\r\n    RCM au bar├¿me : abattement forfaitaire de 40% sur l&apos;assiette IR (simplifi├®).\r\n  </p>\r\n  <p>\r\n    RFR (CEHR / CDHR) : revenu imposable + RCM au PFU (simplifi├®).\r\n  </p>\r\n  <p>\r\n    CDHR : certains param├¿tres (d├®cote / majorations) utilisent des valeurs par d├®faut si non param├®tr├®s.\r\n  </p>\r\n  <p>\r\n    Le simulateur ne prend pas en compte certaines situations particuli├¿res (enfants\r\n    majeurs rattach├®s, pensions complexes, fiscalit├® ├®trang├¿re, transfert de domicile en cours d'ann├®e, ...).\r\n    <br />\r\n    Ces situations peuvent n├®cessiter une analyse personnalis├®e.\r\n  </p>\r\n  {isIsolated && (\r\n    <p>\r\n      R├¿gle cl├® : tu dois choisir entre le calcul en \"parts\" (enfant ├á charge / altern├®e) et la\r\n      \"d├®duction de pension alimentaire\". Si tu d├®duis une pension pour un enfant, cet enfant ne\r\n      peut pas ├¬tre compt├® ├á ta charge pour le quotient familial.\r\n    </p>\r\n  )}\r\n</div>\r\n\r\n\r\n\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pages\\Login.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pages\\PlacementV2.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'deltas' is assigned a value but never used.","line":1328,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":1328,"endColumn":37,"suggestions":[{"messageId":"removeVar","data":{"varName":"deltas"},"fix":{"range":[51892,51900],"text":""},"desc":"Remove unused variable 'deltas'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"´╗┐/**\r\n * PlacementV2.jsx - Simulateur de placement refondu\r\n * \r\n * Architecture :\r\n * - Moteur de calcul d├®coupl├® (placementEngine.js)\r\n * - Settings-driven (hook usePlacementSettings)\r\n * - 3 phases : ├ëpargne ÔåÆ Liquidation ÔåÆ Transmission\r\n */\r\n\r\nimport React, { useCallback, useEffect, useMemo, useState } from 'react';\r\nimport { usePlacementSettings } from '../hooks/usePlacementSettings.js';\r\nimport {\r\n  ENVELOPE_LABELS,\r\n  simulateComplete,\r\n  compareProducts,\r\n} from '../engine/placementEngine.js';\r\nimport './Ir.css';\r\nimport './Placement.css';\r\nimport { DEFAULT_VERSEMENT_CONFIG, normalizeVersementConfig } from '../utils/versementConfig.js';\r\nimport { onResetEvent, storageKeyFor } from '../utils/reset.js';\r\nimport { PLACEMENT_SAVE_EVENT, PLACEMENT_LOAD_EVENT } from '../utils/placementEvents.js';\r\nimport { buildWorksheetXmlVertical, downloadExcel } from '../utils/exportExcel.js';\r\nimport { savePlacementState, loadPlacementStateFromFile } from '../utils/placementPersistence.js';\r\nimport { TimelineBar } from '../components/TimelineBar.jsx';\r\nimport { computeDmtgConsumptionRatio, shouldShowDmtgDisclaimer } from '../utils/transmissionDisclaimer.js';\r\nimport { ExportMenu } from '../components/ExportMenu';\r\n\r\n// ============================================================================\r\n// HELPERS\r\n// ============================================================================\r\n\r\nconst fmt = (n) => Math.round(n).toLocaleString('fr-FR');\r\nconst euro = (n) => `${fmt(n)} Ôé¼`;\r\nconst EPSILON = 1e-6;\r\n\r\nconst formatPsApplicability = (ps) => (ps?.applicable ? 'Oui' : 'Non');\r\nconst formatPsMontant = (ps, formatter) => (ps?.applicable ? formatter(ps.montant || 0) : 'ÔÇö');\r\nconst formatPsNote = (ps) => ps?.note || 'ÔÇö';\r\nconst getPsAssietteNumeric = (ps) => (ps?.applicable ? ps.assiette || 0 : 0);\r\nconst getPsTauxNumeric = (ps) => (ps?.applicable && typeof ps?.taux === 'number' ? ps.taux : 0);\r\nconst getPsMontantNumeric = (ps) => (ps?.applicable ? ps.montant || 0 : 0);\r\n\r\nconst shortEuro = (v) => {\r\n  const n = Number(v) || 0;\r\n  if (Math.abs(n) >= 1_000_000) return `${(n / 1_000_000).toLocaleString('fr-FR', { maximumFractionDigits: 1 })} MÔé¼`;\r\n  if (Math.abs(n) >= 1_000) return `${(n / 1_000).toLocaleString('fr-FR', { maximumFractionDigits: 0 })} kÔé¼`;\r\n  return `${n.toLocaleString('fr-FR', { maximumFractionDigits: 0 })} Ôé¼`;\r\n};\r\n\r\nfunction withReinvestCumul(rows = []) {\r\n  let cumul = 0;\r\n  return rows.map((row) => {\r\n    const montant = row.reinvestissementDistribNetAnnee ?? 0;\r\n    cumul += montant;\r\n    return { ...row, cumulReinvestissement: cumul };\r\n  });\r\n}\r\n\r\nconst DEFAULT_PRODUCT = {\r\n  envelope: 'AV',\r\n  dureeEpargne: 20,\r\n  perBancaire: false,\r\n  optionBaremeIR: false,\r\n  fraisGestion: 0.01,\r\n  rendementLiquidationOverride: null,\r\n  versementConfig: normalizeVersementConfig(DEFAULT_VERSEMENT_CONFIG),\r\n};\r\n\r\nfunction normalizeProduct(product = {}) {\r\n  return {\r\n    ...DEFAULT_PRODUCT,\r\n    ...product,\r\n    versementConfig: normalizeVersementConfig(\r\n      product.versementConfig || DEFAULT_VERSEMENT_CONFIG\r\n    ),\r\n  };\r\n}\r\n\r\nfunction sanitizeStep(step) {\r\n  const allowed = new Set(['epargne', 'liquidation', 'transmission', 'synthese']);\r\n  return allowed.has(step) ? step : 'epargne';\r\n}\r\n\r\nfunction normalizeLoadedState(payload = {}) {\r\n  const products = Array.isArray(payload.products) ? payload.products : [];\r\n  const product1 = normalizeProduct(products[0]);\r\n  const product2 = normalizeProduct(products[1]);\r\n\r\n  return {\r\n    step: sanitizeStep(payload.step),\r\n    client: { ...DEFAULT_CLIENT, ...(payload.client || {}) },\r\n    products: [product1, product2],\r\n    liquidation: { ...DEFAULT_LIQUIDATION, ...(payload.liquidation || {}) },\r\n    transmission: { ...DEFAULT_TRANSMISSION, ...(payload.transmission || {}) },\r\n  };\r\n}\r\n\r\nfunction buildPersistedState(state) {\r\n  return {\r\n    step: state.step,\r\n    client: state.client,\r\n    products: state.products,\r\n    liquidation: state.liquidation,\r\n    transmission: state.transmission,\r\n  };\r\n}\r\n\r\nfunction getRendementLiquidation(product) {\r\n  if (!product || product.envelope === 'SCPI') return null;\r\n  const override = product.rendementLiquidationOverride;\r\n  if (typeof override === 'number') return override;\r\n  return product.versementConfig?.capitalisation?.rendementAnnuel ?? 0.03;\r\n}\r\n\r\nconst DEFAULT_CLIENT = {\r\n  ageActuel: 45,\r\n  tmiEpargne: 0.30,\r\n  tmiRetraite: 0.11,\r\n  situation: 'single',\r\n};\r\n\r\nconst DEFAULT_LIQUIDATION = {\r\n  mode: 'epuiser',\r\n  duree: 25,\r\n  mensualiteCible: 500,\r\n  montantUnique: 50000,\r\n  optionBaremeIR: false,\r\n};\r\n\r\nconst DEFAULT_DMTG_RATE = 0.20;\r\n\r\nfunction formatPercent(value) {\r\n  if (typeof value !== 'number' || Number.isNaN(value)) return '';\r\n  const percent = value * 100;\r\n  const decimals = Number.isInteger(percent) ? 0 : 2;\r\n  return `${percent.toFixed(decimals)} %`;\r\n}\r\n\r\nfunction formatDmtgRange(from, to) {\r\n  const formatEuro = (val, fallback = 0) => {\r\n    const numeric = typeof val === 'number' ? val : fallback;\r\n    return `${numeric.toLocaleString('fr-FR')} Ôé¼`;\r\n  };\r\n  const fromText = formatEuro(from, 0);\r\n  const toText = typeof to === 'number' ? formatEuro(to, 0) : 'Ôê×';\r\n  return `${fromText} ÔåÆ ${toText}`;\r\n}\r\n\r\nfunction buildDmtgOptions(scale) {\r\n  if (!Array.isArray(scale) || !scale.length) {\r\n    return [\r\n      {\r\n        value: DEFAULT_DMTG_RATE,\r\n        label: `${formatPercent(DEFAULT_DMTG_RATE)} (par d├®faut)`,\r\n        rangeFrom: 0,\r\n        rangeTo: null,\r\n        key: 'dmtg-default',\r\n      },\r\n    ];\r\n  }\r\n\r\n  return [...scale]\r\n    .sort((a, b) => (a?.rate ?? 0) - (b?.rate ?? 0))\r\n    .map((tranche, idx) => {\r\n      const rateValue = (tranche?.rate ?? 0) / 100;\r\n      return {\r\n        value: rateValue,\r\n        label: `${formatPercent(rateValue)} (${formatDmtgRange(tranche?.from, tranche?.to)})`,\r\n        rangeFrom: typeof tranche?.from === 'number' ? tranche.from : 0,\r\n        rangeTo: typeof tranche?.to === 'number' ? tranche.to : null,\r\n        key: `dmtg-${idx}-${rateValue}`,\r\n      };\r\n    });\r\n}\r\n\r\nfunction buildCustomDmtgOption(value) {\r\n  return {\r\n    value,\r\n    label: `Personnalis├® (${formatPercent(value)})`,\r\n    rangeFrom: 0,\r\n    rangeTo: null,\r\n    key: 'dmtg-custom',\r\n  };\r\n}\r\n\r\nconst DEFAULT_TRANSMISSION = {\r\n  ageAuDeces: 85,\r\n  nbBeneficiaires: 2,\r\n  dmtgTaux: null,\r\n  beneficiaryType: 'enfants',\r\n};\r\n\r\nconst BENEFICIARY_OPTIONS = [\r\n  { value: 'conjoint', label: 'Conjoint / partenaire PACS' },\r\n  { value: 'enfants', label: 'Enfant(s)' },\r\n];\r\n\r\nconst DEFAULT_STATE = {\r\n  step: 'epargne',\r\n  client: DEFAULT_CLIENT,\r\n  products: [\r\n    normalizeProduct({ envelope: 'AV' }),\r\n    normalizeProduct({ envelope: 'PER' }),\r\n  ],\r\n  liquidation: DEFAULT_LIQUIDATION,\r\n  transmission: DEFAULT_TRANSMISSION,\r\n};\r\n\r\n// ============================================================================\r\n// COMPONENTS\r\n// ============================================================================\r\n\r\nfunction InputEuro({ value, onChange, label, disabled }) {\r\n  return (\r\n    <div className=\"pl-field\">\r\n      {label && <label>{label}</label>}\r\n      <div className=\"pl-input\">\r\n        <input\r\n          type=\"text\"\r\n          className=\"pl-input__field\"\r\n          value={fmt(value)}\r\n          onChange={(e) => {\r\n            const clean = e.target.value.replace(/\\D/g, '').slice(0, 9);\r\n            onChange(clean === '' ? 0 : Number(clean));\r\n          }}\r\n          disabled={disabled}\r\n        />\r\n        <span className=\"pl-input__unit\">Ôé¼</span>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction formatPctInput(value) {\r\n  const numeric = Number(value);\r\n  if (Number.isNaN(numeric)) return '';\r\n  return numeric.toLocaleString('fr-FR', { maximumFractionDigits: 2 });\r\n}\r\n\r\nfunction parsePctInput(input) {\r\n  const trimmed = input.trim();\r\n  if (trimmed === '') return { numeric: null };\r\n  const normalized = trimmed.replace(',', '.').replace(/[^\\d.-]/g, '');\r\n  if (normalized === '' || normalized === '-' || normalized === '.') {\r\n    return { numeric: null };\r\n  }\r\n  const num = parseFloat(normalized);\r\n  if (Number.isNaN(num)) return { numeric: null };\r\n  return { numeric: num };\r\n}\r\n\r\nfunction InputPct({ value, onChange, label, disabled }) {\r\n  const [local, setLocal] = useState(() => formatPctInput(value * 100));\r\n  const [isFocused, setIsFocused] = useState(false);\r\n\r\n  useEffect(() => {\r\n    if (!isFocused) {\r\n      setLocal(formatPctInput(value * 100));\r\n    }\r\n  }, [value, isFocused]);\r\n\r\n  const handleChange = (e) => {\r\n    // IMPORTANT: ne pas pousser dans le state parent pendant la frappe.\r\n    // Sinon, une re-normalisation / re-render peut ├®craser la saisie.\r\n    setLocal(e.target.value);\r\n  };\r\n\r\n  const handleBlur = () => {\r\n    setIsFocused(false);\r\n\r\n    const parsed = parsePctInput(local);\r\n    const numeric = parsed.numeric;\r\n    const clamped = numeric === null ? 0 : Math.min(100, Math.max(0, numeric));\r\n    onChange(clamped / 100);\r\n    setLocal(formatPctInput(clamped));\r\n  };\r\n\r\n  const handleFocus = () => {\r\n    setIsFocused(true);\r\n  };\r\n\r\n  return (\r\n    <div className=\"pl-field\">\r\n      {label && <label>{label}</label>}\r\n      <div className=\"pl-input\">\r\n        <input\r\n          type=\"text\"\r\n          inputMode=\"decimal\"\r\n          className=\"pl-input__field\"\r\n          value={local}\r\n          onChange={handleChange}\r\n          onFocus={handleFocus}\r\n          onBlur={handleBlur}\r\n          disabled={disabled}\r\n        />\r\n        <span className=\"pl-input__unit\">%</span>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction InputNumber({ value, onChange, label, unit, min = 0, max = 999, inline = false }) {\r\n  const [localValue, setLocalValue] = useState(String(value));\r\n\r\n  useEffect(() => {\r\n    setLocalValue(String(value));\r\n  }, [value]);\r\n\r\n  const handleChange = (e) => {\r\n    const raw = e.target.value;\r\n    // Permettre la saisie libre de chiffres\r\n    if (/^\\d*$/.test(raw)) {\r\n      setLocalValue(raw);\r\n    }\r\n  };\r\n\r\n  const handleBlur = () => {\r\n    const num = localValue === '' ? min : Number(localValue);\r\n    const clamped = Math.min(max, Math.max(min, num));\r\n    setLocalValue(String(clamped));\r\n    onChange(clamped);\r\n  };\r\n\r\n  const inputEl = (\r\n    <input\r\n      type=\"text\"\r\n      inputMode=\"numeric\"\r\n      className=\"pl-input__field\"\r\n      value={localValue}\r\n      onChange={handleChange}\r\n      onBlur={handleBlur}\r\n      style={{ width: inline ? 70 : '100%' }}\r\n    />\r\n  );\r\n\r\n  if (inline) {\r\n    return (\r\n      <div className=\"pl-input\">\r\n        {inputEl}\r\n        {unit && <span className=\"pl-input__unit\">{unit}</span>}\r\n      </div>\r\n    );\r\n  }\r\n  return (\r\n    <div className=\"pl-field\">\r\n      {label && <label>{label}</label>}\r\n      <div className=\"pl-input\">\r\n        {inputEl}\r\n        {unit && <span className=\"pl-input__unit\">{unit}</span>}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction Select({ value, onChange, options, label }) {\r\n  return (\r\n    <div className=\"pl-field\">\r\n      {label && <label>{label}</label>}\r\n      <select className=\"pl-select\" value={value} onChange={(e) => onChange(e.target.value)}>\r\n        {options.map((o) => (\r\n          <option key={o.value} value={o.value}>{o.label}</option>\r\n        ))}\r\n      </select>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction Toggle({ checked, onChange, label }) {\r\n  return (\r\n    <label className=\"pl-toggle\">\r\n      <input type=\"checkbox\" checked={checked} onChange={(e) => onChange(e.target.checked)} />\r\n      <span className=\"pl-toggle__label\">{label}</span>\r\n    </label>\r\n  );\r\n}\r\n\r\nfunction CollapsibleTable({ title, rows, columns, renderRow }) {\r\n  const [open, setOpen] = useState(false);\r\n  if (!rows || rows.length === 0) return null;\r\n  return (\r\n    <div className=\"pl-collapsible\">\r\n      <button className=\"pl-collapsible__toggle\" onClick={() => setOpen(!open)}>\r\n        {open ? 'Ôû╝' : 'ÔûÂ'} {title} ({rows.length} ann├®es)\r\n      </button>\r\n      {open && (\r\n        <table className=\"ir-table pl-detail-table\">\r\n          <thead>\r\n            <tr>\r\n              {columns.map((c, i) => <th key={i}>{c}</th>)}\r\n            </tr>\r\n          </thead>\r\n          <tbody>\r\n            {rows.map((r, i) => renderRow(r, i))}\r\n          </tbody>\r\n        </table>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n// ============================================================================\r\n// Allocation Slider Component\r\nfunction AllocationSlider({ pctCapi, pctDistrib, onChange, disabled, isSCPI }) {\r\n  const handleCapiChange = (pctCapi) => {\r\n    onChange(pctCapi, 100 - pctCapi);\r\n  };\r\n\r\n  if (isSCPI) {\r\n    return (\r\n      <div className=\"pl-alloc-fixed\">\r\n        <span className=\"pl-alloc-badge pl-alloc-badge--distrib\">100% Distribution</span>\r\n        <span className=\"pl-alloc-hint\">SCPI : distribution uniquement</span>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"pl-alloc-slider\">\r\n      <div className=\"pl-alloc-labels\">\r\n        <span className=\"pl-alloc-label\">Capitalisation</span>\r\n        <span className=\"pl-alloc-label\">Distribution</span>\r\n      </div>\r\n      <div className=\"pl-alloc-track\">\r\n        <input\r\n          type=\"range\"\r\n          min=\"0\"\r\n          max=\"100\"\r\n          value={pctCapi}\r\n          onChange={(e) => handleCapiChange(Number(e.target.value))}\r\n          className=\"pl-alloc-range\"\r\n          disabled={disabled}\r\n        />\r\n        <div className=\"pl-alloc-fill\" style={{ width: `${pctCapi}%` }} />\r\n      </div>\r\n      <div className=\"pl-alloc-values\">\r\n        <div className=\"pl-alloc-value\">\r\n          <input\r\n            type=\"number\"\r\n            min=\"0\"\r\n            max=\"100\"\r\n            value={pctCapi}\r\n            onChange={(e) => handleCapiChange(Number(e.target.value))}\r\n            className=\"pl-alloc-input\"\r\n            disabled={disabled}\r\n          />\r\n          <span>%</span>\r\n        </div>\r\n        <div className=\"pl-alloc-value\">\r\n          <input\r\n            type=\"number\"\r\n            min=\"0\"\r\n            max=\"100\"\r\n            value={pctDistrib}\r\n            onChange={(e) => handleCapiChange(100 - Number(e.target.value))}\r\n            className=\"pl-alloc-input\"\r\n            disabled={disabled}\r\n          />\r\n          <span>%</span>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n// ============================================================================\r\n// Helper function for updating product options (moved inside component)\r\n\r\nfunction VersementConfigModal({ envelope, config, dureeEpargne, onSave, onClose }) {\r\n  const [draft, setDraft] = useState(() => normalizeVersementConfig(config));\r\n  \r\n  const isSCPI = envelope === 'SCPI';\r\n  const isPER = envelope === 'PER';\r\n  const isCTO = envelope === 'CTO';\r\n  const isAV = envelope === 'AV';\r\n  \r\n  // SCPI forc├® en 100% distribution\r\n  useEffect(() => {\r\n    if (isSCPI) {\r\n      setDraft(d => ({\r\n        ...d,\r\n        initial: { ...d.initial, pctCapitalisation: 0, pctDistribution: 100 },\r\n        annuel: { ...d.annuel, pctCapitalisation: 0, pctDistribution: 100 },\r\n        ponctuels: (d.ponctuels || []).map((p) => ({\r\n          ...p,\r\n          pctCapitalisation: 0,\r\n          pctDistribution: 100,\r\n        })),\r\n      }));\r\n    }\r\n  }, [isSCPI]);\r\n\r\n  const updateInitial = (field, value) => {\r\n    setDraft(d => ({ ...d, initial: { ...d.initial, [field]: value } }));\r\n  };\r\n\r\n  const updateInitialAlloc = (capi, distrib) => {\r\n    setDraft(d => ({ ...d, initial: { ...d.initial, pctCapitalisation: capi, pctDistribution: distrib } }));\r\n  };\r\n\r\n  const updateAnnuel = (field, value) => {\r\n    setDraft(d => ({ ...d, annuel: { ...d.annuel, [field]: value } }));\r\n  };\r\n\r\n  const updateAnnuelAlloc = (capi, distrib) => {\r\n    setDraft(d => ({ ...d, annuel: { ...d.annuel, pctCapitalisation: capi, pctDistribution: distrib } }));\r\n  };\r\n\r\n  const updateAnnuelOption = (optionName, field, value) => {\r\n    setDraft(d => ({\r\n      ...d,\r\n      annuel: { ...d.annuel, [optionName]: { ...d.annuel[optionName], [field]: value } }\r\n    }));\r\n  };\r\n\r\n  const updateCapitalisation = (field, value) => {\r\n    setDraft(d => ({ ...d, capitalisation: { ...d.capitalisation, [field]: value } }));\r\n  };\r\n\r\n  const updateDistribution = (field, value) => {\r\n    setDraft(d => ({ ...d, distribution: { ...d.distribution, [field]: value } }));\r\n  };\r\n\r\n  const addPonctuel = () => {\r\n    setDraft(d => ({\r\n      ...d,\r\n      ponctuels: [...d.ponctuels, {\r\n        annee: Math.min(5, dureeEpargne),\r\n        montant: 5000,\r\n        fraisEntree: draft.initial.fraisEntree,\r\n        pctCapitalisation: isSCPI ? 0 : draft.initial.pctCapitalisation,\r\n        pctDistribution: isSCPI ? 100 : draft.initial.pctDistribution,\r\n      }]\r\n    }));\r\n  };\r\n\r\n  const updatePonctuel = (index, field, value) => {\r\n    setDraft(d => ({\r\n      ...d,\r\n      ponctuels: d.ponctuels.map((p, i) => i === index ? { ...p, [field]: value } : p)\r\n    }));\r\n  };\r\n\r\n  const updatePonctuelAlloc = (index, capi, distrib) => {\r\n    setDraft(d => ({\r\n      ...d,\r\n      ponctuels: d.ponctuels.map((p, i) => i === index \r\n        ? { ...p, pctCapitalisation: capi, pctDistribution: distrib } \r\n        : p)\r\n    }));\r\n  };\r\n\r\n  const removePonctuel = (index) => {\r\n    setDraft(d => ({ ...d, ponctuels: d.ponctuels.filter((_, i) => i !== index) }));\r\n  };\r\n\r\n  // Helpers\r\n  const hasDistribution = (obj) => (obj.pctDistribution || 0) > 0;\r\n  const hasCapitalisation = (obj) => (obj.pctCapitalisation || 0) > 0;\r\n  const showCapiBlock = !isSCPI && (hasCapitalisation(draft.initial) || hasCapitalisation(draft.annuel) || draft.distribution.strategie === 'reinvestir_capi');\r\n  const showDistribBlock = hasDistribution(draft.initial) || hasDistribution(draft.annuel);\r\n\r\n  return (\r\n    <div className=\"vcm-overlay\" onClick={onClose}>\r\n      <div className=\"vcm\" onClick={e => e.stopPropagation()}>\r\n        {/* Header Premium */}\r\n        <div className=\"vcm__header\">\r\n          <div className=\"vcm__header-content\">\r\n            <div className=\"vcm__icon\">­ƒÆ░</div>\r\n            <div>\r\n              <h2 className=\"vcm__title\">Param├®trage des versements</h2>\r\n              <p className=\"vcm__subtitle\">{ENVELOPE_LABELS[envelope]}</p>\r\n            </div>\r\n          </div>\r\n          <button className=\"vcm__close\" onClick={onClose}>├ù</button>\r\n        </div>\r\n        \r\n        <div className=\"vcm__body\">\r\n          {isAV && (\r\n            <div className=\"vcm__hint\" style={{ marginBottom: 12 }}>\r\n              Hypoth├¿se : investissement 100 % unit├®s de compte ÔÇô pr├®l├¿vements sociaux dus au rachat.\r\n            </div>\r\n          )}\r\n          {/* VERSEMENT INITIAL */}\r\n          <section className=\"vcm__section\">\r\n            <div className=\"vcm__section-header\">\r\n              <div className=\"vcm__section-icon\">1</div>\r\n              <h3 className=\"vcm__section-title\">Versement initial</h3>\r\n            </div>\r\n            \r\n            <div className=\"vcm__card\">\r\n              <div className=\"vcm__row\">\r\n                <InputEuro label=\"Montant\" value={draft.initial.montant} onChange={(v) => updateInitial('montant', v)} />\r\n                <InputPct label=\"Frais d'entr├®e\" value={draft.initial.fraisEntree} onChange={(v) => updateInitial('fraisEntree', v)} />\r\n              </div>\r\n              \r\n              <div className=\"vcm__field\">\r\n                <label className=\"vcm__label\">Allocation</label>\r\n                <AllocationSlider\r\n                  pctCapi={draft.initial.pctCapitalisation}\r\n                  pctDistrib={draft.initial.pctDistribution}\r\n                  onChange={updateInitialAlloc}\r\n                  isSCPI={isSCPI}\r\n                />\r\n              </div>\r\n\r\n              {/* Options Capitalisation (unifi├®) */}\r\n              {showCapiBlock && (\r\n                <div className=\"vcm__suboption vcm__suboption--capi\">\r\n                  <div className=\"vcm__suboption-header\">\r\n                    <span className=\"vcm__badge vcm__badge--capi\">Capitalisation</span>\r\n                  </div>\r\n                  <InputPct \r\n                    label=\"Rendement annuel net de FG\" \r\n                    value={draft.capitalisation.rendementAnnuel} \r\n                    onChange={(v) => updateCapitalisation('rendementAnnuel', v)} \r\n                  />\r\n                </div>\r\n              )}\r\n\r\n              {/* Options Distribution (unifi├®) */}\r\n              {showDistribBlock && (\r\n                <div className=\"vcm__suboption vcm__suboption--distrib\">\r\n                  <div className=\"vcm__suboption-header\">\r\n                    <span className=\"vcm__badge vcm__badge--distrib\">Distribution</span>\r\n                  </div>\r\n                  \r\n                  <div className=\"vcm__row\">\r\n                    <InputPct \r\n                      label=\"Rendement annuel net de FG\" \r\n                      value={draft.distribution.rendementAnnuel} \r\n                      onChange={(v) => updateDistribution('rendementAnnuel', v)} \r\n                    />\r\n                    <InputPct \r\n                      label={isSCPI ? \"Taux de loyers net de FG\" : \"Taux de distribution net de FG\"} \r\n                      value={draft.distribution.tauxDistribution} \r\n                      onChange={(v) => updateDistribution('tauxDistribution', v)} \r\n                    />\r\n                  </div>\r\n                  \r\n                  <div className=\"vcm__row\">\r\n                    {!isSCPI && (\r\n                      <InputNumber \r\n                        label=\"Dur├®e du produit\" \r\n                        value={draft.distribution.dureeProduit || ''} \r\n                        onChange={(v) => updateDistribution('dureeProduit', v || null)} \r\n                        unit=\"ans\" min={1} max={100} \r\n                      />\r\n                    )}\r\n                    <InputNumber \r\n                      label=\"D├®lai de jouissance\" \r\n                      value={draft.distribution.delaiJouissance} \r\n                      onChange={(v) => updateDistribution('delaiJouissance', v)} \r\n                      unit=\"mois\" min={0} max={12} \r\n                    />\r\n                  </div>\r\n\r\n                  <div className=\"vcm__field\">\r\n                    <label className=\"vcm__label\">Strat├®gie</label>\r\n                    <select className=\"vcm__select\" value={draft.distribution.strategie} onChange={(e) => updateDistribution('strategie', e.target.value)}>\r\n                      {!isSCPI && <option value=\"stocker\">Stocker les distributions ├á 0%</option>}\r\n                      {(isSCPI || isCTO) && (\r\n                        <option value=\"apprehender\">\r\n                          {isSCPI ? 'Appr├®hender les distributions chaque ann├®e' : 'Appr├®hender les distributions chaque ann├®e'}\r\n                        </option>\r\n                      )}\r\n                      <option value=\"reinvestir_capi\">\r\n                        {isSCPI\r\n                          ? 'R├®investir les distributions nettes de fiscalit├® chaque ann├®e'\r\n                          : 'R├®investir les distributions chaque ann├®e vers la capitalisation'}\r\n                      </option>\r\n                    </select>\r\n                  </div>\r\n\r\n                  {/* Au terme du produit, r├®investir vers - visible si dur├®e renseign├®e */}\r\n                  {!isSCPI && draft.distribution.dureeProduit && (\r\n                    <div className=\"vcm__field\">\r\n                      <label className=\"vcm__label\">Au terme du produit, r├®investir vers</label>\r\n                      <select className=\"vcm__select\" value={draft.distribution.reinvestirVersAuTerme} onChange={(e) => updateDistribution('reinvestirVersAuTerme', e.target.value)}>\r\n                        <option value=\"capitalisation\">Capitalisation</option>\r\n                        <option value=\"distribution\">Distribution</option>\r\n                      </select>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              )}\r\n            </div>\r\n          </section>\r\n\r\n          {/* VERSEMENT ANNUEL */}\r\n          <section className=\"vcm__section\">\r\n            <div className=\"vcm__section-header\">\r\n              <div className=\"vcm__section-icon\">2</div>\r\n              <h3 className=\"vcm__section-title\">Versement annuel</h3>\r\n            </div>\r\n            \r\n            <div className=\"vcm__card\">\r\n              <div className=\"vcm__row\">\r\n                <InputEuro label=\"Montant\" value={draft.annuel.montant} onChange={(v) => updateAnnuel('montant', v)} />\r\n                <InputPct label=\"Frais d'entr├®e\" value={draft.annuel.fraisEntree} onChange={(v) => updateAnnuel('fraisEntree', v)} />\r\n              </div>\r\n\r\n              <div className=\"vcm__field\">\r\n                <label className=\"vcm__label\">Allocation</label>\r\n                <AllocationSlider\r\n                  pctCapi={draft.annuel.pctCapitalisation}\r\n                  pctDistrib={draft.annuel.pctDistribution}\r\n                  onChange={updateAnnuelAlloc}\r\n                  isSCPI={isSCPI}\r\n                />\r\n              </div>\r\n\r\n              {/* Options PER */}\r\n              {isPER && (\r\n                <div className=\"vcm__per-options\">\r\n                  <div className=\"vcm__per-option\">\r\n                    <label className=\"vcm__checkbox\">\r\n                      <input type=\"checkbox\" checked={draft.annuel.garantieBonneFin.active} onChange={(e) => updateAnnuelOption('garantieBonneFin', 'active', e.target.checked)} />\r\n                      <span>Garantie de bonne fin</span>\r\n                    </label>\r\n                    {draft.annuel.garantieBonneFin.active && (\r\n                      <InputPct label=\"Co├╗t annuel\" value={draft.annuel.garantieBonneFin.cout} onChange={(v) => updateAnnuelOption('garantieBonneFin', 'cout', v)} />\r\n                    )}\r\n                    <p className=\"vcm__hint\">Capital d├®c├¿s = dur├®e restante ├ù versement annuel</p>\r\n                  </div>\r\n                  \r\n                  <div className=\"vcm__per-option\">\r\n                    <label className=\"vcm__checkbox\">\r\n                      <input type=\"checkbox\" checked={draft.annuel.exonerationCotisations.active} onChange={(e) => updateAnnuelOption('exonerationCotisations', 'active', e.target.checked)} />\r\n                      <span>Exon├®ration des cotisations</span>\r\n                    </label>\r\n                    {draft.annuel.exonerationCotisations.active && (\r\n                      <InputPct label=\"Co├╗t annuel\" value={draft.annuel.exonerationCotisations.cout} onChange={(v) => updateAnnuelOption('exonerationCotisations', 'cout', v)} />\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </div>\r\n          </section>\r\n\r\n          {/* VERSEMENTS PONCTUELS */}\r\n          <section className=\"vcm__section\">\r\n            <div className=\"vcm__section-header\">\r\n              <div className=\"vcm__section-icon\">3</div>\r\n              <h3 className=\"vcm__section-title\">Versements ponctuels</h3>\r\n              <button className=\"vcm__add-btn\" onClick={addPonctuel}>+ Ajouter</button>\r\n            </div>\r\n            \r\n            {draft.ponctuels.length === 0 ? (\r\n              <div className=\"vcm__empty\">\r\n                <p>Aucun versement ponctuel configur├®</p>\r\n                <button className=\"vcm__add-btn vcm__add-btn--large\" onClick={addPonctuel}>+ Ajouter un versement</button>\r\n              </div>\r\n            ) : (\r\n              <div className=\"vcm__ponctuels\">\r\n                {/* En-t├¬tes colonnes */}\r\n                <div className=\"vcm__ponctuel-headers\">\r\n                  <span>Ann├®e</span>\r\n                  <span>Montant</span>\r\n                  <span>Frais</span>\r\n                  <span>Allocation Capi/Distrib</span>\r\n                  <span></span>\r\n                </div>\r\n                {draft.ponctuels.map((p, i) => (\r\n                  <div key={i} className=\"vcm__ponctuel-row\">\r\n                    <div className=\"vcm__ponctuel-cell\">\r\n                      <input\r\n                        type=\"number\"\r\n                        min={1}\r\n                        max={dureeEpargne}\r\n                        value={p.annee}\r\n                        onChange={(e) => updatePonctuel(i, 'annee', Number(e.target.value))}\r\n                        className=\"vcm__mini-input\"\r\n                      />\r\n                    </div>\r\n                    <div className=\"vcm__ponctuel-cell\">\r\n                      <input\r\n                        type=\"number\"\r\n                        value={p.montant}\r\n                        onChange={(e) => updatePonctuel(i, 'montant', Number(e.target.value))}\r\n                        className=\"vcm__mini-input\"\r\n                      />\r\n                      <span className=\"vcm__unit\">Ôé¼</span>\r\n                    </div>\r\n                    <div className=\"vcm__ponctuel-cell\">\r\n                      <input\r\n                        type=\"number\"\r\n                        step=\"0.1\"\r\n                        value={(p.fraisEntree * 100).toFixed(1)}\r\n                        onChange={(e) => updatePonctuel(i, 'fraisEntree', Number(e.target.value) / 100)}\r\n                        className=\"vcm__mini-input vcm__mini-input--small\"\r\n                      />\r\n                      <span className=\"vcm__unit\">%</span>\r\n                    </div>\r\n                    <div className=\"vcm__ponctuel-cell vcm__ponctuel-cell--alloc\">\r\n                      {isSCPI ? (\r\n                        <span className=\"vcm__alloc-fixed\">100% D</span>\r\n                      ) : (\r\n                        <div className=\"vcm__alloc-mini\">\r\n                          <input\r\n                            type=\"number\"\r\n                            min={0}\r\n                            max={100}\r\n                            value={p.pctCapitalisation}\r\n                            onChange={(e) => updatePonctuelAlloc(i, Number(e.target.value), 100 - Number(e.target.value))}\r\n                            className=\"vcm__mini-input vcm__mini-input--tiny\"\r\n                          />\r\n                          <span>/</span>\r\n                          <input\r\n                            type=\"number\"\r\n                            min={0}\r\n                            max={100}\r\n                            value={p.pctDistribution}\r\n                            onChange={(e) => updatePonctuelAlloc(i, 100 - Number(e.target.value), Number(e.target.value))}\r\n                            className=\"vcm__mini-input vcm__mini-input--tiny\"\r\n                          />\r\n                        </div>\r\n                      )}\r\n                    </div>\r\n                    <div className=\"vcm__ponctuel-cell\">\r\n                      <button className=\"vcm__remove-btn\" onClick={() => removePonctuel(i)}>├ù</button>\r\n                    </div>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            )}\r\n          </section>\r\n        </div>\r\n\r\n        <div className=\"vcm__footer\">\r\n          <button className=\"vcm__btn vcm__btn--secondary\" onClick={onClose}>Annuler</button>\r\n          <button \r\n            className=\"vcm__btn vcm__btn--primary\" \r\n            onClick={() => {\r\n              onSave(draft);\r\n              onClose();\r\n            }}\r\n          >\r\n            Valider\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n// ============================================================================\r\n// MAIN COMPONENT\r\n// ============================================================================\r\n\r\n// Fonction de transformation versementConfig ÔåÆ format moteur\r\n// G├¿re la ventilation % entre capitalisation et distribution\r\nfunction buildEngineProduct(product) {\r\n  const { versementConfig, envelope, dureeEpargne, perBancaire, optionBaremeIR, fraisGestion } = product;\r\n  const normalizedConfig = normalizeVersementConfig(versementConfig);\r\n  const { initial, annuel, ponctuels, capitalisation, distribution } = normalizedConfig;\r\n  \r\n  // Calcul du rendement moyen pond├®r├® selon la ventilation\r\n  const pctCapi = (initial.pctCapitalisation || 0) / 100;\r\n  const pctDistrib = (initial.pctDistribution || 0) / 100;\r\n  \r\n  // Rendement = moyenne pond├®r├®e des deux allocations (utilise les param├¿tres globaux)\r\n  const rendementCapi = capitalisation.rendementAnnuel || 0;\r\n  const rendementDistrib = distribution.tauxDistribution || 0;\r\n  const rendementMoyen = pctCapi * rendementCapi + pctDistrib * rendementDistrib;\r\n  \r\n  // Taux de revalorisation (uniquement si distribution)\r\n  const tauxRevalo = pctDistrib > 0 ? distribution.rendementAnnuel || 0 : 0;\r\n  \r\n  return {\r\n    envelope,\r\n    dureeEpargne,\r\n    perBancaire,\r\n    optionBaremeIR,\r\n    fraisGestion,\r\n    // Versements\r\n    versementInitial: initial.montant,\r\n    versementAnnuel: annuel.montant,\r\n    fraisEntree: initial.fraisEntree,\r\n    // Rendement pond├®r├® (pour compatibilit├®)\r\n    rendement: rendementMoyen,\r\n    tauxRevalorisation: tauxRevalo,\r\n    // Options distribution (si part distribution > 0)\r\n    delaiJouissance: pctDistrib > 0 ? (distribution.delaiJouissance || 0) : 0,\r\n    dureeProduit: pctDistrib > 0 ? distribution.dureeProduit : null,\r\n    strategieCompteEspece: pctDistrib > 0 ? distribution.strategie : 'reinvestir_capi',\r\n    reinvestirVersAuTerme: distribution.reinvestirVersAuTerme || 'capitalisation',\r\n    // Ventilation pour info\r\n    pctCapitalisation: initial.pctCapitalisation,\r\n    pctDistribution: initial.pctDistribution,\r\n    // Configuration d├®taill├®e pour calculs futurs\r\n    versementConfig,\r\n    // Versements ponctuels\r\n    versementsPonctuels: ponctuels,\r\n    // Options PER\r\n    garantieBonneFin: annuel.garantieBonneFin,\r\n    exonerationCotisations: annuel.exonerationCotisations,\r\n  };\r\n}\r\n\r\nexport default function PlacementV2() {\r\n  const STORE_KEY = storageKeyFor('placement');\r\n  const { fiscalParams, loading, error, tmiOptions, taxSettings, psSettings } = usePlacementSettings();\r\n\r\n  const [hydrated, setHydrated] = useState(false);\r\n  const [state, setState] = useState(DEFAULT_STATE);\r\n  const [modalOpen, setModalOpen] = useState(null); // null | 0 | 1\r\n  const [actionInProgress, setActionInProgress] = useState(false);\r\n\r\n  const dmtgScale = taxSettings?.dmtg?.scale;\r\n  const dmtgOptions = useMemo(() => buildDmtgOptions(dmtgScale), [dmtgScale]);\r\n  const dmtgDefaultRate = dmtgOptions[0]?.value ?? DEFAULT_DMTG_RATE;\r\n\r\n  const dmtgSelectOptions = useMemo(() => {\r\n    const current = state.transmission.dmtgTaux;\r\n    if (current == null) return dmtgOptions;\r\n    const exists = dmtgOptions.some((option) => option.value === current);\r\n    if (exists) return dmtgOptions;\r\n    return [...dmtgOptions, buildCustomDmtgOption(current)];\r\n  }, [dmtgOptions, state.transmission.dmtgTaux]);\r\n\r\n  const selectedDmtgOption = useMemo(\r\n    () => dmtgSelectOptions.find((opt) => opt.value === state.transmission.dmtgTaux),\r\n    [dmtgSelectOptions, state.transmission.dmtgTaux],\r\n  );\r\n\r\n  const selectedDmtgTrancheWidth = useMemo(() => {\r\n    if (!selectedDmtgOption) return null;\r\n    const from = typeof selectedDmtgOption.rangeFrom === 'number' ? selectedDmtgOption.rangeFrom : 0;\r\n    const to = typeof selectedDmtgOption.rangeTo === 'number' ? selectedDmtgOption.rangeTo : null;\r\n    if (to == null) return null; // pas de borne sup├®rieure => pas de ratio pertinent\r\n    const width = to - from;\r\n    return width > 0 ? width : null;\r\n  }, [selectedDmtgOption]);\r\n\r\n  // Hydratation depuis sessionStorage\r\n  useEffect(() => {\r\n    try {\r\n      const raw = sessionStorage.getItem(STORE_KEY);\r\n      if (raw) {\r\n        const s = JSON.parse(raw);\r\n        if (s && typeof s === 'object') {\r\n          setState({ ...DEFAULT_STATE, ...s });\r\n        }\r\n      }\r\n    } catch {}\r\n    setHydrated(true);\r\n  }, [STORE_KEY]);\r\n\r\n  // Persistance\r\n  useEffect(() => {\r\n    if (!hydrated) return;\r\n    try {\r\n      sessionStorage.setItem(STORE_KEY, JSON.stringify(state));\r\n    } catch {}\r\n  }, [hydrated, state, STORE_KEY]);\r\n\r\n  useEffect(() => {\r\n    if (!hydrated) return;\r\n    if (typeof dmtgDefaultRate !== 'number') return;\r\n    setState((prev) => {\r\n      if (prev.transmission?.dmtgTaux == null) {\r\n        return {\r\n          ...prev,\r\n          transmission: { ...prev.transmission, dmtgTaux: dmtgDefaultRate },\r\n        };\r\n      }\r\n      return prev;\r\n    });\r\n  }, [hydrated, dmtgDefaultRate]);\r\n\r\n  // Reset\r\n  useEffect(() => {\r\n    const off = onResetEvent?.(({ simId }) => {\r\n      if (simId && simId !== 'placement') return;\r\n      setState(DEFAULT_STATE);\r\n      try { sessionStorage.removeItem(STORE_KEY); } catch {}\r\n    });\r\n    return off || (() => {});\r\n  }, [STORE_KEY]);\r\n\r\n\r\n\r\n  const handleSavePlacement = useCallback(async () => {\r\n    if (actionInProgress) return;\r\n    setActionInProgress(true);\r\n    try {\r\n      const result = await savePlacementState(buildPersistedState(state));\r\n      if (result?.cancelled) return;\r\n      if (result?.success) {\r\n        window.alert(`Simulation enregistr├®e (${result.filename ?? 'fichier'}).`);\r\n      } else {\r\n        window.alert(result?.message || 'Impossible de sauvegarder la simulation.');\r\n      }\r\n    } finally {\r\n      setActionInProgress(false);\r\n    }\r\n  }, [actionInProgress, state]);\r\n\r\n  const handleLoadPlacement = useCallback(async () => {\r\n    if (actionInProgress) return;\r\n    setActionInProgress(true);\r\n    try {\r\n      const result = await loadPlacementStateFromFile();\r\n      if (result?.cancelled) return;\r\n      if (result?.success && result.data) {\r\n        const nextState = normalizeLoadedState(result.data);\r\n        setState(nextState);\r\n        window.alert(`Simulation charg├®e (${result.filename ?? 'fichier'}).`);\r\n      } else {\r\n        window.alert(result?.message || 'Impossible de charger ce fichier.');\r\n      }\r\n    } finally {\r\n      setActionInProgress(false);\r\n    }\r\n  }, [actionInProgress]);\r\n\r\n  useEffect(() => {\r\n    const saveListener = () => handleSavePlacement();\r\n    const loadListener = () => handleLoadPlacement();\r\n    window.addEventListener(PLACEMENT_SAVE_EVENT, saveListener);\r\n    window.addEventListener(PLACEMENT_LOAD_EVENT, loadListener);\r\n    return () => {\r\n      window.removeEventListener(PLACEMENT_SAVE_EVENT, saveListener);\r\n      window.removeEventListener(PLACEMENT_LOAD_EVENT, loadListener);\r\n    };\r\n  }, [handleSavePlacement, handleLoadPlacement]);\r\n\r\n  // Calculs\r\n  const results = useMemo(() => {\r\n    if (!hydrated || loading || error) return null;\r\n\r\n    // Ajouter le taux DMTG choisi aux fiscalParams\r\n    const fpWithDmtg = { ...fiscalParams, dmtgTauxChoisi: state.transmission.dmtgTaux };\r\n\r\n    // Transformer les produits vers le format moteur\r\n    const engineProduct1 = buildEngineProduct(state.products[0]);\r\n    const engineProduct2 = buildEngineProduct(state.products[1]);\r\n\r\n    const liquidationParams1 = {\r\n      ...state.liquidation,\r\n      rendement: getRendementLiquidation(state.products[0]) ?? undefined,\r\n    };\r\n    const liquidationParams2 = {\r\n      ...state.liquidation,\r\n      rendement: getRendementLiquidation(state.products[1]) ?? undefined,\r\n    };\r\n\r\n    const result1 = simulateComplete(\r\n      engineProduct1,\r\n      state.client,\r\n      liquidationParams1,\r\n      { ...state.transmission, agePremierVersement: state.client.ageActuel },\r\n      fpWithDmtg\r\n    );\r\n\r\n    const result2 = simulateComplete(\r\n      engineProduct2,\r\n      state.client,\r\n      liquidationParams2,\r\n      { ...state.transmission, agePremierVersement: state.client.ageActuel },\r\n      fpWithDmtg\r\n    );\r\n\r\n    return compareProducts(result1, result2);\r\n  }, [state, fiscalParams, loading, hydrated, error]);\r\n\r\n  // Helpers pour mise ├á jour du state\r\n  const setClient = (patch) => setState((s) => ({ ...s, client: { ...s.client, ...patch } }));\r\n  const setProduct = (i, patch) => setState((s) => ({\r\n    ...s,\r\n    products: s.products.map((p, k) => (k === i ? { ...p, ...patch } : p)),\r\n  }));\r\n  const setLiquidation = (patch) => setState((s) => ({ ...s, liquidation: { ...s.liquidation, ...patch } }));\r\n  const setTransmission = (patch) => setState((s) => ({ ...s, transmission: { ...s.transmission, ...patch } }));\r\n  const setStep = (step) => setState((s) => ({ ...s, step }));\r\n\r\n  const setVersementConfig = (productIndex, config) => {\r\n    const normalized = normalizeVersementConfig(config);\r\n    setState((s) => ({\r\n      ...s,\r\n      products: s.products.map((p, idx) =>\r\n        idx === productIndex ? { ...p, versementConfig: normalized } : p\r\n      ),\r\n    }));\r\n  };\r\n\r\n  const updateProductOption = (productIndex, path, value) => {\r\n    setState(prev => {\r\n      const newState = { ...prev };\r\n      const pathParts = path.split('.');\r\n      let current = newState.products[productIndex];\r\n      \r\n      for (let i = 0; i < pathParts.length - 1; i++) {\r\n        current = current[pathParts[i]];\r\n      }\r\n      \r\n      current[pathParts[pathParts.length - 1]] = value;\r\n      return newState;\r\n    });\r\n  };\r\n\r\n  // Export Excel\r\n  const exportExcel = useCallback(async () => {\r\n    try {\r\n      console.info(\"[ExcelExport] Starting export\");\r\n      \r\n      // V├®rifier qu'on a des r├®sultats ├á exporter\r\n      if (!results || !results.produit1) {\r\n        console.warn(\"[ExcelExport] No results available\", { results, produit1: results?.produit1 });\r\n        alert('Veuillez lancer une simulation avant d\\'exporter.');\r\n        return;\r\n      }\r\n\r\n      console.info(\"[ExcelExport] Results validated\", { \r\n        hasProduit1: !!results.produit1,\r\n        hasProduit2: !!results.produit2,\r\n        epargneRows: results.produit1?.epargne?.rows?.length,\r\n        liquidationRows: results.produit1?.liquidation?.rows?.length\r\n      });\r\n\r\n      // 0) Param├¿tres : hypoth├¿ses et configuration\r\n      const headerParams = ['Champ', 'Valeur'];\r\n      const rowsParams = [];\r\n\r\n      // Client\r\n      rowsParams.push(['├ége actuel', `${state.client.ageActuel} ans`]);\r\n      rowsParams.push(['TMI ├®pargne', `${(state.client.tmiEpargne * 100).toFixed(1).replace('.', ',')} %`]);\r\n      rowsParams.push(['TMI retraite', `${(state.client.tmiRetraite * 100).toFixed(1).replace('.', ',')} %`]);\r\n      rowsParams.push(['Situation', state.client.situation === 'single' ? 'C├®libataire' : 'Couple']);\r\n\r\n      // Transmission\r\n      rowsParams.push(['├ége au d├®c├¿s', `${state.transmission.ageAuDeces} ans`]);\r\n      rowsParams.push(['Nombre de b├®n├®ficiaires', state.transmission.nbBeneficiaires]);\r\n      rowsParams.push(['Taux DMTG', `${(state.transmission.dmtgTaux * 100).toFixed(1).replace('.', ',')} %`]);\r\n\r\n      // Produits\r\n      state.products.forEach((product, idx) => {\r\n        const prefix = `Produit ${idx + 1}`;\r\n        rowsParams.push([`${prefix} - Enveloppe`, ENVELOPE_LABELS[product.envelope] || product.envelope]);\r\n        rowsParams.push([`${prefix} - Dur├®e ├®pargne`, `${product.dureeEpargne} ans`]);\r\n        rowsParams.push([`${prefix} - Frais de gestion`, `${(product.fraisGestion * 100).toFixed(2).replace('.', ',')} %`]);\r\n        rowsParams.push([`${prefix} - Option bar├¿me IR`, product.optionBaremeIR ? 'Oui' : 'Non']);\r\n        rowsParams.push([`${prefix} - PER bancaire`, product.perBancaire ? 'Oui' : 'Non']);\r\n        \r\n        const versementConfig = product.versementConfig;\r\n        if (versementConfig) {\r\n          rowsParams.push([`${prefix} - Versement initial`, `${versementConfig.initial?.montant || 0} Ôé¼`]);\r\n          rowsParams.push([`${prefix} - Versements annuels`, `${versementConfig.annuel?.montant || 0} Ôé¼`]);\r\n          rowsParams.push([`${prefix} - Allocation capitalisation`, `${versementConfig.initial?.pctCapitalisation || 0} %`]);\r\n          rowsParams.push([`${prefix} - Allocation distribution`, `${versementConfig.initial?.pctDistribution || 0} %`]);\r\n        }\r\n      });\r\n\r\n      // R├®cup├®rer les r├®sultats calcul├®s\r\n      const { produit1, produit2 } = results;\r\n\r\n      // 1) Tables ├®pargne (vertical)\r\n      const buildEpargneSheet = (produit, suffix = '') => {\r\n        if (!produit?.epargne?.rows?.length) return null;\r\n\r\n        const header = ['Indicateur'];\r\n        produit.epargne.rows.forEach((row, idx) => {\r\n          header.push(`Ann├®e ${idx}`);\r\n        });\r\n\r\n        const series = [\r\n          { key: 'capitalDebut', label: 'Capital d├®but' },\r\n          { key: 'versements', label: 'Versements' },\r\n          { key: 'capitalCapi', label: 'Capital (capi)' },\r\n          { key: 'capitalDistrib', label: 'Capital (distrib)' },\r\n          { key: 'compteEspece', label: 'Compte esp├¿ces' },\r\n          { key: 'gainsAnnee', label: 'Gains annuels' },\r\n          { key: 'revenusNetAnnee', label: 'Revenus nets' },\r\n          { key: 'capitalFin', label: 'Capital fin' },\r\n          { key: 'capitalDecesTheorique', label: 'Capital d├®c├¿s th├®orique' },\r\n        ];\r\n\r\n        const rows = series.map(({ key, label }) => {\r\n          const row = [label];\r\n          produit.epargne.rows.forEach((r) => {\r\n            row.push(r[key] ?? 0);\r\n          });\r\n          return row;\r\n        });\r\n\r\n        return { header, rows, name: `├ëpargne ${suffix}`.trim() };\r\n      };\r\n\r\n      const sheetEpargneProduit1 = buildEpargneSheet(produit1, 'Produit 1');\r\n      const sheetEpargneProduit2 = buildEpargneSheet(produit2, 'Produit 2');\r\n\r\n      // 2) Tables liquidation (vertical)\r\n      const buildLiquidationSheet = (produit, suffix = '') => {\r\n        if (!produit?.liquidation?.rows?.length) return null;\r\n\r\n        const header = ['Indicateur'];\r\n        produit.liquidation.rows.forEach((row, idx) => {\r\n          header.push(`├ége ${row.age ?? idx}`);\r\n        });\r\n\r\n        const series = [\r\n          { key: 'capitalDebut', label: 'Capital d├®but' },\r\n          { key: 'retraitBrut', label: 'Retrait brut' },\r\n          { key: 'fiscalite', label: 'Fiscalit├®' },\r\n          { key: 'retraitNet', label: 'Retrait net' },\r\n          { key: 'capitalFin', label: 'Capital fin' },\r\n          { key: 'pvLatenteDebut', label: 'PV latente d├®but' },\r\n          { key: 'pvLatenteFin', label: 'PV latente fin' },\r\n        ];\r\n\r\n        const rows = series.map(({ key, label }) => {\r\n          const row = [label];\r\n          produit.liquidation.rows.forEach((r) => {\r\n            row.push(r[key] ?? 0);\r\n          });\r\n          return row;\r\n        });\r\n\r\n        return { header, rows, name: `Liquidation ${suffix}`.trim() };\r\n      };\r\n\r\n      const sheetLiquidationProduit1 = buildLiquidationSheet(produit1, 'Produit 1');\r\n      const sheetLiquidationProduit2 = buildLiquidationSheet(produit2, 'Produit 2');\r\n\r\n      // 3) Transmission\r\n      const headerTransmission = ['Indicateur', 'Produit 1', 'Produit 2'];\r\n      const psRowApplic = [\r\n        'PS d├®c├¿s - applicables ?',\r\n        formatPsApplicability(produit1?.transmission?.psDeces),\r\n        formatPsApplicability(produit2?.transmission?.psDeces),\r\n      ];\r\n      const psRowAssiette = [\r\n        'PS d├®c├¿s - assiette',\r\n        getPsAssietteNumeric(produit1?.transmission?.psDeces),\r\n        getPsAssietteNumeric(produit2?.transmission?.psDeces),\r\n      ];\r\n      const psRowTaux = [\r\n        'PS d├®c├¿s - taux',\r\n        getPsTauxNumeric(produit1?.transmission?.psDeces),\r\n        getPsTauxNumeric(produit2?.transmission?.psDeces),\r\n      ];\r\n      const psRowMontant = [\r\n        'PS d├®c├¿s - montant',\r\n        getPsMontantNumeric(produit1?.transmission?.psDeces),\r\n        getPsMontantNumeric(produit2?.transmission?.psDeces),\r\n      ];\r\n      const psRowNote = [\r\n        'PS d├®c├¿s - commentaire',\r\n        formatPsNote(produit1?.transmission?.psDeces),\r\n        formatPsNote(produit2?.transmission?.psDeces),\r\n      ];\r\n\r\n      const rowsTransmission = [\r\n        ['Capital transmis', produit1?.transmission?.capitalTransmis || 0, produit2?.transmission?.capitalTransmis || 0],\r\n        ['Abattement', produit1?.transmission?.abattement || 0, produit2?.transmission?.abattement || 0],\r\n        ['Assiette fiscale', produit1?.transmission?.assiette || 0, produit2?.transmission?.assiette || 0],\r\n        psRowApplic,\r\n        psRowAssiette,\r\n        psRowTaux,\r\n        psRowMontant,\r\n        psRowNote,\r\n        ['Fiscalit├® forfaitaire (990 I / 757 B)', produit1?.transmission?.taxeForfaitaire || 0, produit2?.transmission?.taxeForfaitaire || 0],\r\n        ['Fiscalit├® DMTG', produit1?.transmission?.taxeDmtg || 0, produit2?.transmission?.taxeDmtg || 0],\r\n        ['Fiscalit├® totale', produit1?.transmission?.taxe || 0, produit2?.transmission?.taxe || 0],\r\n        ['Net transmis', produit1?.transmission?.capitalTransmisNet || 0, produit2?.transmission?.capitalTransmisNet || 0],\r\n      ];\r\n\r\n      // 4) Synth├¿se comparative\r\n      const headerSynthese = ['Indicateur', 'Produit 1', 'Produit 2'];\r\n      const rowsSynthese = [\r\n        ['Enveloppe', ENVELOPE_LABELS[produit1?.envelope] || '', ENVELOPE_LABELS[produit2?.envelope] || ''],\r\n        ['Capital acquis ├®pargne', produit1?.epargne?.capitalFin || 0, produit2?.epargne?.capitalFin || 0],\r\n        ['Total retraits liquidation', produit1?.liquidation?.totalRetraits || 0, produit2?.liquidation?.totalRetraits || 0],\r\n        ['Fiscalit├® totale', (produit1?.liquidation?.totalFiscalite || 0) + (produit1?.transmission?.taxe || 0), (produit2?.liquidation?.totalFiscalite || 0) + (produit2?.transmission?.taxe || 0)],\r\n        ['Net global', (produit1?.liquidation?.totalRetraits || 0) + (produit1?.transmission?.capitalTransmisNet || 0), (produit2?.liquidation?.totalRetraits || 0) + (produit2?.transmission?.capitalTransmisNet || 0)],\r\n      ];\r\n\r\n      console.info(\"[ExcelExport] Data preparation\", {\r\n        headerParamsLength: headerParams.length,\r\n        rowsParamsLength: rowsParams.length,\r\n        hasEpargneP1: !!sheetEpargneProduit1,\r\n        hasEpargneP2: !!sheetEpargneProduit2,\r\n        hasLiquidationP1: !!sheetLiquidationProduit1,\r\n        hasLiquidationP2: !!sheetLiquidationProduit2,\r\n      });\r\n\r\n      // Construction XML\r\n      console.info(\"[ExcelExport] Building XML\");\r\n      const xml = `<?xml version=\"1.0\"?>\r\n        <?mso-application progid=\"Excel.Sheet\"?>\r\n        <Workbook xmlns=\"urn:schemas-microsoft-com:office:spreadsheet\"\r\n          xmlns:o=\"urn:schemas-microsoft-com:office:office\"\r\n          xmlns:x=\"urn:schemas-microsoft-com:office:excel\"\r\n          xmlns:ss=\"urn:schemas-microsoft-com:office:spreadsheet\">\r\n          ${buildWorksheetXmlVertical('Param├¿tres', headerParams, rowsParams)}\r\n          ${sheetEpargneProduit1 ? buildWorksheetXmlVertical(sheetEpargneProduit1.name, sheetEpargneProduit1.header, sheetEpargneProduit1.rows) : ''}\r\n          ${sheetEpargneProduit2 ? buildWorksheetXmlVertical(sheetEpargneProduit2.name, sheetEpargneProduit2.header, sheetEpargneProduit2.rows) : ''}\r\n          ${sheetLiquidationProduit1 ? buildWorksheetXmlVertical(sheetLiquidationProduit1.name, sheetLiquidationProduit1.header, sheetLiquidationProduit1.rows) : ''}\r\n          ${sheetLiquidationProduit2 ? buildWorksheetXmlVertical(sheetLiquidationProduit2.name, sheetLiquidationProduit2.header, sheetLiquidationProduit2.rows) : ''}\r\n          ${buildWorksheetXmlVertical('Transmission', headerTransmission, rowsTransmission)}\r\n          ${buildWorksheetXmlVertical('Synth├¿se', headerSynthese, rowsSynthese)}\r\n        </Workbook>`;\r\n\r\n      console.info(\"[ExcelExport] XML built\", { xmlLength: xml.length });\r\n\r\n      try {\r\n        console.info(\"[ExcelExport] Starting download\");\r\n        await downloadExcel(xml, `SER1_Placement_${new Date().toISOString().slice(0, 10)}.xls`);\r\n        console.info(\"[ExcelExport] Download completed successfully\");\r\n      } catch (downloadErr) {\r\n        console.error(\"[ExcelExport] Download failed\", { \r\n          err: downloadErr, \r\n          message: downloadErr?.message, \r\n          stack: downloadErr?.stack \r\n        });\r\n        alert('Erreur lors du t├®l├®chargement du fichier Excel.');\r\n      }\r\n    } catch (e) {\r\n      console.error(\"[ExcelExport] Export failed\", { \r\n        err: e, \r\n        message: e?.message, \r\n        stack: e?.stack \r\n      });\r\n      alert('Impossible de g├®n├®rer le fichier Excel.');\r\n    }\r\n  }, [state, results]);\r\n\r\n  const { produit1, produit2, deltas } = results || { produit1: null, produit2: null, deltas: {} };\r\n  const psDecesProduit1 = produit1?.transmission?.psDeces;\r\n  const psDecesProduit2 = produit2?.transmission?.psDeces;\r\n  const hasTransmissionData = Boolean(produit1 || produit2);\r\n\r\n  const assietteDmtgProduit1 = (produit1?.transmission?.taxeDmtg || 0) > 0\r\n    ? (produit1?.transmission?.assiette || 0)\r\n    : 0;\r\n  const assietteDmtgProduit2 = (produit2?.transmission?.taxeDmtg || 0) > 0\r\n    ? (produit2?.transmission?.assiette || 0)\r\n    : 0;\r\n\r\n  const dmtgConsumptionRatioProduit1 = computeDmtgConsumptionRatio(\r\n    assietteDmtgProduit1,\r\n    selectedDmtgTrancheWidth,\r\n  );\r\n  const dmtgConsumptionRatioProduit2 = computeDmtgConsumptionRatio(\r\n    assietteDmtgProduit2,\r\n    selectedDmtgTrancheWidth,\r\n  );\r\n\r\n  const showDmtgDisclaimer =\r\n    shouldShowDmtgDisclaimer(assietteDmtgProduit1, selectedDmtgTrancheWidth) ||\r\n    shouldShowDmtgDisclaimer(assietteDmtgProduit2, selectedDmtgTrancheWidth);\r\n\r\n  const dmtgConsumptionPercentProduit1 = Math.min(100, Math.round(dmtgConsumptionRatioProduit1 * 100));\r\n  const dmtgConsumptionPercentProduit2 = Math.min(100, Math.round(dmtgConsumptionRatioProduit2 * 100));\r\n\r\n  // ├ëtat pour le toggle \"Afficher toutes les colonnes\"\r\n  const [showAllColumns, setShowAllColumns] = useState(false);\r\n\r\n  // Fonction pour filtrer les colonnes pertinentes (valeurs > 0)\r\n  const structuralEpargneColumns = ['├ége', 'Capital d├®but', 'Versement net', 'Gains ann├®e', 'Revenus nets appr├®hend├®s', 'Capital fin'];\r\n\r\n  const columnResolvers = {\r\n    '├ége': (row) => row.age,\r\n    'Capital d├®but': (row) => row.capitalDebut,\r\n    'Versement net': (row) => row.versementNet,\r\n    'Poche capi (fin)': (row) => row.capitalCapi,\r\n    'Poche distrib (fin)': (row) => row.capitalDistrib,\r\n    'Poche 0% / esp├¿ces': (row) => row.compteEspece0pct ?? row.compteEspece,\r\n    'Gains ann├®e': (row) => row.gainsAnnee ?? (row.gains || 0) + (row.revaloDistrib || 0),\r\n    'Revenus nets appr├®hend├®s': (row) => row.revenusNetsPercusAnnee ?? 0,\r\n    'Revenus nets r├®investis': (row) => row.reinvestissement ?? row.reinvestissementDistribNetAnnee,\r\n    'Capital d├®c├¿s d├®gressif': (row) => row.capitalDecesDegressif,\r\n    'Capital fin': (row) => row.capitalFin,\r\n  };\r\n\r\n  const isColumnRelevant = (rows, column) => {\r\n    if (structuralEpargneColumns.includes(column)) return true;\r\n    const resolver = columnResolvers[column];\r\n    if (!resolver) return false;\r\n    return rows.some((row) => {\r\n      const raw = resolver(row);\r\n      if (raw === undefined || raw === null) return false;\r\n      const value = typeof raw === 'number' ? raw : Number(raw);\r\n      if (Number.isNaN(value)) return !!raw;\r\n      return Math.abs(value) > EPSILON;\r\n    });\r\n  };\r\n\r\n  const getRelevantColumnsEpargne = (rows, baseColumns) => {\r\n    if (showAllColumns || !rows || rows.length === 0) return baseColumns;\r\n    return baseColumns.filter((col) => isColumnRelevant(rows, col));\r\n  };\r\n\r\n  // Fonction pour construire les colonnes du tableau\r\n  const buildColumns = (produit) => {\r\n    const baseColumns = produit.envelope === 'SCPI'\r\n      ? ['├ége', 'Capital', 'Loyers bruts', 'Fiscalit├®', 'Loyers nets', 'Capital fin']\r\n      : ['CTO', 'PEA'].includes(produit.envelope)\r\n        ? ['├ége', 'Capital', 'Cession brute', 'PV latente (d├®but)', 'Fiscalit├®', 'Cession nette', 'PV latente (fin)', 'Capital fin']\r\n        : ['├ége', 'Capital d├®but', 'Retrait brut', 'Part int├®r├¬ts', 'Part capital', 'Fiscalit├®', 'Retrait net', 'Capital fin'];\r\n    \r\n    // Ajouter la colonne \"Capital d├®c├¿s th├®orique\" pour les PER avec garantie active\r\n    if (produit.envelope === 'PER' && produit?.versementConfig?.annuel?.garantieBonneFin?.active) {\r\n      baseColumns.splice(baseColumns.length - 1, 0, 'Capital d├®c├¿s th├®orique');\r\n    }\r\n    \r\n    return baseColumns;\r\n  };\r\n\r\n  const detailRows1 = produit1 ? withReinvestCumul(produit1.epargne.rows) : [];\r\n  const detailRows2 = produit2 ? withReinvestCumul(produit2.epargne.rows) : [];\r\n\r\n  const baseEpargneColumns = [\r\n    '├ége',\r\n    'Capital d├®but',\r\n    'Versement net',\r\n    'Poche capi (fin)',\r\n    'Poche distrib (fin)',\r\n    'Poche 0% / esp├¿ces',\r\n    'Gains ann├®e',\r\n    'Revenus nets appr├®hend├®s',\r\n    'Revenus nets r├®investis',\r\n    'Capital d├®c├¿s d├®gressif',\r\n    'Capital fin',\r\n  ];\r\n\r\n  const hasDegressifData = (produit) =>\r\n    produit?.epargne?.rows?.some((row) => Math.abs(row.capitalDecesDegressif || 0) > EPSILON);\r\n\r\n  const shouldShowDegressifColumn = (produit) =>\r\n    produit?.envelope === 'PER' &&\r\n    produit?.versementConfig?.annuel?.garantieBonneFin?.active;\r\n\r\n  const getBaseColumnsForProduct = (produit) => {\r\n    if (!produit) return baseEpargneColumns;\r\n    if (shouldShowDegressifColumn(produit) || hasDegressifData(produit)) return baseEpargneColumns;\r\n    return baseEpargneColumns.filter((col) => col !== 'Capital d├®c├¿s d├®gressif');\r\n  };\r\n\r\n  const renderEpargneCell = (column, row, produit) => {\r\n    switch (column) {\r\n      case '├ége':\r\n        return `${row.age} ans`;\r\n      case 'Capital d├®but':\r\n        return euro(row.capitalDebut);\r\n      case 'Versement net':\r\n        return (\r\n          <>\r\n            {euro(row.versementNet)}\r\n            <div className=\"pl-detail-cumul\">Cumul : {euro(row.cumulVersementsNets)}</div>\r\n          </>\r\n        );\r\n      case 'Poche capi (fin)':\r\n        return euro(row.capitalCapi || 0);\r\n      case 'Poche distrib (fin)':\r\n        return (\r\n          <>\r\n            {euro(row.capitalDistrib || 0)}\r\n            {(row.revaloDistrib || 0) !== 0 && (\r\n              <div className=\"pl-detail-cumul\">Revalo : {euro(row.revaloDistrib)}</div>\r\n            )}\r\n          </>\r\n        );\r\n      case 'Poche 0% / esp├¿ces':\r\n        return euro(row.compteEspece0pct ?? row.compteEspece ?? 0);\r\n      case 'Gains ann├®e': {\r\n        const gainsValue = row.gainsAnnee ?? (row.gains || 0) + (row.revaloDistrib || 0);\r\n        return (\r\n          <>\r\n            {euro(gainsValue)}\r\n            <div className=\"pl-detail-cumul\">Cumul : {euro(row.cumulGains ?? row.cumulInterets ?? 0)}</div>\r\n          </>\r\n        );\r\n      }\r\n      case 'Revenus nets appr├®hend├®s':\r\n        return euro(row.revenusNetsPercusAnnee ?? 0);\r\n      case 'Revenus nets r├®investis':\r\n        return (\r\n          <>\r\n            {euro(row.reinvestissement ?? 0)}\r\n            <div className=\"pl-detail-cumul\">\r\n              {produit.envelope === 'SCPI' ? 'Loyer net N (r├®investi N+1)' : 'Coupon net N (r├®investi N+1)'} :{' '}\r\n              {euro(row.reinvestissementDistribNetAnnee ?? 0)}\r\n            </div>\r\n          </>\r\n        );\r\n      case 'Capital d├®c├¿s d├®gressif':\r\n        return euro(row.capitalDecesDegressif || 0);\r\n      case 'Capital fin':\r\n        return euro(row.capitalFin);\r\n      default:\r\n        return null;\r\n    }\r\n  };\r\n\r\n  const renderEpargneRow = (produit, columns) => (row, index) => (\r\n    <tr key={index} className={row.cessionProduit ? 'pl-row-cession' : ''}>\r\n      {columns.map((col) => (\r\n        <td key={`${index}-${col}`}>{renderEpargneCell(col, row, produit)}</td>\r\n      ))}\r\n    </tr>\r\n  );\r\n\r\n  const columnsProduit1 = getRelevantColumnsEpargne(detailRows1, getBaseColumnsForProduct(produit1));\r\n  const columnsProduit2 = getRelevantColumnsEpargne(detailRows2, getBaseColumnsForProduct(produit2));\r\n\r\n  // Fonction pour filtrer les colonnes pertinentes (valeurs > 0)\r\n  const getRelevantColumns = (rows, baseColumns) => {\r\n    if (showAllColumns || !rows || rows.length === 0) return baseColumns;\r\n\r\n    const guaranteedColumns = baseColumns.slice(0, Math.min(3, baseColumns.length));\r\n    guaranteedColumns.push('Capital fin');\r\n\r\n    const relevantColumns = new Set(guaranteedColumns);\r\n\r\n    baseColumns.forEach((col) => {\r\n      const hasNonZeroValue = rows.some((row) => {\r\n        const valueMap = {\r\n          'Capital': row.capitalDebut ?? row.capital ?? 0,\r\n          'Capital d├®but': row.capitalDebut,\r\n          'Capital fin': row.capitalFin,\r\n          'Fiscalit├®': row.fiscaliteTotal,\r\n          'Loyers bruts': row.retraitBrut,\r\n          'Loyers nets': row.retraitNet,\r\n          'Cession brute': row.retraitBrut,\r\n          'PV latente (d├®but)': row.pvLatenteDebut,\r\n          'Cession nette': row.retraitNet,\r\n          'PV latente (fin)': row.pvLatenteFin,\r\n          'Retrait brut': row.retraitBrut,\r\n          'Part int├®r├¬ts': row.partGains,\r\n          'Part capital': row.partCapital,\r\n          'Retrait net': row.retraitNet,\r\n          'Capital d├®c├¿s th├®orique': row.capitalDecesTheorique,\r\n        };\r\n\r\n        const value = valueMap[col];\r\n        return value !== undefined && value !== null && Math.abs(value) > EPSILON;\r\n      });\r\n\r\n      if (hasNonZeroValue) {\r\n        relevantColumns.add(col);\r\n      }\r\n    });\r\n\r\n    return baseColumns.filter((col) => relevantColumns.has(col));\r\n  };\r\n\r\n  // Loading / Error (plac├®s apr├¿s les hooks pour respecter les Rules of Hooks)\r\n  if (error) {\r\n    return (\r\n      <div className=\"ir-panel placement-page\">\r\n        <div className=\"ir-header\">\r\n          <div className=\"ir-title\">Erreur</div>\r\n          <div className=\"pl-error\">{error}</div>\r\n        </div>\r\n      </div>\r\n    );\r\n  };\r\n\r\n  return (\r\n    <div className=\"ir-panel placement-page premium-page\">\r\n      {/* Header */}\r\n      <div className=\"ir-header pl-header premium-header\">\r\n        <div className=\"pl-header-main\">\r\n          <div className=\"ir-title premium-title\">Comparer deux placements</div>\r\n          <div className=\"pl-subtitle premium-subtitle\">\r\n            ├ëpargne ÔåÆ Liquidation ÔåÆ Transmission\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"pl-header-actions\">\r\n          <ExportMenu\r\n            options={[\r\n              { label: 'Excel', onClick: exportExcel, disabled: !results || !results.produit1 },\r\n            ]}\r\n          />\r\n        </div>\r\n      </div>\r\n\r\n      {/* Navigation par phases */}\r\n      <div className=\"pl-phase-nav\">\r\n        {['epargne', 'liquidation', 'transmission'].map((s) => (\r\n          <button\r\n            key={s}\r\n            className={`pl-phase-tab ${state.step === s ? 'is-active' : ''}`}\r\n            onClick={() => setStep(s)}\r\n          >\r\n            {s === 'epargne' && 'Phase d\\'├®pargne'}\r\n            {s === 'liquidation' && 'Phase de liquidation'}\r\n            {s === 'transmission' && 'Phase de transmission'}\r\n          </button>\r\n        ))}\r\n      </div>\r\n\r\n      <div className=\"ir-grid\">\r\n        {/* LEFT PANEL */}\r\n        <div className=\"ir-left\">\r\n          {/* Param├¿tres client */}\r\n          <div className=\"ir-table-wrapper premium-card premium-section\">\r\n            <div className=\"pl-section-title premium-section-title\">Profil client</div>\r\n            <div className=\"pl-topgrid premium-grid-4\">\r\n              <InputNumber\r\n                label=\"├ége actuel\"\r\n                value={state.client.ageActuel}\r\n                onChange={(v) => setClient({ ageActuel: v })}\r\n                unit=\"ans\"\r\n                min={18}\r\n                max={90}\r\n              />\r\n              <Select\r\n                label=\"TMI actuel\"\r\n                value={state.client.tmiEpargne}\r\n                onChange={(v) => setClient({ tmiEpargne: parseFloat(v) })}\r\n                options={tmiOptions}\r\n              />\r\n              <Select\r\n                label=\"TMI retraite\"\r\n                value={state.client.tmiRetraite}\r\n                onChange={(v) => setClient({ tmiRetraite: parseFloat(v) })}\r\n                options={tmiOptions}\r\n              />\r\n              <Select\r\n                label=\"Situation\"\r\n                value={state.client.situation}\r\n                onChange={(v) => setClient({ situation: v })}\r\n                options={[\r\n                  { value: 'single', label: 'C├®libataire' },\r\n                  { value: 'couple', label: 'Mari├® / Pacs├®' },\r\n                ]}\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          {/* Phase ├ëpargne */}\r\n          {state.step === 'epargne' && (\r\n            <div className=\"ir-table-wrapper premium-card premium-section\">\r\n              <div className=\"pl-section-title premium-section-title\">Phase d'├®pargne</div>\r\n              <table className=\"ir-table pl-table premium-table\">\r\n                <thead>\r\n                  <tr>\r\n                    <th></th>\r\n                    <th className=\"pl-colhead\" aria-label=\"Produit 1\">\r\n                      <div className=\"pl-colbadge-wrapper\">\r\n                        <div className=\"pl-collabel pl-collabel--product1\">{ENVELOPE_LABELS[state.products[0].envelope]}</div>\r\n                      </div>\r\n                    </th>\r\n                    <th className=\"pl-colhead\" aria-label=\"Produit 2\">\r\n                      <div className=\"pl-colbadge-wrapper\">\r\n                        <div className=\"pl-collabel pl-collabel--product2\">{ENVELOPE_LABELS[state.products[1].envelope]}</div>\r\n                      </div>\r\n                    </th>\r\n                  </tr>\r\n                </thead>\r\n                <tbody>\r\n                  <tr>\r\n                    <td>Enveloppe</td>\r\n                    {state.products.map((p, i) => (\r\n                      <td key={i}>\r\n                        <select\r\n                          className=\"pl-select\"\r\n                          value={p.envelope}\r\n                          onChange={(e) => setProduct(i, { envelope: e.target.value })}\r\n                        >\r\n                          {Object.entries(ENVELOPE_LABELS).map(([k, v]) => (\r\n                            <option key={k} value={k}>{v}</option>\r\n                          ))}\r\n                        </select>\r\n                      </td>\r\n                    ))}\r\n                  </tr>\r\n                  <tr>\r\n                    <td>Dur├®e de la phase ├®pargne</td>\r\n                    {state.products.map((p, i) => (\r\n                      <td key={i}>\r\n                        <InputNumber\r\n                          value={p.dureeEpargne}\r\n                          onChange={(v) => setProduct(i, { dureeEpargne: v })}\r\n                          unit=\"ans\"\r\n                          min={1}\r\n                          max={50}\r\n                        />\r\n                      </td>\r\n                    ))}\r\n                  </tr>\r\n                  {(state.products[0].envelope === 'PER' || state.products[1].envelope === 'PER') && (\r\n                    <tr>\r\n                      <td>PER bancaire (CTO)</td>\r\n                      {state.products.map((p, i) => (\r\n                        <td key={i} style={{ textAlign: 'center' }}>\r\n                          {p.envelope === 'PER' ? (\r\n                            <Toggle\r\n                              checked={p.perBancaire}\r\n                              onChange={(v) => setProduct(i, { perBancaire: v })}\r\n                              label=\"\"\r\n                            />\r\n                          ) : (\r\n                            <span className=\"pl-muted\">ÔÇö</span>\r\n                          )}\r\n                        </td>\r\n                      ))}\r\n                    </tr>\r\n                  )}\r\n                  {(state.products[0].envelope === 'CTO' || state.products[1].envelope === 'CTO') && (\r\n                    <tr>\r\n                      <td>Option dividendes au bar├¿me IR</td>\r\n                      {state.products.map((p, i) => (\r\n                        <td key={i} style={{ textAlign: 'center' }}>\r\n                          {p.envelope === 'CTO' ? (\r\n                            <Toggle\r\n                              checked={p.optionBaremeIR}\r\n                              onChange={(v) => setProduct(i, { optionBaremeIR: v })}\r\n                              label=\"\"\r\n                            />\r\n                          ) : (\r\n                            <span className=\"pl-muted\">ÔÇö</span>\r\n                          )}\r\n                        </td>\r\n                      ))}\r\n                    </tr>\r\n                  )}\r\n                  <tr>\r\n                    <td>\r\n                      Param├®trer les versements\r\n                      <div className=\"pl-detail-cumul\">Initial, annuel, allocation, frais</div>\r\n                    </td>\r\n                    {state.products.map((p, i) => (\r\n                      <td key={i}>\r\n                        <button \r\n                          className=\"pl-btn pl-btn--config\"\r\n                          onClick={() => setModalOpen(i)}\r\n                        >\r\n                          <span className=\"pl-btn__icon\">ÔÜÖ</span>\r\n                          <span className=\"pl-btn__summary\">\r\n                            {shortEuro(p.versementConfig.initial.montant)} + {shortEuro(p.versementConfig.annuel.montant)}/an\r\n                          </span>\r\n                        </button>\r\n                      </td>\r\n                    ))}\r\n                  </tr>\r\n                </tbody>\r\n              </table>\r\n\r\n              {/* D├®tail ann├®e par ann├®e */}\r\n              {produit1 && produit2 && (\r\n                <div className=\"pl-details-section\">\r\n                  <div className=\"pl-details-toolbar\">\r\n                    <label className=\"pl-details-toggle\">\r\n                      <input \r\n                        type=\"checkbox\" \r\n                        checked={showAllColumns} \r\n                        onChange={(e) => setShowAllColumns(e.target.checked)} \r\n                      />\r\n                      Afficher toutes les colonnes\r\n                    </label>\r\n                  </div>\r\n                  <div className=\"pl-details-scroll\">\r\n                    <CollapsibleTable\r\n                      title={`D├®tail ${produit1.envelopeLabel}`}\r\n                      rows={detailRows1}\r\n                      columns={columnsProduit1}\r\n                      renderRow={renderEpargneRow(produit1, columnsProduit1)}\r\n                    />\r\n                  </div>\r\n                  <div className=\"pl-details-scroll\">\r\n                    <CollapsibleTable\r\n                      title={`D├®tail ${produit2.envelopeLabel}`}\r\n                      rows={detailRows2}\r\n                      columns={columnsProduit2}\r\n                      renderRow={renderEpargneRow(produit2, columnsProduit2)}\r\n                    />\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </div>\r\n          )}\r\n\r\n          {/* Phase Liquidation */}\r\n          {state.step === 'liquidation' && (\r\n            <div className=\"ir-table-wrapper premium-card premium-section\">\r\n              <div className=\"pl-section-title premium-section-title\">Phase de liquidation</div>\r\n              <table className=\"ir-table pl-table premium-table\">\r\n                <tbody>\r\n                  <tr>\r\n                    <td>Strat├®gie de retraits</td>\r\n                    <td colSpan={2}>\r\n                      <select\r\n                        className=\"pl-select\"\r\n                        value={state.liquidation.mode}\r\n                        onChange={(e) => setLiquidation({ mode: e.target.value })}\r\n                      >\r\n                        <option value=\"epuiser\">├ëpuiser sur N ann├®es</option>\r\n                        <option value=\"mensualite\">Mensualit├® cible</option>\r\n                        <option value=\"unique\">Retrait unique</option>\r\n                      </select>\r\n                    </td>\r\n                  </tr>\r\n                  {state.liquidation.mode === 'epuiser' && (\r\n                    <tr>\r\n                      <td>Dur├®e de liquidation</td>\r\n                      <td colSpan={2}>\r\n                        <InputNumber\r\n                          value={state.liquidation.duree}\r\n                          onChange={(v) => setLiquidation({ duree: v })}\r\n                          unit=\"ans\"\r\n                          min={1}\r\n                          max={50}\r\n                          inline\r\n                        />\r\n                      </td>\r\n                    </tr>\r\n                  )}\r\n\r\n                  {(state.products[0].envelope !== 'SCPI' || state.products[1].envelope !== 'SCPI') && (\r\n                    <tr>\r\n                      <td>\r\n                        Rendement capitalisation (liquidation)\r\n                        <div className=\"pl-detail-cumul\">Valeur par d├®faut : rendement capitalisation du modal</div>\r\n                      </td>\r\n                      {state.products.map((p, i) => (\r\n                        <td key={i} style={{ opacity: p.envelope === 'SCPI' ? 0.55 : 0.85 }}>\r\n                          {p.envelope === 'SCPI' ? (\r\n                            'ÔÇö'\r\n                          ) : (\r\n                            <InputPct\r\n                              value={getRendementLiquidation(p) || 0}\r\n                              onChange={(v) => setProduct(i, { rendementLiquidationOverride: v })}\r\n                            />\r\n                          )}\r\n                        </td>\r\n                      ))}\r\n                    </tr>\r\n                  )}\r\n                  {state.liquidation.mode === 'mensualite' && (\r\n                    <tr>\r\n                      <td>Mensualit├® cible</td>\r\n                      <td colSpan={2}>\r\n                        <InputEuro\r\n                          value={state.liquidation.mensualiteCible}\r\n                          onChange={(v) => setLiquidation({ mensualiteCible: v })}\r\n                        />\r\n                      </td>\r\n                    </tr>\r\n                  )}\r\n                  {state.liquidation.mode === 'unique' && (\r\n                    <tr>\r\n                      <td>Montant du retrait</td>\r\n                      <td colSpan={2}>\r\n                        <InputEuro\r\n                          value={state.liquidation.montantUnique}\r\n                          onChange={(v) => setLiquidation({ montantUnique: v })}\r\n                        />\r\n                      </td>\r\n                    </tr>\r\n                  )}\r\n                  {/* Option au bar├¿me IR - Une seule ligne avec checkboxes */}\r\n                  {(produit1 && (produit1.envelope === 'CTO' || produit1.envelope === 'AV' || produit1.envelope === 'PEA')) ||\r\n                   (produit2 && (produit2.envelope === 'CTO' || produit2.envelope === 'AV' || produit2.envelope === 'PEA')) ? (\r\n                    <tr>\r\n                      <td>Option au bar├¿me IR</td>\r\n                      <td style={{ textAlign: 'center' }}>\r\n                        {produit1 && (produit1.envelope === 'CTO' || produit1.envelope === 'AV' || produit1.envelope === 'PEA') ? (\r\n                          <Toggle\r\n                            checked={produit1.liquidation.optionBaremeIR}\r\n                            onChange={(v) => updateProductOption(0, 'liquidation.optionBaremeIR', v)}\r\n                            label=\"\"\r\n                          />\r\n                        ) : (\r\n                          <span className=\"pl-muted\">ÔÇö</span>\r\n                        )}\r\n                      </td>\r\n                      <td style={{ textAlign: 'center' }}>\r\n                        {produit2 && (produit2.envelope === 'CTO' || produit2.envelope === 'AV' || produit2.envelope === 'PEA') ? (\r\n                          <Toggle\r\n                            checked={produit2.liquidation.optionBaremeIR}\r\n                            onChange={(v) => updateProductOption(1, 'liquidation.optionBaremeIR', v)}\r\n                            label=\"\"\r\n                          />\r\n                        ) : (\r\n                          <span className=\"pl-muted\">ÔÇö</span>\r\n                        )}\r\n                      </td>\r\n                    </tr>\r\n                  ) : null}\r\n                </tbody>\r\n              </table>\r\n\r\n              {/* D├®tail ann├®e par ann├®e - masquer les lignes apr├¿s le d├®c├¿s */}\r\n              {produit1 && produit2 && (\r\n                <div className=\"pl-details-section\">\r\n                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>\r\n                    <h4 style={{ margin: 0, fontSize: '14px', fontWeight: '600', color: 'var(--color-c1)' }}>D├®tail ann├®e par ann├®e</h4>\r\n                    <label style={{ display: 'flex', alignItems: 'center', gap: '8px', fontSize: '12px', color: 'var(--color-c9)', cursor: 'pointer' }}>\r\n                      <input\r\n                        type=\"checkbox\"\r\n                        checked={showAllColumns}\r\n                        onChange={(e) => setShowAllColumns(e.target.checked)}\r\n                        style={{ margin: 0 }}\r\n                      />\r\n                      Afficher toutes les colonnes\r\n                    </label>\r\n                  </div>\r\n                  <CollapsibleTable\r\n                    title={`D├®tail ${produit1.envelopeLabel}`}\r\n                    rows={produit1.liquidation.rows.filter(r => r.age <= produit1.liquidation.ageAuDeces)}\r\n                    columns={getRelevantColumns(produit1.liquidation.rows, buildColumns(produit1))}\r\n                    renderRow={(r, i) => (\r\n                      <tr key={i} className={r.isAgeAuDeces ? 'pl-row-deces' : ''}>\r\n                        <td>{r.age} ans {r.isAgeAuDeces && 'ÔÇá'}</td>\r\n                        {produit1.envelope === 'SCPI' ? (\r\n                          <>\r\n                            <td>{euro(r.capitalDebut)}</td>\r\n                            <td>{euro(r.retraitBrut)}</td>\r\n                            <td>{euro(r.fiscaliteTotal)}</td>\r\n                            <td>{euro(r.retraitNet)}</td>\r\n                            <td>{euro(r.capitalFin)}</td>\r\n                          </>\r\n                        ) : ['CTO', 'PEA'].includes(produit1.envelope) ? (\r\n                          <>\r\n                            <td>{euro(r.capitalDebut)}</td>\r\n                            <td>{euro(r.retraitBrut)}</td>\r\n                            <td>{euro(r.pvLatenteDebut ?? 0)}</td>\r\n                            <td>{euro(r.fiscaliteTotal)}</td>\r\n                            <td>{euro(r.retraitNet)}</td>\r\n                            <td>{euro(r.pvLatenteFin ?? r.totalInteretsRestants ?? 0)}</td>\r\n                            <td>{euro(r.capitalFin)}</td>\r\n                          </>\r\n                        ) : (\r\n                          <>\r\n                            <td>\r\n                              {euro(r.capitalDebut)}\r\n                              <div className=\"pl-detail-cumul\">+{euro(r.gainsAnnee)} int├®r├¬ts</div>\r\n                              {/* Afficher le cumul des revenus nets r├®investis */}\r\n                              <div className=\"pl-detail-cumul\">Cumul : {euro(r.cumulRevenusNetsPercus || 0)}</div>\r\n                            </td>\r\n                            <td>{euro(r.retraitBrut)}</td>\r\n                            <td>\r\n                              {euro(r.partGains)}\r\n                              <div className=\"pl-detail-cumul\">Reste : {euro(r.totalInteretsRestants)}</div>\r\n                            </td>\r\n                            <td>\r\n                              {euro(r.partCapital)}\r\n                              <div className=\"pl-detail-cumul\">Reste : {euro(r.totalCapitalRestant)}</div>\r\n                            </td>\r\n                            <td>{euro(r.fiscaliteTotal)}</td>\r\n                            <td>{euro(r.retraitNet)}</td>\r\n                            {/* Ajouter la colonne \"Capital d├®c├¿s th├®orique\" pour les PER */}\r\n                            {produit2.envelope === 'PER' && produit2?.versementConfig?.annuel?.garantieBonneFin?.active && (\r\n                              <td>{euro(r.capitalDecesTheorique || 0)}</td>\r\n                            )}\r\n                            <td>{euro(r.capitalFin)}</td>\r\n                          </>\r\n                        )}\r\n                      </tr>\r\n                    )}\r\n                  />\r\n                  <CollapsibleTable\r\n                    title={`D├®tail ${produit2.envelopeLabel}`}\r\n                    rows={produit2.liquidation.rows.filter(r => r.age <= produit2.liquidation.ageAuDeces)}\r\n                    columns={getRelevantColumns(produit2.liquidation.rows, buildColumns(produit2))}\r\n                    renderRow={(r, i) => (\r\n                      <tr key={i} className={r.isAgeAuDeces ? 'pl-row-deces' : ''}>\r\n                        <td>{r.age} ans {r.isAgeAuDeces && 'ÔÇá'}</td>\r\n                        {produit2.envelope === 'SCPI' ? (\r\n                          <>\r\n                            <td>{euro(r.capitalDebut)}</td>\r\n                            <td>{euro(r.retraitBrut)}</td>\r\n                            <td>{euro(r.fiscaliteTotal)}</td>\r\n                            <td>{euro(r.retraitNet)}</td>\r\n                            <td>{euro(r.capitalFin)}</td>\r\n                          </>\r\n                        ) : ['CTO', 'PEA'].includes(produit2.envelope) ? (\r\n                          <>\r\n                            <td>{euro(r.capitalDebut)}</td>\r\n                            <td>{euro(r.retraitBrut)}</td>\r\n                            <td>{euro(r.pvLatenteDebut ?? 0)}</td>\r\n                            <td>{euro(r.fiscaliteTotal)}</td>\r\n                            <td>{euro(r.retraitNet)}</td>\r\n                            <td>{euro(r.pvLatenteFin ?? r.totalInteretsRestants ?? 0)}</td>\r\n                            <td>{euro(r.capitalFin)}</td>\r\n                          </>\r\n                        ) : (\r\n                          <>\r\n                            <td>\r\n                              {euro(r.capitalDebut)}\r\n                              <div className=\"pl-detail-cumul\">+{euro(r.gainsAnnee)} int├®r├¬ts</div>\r\n                              {/* Afficher le cumul des revenus nets r├®investis */}\r\n                              <div className=\"pl-detail-cumul\">Cumul : {euro(r.cumulRevenusNetsPercus || 0)}</div>\r\n                            </td>\r\n                            <td>{euro(r.retraitBrut)}</td>\r\n                            <td>\r\n                              {euro(r.partGains)}\r\n                              <div className=\"pl-detail-cumul\">Reste : {euro(r.totalInteretsRestants)}</div>\r\n                            </td>\r\n                            <td>\r\n                              {euro(r.partCapital)}\r\n                              <div className=\"pl-detail-cumul\">Reste : {euro(r.totalCapitalRestant)}</div>\r\n                            </td>\r\n                            <td>{euro(r.fiscaliteTotal)}</td>\r\n                            <td>{euro(r.retraitNet)}</td>\r\n                            {/* Ajouter la colonne \"Capital d├®c├¿s th├®orique\" pour les PER */}\r\n                            {produit2.envelope === 'PER' && produit2?.versementConfig?.annuel?.garantieBonneFin?.active && (\r\n                              <td>{euro(r.capitalDecesTheorique || 0)}</td>\r\n                            )}\r\n                            <td>{euro(r.capitalFin)}</td>\r\n                          </>\r\n                        )}\r\n                      </tr>\r\n                    )}\r\n                  />\r\n                </div>\r\n              )}\r\n              <div className=\"pl-hint\">\r\n                <a href=\"/settings/fiscalites-contrats\" style={{ color: 'var(--color-c2)', fontSize: 11 }}>Consulter la fiscalit├® des contrats ÔåÆ</a>\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {/* Phase Transmission */}\r\n          {state.step === 'transmission' && (\r\n            <>\r\n            <div className=\"ir-table-wrapper premium-card premium-section\">\r\n              <div className=\"pl-section-title premium-section-title\">Transmission</div>\r\n              <table className=\"ir-table pl-table premium-table\">\r\n                <tbody>\r\n                  <tr>\r\n                    <td>├ége au d├®c├¿s (simulation)</td>\r\n                    <td colSpan={2}>\r\n                      <div className=\"pl-field-container\" style={{ alignItems: 'flex-end' }}>\r\n                        <InputNumber\r\n                          value={state.transmission.ageAuDeces}\r\n                          onChange={(v) => setTransmission({ ageAuDeces: v })}\r\n                          unit=\"ans\"\r\n                          min={state.client.ageActuel}\r\n                          max={120}\r\n                          inline\r\n                        />\r\n                        <div className=\"pl-field-help\" style={{ textAlign: 'right', alignSelf: 'flex-end' }}>\r\n                          Minimum : {state.client.ageActuel} ans (├óge actuel)\r\n                        </div>\r\n                      </div>\r\n                    </td>\r\n                  </tr>\r\n                  <tr>\r\n                    <td>Choix du b├®n├®ficiaire</td>\r\n                    <td colSpan={2}>\r\n                      <select\r\n                        className=\"pl-select\"\r\n                        value={state.transmission.beneficiaryType || 'enfants'}\r\n                        onChange={(e) => {\r\n                          const value = e.target.value;\r\n                          if (value === 'conjoint') {\r\n                            setTransmission({ beneficiaryType: value, nbBeneficiaires: 1 });\r\n                          } else {\r\n                            setTransmission({ beneficiaryType: value });\r\n                          }\r\n                        }}\r\n                      >\r\n                        {BENEFICIARY_OPTIONS.map((option) => (\r\n                          <option key={option.value} value={option.value}>\r\n                            {option.label}\r\n                          </option>\r\n                        ))}\r\n                      </select>\r\n                    </td>\r\n                  </tr>\r\n                  {state.transmission.beneficiaryType !== 'conjoint' && (\r\n                    <tr>\r\n                      <td>Nombre de b├®n├®ficiaires</td>\r\n                      <td colSpan={2}>\r\n                        <InputNumber\r\n                          value={state.transmission.nbBeneficiaires}\r\n                          onChange={(v) => setTransmission({ nbBeneficiaires: v })}\r\n                          min={1}\r\n                          max={10}\r\n                          inline\r\n                        />\r\n                      </td>\r\n                    </tr>\r\n                  )}\r\n                  <tr>\r\n                    <td>Tranche DMTG estim├®e</td>\r\n                    <td colSpan={2}>\r\n                      <select\r\n                        className=\"pl-select\"\r\n                        value={state.transmission.dmtgTaux}\r\n                        onChange={(e) => {\r\n                          const nextValue = parseFloat(e.target.value);\r\n                          if (Number.isNaN(nextValue)) return;\r\n                          setTransmission({ dmtgTaux: nextValue });\r\n                        }}\r\n                      >\r\n                        {dmtgSelectOptions.map((option) => (\r\n                          <option key={option.key || option.value} value={option.value}>\r\n                            {option.label}\r\n                          </option>\r\n                        ))}\r\n                      </select>\r\n                    </td>\r\n                  </tr>\r\n                  {showDmtgDisclaimer && (\r\n                    <tr>\r\n                      <td colSpan={3}>\r\n                        <div className=\"pl-alert pl-alert--warning\">\r\n                          ÔÜá´©Å Consommation estim├®e de la tranche DMTG (sur lÔÇÖassiette r├®ellement soumise aux DMTG) <sup>(1)</sup> :\r\n                          <div style={{ marginTop: 6 }}>\r\n                            <div>\r\n                              Placement 1 : {dmtgConsumptionPercentProduit1}%\r\n                            </div>\r\n                            <div>\r\n                              Placement 2 : {dmtgConsumptionPercentProduit2}%\r\n                            </div>\r\n                          </div>\r\n                          <div style={{ marginTop: 6 }}>\r\n                            Pensez ├á ajuster la tranche DMTG pour refl├®ter lÔÇÖensemble du patrimoine.\r\n                          </div>\r\n                        </div>\r\n                      </td>\r\n                    </tr>\r\n                  )}\r\n                </tbody>\r\n              </table>\r\n\r\n              {/* Tableau d├®taill├® des droits de succession */}\r\n              <div className=\"pl-section-title premium-section-title\" style={{ marginTop: 24 }}>D├®tail des droits de succession</div>\r\n              <table className=\"ir-table pl-table premium-table pl-table--transmission-compact\">\r\n                <thead>\r\n                  <tr>\r\n                    <th>Produit</th>\r\n                    <th>Capital transmis</th>\r\n                    <th>Abattement</th>\r\n                    <th>Assiette</th>\r\n                    <th>PS</th>\r\n                    <th>Taxes (Forfaitaire + DMTG)</th>\r\n                    <th>Net transmis</th>\r\n                  </tr>\r\n                </thead>\r\n                <tbody>\r\n                  <tr>\r\n                    <td>{produit1?.envelopeLabel || 'Produit 1'}</td>\r\n                    <td>{euro(produit1?.transmission?.capitalTransmis || 0)}</td>\r\n                    <td>{euro(produit1?.transmission?.abattement || 0)}</td>\r\n                    <td>{euro(produit1?.transmission?.assiette || 0)}</td>\r\n                    <td>{formatPsMontant(psDecesProduit1, euro)}</td>\r\n                    <td>{euro((produit1?.transmission?.taxeForfaitaire || 0) + (produit1?.transmission?.taxeDmtg || 0))}</td>\r\n                    <td><strong>{euro(produit1?.transmission?.capitalTransmisNet || 0)}</strong></td>\r\n                  </tr>\r\n                  <tr>\r\n                    <td>{produit2?.envelopeLabel || 'Produit 2'}</td>\r\n                    <td>{euro(produit2?.transmission?.capitalTransmis || 0)}</td>\r\n                    <td>{euro(produit2?.transmission?.abattement || 0)}</td>\r\n                    <td>{euro(produit2?.transmission?.assiette || 0)}</td>\r\n                    <td>{formatPsMontant(psDecesProduit2, euro)}</td>\r\n                    <td>{euro((produit2?.transmission?.taxeForfaitaire || 0) + (produit2?.transmission?.taxeDmtg || 0))}</td>\r\n                    <td><strong>{euro(produit2?.transmission?.capitalTransmisNet || 0)}</strong></td>\r\n                  </tr>\r\n                  {!hasTransmissionData && (\r\n                    <tr>\r\n                      <td colSpan={7} style={{ textAlign: 'center', color: 'var(--color-c8)', fontStyle: 'italic' }}>\r\n                        Aucune donn├®e ├á afficher - Configurez les param├¿tres de transmission ci-dessus\r\n                      </td>\r\n                    </tr>\r\n                  )}\r\n                </tbody>\r\n              </table>\r\n            </div>\r\n            <div className=\"pl-disclaimer pl-transmission-info-card\">\r\n              <strong>R├®gimes applicables :</strong>\r\n              <ul>\r\n                <li>AV : 990 I (versements avant 70 ans) ou 757 B (apr├¿s 70 ans)</li>\r\n                <li>PER assurance : 990 I (d├®c├¿s avant 70 ans) ou 757 B (d├®c├¿s ÔëÑ 70 ans)</li>\r\n                <li>PER bancaire / CTO / PEA / SCPI : int├®gration ├á l'actif successoral (DMTG)</li>\r\n                <li>Conjoint / partenaire PACS : exon├®ration du pr├®l├¿vement 20 % et des DMTG</li>\r\n              </ul>\r\n              <p>\r\n                <a href=\"/settings/impots\" className=\"pl-transmission-info-card__link\">Consulter le bar├¿me DMTG ÔåÆ</a>\r\n              </p>\r\n              <strong>Hypoth├¿ses PS d├®c├¿s :</strong>\r\n              <p>\r\n                Assurance-vie & PER simul├®s ├á 100 % en unit├®s de compte (pas de fonds Ôé¼). Les PS au d├®c├¿s sont appliqu├®s au taux de {psSettings?.patrimony?.current?.totalRate ?? 17.2}% (<a href=\"/settings/prelevements\" className=\"pl-transmission-info-card__link\">param├®trable</a>), puis les montants nets alimentent les DMTG.\r\n              </p>\r\n              <p className=\"pl-transmission-info-card__note\">\r\n                La d├®termination de lÔÇÖassiette taxable au pr├®l├¿vement 990&nbsp;I sÔÇÖeffectue apr├¿s imputation des PS dus sur les produits du contrat, pr├®lev├®s par lÔÇÖassureur au d├®c├¿s (BOI-TCAS-AUT-60).\r\n              </p>\r\n              <p className=\"pl-transmission-info-card__footnote\"><sup>(1)</sup> Seuls les montants r├®ellement soumis aux PS/DMTG sont utilis├®s pour les pourcentages affich├®s.</p>\r\n            </div>\r\n            </>\r\n          )}\r\n        </div>\r\n\r\n        {/* RIGHT PANEL - Synth├¿se unifi├®e */}\r\n        <div className=\"ir-right\">\r\n          <div className=\"ir-synthesis-card premium-card\">\r\n            <div className=\"pl-card-title premium-section-title\">Synth├¿se comparative</div>\r\n\r\n            {loading ? (\r\n              <div className=\"pl-synthesis-placeholder\">ChargementÔÇª</div>\r\n            ) : !hydrated || !results ? (\r\n              <div className=\"pl-synthesis-placeholder\">Aucune simulation (recharger ou compl├®ter Produit 1/2)</div>\r\n            ) : !produit1 || !produit2 ? (\r\n              <div className=\"pl-synthesis-placeholder\">S├®lectionne Produit 1 et Produit 2ÔÇª</div>\r\n            ) : (\r\n              <>\r\n                {/* Timeline visuelle du parcours */}\r\n                <TimelineBar\r\n                  ageActuel={state.client.ageActuel}\r\n                  ageDebutLiquidation={state.client.ageActuel + state.products[0].dureeEpargne}\r\n                  ageAuDeces={state.transmission.ageAuDeces}\r\n                />\r\n\r\n                {/* Trait s├®parateur avant ROI */}\r\n                <div style={{ borderTop: '1px solid var(--color-c6)', margin: '12px 0' }} />\r\n\r\n                {/* Calcul du ROI pour chaque produit */}\r\n                {(() => {\r\n                  const totalGains1 = produit1.totaux.revenusNetsLiquidation + produit1.totaux.capitalTransmisNet;\r\n                  const totalGains2 = produit2.totaux.revenusNetsLiquidation + produit2.totaux.capitalTransmisNet;\r\n                  const roi1 = produit1.totaux.effortReel > 0 ? totalGains1 / produit1.totaux.effortReel : 0;\r\n                  const roi2 = produit2.totaux.effortReel > 0 ? totalGains2 / produit2.totaux.effortReel : 0;\r\n                  const meilleurProduit = roi1 > roi2 ? 1 : 2;\r\n\r\n                  return (\r\n                    <>\r\n                      {/* Comparaison ROI - 2 colonnes */}\r\n                      <div className=\"pl-roi-compare\">\r\n                        <div className=\"pl-roi-compare__title\">ROI</div>\r\n                        <div className=\"pl-roi-compare__grid\">\r\n                          <div className={`pl-roi-compare__card ${meilleurProduit === 1 ? 'is-winner' : ''}`}>\r\n                            <div className=\"pl-roi-compare__product-indicator\" style={{ background: 'var(--color-c2)' }}></div>\r\n                            <div className=\"pl-roi-compare__product\">{produit1.envelopeLabel.replace('PER individuel d├®ductible', 'PER individuel')}</div>\r\n                            <div className=\"pl-roi-compare__ratio\">├ù {roi1.toFixed(2)}</div>\r\n                          </div>\r\n                          <div className={`pl-roi-compare__card ${meilleurProduit === 2 ? 'is-winner' : ''}`}>\r\n                            <div className=\"pl-roi-compare__product-indicator\" style={{ background: 'var(--color-c4)' }}></div>\r\n                            <div className=\"pl-roi-compare__product\">{produit2.envelopeLabel.replace('PER individuel d├®ductible', 'PER individuel')}</div>\r\n                            <div className=\"pl-roi-compare__ratio\">├ù {roi2.toFixed(2)}</div>\r\n                          </div>\r\n                        </div>\r\n                      </div>\r\n\r\n                      {/* Tableau comparatif */}\r\n                      <div className=\"pl-kpi-compare\">\r\n                        <div className=\"pl-kpi-compare__header-empty\"></div>\r\n                        <div className=\"pl-kpi-compare__header\">\r\n                          <div className=\"pl-kpi-compare__indicator\" style={{ background: 'var(--color-c2)' }}>1</div>\r\n                        </div>\r\n                        <div className=\"pl-kpi-compare__header\">\r\n                          <div className=\"pl-kpi-compare__indicator\" style={{ background: 'var(--color-c4)' }}>2</div>\r\n                        </div>\r\n\r\n                        <div className=\"pl-kpi-compare__label\">Effort total</div>\r\n                        <div className=\"pl-kpi-compare__value\">{shortEuro(produit1.totaux.effortReel)}</div>\r\n                        <div className=\"pl-kpi-compare__value\">{shortEuro(produit2.totaux.effortReel)}</div>\r\n\r\n                        <div className=\"pl-kpi-compare__label\">Capital acquis</div>\r\n                        <div className=\"pl-kpi-compare__value\">{shortEuro(produit1.epargne.capitalAcquis)}</div>\r\n                        <div className=\"pl-kpi-compare__value\">{shortEuro(produit2.epargne.capitalAcquis)}</div>\r\n\r\n                        <div className=\"pl-kpi-compare__label\">Revenus nets</div>\r\n                        <div className=\"pl-kpi-compare__value\">{shortEuro(produit1.totaux.revenusNetsLiquidation)}</div>\r\n                        <div className=\"pl-kpi-compare__value\">{shortEuro(produit2.totaux.revenusNetsLiquidation)}</div>\r\n\r\n                        <div className=\"pl-kpi-compare__label\">Transmis net</div>\r\n                        <div className=\"pl-kpi-compare__value\">{shortEuro(produit1.totaux.capitalTransmisNet)}</div>\r\n                        <div className=\"pl-kpi-compare__value\">{shortEuro(produit2.totaux.capitalTransmisNet)}</div>\r\n\r\n                        <div className=\"pl-kpi-compare__separator\"></div>\r\n                        <div className=\"pl-kpi-compare__separator\"></div>\r\n                        <div className=\"pl-kpi-compare__separator\"></div>\r\n\r\n                        <div className=\"pl-kpi-compare__label pl-kpi-compare__label--total\">Total r├®cup├®r├®</div>\r\n                        <div className=\"pl-kpi-compare__value pl-kpi-compare__value--total\">{shortEuro(totalGains1)}</div>\r\n                        <div className=\"pl-kpi-compare__value pl-kpi-compare__value--total\">{shortEuro(totalGains2)}</div>\r\n                      </div>\r\n                    </>\r\n                  );\r\n                })()}\r\n              </>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Modal de configuration des versements */}\r\n      {modalOpen !== null && (\r\n        <VersementConfigModal\r\n          envelope={state.products[modalOpen].envelope}\r\n          config={state.products[modalOpen].versementConfig}\r\n          dureeEpargne={state.products[modalOpen].dureeEpargne}\r\n          onSave={(config) => {\r\n            console.log('[PlacementV2] onSave called with config:', config);\r\n            console.log('[PlacementV2] modalOpen:', modalOpen);\r\n            try {\r\n              setVersementConfig(modalOpen, config);\r\n              console.log('[PlacementV2] setVersementConfig called');\r\n              setModalOpen(null);\r\n              console.log('[PlacementV2] setModalOpen(null) called');\r\n            } catch (error) {\r\n              console.error('[PlacementV2] Error in onSave handler:', error);\r\n            }\r\n          }}\r\n          onClose={() => setModalOpen(null)}\r\n        />\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pages\\SetPassword.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pages\\Settings.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'logo' and 'setLogo'. Either include them or remove the dependency array.","line":268,"column":6,"nodeType":"ArrayExpression","endLine":268,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [logo, setLogo]","fix":{"range":[8483,8485],"text":"[logo, setLogo]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react';\r\nimport { supabase, DEBUG_AUTH } from '../supabaseClient';\r\nimport { useTheme } from '../settings/ThemeProvider';\r\nimport { UserInfoBanner } from '../components/UserInfoBanner';\r\nimport { recalculatePaletteFromC1 } from '../utils/paletteGenerator';\r\n\r\n// Couleurs par d├®faut\r\nconst DEFAULT_COLORS = {\r\n  color1: '#2B3E37',\r\n  color2: '#709B8B',\r\n  color3: '#9FBDB2',\r\n  color4: '#CFDED8',\r\n  color5: '#788781',\r\n  color6: '#CEC1B6',\r\n  color7: '#F5F3F0',\r\n  color8: '#D9D9D9',\r\n  color9: '#7F7F7F',\r\n  color10: '#000000',\r\n};\r\n\r\n// Th├¿mes pr├®d├®finis (objets immuables)\r\nconst PREDEFINED_THEMES = Object.freeze([\r\n  {\r\n    id: 'ser1-classic',\r\n    name: 'Th├¿me Original',\r\n    description: 'Th├¿me original ├®l├®gant et professionnel',\r\n    colors: Object.freeze({\r\n      color1: '#2B3E37',\r\n      color2: '#709B8B',\r\n      color3: '#9FBDB2',\r\n      color4: '#CFDED8',\r\n      color5: '#788781',\r\n      color6: '#CEC1B6',\r\n      color7: '#F5F3F0',\r\n      color8: '#D9D9D9',\r\n      color9: '#7F7F7F',\r\n      color10: '#000000',\r\n    })\r\n  },\r\n  {\r\n    id: 'blue-patrimonial',\r\n    name: 'Bleu patrimonial',\r\n    description: 'Bleu sobre pour la gestion de patrimoine',\r\n    colors: Object.freeze({\r\n      color1: '#1e3a5f',\r\n      color2: '#2c5282',\r\n      color3: '#3182ce',\r\n      color4: '#bee3f8',\r\n      color5: '#4a5568',\r\n      color6: '#e2e8f0',\r\n      color7: '#f7fafc',\r\n      color8: '#cbd5e0',\r\n      color9: '#718096',\r\n      color10: '#1a202c',\r\n    })\r\n  },\r\n  {\r\n    id: 'green-sustainable',\r\n    name: 'Vert investissement durable',\r\n    description: 'Vert profond pour l\\'investissement durable',\r\n    colors: Object.freeze({\r\n      color1: '#22543d',\r\n      color2: '#2f855a',\r\n      color3: '#48bb78',\r\n      color4: '#c6f6d5',\r\n      color5: '#4a5568',\r\n      color6: '#e2e8f0',\r\n      color7: '#f7fafc',\r\n      color8: '#cbd5e0',\r\n      color9: '#718096',\r\n      color10: '#1a202c',\r\n    })\r\n  },\r\n  {\r\n    id: 'grey-modern',\r\n    name: 'Gris moderne',\r\n    description: 'Gris minimaliste et ├®pur├®',\r\n    colors: Object.freeze({\r\n      color1: '#2d3748',\r\n      color2: '#4a5568',\r\n      color3: '#718096',\r\n      color4: '#e2e8f0',\r\n      color5: '#4a5568',\r\n      color6: '#edf2f7',\r\n      color7: '#f7fafc',\r\n      color8: '#cbd5e0',\r\n      color9: '#718096',\r\n      color10: '#1a202c',\r\n    })\r\n  },\r\n  {\r\n    id: 'gold-elite',\r\n    name: 'Or ├®lite',\r\n    description: 'Or subtil et noir pour le patrimoine haut de gamme',\r\n    colors: Object.freeze({\r\n      color1: '#4a3426',      // Brun profond (remplace jaune flashy)\r\n      color2: '#8b6914',      // Or patin├®\r\n      color3: '#b8860b',      // Or doux\r\n      color4: '#f4e4c1',      // Cr├¿me d├®licat\r\n      color5: '#4a5568',      // Gris neutre\r\n      color6: '#e8e3d3',      // Beige subtil\r\n      color7: '#faf8f3',      // Fond tr├¿s clair\r\n      color8: '#d4c4a0',      // Or en bordure\r\n      color9: '#6b5d54',      // Texte secondaire\r\n      color10: '#1a1a1a',     // Texte principal (noir doux)\r\n    })\r\n  }\r\n]);\r\n\r\nconst COLOR_FIELDS = [\r\n  { key: 'color1', label: 'Couleur 1' },\r\n  { key: 'color2', label: 'Couleur 2' },\r\n  { key: 'color3', label: 'Couleur 3' },\r\n  { key: 'color4', label: 'Couleur 4' },\r\n  { key: 'color5', label: 'Couleur 5' },\r\n  { key: 'color6', label: 'Couleur 6' },\r\n  { key: 'color7', label: 'Couleur 7' },\r\n  { key: 'color8', label: 'Couleur 8' },\r\n  { key: 'color9', label: 'Couleur 9' },\r\n  { key: 'color10', label: 'Couleur 10' },\r\n];\r\n\r\nexport default function Settings() {\r\n  const { colors, setColors, saveThemeToUiSettings, isLoading: themeLoading, logo, setLogo } = useTheme();\r\n  const [user, setUser] = useState(null);\r\n  const [loading, setLoading] = useState(true);\r\n\r\n  // Convertir le format ThemeProvider vers l'ancien format pour compatibilit├®\r\n  const [colorsLegacy, setColorsLegacy] = useState(DEFAULT_COLORS);\r\n  const [colorText, setColorText] = useState(DEFAULT_COLORS);\r\n  const [savingColors, setSavingColors] = useState(false);\r\n  const [saveMessage, setSaveMessage] = useState('');\r\n  \r\n  // V3.1: Theme source state (cabinet vs custom) - synchronis├® avec ThemeProvider\r\n  const [themeSource, setThemeSource] = useState(() => {\r\n    return localStorage.getItem('themeSource') || 'cabinet';\r\n  });\r\n\r\n  // Synchroniser avec ThemeProvider\r\n  const { themeSource: providerThemeSource, setThemeSource: setProviderThemeSource } = useTheme();\r\n\r\n  useEffect(() => {\r\n    localStorage.setItem('themeSource', themeSource);\r\n    // Synchroniser avec ThemeProvider\r\n    if (providerThemeSource !== themeSource) {\r\n      setProviderThemeSource?.(themeSource);\r\n    }\r\n  }, [themeSource, providerThemeSource, setProviderThemeSource]);\r\n\r\n  // V3.1: Advanced colors visibility\r\n  const [showAdvancedColors, setShowAdvancedColors] = useState(false);\r\n\r\n  // Legacy states (kept for compatibility)\r\n  const [selectedTheme, setSelectedTheme] = useState('Personnalis├®');\r\n  \r\n  // TODO: themeScope will be removed fully in V3.3 when PPTX is cabinet-governed\r\n  // Default stable value for compatibility\r\n  const themeScope = 'ui-only';\r\n\r\n  // Convertir les couleurs du ThemeProvider vers l'ancien format\r\n  useEffect(() => {\r\n    if (colors && !themeLoading) {\r\n      const legacyColors = {\r\n        color1: colors.c1,\r\n        color2: colors.c2,\r\n        color3: colors.c3,\r\n        color4: colors.c4,\r\n        color5: colors.c5,\r\n        color6: colors.c6,\r\n        color7: colors.c7,\r\n        color8: colors.c8,\r\n        color9: colors.c9,\r\n        color10: colors.c10,\r\n      };\r\n      setColorsLegacy(legacyColors);\r\n      setColorText(legacyColors);\r\n      \r\n      // D├®tecter si c'est un th├¿me pr├®d├®fini\r\n      const matchingTheme = PREDEFINED_THEMES.find(theme => \r\n        Object.entries(theme.colors).every(([key, value]) => legacyColors[key] === value)\r\n      );\r\n      setSelectedTheme(matchingTheme ? matchingTheme.name : 'Personnalis├®');\r\n    }\r\n  }, [colors, themeLoading]);\r\n\r\n  // NOTE: themeScope is now loaded by ThemeProvider, no need for local loading\r\n\r\n  // Fonction pour synchroniser les couleurs avec ThemeProvider\r\n  const syncThemeColors = (settingsColors) => {\r\n    const themeColors = {\r\n      c1: settingsColors.color1,\r\n      c2: settingsColors.color2,\r\n      c3: settingsColors.color3,\r\n      c4: settingsColors.color4,\r\n      c5: settingsColors.color5,\r\n      c6: settingsColors.color6,\r\n      c7: settingsColors.color7,\r\n      c8: settingsColors.color8,\r\n      c9: settingsColors.color9,\r\n      c10: settingsColors.color10,\r\n    };\r\n    \r\n    setColors(themeColors);\r\n  };\r\n\r\n  useEffect(() => {\r\n    let mounted = true;\r\n    let timeoutId;\r\n\r\n    async function loadUser() {\r\n      try {\r\n        if (DEBUG_AUTH) console.log('[Settings] loadUser:start');\r\n        // Timeout de 6s pour ├®viter le blocage infini\r\n        timeoutId = setTimeout(() => {\r\n          if (mounted) {\r\n            console.warn('[Settings] Timeout lors du chargement utilisateur, utilisation des valeurs par d├®faut');\r\n            setLoading(false);\r\n          }\r\n        }, 6000);\r\n\r\n        const { data, error } = await supabase.auth.getUser();\r\n        \r\n        if (error) {\r\n          console.error('Erreur chargement user :', error);\r\n          return;\r\n        }\r\n\r\n        const u = data?.user || null;\r\n        if (!mounted) return;\r\n\r\n        if (DEBUG_AUTH) console.log('[Settings] loadUser:success', { hasUser: !!u, userId: u?.id });\r\n\r\n        setUser(u);\r\n\r\n        if (u) {\r\n          const meta = u.user_metadata || {};\r\n\r\n          // r├┤le Admin / User\r\n          const isAdmin =\r\n            (typeof meta.role === 'string' &&\r\n              meta.role.toLowerCase() === 'admin') ||\r\n            meta.is_admin === true;\r\n\r\n          if (DEBUG_AUTH) {\r\n            console.log('[Settings] role detected', { userId: u.id, isAdmin, role: meta.role });\r\n          }\r\n\r\n          // TODO: Logo handling deprecated in V3.1 - cabinet logos now managed in admin\r\n          // Kept for compatibility only\r\n          if (meta.cover_slide_url && !logo) {\r\n            setLogo(meta.cover_slide_url);\r\n          }\r\n        }\r\n      } catch (e) {\r\n        console.error(e);\r\n      } finally {\r\n        // Annuler le timeout et forcer loading=false dans tous les cas\r\n        if (timeoutId) clearTimeout(timeoutId);\r\n        if (mounted) setLoading(false);\r\n      }\r\n    }\r\n\r\n    loadUser();\r\n    return () => {\r\n      mounted = false;\r\n      if (timeoutId) clearTimeout(timeoutId);\r\n    };\r\n  }, []);\r\n\r\n  /* ---------- Gestion des couleurs ---------- */\r\n\r\n  const handleColorChange = (key, value) => {\r\n    // Bloquer l'├®dition en mode cabinet\r\n    if (themeSource === 'cabinet') {\r\n      return;\r\n    }\r\n    \r\n    // l'utilisateur clique sur un swatch de couleur\r\n    const newColors = { ...colorsLegacy, [key]: value };\r\n    setColorsLegacy(newColors);\r\n    setColorText(prev => ({ ...prev, [key]: value.toUpperCase() }));\r\n    setSaveMessage('');\r\n    \r\n    // ­ƒöä UX: Si on modifie une couleur manuellement, basculer sur \"Personnalis├®\"\r\n    if (selectedTheme !== 'Personnalis├®') {\r\n      setSelectedTheme('Personnalis├®');\r\n    }\r\n    \r\n    // If changing c1, recalculate other colors automatically\r\n    if (key === 'color1' && themeSource === 'custom') {\r\n      const recalculated = recalculatePaletteFromC1(value);\r\n      setColorsLegacy(prev => ({ ...prev, ...recalculated }));\r\n      setColorText(prev => ({ ...prev, ...Object.fromEntries(\r\n        Object.entries(recalculated).map(([k, v]) => [k, v.toUpperCase()])\r\n      ) }));\r\n      syncThemeColors({ ...newColors, ...recalculated });\r\n    } else {\r\n      // Synchronisation temps r├®el avec le nouveau th├¿me\r\n      syncThemeColors(newColors);\r\n    }\r\n  };\r\n\r\n  const handleColorTextChange = (key, value) => {\r\n    // lÔÇÖutilisateur tape dans le champ texte\r\n    setColorText(prev => ({ ...prev, [key]: value }));\r\n    setSaveMessage('');\r\n  };\r\n\r\n  const handleColorTextBlur = (key) => {\r\n    const v = (colorText[key] || '').trim();\r\n    const hex = v.startsWith('#') ? v : `#${v}`;\r\n\r\n    // hex complet #RRGGBB\r\n    const isValid = /^#[0-9a-fA-F]{6}$/.test(hex);\r\n\r\n    if (isValid) {\r\n      const newColors = { ...colorsLegacy, [key]: hex };\r\n      setColorsLegacy(newColors);\r\n      setColorText(prev => ({ ...prev, [key]: hex.toUpperCase() }));\r\n      \r\n      // ­ƒöä UX: Si on modifie une couleur manuellement, basculer sur \"Personnalis├®\"\r\n      if (selectedTheme !== 'Personnalis├®') {\r\n        setSelectedTheme('Personnalis├®');\r\n      }\r\n      \r\n      // If changing c1 via text input, recalculate other colors automatically\r\n      if (key === 'color1' && themeSource === 'custom') {\r\n        const recalculated = recalculatePaletteFromC1(hex);\r\n        setColorsLegacy(prev => ({ ...prev, ...recalculated }));\r\n        setColorText(prev => ({ ...prev, ...Object.fromEntries(\r\n          Object.entries(recalculated).map(([k, v]) => [k, v.toUpperCase()])\r\n        ) }));\r\n        syncThemeColors({ ...newColors, ...recalculated });\r\n      } else {\r\n        // Synchronisation temps r├®el avec le nouveau th├¿me\r\n        syncThemeColors(newColors);\r\n      }\r\n    } else {\r\n      // invalide ÔåÆ on revient ├á la couleur r├®elle\r\n      setColorText(prev => ({ ...prev, [key]: prev[key] || colorsLegacy[key] || '' }));\r\n    }\r\n  };\r\n\r\n  const handleSaveColors = async () => {\r\n    try {\r\n      setSavingColors(true);\r\n      setSaveMessage('');\r\n\r\n      // Construire le nom du th├¿me avec le scope\r\n      const themeName = selectedTheme === 'Personnalis├®' \r\n        ? `custom${themeScope === 'ui-only' ? '-ui-only' : ''}`\r\n        : selectedTheme;\r\n\r\n      // Sauvegarder avec le nouveau syst├¿me ui_settings\r\n      const result = await saveThemeToUiSettings({\r\n        c1: colorsLegacy.color1,\r\n        c2: colorsLegacy.color2,\r\n        c3: colorsLegacy.color3,\r\n        c4: colorsLegacy.color4,\r\n        c5: colorsLegacy.color5,\r\n        c6: colorsLegacy.color6,\r\n        c7: colorsLegacy.color7,\r\n        c8: colorsLegacy.color8,\r\n        c9: colorsLegacy.color9,\r\n        c10: colorsLegacy.color10,\r\n      }, themeName);\r\n      \r\n      if (result.success) {\r\n        setSaveMessage('Th├¿me enregistr├® avec succ├¿s.');\r\n      } else {\r\n        setSaveMessage(\"Erreur lors de l'enregistrement : \" + result.error);\r\n      }\r\n    } catch (e) {\r\n      console.error(e);\r\n      setSaveMessage(\"Erreur lors de l'enregistrement.\");\r\n    } finally {\r\n      setSavingColors(false);\r\n    }\r\n  };\r\n\r\n  // Gestionnaire de s├®lection de th├¿me pr├®d├®fini\r\n  const handleThemeSelect = (themeName) => {\r\n    setSelectedTheme(themeName);\r\n    \r\n    if (themeName === 'Personnalis├®') {\r\n      return; // Ne rien faire, l'utilisateur garde ses couleurs personnalis├®es\r\n    }\r\n    \r\n    const theme = PREDEFINED_THEMES.find(t => t.name === themeName);\r\n    if (theme) {\r\n      // ­ƒöä UX: Appliquer les couleurs du preset (copie immuable)\r\n      setColorsLegacy({ ...theme.colors });\r\n      setColorText({ ...theme.colors });\r\n      syncThemeColors(theme.colors);\r\n      setSaveMessage('');\r\n    }\r\n  };\r\n\r\n  /* ---------- Rendu ---------- */\r\n\r\n  if (loading) {\r\n    return <p>ChargementÔÇª</p>;\r\n  }\r\n\r\n  if (!user) {\r\n    return <p>Aucun utilisateur connect├®.</p>;\r\n  }\r\n\r\n  return (\r\n    <>\r\n      {/* Contenu onglet G├®n├®raux */}\r\n      <div\r\n          style={{\r\n            fontSize: 16,\r\n            marginTop: 24,\r\n            display: 'flex',\r\n            flexDirection: 'column',\r\n            gap: 24,\r\n          }}\r\n        >\r\n          {/* Infos utilisateur */}\r\n          <UserInfoBanner />\r\n\r\n          {/* Personnalisation avanc├®e du th├¿me */}\r\n          <div>\r\n            <h3 style={{ marginBottom: 8 }}>Personnalisation avanc├®e du th├¿me</h3>\r\n            <p style={{ marginBottom: 12, fontSize: 14, color: 'var(--color-c9)' }}>\r\n              Personnalisez l'interface compl├¿te avec des th├¿mes pr├®d├®finis ou des couleurs sur mesure.\r\n            </p>\r\n\r\n            {/* Th├¿mes pr├®d├®finis */}\r\n            <div style={{ marginBottom: 20 }}>\r\n              <label style={{ display: 'block', marginBottom: 8, fontWeight: 600, color: 'var(--color-c10)' }}>\r\n                Source du th├¿me\r\n              </label>\r\n              <div style={{ display: 'flex', gap: 12, alignItems: 'center' }}>\r\n                <label style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer', color: 'var(--color-c10)' }}>\r\n                  <input\r\n                    type=\"radio\"\r\n                    name=\"themeSource\"\r\n                    value=\"cabinet\"\r\n                    checked={themeSource === 'cabinet'}\r\n                    onChange={(e) => setThemeSource(e.target.value)}\r\n                    style={{ margin: 0 }}\r\n                  />\r\n                  <span style={{ fontSize: '14px' }}>Th├¿me du cabinet</span>\r\n                </label>\r\n                <label style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer', color: 'var(--color-c10)' }}>\r\n                  <input\r\n                    type=\"radio\"\r\n                    name=\"themeSource\"\r\n                    value=\"custom\"\r\n                    checked={themeSource === 'custom'}\r\n                    onChange={(e) => setThemeSource(e.target.value)}\r\n                    style={{ margin: 0 }}\r\n                  />\r\n                  <span style={{ fontSize: '14px' }}>Th├¿me personnalis├®</span>\r\n                </label>\r\n              </div>\r\n              {themeSource === 'custom' && (\r\n                <div style={{ marginTop: 12, display: 'flex', gap: 12, alignItems: 'center' }}>\r\n                  <select\r\n                    value={selectedTheme}\r\n                    onChange={(e) => handleThemeSelect(e.target.value)}\r\n                    style={{\r\n                      flex: 1,\r\n                      maxWidth: '300px',\r\n                      padding: '8px 12px',\r\n                      border: '1px solid var(--color-c8)',\r\n                      borderRadius: '6px',\r\n                      fontSize: '14px',\r\n                      backgroundColor: 'var(--color-c7)',\r\n                      cursor: 'pointer',\r\n                      color: 'var(--color-c10)'\r\n                    }}\r\n                  >\r\n                    <option value=\"Personnalis├®\">Personnalis├®</option>\r\n                    {PREDEFINED_THEMES.map((theme) => (\r\n                      <option key={theme.name} value={theme.name}>\r\n                        {theme.name}\r\n                      </option>\r\n                    ))}\r\n                  </select>\r\n                  <button\r\n                    type=\"button\"\r\n                    className=\"chip\"\r\n                    onClick={handleSaveColors}\r\n                    disabled={savingColors || !user || themeSource === 'cabinet'}\r\n                    style={{ opacity: (user && themeSource !== 'cabinet') ? 1 : 0.5 }}\r\n                    title={\r\n                      !user \r\n                        ? 'Utilisateur non connect├®' \r\n                        : themeSource === 'cabinet'\r\n                        ? 'Le th├¿me cabinet est g├®r├® par l\\'administrateur'\r\n                        : ''\r\n                    }\r\n                  >\r\n                    {savingColors ? 'EnregistrementÔÇª' : 'Enregistrer le th├¿me'}\r\n                  </button>\r\n                </div>\r\n              )}\r\n            </div>\r\n\r\n            {saveMessage && (\r\n              <div className=\"settings-success-message\" style={{ \r\n                fontSize: 14, \r\n                marginTop: 12, \r\n                padding: '12px 16px', \r\n                background: saveMessage.includes('Erreur') ? 'var(--color-error-bg)' : 'var(--color-success-bg)', \r\n                border: saveMessage.includes('Erreur') ? '1px solid var(--color-error-border)' : '1px solid var(--color-success-border)', \r\n                borderRadius: 6, \r\n                color: saveMessage.includes('Erreur') ? 'var(--color-error-text)' : 'var(--color-success-text)',\r\n                fontWeight: 500\r\n              }}>\r\n                {saveMessage}\r\n              </div>\r\n            )}\r\n\r\n\r\n            {/* ├ëditeur de couleurs */}\r\n            {themeSource === 'custom' && (\r\n              <>\r\n                <div style={{ marginBottom: 16 }}>\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => setShowAdvancedColors(!showAdvancedColors)}\r\n                    style={{\r\n                      padding: '8px 16px',\r\n                      border: '1px solid var(--color-c8)',\r\n                      borderRadius: '6px',\r\n                      backgroundColor: 'var(--color-c7)',\r\n                      color: 'var(--color-c10)',\r\n                      cursor: 'pointer',\r\n                      fontSize: '14px',\r\n                      display: 'flex',\r\n                      alignItems: 'center',\r\n                      gap: '8px'\r\n                    }}\r\n                  >\r\n                    <span>{showAdvancedColors ? 'Ôû╝' : 'ÔûÂ'}</span>\r\n                    <span>Couleurs avanc├®es</span>\r\n                  </button>\r\n                </div>\r\n                <div\r\n                  style={{\r\n                    display: 'grid',\r\n                    gridTemplateColumns: '1fr',\r\n                    gap: 12,\r\n                    marginBottom: 16,\r\n                  }}\r\n                >\r\n                  {/* Always show color1 */}\r\n                  <div\r\n                    style={{\r\n                      display: 'flex',\r\n                      alignItems: 'center',\r\n                      gap: 8,\r\n                      padding: '8px 12px',\r\n                      borderRadius: 8,\r\n                      background: 'var(--color-c7)',\r\n                      border: '1px solid var(--color-c8)',\r\n                      minWidth: 0,\r\n                    }}\r\n                  >\r\n                    <span style={{ minWidth: 80, fontSize: 13, fontWeight: 500, color: 'var(--color-c10)', flexShrink: 0 }}>Couleur 1</span>\r\n                    \r\n                    <div\r\n                      style={{\r\n                        width: 20,\r\n                        height: 20,\r\n                        borderRadius: '4px',\r\n                        backgroundColor: colorsLegacy.color1,\r\n                        border: '1px solid var(--color-c8)',\r\n                        flexShrink: 0,\r\n                      }}\r\n                    />\r\n\r\n                    <input\r\n                      type=\"color\"\r\n                      value={colorsLegacy.color1}\r\n                      onChange={(e) => handleColorChange('color1', e.target.value)}\r\n                      style={{\r\n                        width: 32,\r\n                        height: 32,\r\n                        border: 'none',\r\n                        borderRadius: '4px',\r\n                        cursor: 'pointer',\r\n                        flexShrink: 0,\r\n                      }}\r\n                    />\r\n\r\n                    <input\r\n                      type=\"text\"\r\n                      value={colorText.color1 || ''}\r\n                      onChange={(e) => handleColorTextChange('color1', e.target.value)}\r\n                      onBlur={() => handleColorTextBlur('color1')}\r\n                      placeholder=\"#RRGGBB\"\r\n                      style={{\r\n                        flex: '1 1 auto',\r\n                        minWidth: 0,\r\n                        maxWidth: '140px',\r\n                        padding: '6px 8px',\r\n                        border: '1px solid var(--color-c8)',\r\n                        borderRadius: '4px',\r\n                        fontSize: '13px',\r\n                        fontFamily: 'monospace',\r\n                        backgroundColor: 'var(--color-c7)',\r\n                        color: 'var(--color-c10)',\r\n                      }}\r\n                    />\r\n                  </div>\r\n\r\n                  {/* Advanced colors */}\r\n                  {showAdvancedColors && COLOR_FIELDS.filter(({ key }) => key !== 'color1').map(({ key, label }) => (\r\n                    <div\r\n                      key={key}\r\n                      style={{\r\n                        display: 'flex',\r\n                        alignItems: 'center',\r\n                        gap: 8,\r\n                        padding: '8px 12px',\r\n                        borderRadius: 8,\r\n                        background: 'var(--color-c7)',\r\n                        border: '1px solid var(--color-c8)',\r\n                        minWidth: 0,\r\n                      }}\r\n                    >\r\n                      <span style={{ minWidth: 80, fontSize: 13, fontWeight: 500, color: 'var(--color-c10)', flexShrink: 0 }}>{label}</span>\r\n                      \r\n                      <div\r\n                        style={{\r\n                          width: 20,\r\n                          height: 20,\r\n                          borderRadius: '4px',\r\n                          backgroundColor: colorsLegacy[key],\r\n                          border: '1px solid var(--color-c8)',\r\n                          flexShrink: 0,\r\n                        }}\r\n                      />\r\n\r\n                      <input\r\n                        type=\"color\"\r\n                        value={colorsLegacy[key]}\r\n                        onChange={(e) => handleColorChange(key, e.target.value)}\r\n                        style={{\r\n                          width: 32,\r\n                          height: 32,\r\n                          border: 'none',\r\n                          borderRadius: '4px',\r\n                          cursor: 'pointer',\r\n                          flexShrink: 0,\r\n                        }}\r\n                      />\r\n\r\n                      <input\r\n                        type=\"text\"\r\n                        value={colorText[key] || ''}\r\n                        onChange={(e) => handleColorTextChange(key, e.target.value)}\r\n                        onBlur={() => handleColorTextBlur(key)}\r\n                        placeholder=\"#RRGGBB\"\r\n                        style={{\r\n                          flex: '1 1 auto',\r\n                          minWidth: 0,\r\n                          maxWidth: '140px',\r\n                          padding: '6px 8px',\r\n                          border: '1px solid var(--color-c8)',\r\n                          borderRadius: '4px',\r\n                          fontSize: '13px',\r\n                          fontFamily: 'monospace',\r\n                          backgroundColor: 'var(--color-c7)',\r\n                          color: 'var(--color-c10)',\r\n                        }}\r\n                      />\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              </>\r\n            )}\r\n\r\n          </div>\r\n        </div>\r\n    </>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pages\\SettingsNav.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pages\\SettingsShell.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pages\\Sous-Settings\\SettingsBaseContrats.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pages\\Sous-Settings\\SettingsComptes.jsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'supabase' is defined but never used.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":18,"suggestions":[{"messageId":"removeVar","data":{"varName":"supabase"},"fix":{"range":[119,128],"text":""},"desc":"Remove unused variable 'supabase'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'DEBUG_COMPTES_REFRESH' and 'fetchUsers'. Either include them or remove the dependency array.","line":71,"column":6,"nodeType":"ArrayExpression","endLine":71,"endColumn":54,"suggestions":[{"desc":"Update the dependencies array to be: [isAdmin, authLoading, location.key, refreshKey, fetchUsers, DEBUG_COMPTES_REFRESH]","fix":{"range":[3227,3275],"text":"[isAdmin, authLoading, location.key, refreshKey, fetchUsers, DEBUG_COMPTES_REFRESH]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useRef, useState } from 'react';\r\nimport { useLocation } from 'react-router-dom';\r\nimport { supabase, DEBUG_AUTH } from '../../supabaseClient';\r\nimport { useUserRole } from '../../auth/useUserRole';\r\nimport { UserInfoBanner } from '../../components/UserInfoBanner';\r\nimport { invokeAdmin } from '../../services/apiAdmin';\r\nimport { uploadLogoWithDedup, getLogoPublicUrl } from '../../utils/logoUpload';\r\nimport './SettingsComptes.css';\r\n\r\nexport default function SettingsComptes() {\r\n  const { isAdmin, isLoading: authLoading } = useUserRole();\r\n  const location = useLocation();\r\n  const [users, setUsers] = useState([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState('');\r\n  const [showReportModal, setShowReportModal] = useState(false);\r\n  const [selectedReport, setSelectedReport] = useState(null);\r\n  const [userReports, setUserReports] = useState([]);\r\n  const [selectedReportUser, setSelectedReportUser] = useState(null);\r\n  const [reportLoading, setReportLoading] = useState(false);\r\n  const [actionLoading, setActionLoading] = useState(false);\r\n  const [refreshKey, setRefreshKey] = useState(0);\r\n  const fetchUsersRequestIdRef = useRef(0);\r\n  const DEBUG_COMPTES_REFRESH = false;\r\n\r\n  // V2: Cabinets & Themes state\r\n  const [cabinets, setCabinets] = useState([]);\r\n  const [themes, setThemes] = useState([]);\r\n  const [cabinetsLoading, setCabinetsLoading] = useState(false);\r\n  const [themesLoading, setThemesLoading] = useState(false);\r\n  \r\n  // Cabinet Modal state\r\n  const [showCabinetModal, setShowCabinetModal] = useState(false);\r\n  const [editingCabinet, setEditingCabinet] = useState(null);\r\n  const [cabinetForm, setCabinetForm] = useState({ name: '', default_theme_id: '', logo_id: '' });\r\n  const [cabinetSaving, setCabinetSaving] = useState(false);\r\n  const [logoFile, setLogoFile] = useState(null);\r\n  const [logoPreview, setLogoPreview] = useState(null);\r\n  const [logoUploading, setLogoUploading] = useState(false);\r\n  \r\n  // Theme Modal state\r\n  const [showThemeModal, setShowThemeModal] = useState(false);\r\n  const [editingTheme, setEditingTheme] = useState(null);\r\n  const [themeForm, setThemeForm] = useState({ name: '', palette: {} });\r\n  const [themeSaving, setThemeSaving] = useState(false);\r\n  \r\n  // User Modal state\r\n  const [showUserModal, setShowUserModal] = useState(false);\r\n  const [userModalEmail, setUserModalEmail] = useState('');\r\n  const [userModalCabinetId, setUserModalCabinetId] = useState('');\r\n  const [userModalError, setUserModalError] = useState('');\r\n  const [userModalSuccess, setUserModalSuccess] = useState('');\r\n\r\n  const DEFAULT_PALETTE = {\r\n    c1: '#2B3E37', c2: '#709B8B', c3: '#9FBDB2', c4: '#CFDED8', c5: '#788781',\r\n    c6: '#CEC1B6', c7: '#F5F3F0', c8: '#D9D9D9', c9: '#7F7F7F', c10: '#000000'\r\n  };\r\n\r\n  useEffect(() => {\r\n    if (authLoading) {\r\n      if (DEBUG_AUTH || DEBUG_COMPTES_REFRESH) console.log('[SettingsComptes] authLoading ÔåÆ wait');\r\n      return;\r\n    }\r\n    if (!isAdmin) {\r\n      if (DEBUG_AUTH || DEBUG_COMPTES_REFRESH) console.log('[SettingsComptes] not admin ÔåÆ skip fetch');\r\n      return;\r\n    }\r\n    fetchUsers('effect');\r\n    fetchCabinets();\r\n    fetchThemes();\r\n  }, [isAdmin, authLoading, location.key, refreshKey]);\r\n\r\n  const triggerRefresh = (reason = '') => {\r\n    if (DEBUG_COMPTES_REFRESH) {\r\n      console.log('[SettingsComptes] triggerRefresh', reason);\r\n    }\r\n    setRefreshKey((k) => k + 1);\r\n  };\r\n\r\n  const fetchUsers = async (reason = '') => {\r\n    const requestId = ++fetchUsersRequestIdRef.current;\r\n    try {\r\n      setLoading(true);\r\n      setError('');\r\n\r\n      if (DEBUG_COMPTES_REFRESH) {\r\n        console.log('[SettingsComptes] fetchUsers:start', { reason, requestId });\r\n      }\r\n\r\n      const { data, error: invokeError } = await invokeAdmin('list_users');\r\n\r\n      if (requestId !== fetchUsersRequestIdRef.current) return;\r\n\r\n      if (invokeError) throw new Error(invokeError.message);\r\n      setUsers(data.users || []);\r\n\r\n      if (DEBUG_COMPTES_REFRESH) {\r\n        console.log('[SettingsComptes] fetchUsers:success', {\r\n          reason,\r\n          requestId,\r\n          usersCount: (data.users || []).length,\r\n        });\r\n      }\r\n\r\n    } catch (err) {\r\n      if (requestId === fetchUsersRequestIdRef.current) {\r\n        setError(err.message);\r\n      }\r\n    } finally {\r\n      if (requestId === fetchUsersRequestIdRef.current) {\r\n        setLoading(false);\r\n      }\r\n    }\r\n  };\r\n\r\n  // V2: Fetch cabinets\r\n  const fetchCabinets = async () => {\r\n    try {\r\n      setCabinetsLoading(true);\r\n      const { data, error: invokeError } = await invokeAdmin('list_cabinets');\r\n      if (invokeError) throw new Error(invokeError.message);\r\n      setCabinets(data?.cabinets || []);\r\n    } catch (err) {\r\n      console.error('[SettingsComptes] fetchCabinets error:', err);\r\n    } finally {\r\n      setCabinetsLoading(false);\r\n    }\r\n  };\r\n\r\n  // V2: Fetch themes\r\n  const fetchThemes = async () => {\r\n    try {\r\n      setThemesLoading(true);\r\n      const { data, error: invokeError } = await invokeAdmin('list_themes');\r\n      if (invokeError) throw new Error(invokeError.message);\r\n      setThemes(data?.themes || []);\r\n    } catch (err) {\r\n      console.error('[SettingsComptes] fetchThemes error:', err);\r\n    } finally {\r\n      setThemesLoading(false);\r\n    }\r\n  };\r\n\r\n  // V2: Cabinet Modal handlers\r\n  const openCabinetModal = (cabinet = null) => {\r\n    setEditingCabinet(cabinet);\r\n    if (cabinet) {\r\n      setCabinetForm({\r\n        name: cabinet.name || '',\r\n        default_theme_id: cabinet.default_theme_id || '',\r\n        logo_id: cabinet.logo_id || ''\r\n      });\r\n      if (cabinet.logos?.storage_path) {\r\n        setLogoPreview(getLogoPublicUrl(cabinet.logos.storage_path));\r\n      } else {\r\n        setLogoPreview(null);\r\n      }\r\n    } else {\r\n      setCabinetForm({ name: '', default_theme_id: '', logo_id: '' });\r\n      setLogoPreview(null);\r\n    }\r\n    setLogoFile(null);\r\n    setShowCabinetModal(true);\r\n  };\r\n\r\n  const closeCabinetModal = () => {\r\n    setShowCabinetModal(false);\r\n    setEditingCabinet(null);\r\n    setCabinetForm({ name: '', default_theme_id: '', logo_id: '' });\r\n    setLogoFile(null);\r\n    setLogoPreview(null);\r\n  };\r\n\r\n  const handleLogoFileChange = (e) => {\r\n    const file = e.target.files?.[0];\r\n    if (!file) return;\r\n    if (!file.type.startsWith('image/')) {\r\n      setError('Veuillez s├®lectionner une image (jpg ou png).');\r\n      return;\r\n    }\r\n    setLogoFile(file);\r\n    setLogoPreview(URL.createObjectURL(file));\r\n  };\r\n\r\n  const handleSaveCabinet = async () => {\r\n    if (!cabinetForm.name.trim()) {\r\n      setError('Le nom du cabinet est requis.');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      setCabinetSaving(true);\r\n      setError('');\r\n\r\n      let logoId = cabinetForm.logo_id;\r\n\r\n      // Upload logo if new file selected\r\n      if (logoFile && editingCabinet?.id) {\r\n        setLogoUploading(true);\r\n        const result = await uploadLogoWithDedup(logoFile, editingCabinet.id);\r\n        setLogoUploading(false);\r\n        \r\n        if (result.error) {\r\n          setError(`Logo upload failed: ${result.error}`);\r\n          setCabinetSaving(false);\r\n          return;\r\n        }\r\n        logoId = result.logo_id;\r\n      }\r\n\r\n      if (editingCabinet) {\r\n        // Update existing cabinet\r\n        const { error: invokeError } = await invokeAdmin('update_cabinet', {\r\n          id: editingCabinet.id,\r\n          name: cabinetForm.name.trim(),\r\n          default_theme_id: cabinetForm.default_theme_id || null,\r\n          logo_id: logoId || null\r\n        });\r\n        if (invokeError) throw new Error(invokeError.message);\r\n      } else {\r\n        // Create new cabinet\r\n        const { data, error: invokeError } = await invokeAdmin('create_cabinet', {\r\n          name: cabinetForm.name.trim(),\r\n          default_theme_id: cabinetForm.default_theme_id || null\r\n        });\r\n        if (invokeError) throw new Error(invokeError.message);\r\n        \r\n        // If logo was selected, upload it now (need cabinet ID)\r\n        if (logoFile && data?.cabinet?.id) {\r\n          setLogoUploading(true);\r\n          const result = await uploadLogoWithDedup(logoFile, data.cabinet.id);\r\n          setLogoUploading(false);\r\n          \r\n          if (!result.error && result.logo_id) {\r\n            await invokeAdmin('assign_cabinet_logo', {\r\n              cabinet_id: data.cabinet.id,\r\n              logo_id: result.logo_id\r\n            });\r\n          }\r\n        }\r\n      }\r\n\r\n      closeCabinetModal();\r\n      fetchCabinets();\r\n    } catch (err) {\r\n      setError(err.message);\r\n    } finally {\r\n      setCabinetSaving(false);\r\n      setLogoUploading(false);\r\n    }\r\n  };\r\n\r\n  const handleDeleteCabinet = async (cabinet) => {\r\n    if (!confirm(`Supprimer le cabinet \"${cabinet.name}\" ?`)) return;\r\n    try {\r\n      setActionLoading(true);\r\n      const { error: invokeError } = await invokeAdmin('delete_cabinet', { id: cabinet.id });\r\n      if (invokeError) throw new Error(invokeError.message);\r\n      fetchCabinets();\r\n    } catch (err) {\r\n      setError(err.message);\r\n    } finally {\r\n      setActionLoading(false);\r\n    }\r\n  };\r\n\r\n  // V2: Theme Modal handlers\r\n  const openThemeModal = (theme = null) => {\r\n    setEditingTheme(theme);\r\n    if (theme) {\r\n      setThemeForm({\r\n        name: theme.name || '',\r\n        palette: theme.palette || { ...DEFAULT_PALETTE }\r\n      });\r\n    } else {\r\n      setThemeForm({ name: '', palette: { ...DEFAULT_PALETTE } });\r\n    }\r\n    setShowThemeModal(true);\r\n  };\r\n\r\n  const closeThemeModal = () => {\r\n    setShowThemeModal(false);\r\n    setEditingTheme(null);\r\n    setThemeForm({ name: '', palette: {} });\r\n  };\r\n\r\n  const handleThemePaletteChange = (colorKey, value) => {\r\n    setThemeForm(prev => ({\r\n      ...prev,\r\n      palette: { ...prev.palette, [colorKey]: value }\r\n    }));\r\n  };\r\n\r\n  const handleSaveTheme = async () => {\r\n    if (!themeForm.name.trim()) {\r\n      setError('Le nom du th├¿me est requis.');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      setThemeSaving(true);\r\n      setError('');\r\n\r\n      if (editingTheme) {\r\n        if (editingTheme.is_system) {\r\n          setError('Les th├¿mes syst├¿me ne peuvent pas ├¬tre modifi├®s.');\r\n          setThemeSaving(false);\r\n          return;\r\n        }\r\n        const { error: invokeError } = await invokeAdmin('update_theme', {\r\n          id: editingTheme.id,\r\n          name: themeForm.name.trim(),\r\n          palette: themeForm.palette\r\n        });\r\n        if (invokeError) throw new Error(invokeError.message);\r\n      } else {\r\n        const { error: invokeError } = await invokeAdmin('create_theme', {\r\n          name: themeForm.name.trim(),\r\n          palette: themeForm.palette\r\n        });\r\n        if (invokeError) throw new Error(invokeError.message);\r\n      }\r\n\r\n      closeThemeModal();\r\n      fetchThemes();\r\n    } catch (err) {\r\n      setError(err.message);\r\n    } finally {\r\n      setThemeSaving(false);\r\n    }\r\n  };\r\n\r\n  const handleDeleteTheme = async (theme) => {\r\n    if (theme.is_system) {\r\n      setError('Les th├¿mes syst├¿me ne peuvent pas ├¬tre supprim├®s.');\r\n      return;\r\n    }\r\n    if (!confirm(`Supprimer le th├¿me \"${theme.name}\" ?`)) return;\r\n    try {\r\n      setActionLoading(true);\r\n      const { error: invokeError } = await invokeAdmin('delete_theme', { id: theme.id });\r\n      if (invokeError) throw new Error(invokeError.message);\r\n      fetchThemes();\r\n    } catch (err) {\r\n      setError(err.message);\r\n    } finally {\r\n      setActionLoading(false);\r\n    }\r\n  };\r\n\r\n  // V2: Assign user to cabinet\r\n  const handleAssignUserCabinet = async (userId, cabinetId) => {\r\n    try {\r\n      setActionLoading(true);\r\n      const { error: invokeError } = await invokeAdmin('assign_user_cabinet', {\r\n        user_id: userId,\r\n        cabinet_id: cabinetId || null\r\n      });\r\n      if (invokeError) throw new Error(invokeError.message);\r\n      triggerRefresh('assign_user_cabinet');\r\n    } catch (err) {\r\n      setError(err.message);\r\n    } finally {\r\n      setActionLoading(false);\r\n    }\r\n  };\r\n\r\n  const closeUserModal = () => {\r\n    setShowUserModal(false);\r\n    setUserModalEmail('');\r\n    setUserModalCabinetId('');\r\n    setUserModalError('');\r\n    setUserModalSuccess('');\r\n  };\r\n\r\n  const handleInviteUser = async () => {\r\n    if (!userModalEmail.trim()) {\r\n      setUserModalError('L\\'email est requis.');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      setActionLoading(true);\r\n      setUserModalError('');\r\n      setUserModalSuccess('');\r\n\r\n      const payload = { email: userModalEmail.trim() };\r\n      if (userModalCabinetId) {\r\n        payload.cabinet_id = userModalCabinetId;\r\n      }\r\n\r\n      const { error: invokeError } = await invokeAdmin('create_user_invite', payload);\r\n\r\n      if (invokeError) throw new Error(invokeError.message);\r\n      \r\n      setUserModalSuccess('Invitation envoy├®e avec succ├¿s !');\r\n      closeUserModal();\r\n      triggerRefresh('create_user_invite');\r\n    } catch (err) {\r\n      setUserModalError(err.message);\r\n    } finally {\r\n      setActionLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleDeleteUser = async (userId, email) => {\r\n    if (!confirm(`Supprimer l'utilisateur ${email} ?`)) return;\r\n\r\n    try {\r\n      setActionLoading(true);\r\n      const { error: invokeError } = await invokeAdmin('delete_user', { userId });\r\n\r\n      if (invokeError) throw new Error(invokeError.message);\r\n      triggerRefresh('delete_user');\r\n    } catch (err) {\r\n      setError(err.message);\r\n    } finally {\r\n      setActionLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleResetPassword = async (userId, email) => {\r\n    try {\r\n      setActionLoading(true);\r\n      const { error: invokeError } = await invokeAdmin('reset_password', { \r\n        userId, \r\n        email \r\n      });\r\n\r\n      if (invokeError) throw new Error(invokeError.message);\r\n      alert('Email de r├®initialisation envoy├®');\r\n    } catch (err) {\r\n      setError(err.message);\r\n    } finally {\r\n      setActionLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleViewReports = async (userId, userEmail) => {\r\n    try {\r\n      setReportLoading(true);\r\n      setSelectedReportUser({ id: userId, email: userEmail });\r\n      setSelectedReport(null);\r\n      setUserReports([]);\r\n      setShowReportModal(true);\r\n\r\n      const { data, error: invokeError } = await invokeAdmin('list_issue_reports', { user_id: userId });\r\n\r\n      if (invokeError) throw new Error(invokeError.message);\r\n      \r\n      // G├®rer les deux formats de r├®ponse possibles\r\n      const reports = data?.reports || data?.data?.reports || [];\r\n      setUserReports(Array.isArray(reports) ? reports : []);\r\n    } catch (err) {\r\n      setError(err.message);\r\n    } finally {\r\n      setReportLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleSelectReport = (report) => {\r\n    setSelectedReport(report);\r\n  };\r\n\r\n  const handleBackToList = () => {\r\n    setSelectedReport(null);\r\n  };\r\n\r\n  const handleCloseModal = () => {\r\n    setShowReportModal(false);\r\n    setSelectedReport(null);\r\n    setUserReports([]);\r\n    setSelectedReportUser(null);\r\n  };\r\n\r\n  const handleMarkAsRead = async (reportId) => {\r\n    try {\r\n      const { error: invokeError } = await invokeAdmin('mark_issue_read', { reportId });\r\n\r\n      if (invokeError) throw new Error(invokeError.message);\r\n      \r\n      triggerRefresh('mark_issue_read');\r\n      // Rafra├«chir la liste des signalements\r\n      if (selectedReportUser) {\r\n        handleViewReports(selectedReportUser.id, selectedReportUser.email);\r\n      }\r\n    } catch (err) {\r\n      setError(err.message);\r\n    }\r\n  };\r\n\r\n  const handleDeleteReport = async (reportId) => {\r\n    if (!confirm('Supprimer d├®finitivement ce signalement ?')) return;\r\n\r\n    try {\r\n      const { error: invokeError } = await invokeAdmin('delete_issue', { reportId });\r\n\r\n      if (invokeError) throw new Error(invokeError.message);\r\n      \r\n      setSelectedReport(null);\r\n      triggerRefresh('delete_issue');\r\n      // Rafra├«chir la liste des signalements\r\n      if (selectedReportUser) {\r\n        handleViewReports(selectedReportUser.id, selectedReportUser.email);\r\n      }\r\n    } catch (err) {\r\n      setError(err.message);\r\n    }\r\n  };\r\n\r\n  const handleDeleteAllReports = async (userId) => {\r\n    if (!confirm('Supprimer tout l\\'historique des signalements pour cet utilisateur ?')) return;\r\n\r\n    try {\r\n      const { error: invokeError } = await invokeAdmin('delete_all_issues_for_user', { userId });\r\n\r\n      if (invokeError) throw new Error(invokeError.message);\r\n      \r\n      handleCloseModal();\r\n      triggerRefresh('delete_all_issues_for_user');\r\n    } catch (err) {\r\n      setError(err.message);\r\n    }\r\n  };\r\n\r\n  if (!isAdmin) {\r\n    return (\r\n      <div style={{ marginTop: 16 }}>\r\n        <p>Vous n'avez pas les droits administrateurs pour acc├®der ├á cette page.</p>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (authLoading) {\r\n    return (\r\n      <div style={{ marginTop: 16 }}>\r\n        <p>Chargement de l'authentification...</p>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"settings-comptes\" style={{ marginTop: 16 }}>\r\n      {/* Bandeau utilisateur */}\r\n      <UserInfoBanner />\r\n\r\n      {error && <div className=\"alert error\">{error}</div>}\r\n      \r\n      {loading ? (\r\n        <p>Chargement...</p>\r\n      ) : (\r\n        <div className=\"admin-content\">\r\n            {/* V2: Section Cabinets */}\r\n            <div className=\"admin-section\">\r\n              <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 16 }}>\r\n                <h3>Cabinets ({cabinets.length})</h3>\r\n                <button \r\n                  className=\"chip\"\r\n                  onClick={() => openCabinetModal()}\r\n                  disabled={cabinetsLoading}\r\n                  style={{ padding: '8px 16px', fontWeight: 600 }}\r\n                >\r\n                  + Nouveau cabinet\r\n                </button>\r\n              </div>\r\n              {cabinetsLoading ? (\r\n                <p>Chargement des cabinets...</p>\r\n              ) : cabinets.length === 0 ? (\r\n                <p style={{ color: 'var(--color-c9)', fontSize: 14 }}>Aucun cabinet cr├®├®.</p>\r\n              ) : (\r\n                <div className=\"admin-cards-grid\">\r\n                  {cabinets.map(cabinet => (\r\n                    <div key={cabinet.id} className=\"admin-card-compact\">\r\n                      <div className=\"admin-card-compact__info\">\r\n                        <div className=\"admin-card-compact__name\">{cabinet.name}</div>\r\n                        <div className=\"admin-card-compact__meta\">\r\n                          {cabinet.themes?.name || 'Aucun th├¿me'}\r\n                        </div>\r\n                      </div>\r\n                      <div className=\"admin-card-compact__actions\">\r\n                        <button \r\n                          className=\"icon-btn\" \r\n                          onClick={() => openCabinetModal(cabinet)}\r\n                          title=\"Modifier\"\r\n                          aria-label=\"Modifier le cabinet\"\r\n                        >\r\n                          <svg viewBox=\"0 0 24 24\" width=\"18\" height=\"18\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" aria-hidden=\"true\">\r\n                            <path d=\"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\" />\r\n                            <path d=\"M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\" />\r\n                          </svg>\r\n                        </button>\r\n                        <button \r\n                          className=\"icon-btn danger\" \r\n                          onClick={() => handleDeleteCabinet(cabinet)}\r\n                          title=\"Supprimer\"\r\n                          aria-label=\"Supprimer le cabinet\"\r\n                        >\r\n                          <svg viewBox=\"0 0 24 24\" width=\"18\" height=\"18\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" aria-hidden=\"true\">\r\n                            <polyline points=\"3 6 5 6 21 6\" />\r\n                            <path d=\"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2\" />\r\n                          </svg>\r\n                        </button>\r\n                      </div>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              )}\r\n            </div>\r\n\r\n            {/* V2: Section Th├¿mes */}\r\n            <div className=\"admin-section\" style={{ marginTop: 24 }}>\r\n              <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 16 }}>\r\n                <h3>Th├¿mes globaux ({themes.length})</h3>\r\n                <button \r\n                  className=\"chip\"\r\n                  onClick={() => openThemeModal()}\r\n                  disabled={themesLoading}\r\n                  style={{ padding: '8px 16px', fontWeight: 600 }}\r\n                >\r\n                  + Nouveau th├¿me\r\n                </button>\r\n              </div>\r\n              {themesLoading ? (\r\n                <p>Chargement des th├¿mes...</p>\r\n              ) : themes.length === 0 ? (\r\n                <p style={{ color: 'var(--color-c9)', fontSize: 14 }}>Aucun th├¿me cr├®├®.</p>\r\n              ) : (\r\n                <div className=\"admin-cards-grid\">\r\n                  {themes.map(theme => (\r\n                    <div key={theme.id} className=\"admin-card-compact\">\r\n                      <div className=\"admin-card-compact__info\">\r\n                        <div className=\"admin-card-compact__name\" style={{ display: 'flex', alignItems: 'center', gap: 6 }}>\r\n                          {theme.name}\r\n                          {theme.is_system && (\r\n                            <span style={{ \r\n                              fontSize: 9, \r\n                              padding: '1px 4px', \r\n                              background: 'var(--color-c2)', \r\n                              color: 'white', \r\n                              borderRadius: 3,\r\n                              fontWeight: 600\r\n                            }}>SYS</span>\r\n                          )}\r\n                        </div>\r\n                        <div className=\"admin-card-compact__palette\">\r\n                          {theme.palette && Object.entries(theme.palette).slice(0, 6).map(([key, color]) => (\r\n                            <div \r\n                              key={key}\r\n                              className=\"admin-card-compact__palette-color\"\r\n                              style={{ backgroundColor: color }}\r\n                              title={`${key}: ${color}`}\r\n                            />\r\n                          ))}\r\n                        </div>\r\n                      </div>\r\n                      {!theme.is_system && (\r\n                        <div className=\"admin-card-compact__actions\">\r\n                          <button \r\n                            className=\"icon-btn\" \r\n                            onClick={() => openThemeModal(theme)}\r\n                            title=\"Modifier\"\r\n                            aria-label=\"Modifier le th├¿me\"\r\n                          >\r\n                            <svg viewBox=\"0 0 24 24\" width=\"18\" height=\"18\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" aria-hidden=\"true\">\r\n                              <path d=\"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\" />\r\n                              <path d=\"M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\" />\r\n                            </svg>\r\n                          </button>\r\n                          <button \r\n                            className=\"icon-btn danger\" \r\n                            onClick={() => handleDeleteTheme(theme)}\r\n                            title=\"Supprimer\"\r\n                            aria-label=\"Supprimer le th├¿me\"\r\n                          >\r\n                            <svg viewBox=\"0 0 24 24\" width=\"18\" height=\"18\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" aria-hidden=\"true\">\r\n                              <polyline points=\"3 6 5 6 21 6\" />\r\n                              <path d=\"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2\" />\r\n                            </svg>\r\n                          </button>\r\n                        </div>\r\n                      )}\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              )}\r\n            </div>\r\n\r\n\r\n            {/* Liste des utilisateurs */}\r\n            <div className=\"admin-section\" style={{ marginTop: 24 }}>\r\n              <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>\r\n                <h3>Utilisateurs ({users.length})</h3>\r\n                <div style={{ display: 'flex', gap: 12, alignItems: 'center' }}>\r\n                  <button \r\n                    className=\"chip\"\r\n                    onClick={() => setShowUserModal(true)}\r\n                    disabled={actionLoading}\r\n                    style={{ padding: '8px 16px', fontWeight: 600 }}\r\n                  >\r\n                    + Nouvel utilisateur\r\n                  </button>\r\n                  <button onClick={() => triggerRefresh('manual')} disabled={actionLoading} style={{ fontSize: 12, padding: '6px 10px' }}>\r\n                    Rafra├«chir\r\n                  </button>\r\n                </div>\r\n              </div>\r\n              <div className=\"users-table\">\r\n                <table>\r\n                  <thead>\r\n                    <tr>\r\n                      <th>Email</th>\r\n                      <th>R├┤le</th>\r\n                      <th>Cabinet</th>\r\n                      <th>Cr├®├® le</th>\r\n                      <th>Derni├¿re connexion</th>\r\n                      <th>Signalements</th>\r\n                      <th>Actions</th>\r\n                    </tr>\r\n                  </thead>\r\n                  <tbody>\r\n                    {users.map((user) => (\r\n                      <tr key={user.id}>\r\n                        <td>{user.email}</td>\r\n                        <td>\r\n                          <span className={`role-badge ${user.role}`}>\r\n                            {user.role}\r\n                          </span>\r\n                        </td>\r\n                        <td>\r\n                          <select\r\n                            value={user.cabinet_id || ''}\r\n                            onChange={(e) => handleAssignUserCabinet(user.id, e.target.value)}\r\n                            disabled={actionLoading}\r\n                            style={{\r\n                              padding: '6px 10px',\r\n                              border: '1px solid var(--color-c8)',\r\n                              borderRadius: 4,\r\n                              fontSize: 12,\r\n                              backgroundColor: 'var(--color-c7)',\r\n                              cursor: 'pointer',\r\n                              minWidth: 120\r\n                            }}\r\n                          >\r\n                            <option value=\"\">ÔÇö Aucun ÔÇö</option>\r\n                            {cabinets.map(cab => (\r\n                              <option key={cab.id} value={cab.id}>{cab.name}</option>\r\n                            ))}\r\n                          </select>\r\n                        </td>\r\n                        <td>{new Date(user.created_at).toLocaleDateString('fr-FR')}</td>\r\n                        <td>\r\n                          {user.last_sign_in_at \r\n                            ? new Date(user.last_sign_in_at).toLocaleDateString('fr-FR')\r\n                            : 'Jamais'\r\n                          }\r\n                        </td>\r\n                        <td>\r\n                          {user.total_reports > 0 ? (\r\n                            <div \r\n                              className=\"report-badge-container\"\r\n                              onClick={() => handleViewReports(user.id, user.email)}\r\n                            >\r\n                              <span className={`report-badge ${user.unread_reports > 0 ? 'has-unread' : 'all-read'}`}>\r\n                                {user.total_reports}\r\n                              </span>\r\n                              {user.unread_reports > 0 && (\r\n                                <span className=\"unread-indicator\">\r\n                                  {user.unread_reports} non lu{user.unread_reports > 1 ? 's' : ''}\r\n                                </span>\r\n                              )}\r\n                            </div>\r\n                          ) : (\r\n                            <span className=\"no-reports\">ÔÇö</span>\r\n                          )}\r\n                        </td>\r\n                        <td className=\"actionsCell\">\r\n                          <div className=\"actionsContainer\">\r\n                            <button \r\n                              onClick={() => handleResetPassword(user.id, user.email)}\r\n                              title=\"Envoyer un email de r├®initialisation\"\r\n                              aria-label=\"Envoyer un email de r├®initialisation\"\r\n                            >\r\n                              R├®init.\r\n                            </button>\r\n                            {user.role !== 'admin' && (\r\n                              <button \r\n                                onClick={() => handleDeleteUser(user.id, user.email)}\r\n                                className=\"danger\"\r\n                                title=\"Supprimer l'utilisateur\"\r\n                                aria-label=\"Supprimer l'utilisateur\"\r\n                              >\r\n                                Suppr.\r\n                              </button>\r\n                            )}\r\n                          </div>\r\n                        </td>\r\n                      </tr>\r\n                    ))}\r\n                  </tbody>\r\n                </table>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* V2: Modal Cabinet */}\r\n        {showCabinetModal && (\r\n          <div className=\"report-modal-overlay\" onClick={closeCabinetModal}>\r\n            <div className=\"report-modal\" onClick={(e) => e.stopPropagation()} style={{ maxWidth: 500 }}>\r\n              <div className=\"report-modal-header\">\r\n                <h3>{editingCabinet ? 'Modifier le cabinet' : 'Nouveau cabinet'}</h3>\r\n                <button className=\"report-modal-close\" onClick={closeCabinetModal}>Ô£ò</button>\r\n              </div>\r\n              <div className=\"report-modal-content\">\r\n                <div style={{ marginBottom: 16 }}>\r\n                  <label style={{ display: 'block', marginBottom: 6, fontWeight: 600, fontSize: 14 }}>Nom du cabinet *</label>\r\n                  <input\r\n                    type=\"text\"\r\n                    value={cabinetForm.name}\r\n                    onChange={(e) => setCabinetForm(prev => ({ ...prev, name: e.target.value }))}\r\n                    placeholder=\"Ex: Cabinet Dupont\"\r\n                    style={{\r\n                      width: '100%',\r\n                      padding: '10px 12px',\r\n                      border: '1px solid var(--color-c8)',\r\n                      borderRadius: 6,\r\n                      fontSize: 14\r\n                    }}\r\n                  />\r\n                </div>\r\n                <div style={{ marginBottom: 16 }}>\r\n                  <label style={{ display: 'block', marginBottom: 6, fontWeight: 600, fontSize: 14 }}>Th├¿me par d├®faut</label>\r\n                  <select\r\n                    value={cabinetForm.default_theme_id}\r\n                    onChange={(e) => setCabinetForm(prev => ({ ...prev, default_theme_id: e.target.value }))}\r\n                    style={{\r\n                      width: '100%',\r\n                      padding: '10px 12px',\r\n                      border: '1px solid var(--color-c8)',\r\n                      borderRadius: 6,\r\n                      fontSize: 14,\r\n                      backgroundColor: 'var(--color-c7)'\r\n                    }}\r\n                  >\r\n                    <option value=\"\">ÔÇö Aucun th├¿me ÔÇö</option>\r\n                    {themes.map(theme => (\r\n                      <option key={theme.id} value={theme.id}>{theme.name}</option>\r\n                    ))}\r\n                  </select>\r\n                </div>\r\n                <div style={{ marginBottom: 16 }}>\r\n                  <label style={{ display: 'block', marginBottom: 6, fontWeight: 600, fontSize: 14 }}>Logo du cabinet</label>\r\n                  <input\r\n                    type=\"file\"\r\n                    accept=\"image/png,image/jpeg\"\r\n                    onChange={handleLogoFileChange}\r\n                    style={{ marginBottom: 8 }}\r\n                  />\r\n                  {logoPreview && (\r\n                    <div style={{ marginTop: 8, display: 'flex', alignItems: 'center', gap: 12 }}>\r\n                      <img \r\n                        src={logoPreview} \r\n                        alt=\"Aper├ºu logo\" \r\n                        style={{ maxWidth: 150, maxHeight: 80, objectFit: 'contain', borderRadius: 4, border: '1px solid var(--color-c8)' }}\r\n                      />\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => {\r\n                          setLogoPreview(null);\r\n                          setLogoFile(null);\r\n                          setCabinetForm(prev => ({ ...prev, logo_id: '' }));\r\n                        }}\r\n                        style={{\r\n                          padding: '6px 12px',\r\n                          fontSize: 12,\r\n                          background: 'transparent',\r\n                          border: '1px solid var(--color-c8)',\r\n                          borderRadius: 6,\r\n                          color: 'var(--color-c9)',\r\n                          cursor: 'pointer'\r\n                        }}\r\n                        title=\"Supprimer le logo\"\r\n                      >\r\n                        ­ƒùæ´©Å Supprimer\r\n                      </button>\r\n                    </div>\r\n                  )}\r\n                  {logoUploading && <p style={{ fontSize: 13, color: 'var(--color-c9)' }}>Upload en cours...</p>}\r\n                </div>\r\n              </div>\r\n              <div className=\"report-modal-actions\">\r\n                <button onClick={closeCabinetModal}>Annuler</button>\r\n                <button \r\n                  className=\"chip\"\r\n                  onClick={handleSaveCabinet}\r\n                  disabled={cabinetSaving || logoUploading}\r\n                  style={{ opacity: cabinetSaving ? 0.6 : 1 }}\r\n                >\r\n                  {cabinetSaving ? 'Enregistrement...' : 'Enregistrer'}\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* V2: Modal Th├¿me */}\r\n        {showThemeModal && (\r\n          <div className=\"report-modal-overlay\" onClick={closeThemeModal}>\r\n            <div className=\"report-modal\" onClick={(e) => e.stopPropagation()} style={{ maxWidth: 600 }}>\r\n              <div className=\"report-modal-header\">\r\n                <h3>{editingTheme ? 'Modifier le th├¿me' : 'Nouveau th├¿me'}</h3>\r\n                <button className=\"report-modal-close\" onClick={closeThemeModal}>Ô£ò</button>\r\n              </div>\r\n              <div className=\"report-modal-content\">\r\n                {editingTheme?.is_system && (\r\n                  <div style={{ \r\n                    padding: 12, \r\n                    marginBottom: 16, \r\n                    background: 'var(--color-c4)', \r\n                    borderRadius: 6, \r\n                    fontSize: 13 \r\n                  }}>\r\n                    Les th├¿mes syst├¿me ne peuvent pas ├¬tre modifi├®s.\r\n                  </div>\r\n                )}\r\n                <div style={{ marginBottom: 16 }}>\r\n                  <label style={{ display: 'block', marginBottom: 6, fontWeight: 600, fontSize: 14 }}>Nom du th├¿me *</label>\r\n                  <input\r\n                    type=\"text\"\r\n                    value={themeForm.name}\r\n                    onChange={(e) => setThemeForm(prev => ({ ...prev, name: e.target.value }))}\r\n                    placeholder=\"Ex: Bleu patrimonial\"\r\n                    disabled={editingTheme?.is_system}\r\n                    style={{\r\n                      width: '100%',\r\n                      padding: '10px 12px',\r\n                      border: '1px solid var(--color-c8)',\r\n                      borderRadius: 6,\r\n                      fontSize: 14\r\n                    }}\r\n                  />\r\n                </div>\r\n                <div style={{ marginBottom: 16 }}>\r\n                  <label style={{ display: 'block', marginBottom: 6, fontWeight: 600, fontSize: 14 }}>Palette (10 couleurs)</label>\r\n                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: 8 }}>\r\n                    {['c1', 'c2', 'c3', 'c4', 'c5', 'c6', 'c7', 'c8', 'c9', 'c10'].map(colorKey => (\r\n                      <div key={colorKey} style={{ display: 'flex', flexDirection: 'column', alignItems: 'center' }}>\r\n                        <span style={{ fontSize: 11, color: 'var(--color-c9)', marginBottom: 4 }}>{colorKey.toUpperCase()}</span>\r\n                        <input\r\n                          type=\"color\"\r\n                          value={themeForm.palette?.[colorKey] || DEFAULT_PALETTE[colorKey]}\r\n                          onChange={(e) => handleThemePaletteChange(colorKey, e.target.value)}\r\n                          disabled={editingTheme?.is_system}\r\n                          style={{ width: 40, height: 32, border: 'none', cursor: 'pointer' }}\r\n                        />\r\n                        <input\r\n                          type=\"text\"\r\n                          value={themeForm.palette?.[colorKey] || DEFAULT_PALETTE[colorKey]}\r\n                          onChange={(e) => handleThemePaletteChange(colorKey, e.target.value)}\r\n                          disabled={editingTheme?.is_system}\r\n                          style={{\r\n                            width: '100%',\r\n                            padding: '4px',\r\n                            border: '1px solid var(--color-c8)',\r\n                            borderRadius: 4,\r\n                            fontSize: 10,\r\n                            fontFamily: 'monospace',\r\n                            textAlign: 'center',\r\n                            marginTop: 4\r\n                          }}\r\n                        />\r\n                      </div>\r\n                    ))}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n              <div className=\"report-modal-actions\">\r\n                <button onClick={closeThemeModal}>Annuler</button>\r\n                {!editingTheme?.is_system && (\r\n                  <button \r\n                    className=\"chip\"\r\n                    onClick={handleSaveTheme}\r\n                    disabled={themeSaving}\r\n                    style={{ opacity: themeSaving ? 0.6 : 1 }}\r\n                  >\r\n                    {themeSaving ? 'Enregistrement...' : 'Enregistrer'}\r\n                  </button>\r\n                )}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Modal Nouvel Utilisateur */}\r\n        {showUserModal && (\r\n          <div className=\"report-modal-overlay\" onClick={closeUserModal}>\r\n            <div className=\"report-modal\" onClick={(e) => e.stopPropagation()} style={{ maxWidth: 500 }}>\r\n              <div className=\"report-modal-header\">\r\n                <h3>Nouvel utilisateur</h3>\r\n                <button className=\"report-modal-close\" onClick={closeUserModal}>Ô£ò</button>\r\n              </div>\r\n              <div className=\"report-modal-content\">\r\n                {userModalError && (\r\n                  <div style={{ \r\n                    padding: '12px', \r\n                    background: 'var(--color-error-bg)', \r\n                    border: '1px solid var(--color-error-border)', \r\n                    color: 'var(--color-error-text)', \r\n                    borderRadius: 6, \r\n                    marginBottom: 16,\r\n                    fontSize: 14\r\n                  }}>\r\n                    {userModalError}\r\n                  </div>\r\n                )}\r\n                {userModalSuccess && (\r\n                  <div style={{ \r\n                    padding: '12px', \r\n                    background: '#d4edda', \r\n                    border: '1px solid #c3e6cb', \r\n                    color: '#155724', \r\n                    borderRadius: 6, \r\n                    marginBottom: 16,\r\n                    fontSize: 14\r\n                  }}>\r\n                    {userModalSuccess}\r\n                  </div>\r\n                )}\r\n                <div style={{ marginBottom: 16 }}>\r\n                  <label style={{ display: 'block', marginBottom: 6, fontWeight: 600, fontSize: 14 }}>Email *</label>\r\n                  <input\r\n                    type=\"email\"\r\n                    value={userModalEmail}\r\n                    onChange={(e) => setUserModalEmail(e.target.value)}\r\n                    placeholder=\"utilisateur@exemple.com\"\r\n                    disabled={actionLoading}\r\n                    style={{\r\n                      width: '100%',\r\n                      padding: '10px 12px',\r\n                      border: '1px solid var(--color-c8)',\r\n                      borderRadius: 6,\r\n                      fontSize: 14,\r\n                      backgroundColor: '#FFFFFF'\r\n                    }}\r\n                  />\r\n                </div>\r\n                <div style={{ marginBottom: 16 }}>\r\n                  <label style={{ display: 'block', marginBottom: 6, fontWeight: 600, fontSize: 14 }}>Cabinet (optionnel)</label>\r\n                  <select\r\n                    value={userModalCabinetId}\r\n                    onChange={(e) => setUserModalCabinetId(e.target.value)}\r\n                    disabled={actionLoading || cabinetsLoading}\r\n                    style={{\r\n                      width: '100%',\r\n                      padding: '10px 12px',\r\n                      border: '1px solid var(--color-c8)',\r\n                      borderRadius: 6,\r\n                      fontSize: 14,\r\n                      backgroundColor: '#FFFFFF',\r\n                      cursor: 'pointer'\r\n                    }}\r\n                  >\r\n                    <option value=\"\">-- Aucun cabinet --</option>\r\n                    {cabinets.map((cabinet) => (\r\n                      <option key={cabinet.id} value={cabinet.id}>\r\n                        {cabinet.name}\r\n                      </option>\r\n                    ))}\r\n                  </select>\r\n                </div>\r\n              </div>\r\n              <div className=\"report-modal-actions\">\r\n                <button onClick={closeUserModal} disabled={actionLoading}>Annuler</button>\r\n                <button \r\n                  className=\"chip\"\r\n                  onClick={handleInviteUser}\r\n                  disabled={actionLoading}\r\n                  style={{ opacity: actionLoading ? 0.6 : 1 }}\r\n                >\r\n                  {actionLoading ? 'Envoi...' : 'Inviter'}\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Modale de signalements premium */}\r\n        {showReportModal && (\r\n          <div className=\"report-modal-overlay\" onClick={handleCloseModal}>\r\n            <div className=\"report-modal\" onClick={(e) => e.stopPropagation()}>\r\n              {/* Vue Liste */}\r\n              {!selectedReport ? (\r\n                <>\r\n                  <div className=\"report-modal-header\">\r\n                    <div className=\"report-modal-title-section\">\r\n                      <h3>Signalements</h3>\r\n                      {selectedReportUser && (\r\n                        <span className=\"report-modal-subtitle\">{selectedReportUser.email}</span>\r\n                      )}\r\n                    </div>\r\n                    <button className=\"report-modal-close\" onClick={handleCloseModal}>Ô£ò</button>\r\n                  </div>\r\n\r\n                  <div className=\"report-modal-content\">\r\n                    {reportLoading ? (\r\n                      <div className=\"report-loading\">Chargement des signalements...</div>\r\n                    ) : userReports.length === 0 ? (\r\n                      <div className=\"report-empty\">Aucun signalement pour cet utilisateur.</div>\r\n                    ) : (\r\n                      <table className=\"reports-table\">\r\n                        <thead>\r\n                          <tr>\r\n                            <th>Date</th>\r\n                            <th>Page</th>\r\n                            <th>Titre</th>\r\n                            <th>Statut</th>\r\n                            <th>Action</th>\r\n                          </tr>\r\n                        </thead>\r\n                        <tbody>\r\n                          {userReports.map((report) => (\r\n                            <tr key={report.id} className={report.admin_read_at ? 'read' : 'unread'}>\r\n                              <td>{new Date(report.created_at).toLocaleDateString('fr-FR')}</td>\r\n                              <td className=\"report-page-cell\">{report.page || '-'}</td>\r\n                              <td className=\"report-title-cell\">{report.title || 'Sans titre'}</td>\r\n                              <td>\r\n                                <span className={`report-status ${report.admin_read_at ? 'read' : 'unread'}`}>\r\n                                  {report.admin_read_at ? 'Lu' : 'Non lu'}\r\n                                </span>\r\n                              </td>\r\n                              <td>\r\n                                <button \r\n                                  className=\"report-view-btn\"\r\n                                  onClick={() => handleSelectReport(report)}\r\n                                >\r\n                                  Voir\r\n                                </button>\r\n                              </td>\r\n                            </tr>\r\n                          ))}\r\n                        </tbody>\r\n                      </table>\r\n                    )}\r\n                  </div>\r\n\r\n                  <div className=\"report-modal-actions\">\r\n                    {userReports.length > 0 && (\r\n                      <button \r\n                        className=\"danger\"\r\n                        onClick={() => handleDeleteAllReports(selectedReportUser?.id)}\r\n                      >\r\n                        Supprimer tout l'historique\r\n                      </button>\r\n                    )}\r\n                    <button onClick={handleCloseModal}>Fermer</button>\r\n                  </div>\r\n                </>\r\n              ) : (\r\n                /* Vue D├®tail */\r\n                <>\r\n                  <div className=\"report-modal-header\">\r\n                    <div className=\"report-modal-title-section\">\r\n                      <button className=\"report-back-btn\" onClick={handleBackToList}>\r\n                        ÔåÉ Retour\r\n                      </button>\r\n                      <h3>D├®tail du signalement</h3>\r\n                    </div>\r\n                    <button className=\"report-modal-close\" onClick={handleCloseModal}>Ô£ò</button>\r\n                  </div>\r\n\r\n                  <div className=\"report-modal-content\">\r\n                    <div className=\"report-detail-meta\">\r\n                      <div className=\"report-detail-field\">\r\n                        <span className=\"report-detail-label\">Date :</span>\r\n                        <span className=\"report-detail-value\">\r\n                          {new Date(selectedReport.created_at).toLocaleString('fr-FR')}\r\n                        </span>\r\n                      </div>\r\n                      <div className=\"report-detail-field\">\r\n                        <span className=\"report-detail-label\">Page :</span>\r\n                        <span className=\"report-detail-value\">{selectedReport.page || '-'}</span>\r\n                      </div>\r\n                      <div className=\"report-detail-field\">\r\n                        <span className=\"report-detail-label\">Statut :</span>\r\n                        <span className={`report-status ${selectedReport.admin_read_at ? 'read' : 'unread'}`}>\r\n                          {selectedReport.admin_read_at ? 'Lu' : 'Non lu'}\r\n                        </span>\r\n                      </div>\r\n                    </div>\r\n\r\n                    <div className=\"report-detail-section\">\r\n                      <h4>{selectedReport.title || 'Sans titre'}</h4>\r\n                      <div className=\"report-description-box\">\r\n                        {selectedReport.description || 'Aucune description fournie.'}\r\n                      </div>\r\n                    </div>\r\n\r\n                    {selectedReport.meta && Object.keys(selectedReport.meta).length > 0 && (\r\n                      <details className=\"report-detail-metadata\">\r\n                        <summary>Informations techniques</summary>\r\n                        <pre>{JSON.stringify(selectedReport.meta, null, 2)}</pre>\r\n                      </details>\r\n                    )}\r\n                  </div>\r\n\r\n                  <div className=\"report-modal-actions\">\r\n                    {!selectedReport.admin_read_at && (\r\n                      <button onClick={() => handleMarkAsRead(selectedReport.id)}>\r\n                        Marquer comme lu\r\n                      </button>\r\n                    )}\r\n                    <button \r\n                      className=\"danger\"\r\n                      onClick={() => handleDeleteReport(selectedReport.id)}\r\n                    >\r\n                      Supprimer\r\n                    </button>\r\n                    <button onClick={handleBackToList}>Retour ├á la liste</button>\r\n                  </div>\r\n                </>\r\n              )}\r\n            </div>\r\n          </div>\r\n        )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pages\\Sous-Settings\\SettingsFiscalites.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pages\\Sous-Settings\\SettingsImpots.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pages\\Sous-Settings\\SettingsPrelevements.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pages\\Sous-Settings\\SettingsSignalements.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pages\\Sous-Settings\\SettingsTableMortalite.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pages\\StrategyPage.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\assets\\resolvePublicAsset.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\auditPptx.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\creditPptx.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\designSystem\\serenity.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\export\\demoExport.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\export\\exportStudyDeck.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\export\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\icons\\addBusinessIcon.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\irPptx.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\logo\\loadLogoDataUri.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\ops\\addBusinessIcon.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\ops\\applyChapterImage.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\ops\\applyCoverLogo.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\presets\\creditDeckBuilder.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\presets\\irDeckBuilder.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\slides\\buildChapter.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\slides\\buildContent.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\slides\\buildCover.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\slides\\buildCreditAmortization.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\slides\\buildCreditAnnexe.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\slides\\buildCreditGlobalSynthesis.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\slides\\buildCreditLoanSynthesis.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\slides\\buildCreditSynthesis.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\slides\\buildEnd.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\slides\\buildIrAnnexe.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\slides\\buildIrSynthesis.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\slides\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\strategyPptx.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\structure\\slideTypes.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\template\\loadBaseTemplate.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\theme\\getPptxThemeFromUiSettings.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\theme\\pptxTheme.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\theme\\resolvePptxColors.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\theme\\themeBuilder.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\pptx\\theme\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\services\\apiAdmin.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\services\\userModeService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\settings\\ThemeProvider.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'colors' is defined but never used. Allowed unused args must match /^_/u.","line":212,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":212,"endColumn":34,"suggestions":[{"messageId":"removeVar","data":{"varName":"colors"},"fix":{"range":[6232,6251],"text":""},"desc":"Remove unused variable 'colors'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'colors' is defined but never used. Allowed unused args must match /^_/u.","line":213,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":213,"endColumn":46,"suggestions":[{"messageId":"removeVar","data":{"varName":"colors"},"fix":{"range":[6289,6309],"text":""},"desc":"Remove unused variable 'colors'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'themeName' is defined but never used. Allowed unused args must match /^_/u.","line":213,"column":48,"nodeType":"Identifier","messageId":"unusedVar","endLine":213,"endColumn":66,"suggestions":[{"messageId":"removeVar","data":{"varName":"themeName"},"fix":{"range":[6308,6328],"text":""},"desc":"Remove unused variable 'themeName'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'logo' is defined but never used. Allowed unused args must match /^_/u.","line":217,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":217,"endColumn":37,"suggestions":[{"messageId":"removeVar","data":{"varName":"logo"},"fix":{"range":[6521,6545],"text":""},"desc":"Remove unused variable 'logo'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'scope' is defined but never used. Allowed unused args must match /^_/u.","line":221,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":221,"endColumn":36,"suggestions":[{"messageId":"removeVar","data":{"varName":"scope"},"fix":{"range":[6745,6762],"text":""},"desc":"Remove unused variable 'scope'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'source' is defined but never used. Allowed unused args must match /^_/u.","line":224,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":224,"endColumn":39,"suggestions":[{"messageId":"removeVar","data":{"varName":"source"},"fix":{"range":[6936,6955],"text":""},"desc":"Remove unused variable 'source'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The ref value 'mountIdRef.current' will likely have changed by the time this effect cleanup function runs. If this ref points to a node rendered by React, copy 'mountIdRef.current' to a variable inside the effect, and use that variable in the cleanup function.","line":518,"column":84,"nodeType":"Identifier","endLine":518,"endColumn":91},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'applyColorsToCSSWithGuard'. Either include it or remove the dependency array.","line":603,"column":6,"nodeType":"ArrayExpression","endLine":603,"endColumn":20,"suggestions":[{"desc":"Update the dependencies array to be: [activeUserId, applyColorsToCSSWithGuard]","fix":{"range":[22340,22354],"text":"[activeUserId, applyColorsToCSSWithGuard]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'applyColorsToCSSWithGuard', 'cabinetColors', 'cabinetLogo', 'ensureCabinetLogoFetch', and 'ensureCabinetThemeFetch'. Either include them or remove the dependency array.","line":723,"column":6,"nodeType":"ArrayExpression","endLine":723,"endColumn":33,"suggestions":[{"desc":"Update the dependencies array to be: [activeUserId, applyColorsToCSSWithGuard, cabinetColors, cabinetLogo, ensureCabinetLogoFetch, ensureCabinetThemeFetch, themeSource]","fix":{"range":[27434,27461],"text":"[activeUserId, applyColorsToCSSWithGuard, cabinetColors, cabinetLogo, ensureCabinetLogoFetch, ensureCabinetThemeFetch, themeSource]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'applyColorsToCSSWithGuard'. Either include it or remove the dependency array.","line":729,"column":6,"nodeType":"ArrayExpression","endLine":729,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [applyColorsToCSSWithGuard]","fix":{"range":[27716,27718],"text":"[applyColorsToCSSWithGuard]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":10,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * ThemeProvider - Fournit le th├¿me ├á toute l'application\r\n * \r\n * G├¿re :\r\n * - Chargement des couleurs depuis Supabase user_metadata\r\n * - Application des CSS variables\r\n * - Contexte React pour acc├®der aux couleurs partout\r\n */\r\n\r\nimport React, { createContext, useContext, useEffect, useState, useRef, useCallback } from 'react';\r\nimport { supabase } from '../supabaseClient';\r\n\r\n// Debug flag for theme-related logs (set to true for troubleshooting)\r\nconst DEBUG_THEME = false;\r\nimport { resolvePptxColors } from '../pptx/theme/resolvePptxColors';\r\n\r\n// Cache local pour les th├¿mes (performance) - ISOL├ë PAR USER\r\nconst THEME_CACHE_KEY_PREFIX = 'ser1_theme_cache_';\r\nconst THEME_CACHE_TTL = 24 * 60 * 60 * 1000; // 24 heures\r\nconst CABINET_THEME_CACHE_KEY_PREFIX = 'ser1_cabinet_theme_cache_';\r\nconst CABINET_LOGO_CACHE_KEY_PREFIX = 'ser1_cabinet_logo_cache_';\r\nconst CABINET_CACHE_TTL = THEME_CACHE_TTL;\r\n\r\ninterface ThemeCache {\r\n  colors: ThemeColors;\r\n  timestamp: number;\r\n  themeName?: string;\r\n}\r\n\r\ninterface CabinetThemeCache {\r\n  colors: ThemeColors;\r\n  timestamp: number;\r\n}\r\n\r\ninterface CabinetLogoCache {\r\n  logo: string;\r\n  timestamp: number;\r\n}\r\n\r\nfunction getThemeFromCache(userId: string | null): ThemeColors | null {\r\n  if (!userId) return null;\r\n  \r\n  try {\r\n    const cacheKey = `${THEME_CACHE_KEY_PREFIX}${userId}`;\r\n    const cached = localStorage.getItem(cacheKey);\r\n    if (cached) {\r\n      const cache: ThemeCache = JSON.parse(cached);\r\n      const now = Date.now();\r\n      \r\n      // Valider le cache\r\n      if (now - cache.timestamp < THEME_CACHE_TTL) {\r\n        if (DEBUG_THEME) console.info('[ThemeProvider] Using cached theme for user:', userId);\r\n        return cache.colors;\r\n      } else {\r\n        localStorage.removeItem(cacheKey);\r\n      }\r\n    }\r\n  } catch (e) {\r\n    console.warn('[ThemeProvider] Cache read error:', e);\r\n  }\r\n  return null;\r\n}\r\n\r\nfunction saveThemeToCache(colors: ThemeColors, userId: string | null, themeName?: string): void {\r\n  if (!userId) return;\r\n  \r\n  try {\r\n    const cacheKey = `${THEME_CACHE_KEY_PREFIX}${userId}`;\r\n    const cache: ThemeCache = {\r\n      colors,\r\n      timestamp: Date.now(),\r\n      themeName\r\n    };\r\n    localStorage.setItem(cacheKey, JSON.stringify(cache));\r\n  } catch (e) {\r\n    console.warn('[ThemeProvider] Cache write error:', e);\r\n  }\r\n}\r\n\r\nconst CABINET_LOGO_EMPTY = '__none__';\r\n\r\nfunction getCabinetThemeFromCache(userId: string | null): ThemeColors | null {\r\n  if (!userId) return null;\r\n\r\n  try {\r\n    const cacheKey = `${CABINET_THEME_CACHE_KEY_PREFIX}${userId}`;\r\n    const cached = localStorage.getItem(cacheKey);\r\n    if (cached) {\r\n      const cache: CabinetThemeCache = JSON.parse(cached);\r\n      const now = Date.now();\r\n\r\n      if (now - cache.timestamp < CABINET_CACHE_TTL) {\r\n        if (DEBUG_THEME) console.info('[ThemeProvider] Using cached cabinet theme for user:', userId);\r\n        return cache.colors;\r\n      }\r\n      localStorage.removeItem(cacheKey);\r\n    }\r\n  } catch (e) {\r\n    console.warn('[ThemeProvider] Cabinet cache read error:', e);\r\n  }\r\n  return null;\r\n}\r\n\r\nfunction saveCabinetThemeToCache(colors: ThemeColors, userId: string | null): void {\r\n  if (!userId) return;\r\n\r\n  try {\r\n    const cacheKey = `${CABINET_THEME_CACHE_KEY_PREFIX}${userId}`;\r\n    const cache: CabinetThemeCache = {\r\n      colors,\r\n      timestamp: Date.now()\r\n    };\r\n    localStorage.setItem(cacheKey, JSON.stringify(cache));\r\n  } catch (e) {\r\n    console.warn('[ThemeProvider] Cabinet cache write error:', e);\r\n  }\r\n}\r\n\r\nfunction getCabinetLogoFromCache(userId: string | null): string | null | undefined {\r\n  if (!userId) return undefined;\r\n\r\n  try {\r\n    const cacheKey = `${CABINET_LOGO_CACHE_KEY_PREFIX}${userId}`;\r\n    const cached = localStorage.getItem(cacheKey);\r\n    if (cached) {\r\n      const cache: CabinetLogoCache = JSON.parse(cached);\r\n      const now = Date.now();\r\n\r\n      if (now - cache.timestamp < CABINET_CACHE_TTL) {\r\n        if (DEBUG_THEME) console.info('[ThemeProvider] Using cached cabinet logo for user:', userId);\r\n        return cache.logo === CABINET_LOGO_EMPTY ? null : cache.logo;\r\n      }\r\n      localStorage.removeItem(cacheKey);\r\n    }\r\n  } catch (e) {\r\n    console.warn('[ThemeProvider] Cabinet logo cache read error:', e);\r\n  }\r\n  return undefined;\r\n}\r\n\r\nfunction saveCabinetLogoToCache(logo: string | undefined | null, userId: string | null): void {\r\n  if (!userId) return;\r\n\r\n  try {\r\n    const cacheKey = `${CABINET_LOGO_CACHE_KEY_PREFIX}${userId}`;\r\n    const cache: CabinetLogoCache = {\r\n      logo: logo ? logo : CABINET_LOGO_EMPTY,\r\n      timestamp: Date.now()\r\n    };\r\n    localStorage.setItem(cacheKey, JSON.stringify(cache));\r\n  } catch (e) {\r\n    console.warn('[ThemeProvider] Cabinet logo cache write error:', e);\r\n  }\r\n}\r\n\r\nfunction clearThemeCacheForUser(userId: string | null): void {\r\n  if (!userId) return;\r\n  \r\n  try {\r\n    const cacheKey = `${THEME_CACHE_KEY_PREFIX}${userId}`;\r\n    localStorage.removeItem(cacheKey);\r\n    if (DEBUG_THEME) console.info('[ThemeProvider] Cache cleared for user:', userId);\r\n  } catch (e) {\r\n    console.warn('[ThemeProvider] Cache clear error:', e);\r\n  }\r\n}\r\n\r\nexport interface ThemeColors {\r\n  c1: string;\r\n  c2: string;\r\n  c3: string;\r\n  c4: string;\r\n  c5: string;\r\n  c6: string;\r\n  c7: string;\r\n  c8: string;\r\n  c9: string;\r\n  c10: string;\r\n}\r\n\r\nexport const DEFAULT_COLORS: ThemeColors = {\r\n  c1: '#2B3E37',\r\n  c2: '#709B8B',\r\n  c3: '#9FBDB2',\r\n  c4: '#CFDED8',\r\n  c5: '#788781',\r\n  c6: '#CEC1B6',\r\n  c7: '#F5F3F0',\r\n  c8: '#D9D9D9',\r\n  c9: '#7F7F7F',\r\n  c10: '#000000',\r\n};\r\n\r\nfunction getThemeBootstrap(): { colors: ThemeColors; userId?: string | null } | null {\r\n  if (typeof window === 'undefined') return null;\r\n  const bootstrap = (window as any).__ser1ThemeBootstrap;\r\n  if (!bootstrap?.colors) return null;\r\n  return {\r\n    colors: bootstrap.colors as ThemeColors,\r\n    userId: bootstrap.userId ?? null\r\n  };\r\n}\r\n\r\n// SER1 Classic colors centralized in pptx/theme/resolvePptxColors.ts\r\n// (not imported here - only used by resolvePptxColors for PPTX exports)\r\n\r\nexport type ThemeScope = 'all' | 'ui-only';\r\nexport type ThemeSource = 'cabinet' | 'custom';\r\n\r\ninterface ThemeContextValue {\r\n  colors: ThemeColors;\r\n  setColors: (colors: ThemeColors) => void;\r\n  saveThemeToUiSettings: (colors: ThemeColors, themeName?: string) => Promise<{ success: boolean; error?: string }>;\r\n  isLoading: boolean;\r\n  themeReady: boolean; // true when CSS variables are applied (safe to render routes)\r\n  logo?: string;\r\n  setLogo: (logo: string | undefined) => void;\r\n  cabinetLogo?: string; // Logo cabinet (via RPC)\r\n  cabinetColors: ThemeColors | null; // Couleurs cabinet (charg├®es 1x au login, read-only)\r\n  themeScope: ThemeScope;\r\n  setThemeScope: (scope: ThemeScope) => void; // Allow Settings to update scope globally\r\n  pptxColors: ThemeColors; // Colors to use for PPTX (respects scope)\r\n  themeSource: ThemeSource;\r\n  setThemeSource: (source: ThemeSource) => void;\r\n}\r\n\r\nconst ThemeContext = createContext<ThemeContextValue>({\r\n  colors: DEFAULT_COLORS,\r\n  setColors: (_colors: ThemeColors) => {},\r\n  saveThemeToUiSettings: async (_colors: ThemeColors, _themeName?: string) => ({ success: false, error: 'Not implemented' }),\r\n  isLoading: true,\r\n  themeReady: false,\r\n  logo: undefined,\r\n  setLogo: (_logo: string | undefined) => {},\r\n  cabinetLogo: undefined,\r\n  cabinetColors: null,\r\n  themeScope: 'all',\r\n  setThemeScope: (_scope: ThemeScope) => {},\r\n  pptxColors: DEFAULT_COLORS,\r\n  themeSource: 'cabinet',\r\n  setThemeSource: (_source: ThemeSource) => {},\r\n});\r\n\r\nexport function useTheme(): ThemeContextValue {\r\n  return useContext(ThemeContext);\r\n}\r\n\r\n/**\r\n * Convertit les couleurs Settings (color1-10) vers le format interne (c1-10)\r\n */\r\nfunction convertFromSettingsFormat(settingsColors: Record<string, string>): ThemeColors {\r\n  return {\r\n    c1: settingsColors.color1 || DEFAULT_COLORS.c1,\r\n    c2: settingsColors.color2 || DEFAULT_COLORS.c2,\r\n    c3: settingsColors.color3 || DEFAULT_COLORS.c3,\r\n    c4: settingsColors.color4 || DEFAULT_COLORS.c4,\r\n    c5: settingsColors.color5 || DEFAULT_COLORS.c5,\r\n    c6: settingsColors.color6 || DEFAULT_COLORS.c6,\r\n    c7: settingsColors.color7 || DEFAULT_COLORS.c7,\r\n    c8: settingsColors.color8 || DEFAULT_COLORS.c8,\r\n    c9: settingsColors.color9 || DEFAULT_COLORS.c9,\r\n    c10: settingsColors.color10 || DEFAULT_COLORS.c10,\r\n  };\r\n}\r\n\r\ninterface ThemeProviderProps {\r\n  children: React.ReactNode;\r\n}\r\n\r\nexport function ThemeProvider({ children }: ThemeProviderProps): React.ReactElement {\r\n  // ÔÜí INIT SYNCHRONE : Lire le cache AVANT le premier render\r\n  // Cela emp├¬che le flash \"default\" si un cache existe\r\n  const themeBootstrap = getThemeBootstrap();\r\n  const [colorsState, setColorsState] = useState<ThemeColors>(() => themeBootstrap?.colors ?? DEFAULT_COLORS);\r\n  const [logo, setLogo] = useState<string | undefined>(undefined);\r\n  const [cabinetLogo, setCabinetLogo] = useState<string | undefined>(undefined);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [themeReady, setThemeReady] = useState(false); // true when CSS vars applied\r\n  const [themeScope, setThemeScope] = useState<ThemeScope>('all');\r\n  // Lire themeSource depuis localStorage pour persister la pr├®f├®rence user\r\n  const [themeSource, setThemeSource] = useState<ThemeSource>(() => {\r\n    if (typeof window !== 'undefined') {\r\n      const stored = localStorage.getItem('themeSource');\r\n      if (stored === 'cabinet' || stored === 'custom') return stored;\r\n    }\r\n    return 'cabinet';\r\n  });\r\n  const [activeUserId, setActiveUserId] = useState<string | null>(null);\r\n  // Couleurs cabinet stock├®es s├®par├®ment (charg├®es 1x, read-only pour PPTX)\r\n  const [cabinetColors, setCabinetColors] = useState<ThemeColors | null>(null);\r\n\r\n  // Compute PPTX colors - TOUJOURS utiliser cabinetColors si disponible\r\n  // R├êGLE M├ëTIER: PPTX = couleurs cabinet (ou SER1 Classic si pas de cabinet)\r\n  const pptxColors: ThemeColors = resolvePptxColors(colorsState, themeScope, cabinetColors);\r\n\r\n  // Load cabinet logo for user via RPC (contourne RLS)\r\n  // Returns data URI (base64) for direct use in PPTX exports\r\n  const loadCabinetLogo = async (userId: string): Promise<string | undefined> => {\r\n    try {\r\n      // Utiliser RPC SECURITY DEFINER pour r├®cup├®rer le storage_path sans RLS\r\n      const { data: storagePath, error: rpcError } = await supabase\r\n        .rpc('get_my_cabinet_logo');\r\n        \r\n      if (rpcError) {\r\n        if (DEBUG_THEME) console.warn('[ThemeProvider] Cabinet logo RPC error:', rpcError);\r\n        return undefined;\r\n      }\r\n      \r\n      if (!storagePath) {\r\n        if (DEBUG_THEME) console.info('[ThemeProvider] No cabinet logo found for user:', userId);\r\n        return undefined;\r\n      }\r\n      \r\n      // Download blob from Storage (works with public AND private buckets)\r\n      const { data: blob, error: downloadError } = await supabase.storage\r\n        .from('logos')\r\n        .download(storagePath);\r\n      \r\n      if (downloadError || !blob) {\r\n        if (DEBUG_THEME) console.warn('[ThemeProvider] Cabinet logo download error:', downloadError);\r\n        return undefined;\r\n      }\r\n      \r\n      // Convert blob to data URI for direct use in PPTX\r\n      const dataUri = await new Promise<string>((resolve, reject) => {\r\n        const reader = new FileReader();\r\n        reader.onloadend = () => resolve(reader.result as string);\r\n        reader.onerror = reject;\r\n        reader.readAsDataURL(blob);\r\n      });\r\n      \r\n      if (DEBUG_THEME) console.info('[ThemeProvider] Cabinet logo loaded as dataURI, size:', dataUri.length);\r\n      return dataUri;\r\n    } catch (error) {\r\n      console.error('[ThemeProvider] Error loading cabinet logo:', error);\r\n      return undefined;\r\n    }\r\n  };\r\n\r\n  // Load cabinet theme for user via RPC (contourne RLS)\r\n  const loadCabinetTheme = async (userId: string): Promise<ThemeColors> => {\r\n    try {\r\n      // Utiliser RPC SECURITY DEFINER pour r├®cup├®rer la palette sans RLS\r\n      const { data: palette, error: rpcError } = await supabase\r\n        .rpc('get_my_cabinet_theme_palette');\r\n        \r\n      if (rpcError) {\r\n        if (DEBUG_THEME) console.warn('[ThemeProvider] RPC error:', rpcError);\r\n        return DEFAULT_COLORS;\r\n      }\r\n      \r\n      if (!palette) {\r\n        if (DEBUG_THEME) console.warn('[ThemeProvider] No cabinet theme found for user:', userId);\r\n        return DEFAULT_COLORS;\r\n      }\r\n      \r\n      // Convertir palette DB vers format ThemeColors\r\n      const cabinetColors: ThemeColors = {\r\n        c1: palette.c1 || DEFAULT_COLORS.c1,\r\n        c2: palette.c2 || DEFAULT_COLORS.c2,\r\n        c3: palette.c3 || DEFAULT_COLORS.c3,\r\n        c4: palette.c4 || DEFAULT_COLORS.c4,\r\n        c5: palette.c5 || DEFAULT_COLORS.c5,\r\n        c6: palette.c6 || DEFAULT_COLORS.c6,\r\n        c7: palette.c7 || DEFAULT_COLORS.c7,\r\n        c8: palette.c8 || DEFAULT_COLORS.c8,\r\n        c9: palette.c9 || DEFAULT_COLORS.c9,\r\n        c10: palette.c10 || DEFAULT_COLORS.c10,\r\n      };\r\n      \r\n      if (DEBUG_THEME) console.info('[ThemeProvider] Cabinet theme loaded for user:', userId);\r\n      return cabinetColors;\r\n    } catch (error) {\r\n      console.error('[ThemeProvider] Error loading cabinet theme:', error);\r\n      return DEFAULT_COLORS;\r\n    }\r\n  };\r\n\r\n  // Retry helper for cabinet theme with exponential backoff (first login timing issue)\r\n  const loadCabinetThemeWithRetry = async (\r\n    userId: string,\r\n    mountedRef: React.MutableRefObject<boolean>,\r\n    requestIdRef: React.MutableRefObject<number>,\r\n    requestId: number\r\n  ): Promise<ThemeColors> => {\r\n    const delays: number[] = []; // Retry disabled to avoid repeated RPCs per session\r\n    \r\n    // Helper to check if colors are default fallback\r\n    const isDefaultFallback = (colors: ThemeColors): boolean => {\r\n      return Object.keys(DEFAULT_COLORS).every(\r\n        (key) => colors[key as keyof ThemeColors] === DEFAULT_COLORS[key as keyof ThemeColors]\r\n      );\r\n    };\r\n    \r\n    for (let attempt = 0; attempt < delays.length + 1; attempt++) {\r\n      // Abort if unmounted or request is stale (user changed)\r\n      if (!mountedRef.current || requestId !== requestIdRef.current) {\r\n        if (DEBUG_THEME) console.info('[ThemeProvider] Cabinet retry aborted (stale request)');\r\n        return DEFAULT_COLORS;\r\n      }\r\n      \r\n      const palette = await loadCabinetTheme(userId);\r\n      \r\n      // Success: got a real cabinet theme (not fallback)\r\n      if (!isDefaultFallback(palette)) {\r\n        if (DEBUG_THEME) console.info(`[ThemeProvider] Cabinet theme loaded on attempt ${attempt + 1}`);\r\n        return palette;\r\n      }\r\n      \r\n      // Last attempt: accept fallback\r\n      if (attempt === delays.length) {\r\n        if (DEBUG_THEME) console.warn('[ThemeProvider] Cabinet theme fallback after max attempts');\r\n        return DEFAULT_COLORS;\r\n      }\r\n      \r\n      // Wait before next retry (but check if still valid)\r\n      if (DEBUG_THEME) console.info(`[ThemeProvider] Retry cabinet theme in ${delays[attempt]}ms (attempt ${attempt + 1})`);\r\n      await new Promise(resolve => setTimeout(resolve, delays[attempt]));\r\n    }\r\n    \r\n    return DEFAULT_COLORS;\r\n  };\r\n\r\n  const ensureCabinetThemeFetch = (userId: string): Promise<ThemeColors> => {\r\n    if (cabinetThemeLoadedRef.current === userId && cabinetThemePromiseRef.current) {\r\n      return cabinetThemePromiseRef.current;\r\n    }\r\n\r\n    if (cabinetThemeLoadedRef.current === userId && !cabinetThemePromiseRef.current) {\r\n      return Promise.resolve(cabinetColors || DEFAULT_COLORS);\r\n    }\r\n\r\n    cabinetThemeLoadedRef.current = userId;\r\n    const requestId = ++cabinetThemeRequestIdRef.current;\r\n    const promise = (async () => {\r\n      const colors = await loadCabinetThemeWithRetry(userId, mountedRef, cabinetThemeRequestIdRef, requestId);\r\n      if (!mountedRef.current || requestId !== cabinetThemeRequestIdRef.current) {\r\n        return colors;\r\n      }\r\n\r\n      setCabinetColors(colors);\r\n      saveCabinetThemeToCache(colors, userId);\r\n\r\n      if (themeSourceRef.current === 'cabinet') {\r\n        setColorsState(colors);\r\n        applyColorsToCSSWithGuard(colors, userId, 'cabinet-theme');\r\n      }\r\n\r\n      return colors;\r\n    })();\r\n\r\n    cabinetThemePromiseRef.current = promise;\r\n    return promise;\r\n  };\r\n\r\n  const ensureCabinetLogoFetch = (userId: string): Promise<string | undefined> => {\r\n    if (cabinetLogoLoadedRef.current === userId && cabinetLogoPromiseRef.current) {\r\n      return cabinetLogoPromiseRef.current;\r\n    }\r\n\r\n    if (cabinetLogoLoadedRef.current === userId && !cabinetLogoPromiseRef.current) {\r\n      return Promise.resolve(cabinetLogo);\r\n    }\r\n\r\n    cabinetLogoLoadedRef.current = userId;\r\n    const requestId = ++cabinetLogoRequestIdRef.current;\r\n    const promise = (async () => {\r\n      const logoUrl = await loadCabinetLogo(userId);\r\n      if (!mountedRef.current || requestId !== cabinetLogoRequestIdRef.current) {\r\n        return logoUrl;\r\n      }\r\n\r\n      setCabinetLogo(logoUrl);\r\n      saveCabinetLogoToCache(logoUrl ?? null, userId);\r\n      return logoUrl;\r\n    })();\r\n\r\n    cabinetLogoPromiseRef.current = promise;\r\n    return promise;\r\n  };\r\n\r\n  // ­ƒÜ¿ DIAGNOSTIC: Track hash and user ID to prevent unnecessary reapplications\r\n  const lastAppliedHashRef = useRef<string>('');\r\n  const lastAppliedUserIdRef = useRef<string>('');\r\n  const mountIdRef = useRef<string>(Date.now().toString());\r\n  const cacheAppliedRef = useRef<boolean>(false);\r\n  const mountedRef = useRef<boolean>(true);\r\n  const activeRequestIdRef = useRef<number>(0);\r\n  const cabinetThemePromiseRef = useRef<Promise<ThemeColors> | null>(null);\r\n  const cabinetLogoPromiseRef = useRef<Promise<string | undefined> | null>(null);\r\n  const cabinetThemeLoadedRef = useRef<string | null>(null);\r\n  const cabinetLogoLoadedRef = useRef<string | null>(null);\r\n  const cabinetThemeRequestIdRef = useRef<number>(0);\r\n  const cabinetLogoRequestIdRef = useRef<number>(0);\r\n  const themeSourceRef = useRef<ThemeSource>(themeSource);\r\n\r\n  // Debug: Log mount/unmount\r\n  if (DEBUG_THEME) console.info(`[ThemeProvider] MOUNTING - ID: ${mountIdRef.current}`);\r\n\r\n  // Apply default immediately on mount\r\n  const initialApplyDone = useRef(false);\r\n  if (!initialApplyDone.current) {\r\n    if (themeBootstrap?.colors) {\r\n      applyColorsToCSSWithGuard(themeBootstrap.colors, themeBootstrap.userId ?? undefined, 'bootstrap-cache');\r\n      if (DEBUG_THEME) console.info('[ThemeProvider] Bootstrap theme applied on mount');\r\n    } else {\r\n      applyColorsToCSSWithGuard(DEFAULT_COLORS, undefined, 'default-sync-init');\r\n      if (DEBUG_THEME) console.info('[ThemeProvider] Default theme applied on mount');\r\n    }\r\n    initialApplyDone.current = true;\r\n  }\r\n\r\n  // Cleanup on unmount\r\n  useEffect(() => {\r\n    mountedRef.current = true;\r\n    return () => {\r\n      mountedRef.current = false;\r\n      if (DEBUG_THEME) console.info(`[ThemeProvider] UNMOUNTING - ID: ${mountIdRef.current}`);\r\n    };\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    themeSourceRef.current = themeSource;\r\n  }, [themeSource]);\r\n\r\n  // ­ƒÜ¿ DIAGNOSTIC: Hash function to detect if colors actually changed\r\n  function getThemeHash(colors: ThemeColors, userId?: string): string {\r\n    const colorString = Object.values(colors).join('').toLowerCase();\r\n    return `${colorString}-${userId || 'anonymous'}`;\r\n  }\r\n\r\n  // ­ƒÜ¿ DIAGNOSTIC: Enhanced applyColorsToCSS with change detection\r\n  function applyColorsToCSSWithGuard(colors: ThemeColors, userId?: string, source: string = 'unknown'): void {\r\n    const hash = getThemeHash(colors, userId);\r\n    \r\n    if (lastAppliedHashRef.current === hash) {\r\n      if (DEBUG_THEME) console.info(`[ThemeProvider] SKIPPED - Same colors already applied (source: ${source})`);\r\n      return;\r\n    }\r\n\r\n    if (DEBUG_THEME) console.info(`[ThemeProvider] APPLYING - Hash: ${hash.substring(0, 20)}... (source: ${source})`);\r\n    \r\n    const root = document.documentElement;\r\n    root.style.setProperty('--color-c1', colors.c1);\r\n    root.style.setProperty('--color-c2', colors.c2);\r\n    root.style.setProperty('--color-c3', colors.c3);\r\n    root.style.setProperty('--color-c4', colors.c4);\r\n    root.style.setProperty('--color-c5', colors.c5);\r\n    root.style.setProperty('--color-c6', colors.c6);\r\n    root.style.setProperty('--color-c7', colors.c7);\r\n    root.style.setProperty('--color-c8', colors.c8);\r\n    root.style.setProperty('--color-c9', colors.c9);\r\n    root.style.setProperty('--color-c10', colors.c10);\r\n\r\n    lastAppliedHashRef.current = hash;\r\n    lastAppliedUserIdRef.current = userId || '';\r\n    \r\n    // Mark theme as ready for rendering routes\r\n    if (!themeReady) {\r\n      setThemeReady(true);\r\n      if (DEBUG_THEME) console.info('[ThemeProvider] themeReady = true');\r\n    }\r\n  }\r\n\r\n  // Watch auth state changes and load theme when user changes\r\n  useEffect(() => {\r\n    const { data: { subscription } } = supabase.auth.onAuthStateChange(async (event, session) => {\r\n      if (DEBUG_THEME) console.info('[ThemeProvider] Auth event:', event, 'User:', session?.user?.id);\r\n      \r\n      if (event === 'SIGNED_OUT') {\r\n        // Clear theme immediately on logout\r\n        if (activeUserId) {\r\n          clearThemeCacheForUser(activeUserId);\r\n        }\r\n        cabinetThemePromiseRef.current = null;\r\n        cabinetLogoPromiseRef.current = null;\r\n        cabinetThemeLoadedRef.current = null;\r\n        cabinetLogoLoadedRef.current = null;\r\n        cabinetThemeRequestIdRef.current += 1;\r\n        cabinetLogoRequestIdRef.current += 1;\r\n        setActiveUserId(null);\r\n        setColorsState(DEFAULT_COLORS);\r\n        applyColorsToCSSWithGuard(DEFAULT_COLORS, undefined, 'signed-out');\r\n        setLogo(undefined);\r\n        setCabinetLogo(undefined);\r\n        setIsLoading(false);\r\n        if (DEBUG_THEME) console.info('[ThemeProvider] User signed out - reset to defaults');\r\n        return;\r\n      }\r\n      \r\n      if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED' || event === 'INITIAL_SESSION') {\r\n        const newUserId = session?.user?.id || null;\r\n        if (newUserId !== activeUserId) {\r\n          if (DEBUG_THEME) console.info('[ThemeProvider] User changed:', activeUserId, '->', newUserId);\r\n          setActiveUserId(newUserId);\r\n        }\r\n      }\r\n    });\r\n    \r\n    return () => {\r\n      subscription.unsubscribe();\r\n    };\r\n  }, [activeUserId]);\r\n\r\n  // Load theme when activeUserId or themeSource changes\r\n  useEffect(() => {\r\n    if (!activeUserId) {\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n    \r\n    const requestId = ++activeRequestIdRef.current;\r\n    if (DEBUG_THEME) console.info('[ThemeProvider] Loading theme for user:', activeUserId, 'request:', requestId);\r\n\r\n    async function loadTheme() {\r\n      try {\r\n        // Guard: abort if request is stale\r\n        if (!mountedRef.current || requestId !== activeRequestIdRef.current) {\r\n          if (DEBUG_THEME) console.info('[ThemeProvider] Request aborted (stale)');\r\n          return;\r\n        }\r\n\r\n        const cachedCabinetColors = getCabinetThemeFromCache(activeUserId);\r\n        const cachedCabinetLogo = getCabinetLogoFromCache(activeUserId);\r\n\r\n        if (cachedCabinetColors && !cabinetColors) {\r\n          setCabinetColors(cachedCabinetColors);\r\n        }\r\n\r\n        if (cachedCabinetLogo !== undefined && cabinetLogo === undefined) {\r\n          setCabinetLogo(cachedCabinetLogo ?? undefined);\r\n        }\r\n\r\n        const immediateCabinetColors = cabinetColors ?? cachedCabinetColors;\r\n        if (themeSource === 'cabinet' && immediateCabinetColors) {\r\n          setColorsState(immediateCabinetColors);\r\n          applyColorsToCSSWithGuard(immediateCabinetColors, activeUserId || undefined, cachedCabinetColors ? 'cabinet-cache' : 'cabinet-state');\r\n        }\r\n\r\n        const { data: { user } } = await supabase.auth.getUser();\r\n\r\n        if (!mountedRef.current || requestId !== activeRequestIdRef.current || !user) return;\r\n        if (user.id !== activeUserId) return; // User changed during load\r\n\r\n        // Hi├®rarchie modifi├®e selon themeSource\r\n        let finalColors = DEFAULT_COLORS;\r\n        let source = 'default';\r\n\r\n        void ensureCabinetThemeFetch(user.id);\r\n        void ensureCabinetLogoFetch(user.id);\r\n\r\n        // Maintenant d├®terminer les couleurs UI selon themeSource\r\n        if (themeSource === 'cabinet') {\r\n          // Mode cabinet: utiliser les couleurs cabinet pour l'UI\r\n          finalColors = immediateCabinetColors ?? DEFAULT_COLORS;\r\n          source = immediateCabinetColors ? (cachedCabinetColors ? 'cabinet-cache' : 'cabinet-state') : 'cabinet-default';\r\n        } else {\r\n          // themeSource='custom' : logique normale avec cache/ui_settings\r\n          const cachedColors = getThemeFromCache(user.id);\r\n          if (cachedColors) {\r\n            finalColors = cachedColors;\r\n            source = 'cache';\r\n            cacheAppliedRef.current = true;\r\n          } else {\r\n            // 1) Essayer ui_settings (nouveau syst├¿me)\r\n            try {\r\n              const { data: uiSettings, error: uiError } = await supabase\r\n                .from('ui_settings')\r\n                .select('colors')\r\n                .eq('user_id', user.id)\r\n                .order('updated_at', { ascending: false })\r\n                .limit(1)\r\n                .maybeSingle();\r\n\r\n              if (!mountedRef.current || requestId !== activeRequestIdRef.current) return;\r\n\r\n              if (!uiError && uiSettings?.colors) {\r\n                finalColors = convertFromSettingsFormat(uiSettings.colors);\r\n                source = 'ui_settings';\r\n                saveThemeToCache(finalColors, user.id);\r\n              } else if (user.user_metadata?.theme_colors) {\r\n                // 2) Fallback metadata (legacy admin)\r\n                finalColors = convertFromSettingsFormat(user.user_metadata.theme_colors);\r\n                source = 'user_metadata (legacy)';\r\n                saveThemeToCache(finalColors, user.id);\r\n              }\r\n            } catch {\r\n              if (!mountedRef.current || requestId !== activeRequestIdRef.current) return;\r\n              // 2) Fallback metadata (legacy admin)\r\n              if (user.user_metadata?.theme_colors) {\r\n                finalColors = convertFromSettingsFormat(user.user_metadata.theme_colors);\r\n                source = 'user_metadata (fallback)';\r\n                saveThemeToCache(finalColors, user.id);\r\n              }\r\n            }\r\n          }\r\n        }\r\n\r\n        if (mountedRef.current && requestId === activeRequestIdRef.current) {\r\n          setColorsState(finalColors);\r\n          applyColorsToCSSWithGuard(finalColors, user.id, source);\r\n          if (DEBUG_THEME) console.info(`[ThemeProvider] Theme loaded: ${source}`);\r\n        }\r\n\r\n        // Load logo from user_metadata\r\n        if (user.user_metadata?.cover_slide_url && mountedRef.current) {\r\n          setLogo(user.user_metadata.cover_slide_url);\r\n          if (DEBUG_THEME) console.info('[ThemeProvider] Logo loaded');\r\n        }\r\n      } catch (error) {\r\n        if (mountedRef.current && requestId === activeRequestIdRef.current) {\r\n          console.error('[ThemeProvider] Error loading theme:', error);\r\n          applyColorsToCSSWithGuard(DEFAULT_COLORS, undefined, 'error-fallback');\r\n        }\r\n      } finally {\r\n        if (mountedRef.current && requestId === activeRequestIdRef.current) {\r\n          setIsLoading(false);\r\n        }\r\n      }\r\n    }\r\n\r\n    loadTheme();\r\n  }, [activeUserId, themeSource]);\r\n\r\n  // Met ├á jour les couleurs et applique imm├®diatement\r\n  const setColors = useCallback((newColors: ThemeColors) => {\r\n    setColorsState(newColors);\r\n    applyColorsToCSSWithGuard(newColors, lastAppliedUserIdRef.current, 'setColors-manual');\r\n  }, []);\r\n\r\n  // Sauvegarde le th├¿me dans ui_settings (nouveau syst├¿me)\r\n  const saveThemeToUiSettings = useCallback(async (colors: ThemeColors, themeName?: string): Promise<{ success: boolean; error?: string }> => {\r\n    try {\r\n      const { data: { user } } = await supabase.auth.getUser();\r\n      if (!user) {\r\n        return { success: false, error: 'User not authenticated' };\r\n      }\r\n\r\n      // Format pour Supabase\r\n      const settingsColors = {\r\n        color1: colors.c1,\r\n        color2: colors.c2,\r\n        color3: colors.c3,\r\n        color4: colors.c4,\r\n        color5: colors.c5,\r\n        color6: colors.c6,\r\n        color7: colors.c7,\r\n        color8: colors.c8,\r\n        color9: colors.c9,\r\n        color10: colors.c10,\r\n      };\r\n\r\n      const { error } = await supabase\r\n        .from('ui_settings')\r\n        .upsert({\r\n          user_id: user.id,\r\n          theme_name: themeName || 'custom',\r\n          colors: settingsColors,\r\n        }, {\r\n          onConflict: 'user_id'\r\n        });\r\n\r\n      if (error) throw error;\r\n\r\n      // ├ëgalement sauvegarder dans le cache local isol├® par user\r\n      saveThemeToCache(colors, user.id, themeName);\r\n\r\n      return { success: true };\r\n    } catch (error: any) {\r\n      console.error('Error saving theme to ui_settings:', error);\r\n      return { success: false, error: error.message };\r\n    }\r\n  }, []);\r\n\r\n  // Load theme scope from ui_settings\r\n  useEffect(() => {\r\n    async function loadThemeScope() {\r\n      try {\r\n        const { data: { user } } = await supabase.auth.getUser();\r\n        if (user) {\r\n          const { data: uiSettings, error } = await supabase\r\n            .from('ui_settings')\r\n            .select('theme_name')\r\n            .eq('user_id', user.id)\r\n            .maybeSingle();\r\n          \r\n          if (!error && uiSettings?.theme_name) {\r\n            // Le scope est encod├® dans theme_name: \"custom-ui-only\" ou \"custom\"\r\n            if (uiSettings.theme_name.includes('ui-only')) {\r\n              setThemeScope('ui-only');\r\n            } else {\r\n              setThemeScope('all');\r\n            }\r\n          }\r\n        }\r\n      } catch (err) {\r\n        console.error('[ThemeProvider] Error loading theme scope:', err);\r\n      }\r\n    }\r\n    \r\n    loadThemeScope();\r\n  }, []);\r\n\r\n  return (\r\n    <ThemeContext.Provider value={{ colors: colorsState, setColors, saveThemeToUiSettings, isLoading, themeReady, logo, setLogo, cabinetLogo, cabinetColors, themeScope, setThemeScope, pptxColors, themeSource, setThemeSource }}>\r\n      {children}\r\n    </ThemeContext.Provider>\r\n  );\r\n}\r\n\r\n/**\r\n * Hook pour obtenir les couleurs dans un format compatible PPTX\r\n * Les couleurs PPTX sont sans le # prefix\r\n */\r\nexport function useThemeForPptx(): Record<string, string> {\r\n  const { colors } = useTheme();\r\n  return {\r\n    c1: colors.c1.replace('#', ''),\r\n    c2: colors.c2.replace('#', ''),\r\n    c3: colors.c3.replace('#', ''),\r\n    c4: colors.c4.replace('#', ''),\r\n    c5: colors.c5.replace('#', ''),\r\n    c6: colors.c6.replace('#', ''),\r\n    c7: colors.c7.replace('#', ''),\r\n    c8: colors.c8.replace('#', ''),\r\n    c9: colors.c9.replace('#', ''),\r\n    c10: colors.c10.replace('#', ''),\r\n  };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\settings\\theme.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\supabaseClient.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\utils\\exportExcel.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\utils\\fiscalSettingsCache.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\utils\\globalStorage.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\utils\\irEngine.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\utils\\irEngine.parts.test.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\utils\\isAbortError.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\utils\\logoUpload.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\utils\\number.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\utils\\paletteGenerator.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\utils\\placementEvents.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\utils\\placementPersistence.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\utils\\reset.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\utils\\tmiMetrics.dynamicRates.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\utils\\tmiMetrics.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\utils\\tmiMetrics.test.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\utils\\transmissionDisclaimer.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\utils\\versementConfig.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\utils\\xlsxBuilder.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\flore\\Documents\\SER1\\src\\vite-env.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]
